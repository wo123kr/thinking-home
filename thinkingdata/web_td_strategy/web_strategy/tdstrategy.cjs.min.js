function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function asyncGeneratorStep(e,t,r,n,i,a,s){try{var o=e[a](s),u=o.value}catch(e){return void r(e)}o.done?t(u):Promise.resolve(u).then(n,i)}function _asyncToGenerator(o){return function(){var e=this,s=arguments;return new Promise(function(t,r){var n=o.apply(e,s);function i(e){asyncGeneratorStep(n,t,r,i,a,"next",e)}function a(e){asyncGeneratorStep(n,t,r,i,a,"throw",e)}i(void 0)})}}function _callSuper(e,t,r){return t=_getPrototypeOf(t),_possibleConstructorReturn(e,_isNativeReflectConstruct()?Reflect.construct(t,r||[],_getPrototypeOf(e).constructor):t.apply(e,r))}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _createForOfIteratorHelper(e,t){var r,n,i,a,s="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(s)return i=!(n=!0),{s:function(){s=s.call(e)},n:function(){var e=s.next();return n=e.done,e},e:function(e){i=!0,r=e},f:function(){try{n||null==s.return||s.return()}finally{if(i)throw r}}};if(Array.isArray(e)||(s=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length)return s&&(e=s),a=0,{s:t=function(){},n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _defineProperty(e,t,r){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _get(){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=_superPropBase(e,t);if(n)return(n=Object.getOwnPropertyDescriptor(n,t)).get?n.get.call(arguments.length<3?e:r):n.value}).apply(null,arguments)}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_setPrototypeOf(e,t)}function _isNativeReflectConstruct(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(_isNativeReflectConstruct=function(){return!!e})()}function _iterableToArrayLimit(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,i,a,s,o=[],u=!0,l=!1;try{if(a=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;u=!1}else for(;!(u=(n=a.call(r)).done)&&(o.push(n.value),o.length!==t);u=!0);}catch(e){l=!0,i=e}finally{try{if(!u&&null!=r.return&&(s=r.return(),Object(s)!==s))return}finally{if(l)throw i}}return o}}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _possibleConstructorReturn(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}function _regenerator(){var p,e="function"==typeof Symbol?Symbol:{},t=e.iterator||"@@iterator",r=e.toStringTag||"@@toStringTag";function n(e,t,r,n){var i,a,s,o,u,l,c,f,h,t=t&&t.prototype instanceof T?t:T,t=Object.create(t.prototype);return _regeneratorDefine(t,"_invoke",(i=e,a=r,c=n||[],f=!1,h={p:l=0,n:0,v:p,a:g,f:g.bind(p,4),d:function(e,t){return s=e,o=0,u=p,h.n=t,m}},function(e,t,r){if(1<l)throw TypeError("Generator is already running");for(f&&1===t&&g(t,r),o=t,u=r;(y=o<2?p:u)||!f;){s||(o?o<3?(1<o&&(h.n=-1),g(o,u)):h.n=u:h.v=u);try{if(l=2,s){if(y=s[e=o?e:"next"]){if(!(y=y.call(s,u)))throw TypeError("iterator result is not an object");if(!y.done)return y;u=y.value,o<2&&(o=0)}else 1===o&&(y=s.return)&&y.call(s),o<2&&(u=TypeError("The iterator does not provide a '"+e+"' method"),o=1);s=p}else if((y=(f=h.n<0)?u:i.call(a,h))!==m)break}catch(e){s=p,o=1,u=e}finally{l=1}}return{value:y,done:f}}),!0),t;function g(e,t){for(o=e,u=t,y=0;!f&&l&&!r&&y<c.length;y++){var r,n=c[y],i=h.p,a=n[2];3<e?(r=a===t)&&(u=n[(o=n[4])?5:o=3],n[4]=n[5]=p):n[0]<=i&&((r=e<2&&i<n[1])?(o=0,h.v=t,h.n=n[1]):i<a&&(r=e<3||n[0]>t||a<t)&&(n[4]=e,n[5]=t,h.n=a,o=0))}if(r||1<e)return m;throw f=!0,t}}var m={};function T(){}function i(){}function a(){}var y=Object.getPrototypeOf,e=[][t]?y(y([][t]())):(_regeneratorDefine(y={},t,function(){return this}),y),s=a.prototype=T.prototype=Object.create(e);function o(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,a):(e.__proto__=a,_regeneratorDefine(e,r,"GeneratorFunction")),e.prototype=Object.create(s),e}return _regeneratorDefine(s,"constructor",i.prototype=a),_regeneratorDefine(a,"constructor",i),_regeneratorDefine(a,r,i.displayName="GeneratorFunction"),_regeneratorDefine(s),_regeneratorDefine(s,r,"Generator"),_regeneratorDefine(s,t,function(){return this}),_regeneratorDefine(s,"toString",function(){return"[object Generator]"}),(_regenerator=function(){return{w:n,m:o}})()}function _regeneratorDefine(e,t,r,n){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}(_regeneratorDefine=function(e,t,r,n){function i(t,r){_regeneratorDefine(e,t,function(e){return this._invoke(t,r,e)})}t?a?a(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(i("next",0),i("throw",1),i("return",2))})(e,t,r,n)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _superPropBase(e,t){for(;!{}.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}function _superPropGet(e,t,r,n){var i=_get(_getPrototypeOf(1&n?e.prototype:e),t,r);return 2&n&&"function"==typeof i?function(e){return i.apply(r,e)}:i}function _toPrimitive(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);r=r.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==typeof e?e:e+""}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _unsupportedIterableToArray(e,t){var r;if(e)return"string"==typeof e?_arrayLikeToArray(e,t):"Map"===(r="Object"===(r={}.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}var Config={LIB_VERSION:"1.1.1",STRATEGY_TEMPLATE_CODE:"td_strategy",STR_TYPE:"varchar",DATE_TYPE:"timestamp",BOOLEAN_TYPE:"boolean",INTEGER_TYPE:"integer",BIGINT_TYPE:"bigint",DOUBLE_TYPE:"double",DECIMAL_TYPE:"decimal",ARRAY_VARCHAR_TYPE:"array(varchar)",EVENT_NAME_KEY:"#event_name",EVENT_TYPE_KEY:"#type",FIRST_CHECK_ID_KEY:"#first_check_id",EVENT_ZONE_OFFSET:"#zone_offset",EVENT_TIME_KEY:"#time",DATA_BASE_LIMIT:900,DATA_TIME_LIMIT:31},TimeCycleUnit={DAY:"day",WEEK:"week",MONTH:"month",HOUR:"hour",MINUTE:"minute"},runtime=(s=>{var u,e=Object.prototype,l=e.hasOwnProperty,c=Object.defineProperty||function(e,t,r){e[t]=r.value},t="function"==typeof Symbol?Symbol:{},n=t.iterator||"@@iterator",r=t.asyncIterator||"@@asyncIterator",i=t.toStringTag||"@@toStringTag";function a(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{a({},"")}catch(e){a=function(e,t,r){return e[t]=r}}function o(e,t,r,n){var i,a,s,o,t=t&&t.prototype instanceof y?t:y,t=Object.create(t.prototype),n=new S(n||[]);return c(t,"_invoke",{value:(i=e,a=r,s=n,o=h,function(e,t){if(o===p)throw new Error("Generator is already running");if(o===m){if("throw"===e)throw t;return{value:u,done:!0}}for(s.method=e,s.arg=t;;){var r=s.delegate;if(r){r=function e(t,r){var n=r.method;var i=t.iterator[n];if(i===u)return r.delegate=null,"throw"===n&&t.iterator.return&&(r.method="return",r.arg=u,e(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),T;n=f(i,t.iterator,r.arg);if("throw"===n.type)return r.method="throw",r.arg=n.arg,r.delegate=null,T;i=n.arg;if(!i)return r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,T;{if(!i.done)return i;r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=u)}r.delegate=null;return T}(r,s);if(r){if(r===T)continue;return r}}if("next"===s.method)s.sent=s._sent=s.arg;else if("throw"===s.method){if(o===h)throw o=m,s.arg;s.dispatchException(s.arg)}else"return"===s.method&&s.abrupt("return",s.arg);o=p;r=f(i,a,s);if("normal"===r.type){if(o=s.done?m:g,r.arg!==T)return{value:r.arg,done:s.done}}else"throw"===r.type&&(o=m,s.method="throw",s.arg=r.arg)}})}),t}function f(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}s.wrap=o;var h="suspendedStart",g="suspendedYield",p="executing",m="completed",T={};function y(){}function _(){}function d(){}a(t={},n,function(){return this});var v=Object.getPrototypeOf,E=((v=v&&v(v(A([]))))&&v!==e&&l.call(v,n)&&(t=v),d.prototype=y.prototype=Object.create(t));function C(e){["next","throw","return"].forEach(function(t){a(e,t,function(e){return this._invoke(t,e)})})}function k(s,o){var t;c(this,"_invoke",{value:function(r,n){function e(){return new o(function(e,t){!function t(e,r,n,i){var a,e=f(s[e],s,r);if("throw"!==e.type)return(r=(a=e.arg).value)&&"object"==typeof r&&l.call(r,"__await")?o.resolve(r.__await).then(function(e){t("next",e,n,i)},function(e){t("throw",e,n,i)}):o.resolve(r).then(function(e){a.value=e,n(a)},function(e){return t("throw",e,n,i)});i(e.arg)}(r,n,e,t)})}return t=t?t.then(e,e):e()}})}function I(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function b(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function S(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(I,this),this.reset(!0)}function A(t){if(null!=t){var r,e=t[n];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length))return r=-1,(e=function e(){for(;++r<t.length;)if(l.call(t,r))return e.value=t[r],e.done=!1,e;return e.value=u,e.done=!0,e}).next=e}throw new TypeError(typeof t+" is not iterable")}return c(E,"constructor",{value:_.prototype=d,configurable:!0}),c(d,"constructor",{value:_,configurable:!0}),_.displayName=a(d,i,"GeneratorFunction"),s.isGeneratorFunction=function(e){e="function"==typeof e&&e.constructor;return!!e&&(e===_||"GeneratorFunction"===(e.displayName||e.name))},s.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,a(e,i,"GeneratorFunction")),e.prototype=Object.create(E),e},s.awrap=function(e){return{__await:e}},C(k.prototype),a(k.prototype,r,function(){return this}),s.AsyncIterator=k,s.async=function(e,t,r,n,i){void 0===i&&(i=Promise);var a=new k(o(e,t,r,n),i);return s.isGeneratorFunction(t)?a:a.next().then(function(e){return e.done?e.value:a.next()})},C(E),a(E,i,"Generator"),a(E,n,function(){return this}),a(E,"toString",function(){return"[object Generator]"}),s.keys=function(e){var t,r=Object(e),n=[];for(t in r)n.push(t);return n.reverse(),function e(){for(;n.length;){var t=n.pop();if(t in r)return e.value=t,e.done=!1,e}return e.done=!0,e}},s.values=A,S.prototype={constructor:S,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=u,this.done=!1,this.delegate=null,this.method="next",this.arg=u,this.tryEntries.forEach(b),!e)for(var t in this)"t"===t.charAt(0)&&l.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=u)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(r){if(this.done)throw r;var n=this;function e(e,t){return a.type="throw",a.arg=r,n.next=e,t&&(n.method="next",n.arg=u),!!t}for(var t=this.tryEntries.length-1;0<=t;--t){var i=this.tryEntries[t],a=i.completion;if("root"===i.tryLoc)return e("end");if(i.tryLoc<=this.prev){var s=l.call(i,"catchLoc"),o=l.call(i,"finallyLoc");if(s&&o){if(this.prev<i.catchLoc)return e(i.catchLoc,!0);if(this.prev<i.finallyLoc)return e(i.finallyLoc)}else if(s){if(this.prev<i.catchLoc)return e(i.catchLoc,!0)}else{if(!o)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return e(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;0<=r;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&l.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var i=n;break}}var a=(i=i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc?null:i)?i.completion:{};return a.type=e,a.arg=t,i?(this.method="next",this.next=i.finallyLoc,T):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),T},finish:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),b(r),T}},catch:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var r,n,i=this.tryEntries[t];if(i.tryLoc===e)return"throw"===(r=i.completion).type&&(n=r.arg,b(i)),n}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:A(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=u),T}},s})("object"==typeof module?module.exports:{});try{regeneratorRuntime=runtime}catch(e){"object"==typeof globalThis&&(globalThis.regeneratorRuntime=runtime)}var DB_NAME="thinkingdata",TABLE_NAME="data",PlatformProxy=(()=>{function t(e){_classCallCheck(this,t),this.api=e}return _createClass(t,[{key:"openDb",value:function(){return new Promise(function(t,e){var r=indexedDB.open(DB_NAME,1);r.onerror=function(e){t(void 0)},r.onsuccess=function(e){t(e.target.result)},r.onupgradeneeded=function(e){e.target.result.createObjectStore(TABLE_NAME,{keyPath:"id",autoIncrement:!0}).createIndex("key","key",{unique:!0})}})}},{key:"setStorage",value:(n=_asyncToGenerator(_regenerator().m(function e(i,a){var s=this;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(this.db){e.n=2;break}return e.n=1,this.openDb();case 1:this.db=e.v;case 2:return e.a(2,new Promise(function(t,e){var r=s.db.transaction(TABLE_NAME,"readwrite").objectStore(TABLE_NAME),n=r.index("key").get(i);n.onsuccess=function(e){var e=e.target.result;e?(e.value=a,(e=r.put(e)).onsuccess=function(){t(!0)},e.onerror=function(e){t(!1)}):((e=r.add({key:i,value:a})).onsuccess=function(){t(!0)},e.onerror=function(e){t(!1)})},n.onerror=function(e){t(!1)}}))}},e,this)})),function(e,t){return n.apply(this,arguments)})},{key:"getStorage",value:(r=_asyncToGenerator(_regenerator().m(function e(n){var i=this;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(this.db){e.n=2;break}return e.n=1,this.openDb();case 1:this.db=e.v;case 2:return e.a(2,new Promise(function(t,e){var r=i.db.transaction(TABLE_NAME,"readonly").objectStore(TABLE_NAME).index("key").get(n);r.onsuccess=function(e){e=e.target.result;t(e?e.value:void 0)},r.onerror=function(e){t(void 0)}}))}},e,this)})),function(e){return r.apply(this,arguments)})},{key:"getStorageSync",value:function(e){return{}}},{key:"getAnalyticGlobalData",value:function(){return this.api.tdanalytics2024}},{key:"getConfigGlobalData",value:function(){return this.api.tdremoteconfig2024}},{key:"setGlobalData",value:function(e){this.api.tdstrategy2024=e}}],[{key:"createInstance",value:function(){return new t(window)}}]);var r,n})(),PlatformAPI=(()=>_createClass(function e(){_classCallCheck(this,e)},null,[{key:"_getCurrentPlatform",value:function(){return this.currentPlatform||(this.currentPlatform=PlatformProxy.createInstance())}},{key:"setStorage",value:function(e,t){return this._getCurrentPlatform().setStorage(e,t)}},{key:"getStorage",value:function(e){return this._getCurrentPlatform().getStorage(e)}},{key:"getStorageSync",value:function(e){return this._getCurrentPlatform().getStorageSync(e)}},{key:"getAnalyticGlobalData",value:function(){return this._getCurrentPlatform().getAnalyticGlobalData()}},{key:"getConfigGlobalData",value:function(){return this._getCurrentPlatform().getConfigGlobalData()}},{key:"setGlobalData",value:function(e){this._getCurrentPlatform().setGlobalData(e)}}]))(),_={},ArrayProto=Array.prototype,ObjProto=Object.prototype,slice=ArrayProto.slice,nativeToString=ObjProto.toString,nativeHasOwnProperty=Object.prototype.hasOwnProperty,nativeForEach=ArrayProto.forEach,nativeIsArray=Array.isArray,breaker={},logger=(_.checkSettings=function(e){if(e&&!_.isStrEmpty(e.appId)&&!_.isStrEmpty(e.serverUrl))return e.appId=_.checkAppId(e.appId),e.templateCode=Config.STRATEGY_TEMPLATE_CODE,logger.enabled=e.enableLog,e},_.checkAppId=function(e){return e=e.replace(/\s*/g,"")},_.isStrEmpty=function(e){return!e||0===e.length},_.isDate=function(e){return"[object Date]"===nativeToString.call(e)},_.isString=function(e){return"[object String]"===nativeToString.call(e)},_.isBoolean=function(e){return"[object Boolean]"===nativeToString.call(e)},_.isNumber=function(e){return"[object Number]"===nativeToString.call(e)&&/[\d\.]+/.test(String(e))},_.isObject=function(e){return"[object Object]"===nativeToString.call(e)&&null!=e},_.isArray=nativeIsArray||function(e){return"[object Array]"===nativeToString.call(e)},_.stringToBoolean=function(e){switch(e.toLowerCase().trim()){case"true":return!0;case"false":return!1;default:return}},_.toBoolean=function(e){return _.isBoolean(e)?e:_.isString(e)?_.stringToBoolean(e):void 0},_.each=function(e,t,r){if(null==e)return!1;if(nativeForEach&&e.forEach===nativeForEach)e.forEach(t,r);else if(e.length===+e.length){for(var n=0,i=e.length;n<i;n++)if(n in e&&t.call(r,e[n],n,e)===breaker)return!1}else for(var a in e)if(nativeHasOwnProperty.call(e,a)&&t.call(r,e[a],a,e)===breaker)return!1},_.extend=function(r){return _.each(slice.call(arguments,1),function(e){for(var t in e)void 0!==e[t]&&(r[t]=e[t])}),r},_.convertToTimestamp=function(e,t){var r,n,i,a,s,o;return!e||(n=(e=_slicedToArray(e.split(" "),2))[0],e=e[1],!n)||!e||(o=(n=_slicedToArray(n.split("-").map(Number),3))[0],r=n[1],n=n[2],s=(e=_slicedToArray(e.split("."),2))[0],e=e[1],i=(s=_slicedToArray(s.split(":").map(Number),3))[0],a=s[1],s=s[2],e=e?Number(e):0,isNaN(o))||isNaN(r)||isNaN(n)||isNaN(i)||isNaN(a)||isNaN(s)||isNaN(e)?Number.NaN:(o=new Date(Date.UTC(o,r-1,n,i,a,s,e)),new Date(o.getTime()-60*t*6e4).getTime())},_.convertToTimestamp1=function(e,t){var r,n,i,a,s;return!e||(n=(e=_slicedToArray(e.split(" "),2))[0],e=e[1],!n)||!e||(s=(n=_slicedToArray(n.split("-").map(Number),3))[0],r=n[1],n=n[2],i=(e=_slicedToArray(e.split(":").map(Number),3))[0],a=e[1],e=e[2],isNaN(s))||isNaN(r)||isNaN(n)||isNaN(i)||isNaN(a)||isNaN(e)?Number.NaN:(s=new Date(Date.UTC(s,r-1,n,i,a,e)),new Date(s.getTime()-60*t*6e4).getTime())},_.generateUniqueId=function(){return Date.now().toString(36)+Math.random().toString(36).substring(2)},_.buildEventNameRule=function(e){return{calcuSymbol:"C00",columnName:Config.EVENT_NAME_KEY,columnType:Config.STR_TYPE,ftv:[e]}},_.jsonToFacts=function(e){var r={};return _.each(e,function(e,t){"properties"===t?_.each(e,function(e,t){r[t.toLowerCase()]=e}):r[t]=e}),r},_.getTimeCycleUnit=function(e){if(e)return e.toLowerCase()},_.formatDate=function(e){function t(e){return e<10?"0"+e:e}return e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+" "+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())+"."+((e=e.getMilliseconds())<100&&9<e?"0"+e:e<10?"00"+e:e)},_.getFormatDataByLog=function(e){return logger.enabled?_.formatDate(new Date(e)):e},_.parseStartTime=function(e){var t;return!e||(t=(e=_slicedToArray(e.split(":").map(Number),2))[0],e=e[1],isNaN(t))||isNaN(e)?{hour:0,minute:0}:{hour:t,minute:e}},_.UUID=function(){var e=Date.now();return String(Math.random()).replace(".","").slice(1,11)+"-"+e},_.isFunction=function(e){try{return"function"==typeof e}catch(e){return!1}},"object"===_typeof(logger)?logger:{}),TABLE_NAME_STRATEGY_INFO=(logger.info=function(){if("object"===("undefined"==typeof console?"undefined":_typeof(console))&&console.log&&logger.enabled)try{return arguments[0]="[ThinkingData] Info: "+arguments[0],logger.listener&&logger.listener(arguments[0]),console.log.apply(console,arguments)}catch(e){logger.listener&&logger.listener(arguments[0]),console.log("[ThinkingData] Info: "+arguments[0])}},logger.info1=function(e,t){logger.enabled&&(logger.listener&&logger.listener(e+JSON.stringify(t)),logger.info(e+JSON.stringify(t,null,4)))},logger.warn=function(){if("object"===("undefined"==typeof console?"undefined":_typeof(console))&&console.log&&logger.enabled)try{return arguments[0]="[ThinkingData] Warning: "+arguments[0],console.warn.apply(console,arguments)}catch(e){console.warn("[ThinkingData] Warning: "+arguments[0])}},"t_strategy_info"),KEY_CLIENT_VALUE="client_value",TDClientValueManager={addClientParams:(()=>{var t=_asyncToGenerator(_regenerator().m(function e(t){return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(t){e.n=1;break}return e.a(2);case 1:return e.n=2,this.loadLocalClientParams();case 2:return _.extend(this.mClientValueParams,t),e.n=3,PlatformAPI.setStorage(TABLE_NAME_STRATEGY_INFO,_defineProperty({},KEY_CLIENT_VALUE,this.mClientValueParams));case 3:return e.a(2)}},e,this)}));return function(e){return t.apply(this,arguments)}})(),removeClientParam:(()=>{var t=_asyncToGenerator(_regenerator().m(function e(t){return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(void 0===t)return e.a(2);e.n=1;break;case 1:return e.n=2,this.loadLocalClientParams();case 2:return delete this.mClientValueParams[t],e.n=3,PlatformAPI.setStorage(TABLE_NAME_STRATEGY_INFO,_defineProperty({},KEY_CLIENT_VALUE,this.mClientValueParams));case 3:return e.a(2)}},e,this)}));return function(e){return t.apply(this,arguments)}})(),get:function(e){var t;if(void 0!==e)return this.mClientValueParams||(t=PlatformAPI.getStorageSync(TABLE_NAME_STRATEGY_INFO))&&(this.mClientValueParams=t[KEY_CLIENT_VALUE]),this.mClientValueParams||(this.mClientValueParams={}),this.mClientValueParams[e]},loadLocalClientParams:(()=>{var e=_asyncToGenerator(_regenerator().m(function e(){var t;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(this.mClientValueParams){e.n=2;break}return e.n=1,PlatformAPI.getStorage(TABLE_NAME_STRATEGY_INFO);case 1:(t=e.v)&&(this.mClientValueParams=t[KEY_CLIENT_VALUE]);case 2:this.mClientValueParams||(this.mClientValueParams={});case 3:return e.a(2)}},e,this)}));return function(){return e.apply(this,arguments)}})()},TDAnalytics=PlatformAPI.getAnalyticGlobalData(),TDRemoteConfig=PlatformAPI.getConfigGlobalData(),AnalyticUtil={},FAIL=5,SUCCESS=6,FREQUENCY_CONTROL=2,FATIGUE_CONTROL=3,PUSH_ID_IS_NULL=13,WITHOUT_SPLIT_FLOW_ID=12,RACE_SKIP_PUSH=10,SAMPLE=8,EXP_SKIP_PUSH=9,TARGET_USER_IS_FALSE=101,CLIENT_QP_IS_FALSE=102,TRIGGER_EVENT_NAME="te_ops_client_trigger_record",CLIENT_DEBUG_EVENT="te_ops_client_debug_test",RISK_RECORD_EVENT="te_ops_client_risk_record",CHANNEL_TEST_EVENT="ta_channel_test_event",eventBlackList=[TRIGGER_EVENT_NAME,CLIENT_DEBUG_EVENT,RISK_RECORD_EVENT],eventWhiteList=[CHANNEL_TEST_EVENT],TABLE_NAME_TASK=(AnalyticUtil.getCurrentTimeStamp=function(){return Date.now()},AnalyticUtil.getCurrentDate=function(){return new Date(Date.now())},AnalyticUtil.getAccountId=function(e){return TDAnalytics?TDAnalytics.getAccountId(e):""},AnalyticUtil.getDistinctId=function(e){return TDAnalytics?TDAnalytics.getDistinctId(e):""},AnalyticUtil.getClientUserId=(()=>{var t=_asyncToGenerator(_regenerator().m(function e(t){var r,n,i,a;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,PlatformAPI.getStorage(t+"_users");case 1:if(r=e.v,!_.isArray(r)){e.n=6;break}n=this.getAccountId(t),i=this.getDistinctId(t),a=0;case 2:if(a<r.length)if(n){if(n===r[a].accountId)return e.a(2,r[a].clientUserId);e.n=3}else e.n=4;else e.n=6;break;case 3:e.n=5;break;case 4:if(i===r[a].distinctId)return e.a(2,r[a].clientUserId);e.n=5;break;case 5:a++,e.n=2;break;case 6:return e.a(2,"")}},e,this)}));return function(e){return t.apply(this,arguments)}})(),AnalyticUtil.trackTriggerEvent=function(e){TDAnalytics&&(e.isTestTask||e.status!==TARGET_USER_IS_FALSE&&e.status!==CLIENT_QP_IS_FALSE)&&(TDAnalytics.trackInternal({eventName:TRIGGER_EVENT_NAME,properties:{"#client_user_id":e.clientUserId,"#ops_task_id":e.taskId,"#ops_push_id":e.pushId,"#ops_exp_group_id":e.expGroupId,"#ops_trigger_time":e.triggerTime,"#ops_actual_push_time":e.actualPushTime,"#ops_push_status":e.status},debugMode:e.isTestTask?"debugOnly":"none"},e.appId),TDAnalytics.flush())},AnalyticUtil.isBlackEvent=function(e){return eventBlackList.includes(e)},AnalyticUtil.isWhiteEvent=function(e){return eventWhiteList.includes(e)},AnalyticUtil.trackClientDebugEvent=function(e,t){if(TDAnalytics){_.isArray(AnalyticUtil.hasTrackTestTaskIds)||(AnalyticUtil.hasTrackTestTaskIds=[]);for(var r=[],n=0;n<t.length;n++)AnalyticUtil.hasTrackTestTaskIds.includes(t[n])||(AnalyticUtil.hasTrackTestTaskIds.push(t[n]),r.push(t[n]));r.length<=0||TDAnalytics.trackInternal({eventName:CLIENT_DEBUG_EVENT,properties:{"#rcc_pull_result":{business_type:1,is_pull_success:!0,ops_task_id_list:r}},debugMode:"debugOnly"},e)}},AnalyticUtil.buildAnalyticPresetFacts=function(e){var t;return TDAnalytics?((t=TDAnalytics.getPresetProperties(e).toEventPresetProperties())["#account_id"]=this.getAccountId(e),t["#distinct_id"]=this.getDistinctId(e),t):{}},AnalyticUtil.getStrategyInfo=function(e){return TDRemoteConfig?TDRemoteConfig.getData(e,Config.STRATEGY_TEMPLATE_CODE).get("td_strategy_info").arrayValue():[]},AnalyticUtil.getConfigValue=function(e){return TDClientValueManager.get(e)},"t_task_"),TABLE_NAME_EVENT="t_event",TABLE_NAME_LIMIT="t_task_trigger",TABLE_NAME_TOUCH_LIMIT="t_channel_trigger",TABLE_NAME_STATUS="t_task_status",getTasks=(()=>{var r=_asyncToGenerator(_regenerator().m(function e(t,r){var n,i,a,s;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,PlatformAPI.getStorage(TABLE_NAME_TASK+t);case 1:for(n=(n=e.v)||[],i={},a=0;a<n.length;a++)(s=n[a]).clientUserId===r&&s.task&&(i[s.taskId]=s);return e.a(2,i)}},e)}));return function(e,t){return r.apply(this,arguments)}})(),updateTask=(()=>{var n=_asyncToGenerator(_regenerator().m(function e(t,r,n){var i;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,PlatformAPI.getStorage(TABLE_NAME_TASK+t);case 1:return i=(i=(i=e.v)||[]).filter(function(e){return e.clientUserId!==r}),e.n=2,PlatformAPI.setStorage(TABLE_NAME_TASK+t,i.concat(n));case 2:return e.a(2)}},e)}));return function(e,t,r){return n.apply(this,arguments)}})(),deleteTaskByLimit=(()=>{var r=_asyncToGenerator(_regenerator().m(function e(t,r){var n,i;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,PlatformAPI.getStorage(TABLE_NAME_TASK+t);case 1:if(n=e.v,_.isArray(n)&&n.length>r)return i=n.length-r,n.splice(0,i),e.n=2,PlatformAPI.setStorage(TABLE_NAME_TASK+t,n);e.n=2;break;case 2:return e.a(2)}},e)}));return function(e,t){return r.apply(this,arguments)}})(),queryTriggerResult=(()=>{var e=_asyncToGenerator(_regenerator().m(function e(){var t;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,PlatformAPI.getStorage(TABLE_NAME_EVENT);case 1:if(t=e.v,_.isArray(t))return e.a(2,t);e.n=2;break;case 2:return e.a(2,[])}},e)}));return function(){return e.apply(this,arguments)}})(),insertTriggerResult=(()=>{var t=_asyncToGenerator(_regenerator().m(function e(t){return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,PlatformAPI.setStorage(TABLE_NAME_EVENT,t);case 1:return e.a(2)}},e)}));return function(e){return t.apply(this,arguments)}})(),addTriggerResult=(()=>{var t=_asyncToGenerator(_regenerator().m(function e(t){var r;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,PlatformAPI.getStorage(TABLE_NAME_EVENT);case 1:return(r=(r=e.v)||[]).push(t),e.n=2,PlatformAPI.setStorage(TABLE_NAME_EVENT,r);case 2:return e.a(2)}},e)}));return function(e){return t.apply(this,arguments)}})(),deleteTriggerResult=(()=>{var t=_asyncToGenerator(_regenerator().m(function e(t){var r;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,PlatformAPI.getStorage(TABLE_NAME_EVENT);case 1:return r=e.v,_.isArray(r)&&(r=r.filter(function(e){return!(t.appId===e.appId&&t.clientUserId===e.clientUserId&&t.taskId===e.taskId)})),e.n=2,PlatformAPI.setStorage(TABLE_NAME_EVENT,r);case 2:return e.a(2)}},e)}));return function(e){return t.apply(this,arguments)}})(),deleteTriggerResultLimit=(()=>{var t=_asyncToGenerator(_regenerator().m(function e(t){var r,n;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,PlatformAPI.getStorage(TABLE_NAME_EVENT);case 1:if(r=e.v,_.isArray(r)&&r.length>t)return n=r.length-t,r.splice(0,n),e.n=2,PlatformAPI.setStorage(TABLE_NAME_EVENT,r);e.n=2;break;case 2:return e.a(2)}},e)}));return function(e){return t.apply(this,arguments)}})(),getFrequencyLimitCount=(()=>{var t=_asyncToGenerator(_regenerator().m(function e(t){var r;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,PlatformAPI.getStorage(TABLE_NAME_LIMIT);case 1:if(r=e.v,_.isArray(r)){e.n=2;break}return e.a(2,0);case 2:return r=r.filter(function(e){return t.appId===e.appId&&t.clientUserId===e.clientUserId&&t.taskId===e.taskId&&e.triggerTime>=t.start&&e.triggerTime<=t.end}),e.a(2,r.length)}},e)}));return function(e){return t.apply(this,arguments)}})(),addFrequencyLimit=(()=>{var t=_asyncToGenerator(_regenerator().m(function e(t){var r;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,PlatformAPI.getStorage(TABLE_NAME_LIMIT);case 1:return r=e.v,(r=_.isArray(r)?r:[]).push(t),e.n=2,PlatformAPI.setStorage(TABLE_NAME_LIMIT,r);case 2:return e.a(2)}},e)}));return function(e){return t.apply(this,arguments)}})(),deleteFrequencyLimit=(()=>{var t=_asyncToGenerator(_regenerator().m(function e(t){var r;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,PlatformAPI.getStorage(TABLE_NAME_LIMIT);case 1:if(r=e.v,_.isArray(r)){e.n=2;break}return e.a(2);case 2:return r=r.filter(function(e){return!(t.appId===e.appId&&t.clientUserId===e.clientUserId&&t.taskId===e.taskId)}),e.n=3,PlatformAPI.setStorage(TABLE_NAME_LIMIT,r);case 3:return e.a(2)}},e)}));return function(e){return t.apply(this,arguments)}})(),deleteFrequencyByLimit=(()=>{var t=_asyncToGenerator(_regenerator().m(function e(t){var r,n;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,PlatformAPI.getStorage(TABLE_NAME_LIMIT);case 1:if(r=e.v,_.isArray(r)&&r.length>t)return n=r.length-t,r.splice(0,n),e.n=2,PlatformAPI.setStorage(TABLE_NAME_LIMIT,r);e.n=2;break;case 2:return e.a(2)}},e)}));return function(e){return t.apply(this,arguments)}})(),getTouchLimitCount=(()=>{var t=_asyncToGenerator(_regenerator().m(function e(t){var r;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,PlatformAPI.getStorage(TABLE_NAME_TOUCH_LIMIT);case 1:if(r=e.v,_.isArray(r)){e.n=2;break}return e.a(2,0);case 2:return r=r.filter(function(e){return t.appId===e.appId&&t.pushId===e.pushId&&t.channelId===e.channelId&&e.triggerTime>=t.start&&e.triggerTime<=t.end}),e.a(2,r.length)}},e)}));return function(e){return t.apply(this,arguments)}})(),addTouchLimit=(()=>{var t=_asyncToGenerator(_regenerator().m(function e(t){var r;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,PlatformAPI.getStorage(TABLE_NAME_TOUCH_LIMIT);case 1:return r=e.v,(r=_.isArray(r)?r:[]).push(t),e.n=2,PlatformAPI.setStorage(TABLE_NAME_TOUCH_LIMIT,r);case 2:return e.a(2)}},e)}));return function(e){return t.apply(this,arguments)}})(),deleteTouchLimitByTime=(()=>{var t=_asyncToGenerator(_regenerator().m(function e(t){var r,n;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,PlatformAPI.getStorage(TABLE_NAME_TOUCH_LIMIT);case 1:if(r=e.v,_.isArray(r))return n=AnalyticUtil.getCurrentTimeStamp()-24*t*60*60*1e3,r=r.filter(function(e){return e.triggerTime>n}),e.n=2,PlatformAPI.setStorage(TABLE_NAME_TOUCH_LIMIT,r);e.n=2;break;case 2:return e.a(2)}},e)}));return function(e){return t.apply(this,arguments)}})(),updateTaskStatus=(()=>{var t=_asyncToGenerator(_regenerator().m(function e(t){var r,n,i,a;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,PlatformAPI.getStorage(TABLE_NAME_STATUS);case 1:r=e.v,_.isArray(r)||(r=[]),n=!1,i=0;case 2:if(i<r.length){if((a=r[i]).appId===t.appId&&a.clientUserId===t.clientUserId)return a.status=t.status,n=!0,e.a(3,4);e.n=3}else e.n=4;break;case 3:i++,e.n=2;break;case 4:return n||r.push(t),e.n=5,PlatformAPI.setStorage(TABLE_NAME_STATUS,r);case 5:return e.a(2)}},e)}));return function(e){return t.apply(this,arguments)}})(),getTaskStatus=(()=>{var t=_asyncToGenerator(_regenerator().m(function e(t){var r,n,i;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,PlatformAPI.getStorage(TABLE_NAME_STATUS);case 1:if(r=e.v,_.isArray(r)){e.n=2;break}return e.a(2,!1);case 2:n=0;case 3:if(n<r.length){if((i=r[n]).appId===t.appId&&i.clientUserId===t.clientUserId)return e.a(2,i.status);e.n=4}else e.n=5;break;case 4:n++,e.n=3;break;case 5:return e.a(2,!1)}},e)}));return function(e){return t.apply(this,arguments)}})(),CompositeRule=(()=>_createClass(function e(){_classCallCheck(this,e),this.rules=[]},[{key:"addRule",value:function(e){e&&this.rules.push(e)}},{key:"evaluate",value:function(e){return!1}}]))(),ActivationRuleGroup=(()=>{function e(){return _classCallCheck(this,e),_callSuper(this,e)}return _inherits(e,CompositeRule),_createClass(e,[{key:"evaluate",value:(t=_asyncToGenerator(_regenerator().m(function e(t){var r;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:r=0;case 1:if(r<this.rules.length)return e.n=2,this.rules[r].evaluate(t);e.n=4;break;case 2:if(e.v)return e.a(2,!0);e.n=3;break;case 3:r++,e.n=1;break;case 4:return e.a(2,!1)}},e,this)})),function(e){return t.apply(this,arguments)})}]);var t})(),UnitRuleGroup=(()=>{function e(){return _classCallCheck(this,e),_callSuper(this,e)}return _inherits(e,CompositeRule),_createClass(e,[{key:"evaluate",value:(t=_asyncToGenerator(_regenerator().m(function e(t){var r;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(this.rules.length<=0)return e.a(2,!1);e.n=1;break;case 1:r=0;case 2:if(r<this.rules.length)return e.n=3,this.rules[r].evaluate(t);e.n=5;break;case 3:if(e.v){e.n=4;break}return e.a(2,!1);case 4:r++,e.n=2;break;case 5:return e.a(2,!0)}},e,this)})),function(e){return t.apply(this,arguments)})}]);var t})(),PropertiesRule=(()=>_createClass(function e(t){_classCallCheck(this,e),this.ruleJson=t,this.columnName=t.columnName,this.columnType=t.columnType,this.symbol=t.calcuSymbol,this.ftv=t.ftv||[]},[{key:"evaluate",value:function(e){return this.isCondition(e)}},{key:"isCondition",value:function(e){var t,r;return!!(this.columnName&&this.columnType&&this.symbol&&this.ftv)&&(void 0===(t=e[this.columnName])?(r=this.isPresetProperties(),logger.info("CalcuSymbol: "+this.symbol+" Value is null and ColumnName: "+this.columnName+" is Preset: "+r),r):(r=this.executeWhen(t,e),logger.info("CalcuSymbol: "+this.symbol+" ColumnName: "+this.columnName+" Value: "+t+" Ftv:"+this.ftv+" Result: "+r),r))}},{key:"executeWhen",value:function(e,t){return!1}},{key:"isPresetProperties",value:function(){return this.columnName.includes("#")}}]))(),EQRule=(()=>{function t(e){return _classCallCheck(this,t),_callSuper(this,t,[e])}return _inherits(t,PropertiesRule),_createClass(t,[{key:"executeWhen",value:function(e,t){if(this.columnType===Config.STR_TYPE||this.columnType===Config.DATE_TYPE){for(var r=e.toString(),n=0;n<this.ftv.length;n++)if(r===String(this.ftv[n]))return!0}else if(this.columnType===Config.INTEGER_TYPE||this.columnType===Config.BIGINT_TYPE||this.columnType===Config.DOUBLE_TYPE||this.columnType===Config.DECIMAL_TYPE){for(var i=Number(e),a=0;a<this.ftv.length;a++)if(i===Number(this.ftv[a]))return!0}else if(this.columnType===Config.BOOLEAN_TYPE){for(var s=_.toBoolean(e),o=0;o<this.ftv.length;o++)if(s===_.toBoolean(this.ftv[o]))return!0}else if(this.columnType===Config.ARRAY_VARCHAR_TYPE)for(var u=e.toString(),l=0;l<this.ftv.length;l++)if(u===this.ftv[l].toString())return!0;return!1}}])})(),UN_EQRule=(()=>{function t(e){return _classCallCheck(this,t),_callSuper(this,t,[e])}return _inherits(t,PropertiesRule),_createClass(t,[{key:"executeWhen",value:function(e,t){if(this.columnType===Config.STR_TYPE||this.columnType===Config.DATE_TYPE){for(var r=e.toString(),n=!1,i=0;i<this.ftv.length;i++)if(r===String(this.ftv[i])){n=!0;break}return!n}if(this.columnType===Config.INTEGER_TYPE||this.columnType===Config.BIGINT_TYPE||this.columnType===Config.DOUBLE_TYPE||this.columnType===Config.DECIMAL_TYPE){for(var a=Number(e),s=!1,o=0;o<this.ftv.length;o++)if(a===Number(this.ftv[o])){s=!0;break}return!s}if(this.columnType!==Config.BOOLEAN_TYPE)return!1;for(var u=_.toBoolean(e),l=!1,c=0;c<this.ftv.length;c++)if(u===_.toBoolean(this.ftv[c])){l=!0;break}return!l}}])})(),LTRule=(()=>{function t(e){return _classCallCheck(this,t),_callSuper(this,t,[e])}return _inherits(t,PropertiesRule),_createClass(t,[{key:"executeWhen",value:function(e,t){if(0<this.ftv.length&&(this.columnType===Config.INTEGER_TYPE||this.columnType===Config.BIGINT_TYPE||this.columnType===Config.DOUBLE_TYPE||this.columnType===Config.DECIMAL_TYPE))return Number(e)<Number(this.ftv[0]);return!1}}])})(),LTERule=(()=>{function r(e,t){return _classCallCheck(this,r),(e=_callSuper(this,r,[e])).zoneOffset=t,e}return _inherits(r,PropertiesRule),_createClass(r,[{key:"executeWhen",value:function(e,t){if(0<this.ftv.length){if(this.columnType===Config.INTEGER_TYPE||this.columnType===Config.BIGINT_TYPE||this.columnType===Config.DOUBLE_TYPE||this.columnType===Config.DECIMAL_TYPE)return Number(e)<=Number(this.ftv[0]);if(this.columnType===Config.DATE_TYPE)return e=e.toString(),t=t[Config.EVENT_ZONE_OFFSET],e=_.convertToTimestamp(e,t),t=_.convertToTimestamp(this.ftv[0],this.zoneOffset),!isNaN(e)&&!isNaN(t)&&e<=t}return!1}}])})(),GTRule=(()=>{function t(e){return _classCallCheck(this,t),_callSuper(this,t,[e])}return _inherits(t,PropertiesRule),_createClass(t,[{key:"executeWhen",value:function(e,t){if(0<this.ftv.length&&(this.columnType===Config.INTEGER_TYPE||this.columnType===Config.BIGINT_TYPE||this.columnType===Config.DOUBLE_TYPE||this.columnType===Config.DECIMAL_TYPE))return e=Number(e),Number(this.ftv[0])<e;return!1}}])})(),GTERule=(()=>{function r(e,t){return _classCallCheck(this,r),(e=_callSuper(this,r,[e])).zoneOffset=t,e}return _inherits(r,PropertiesRule),_createClass(r,[{key:"executeWhen",value:function(e,t){if(0<this.ftv.length){var r;if(this.columnType===Config.INTEGER_TYPE||this.columnType===Config.BIGINT_TYPE||this.columnType===Config.DOUBLE_TYPE||this.columnType===Config.DECIMAL_TYPE)return r=Number(e),Number(this.ftv[0])<=r;if(this.columnType===Config.DATE_TYPE)return r=e.toString(),e=t[Config.EVENT_ZONE_OFFSET],t=_.convertToTimestamp(r,e),r=_.convertToTimestamp(this.ftv[0],this.zoneOffset),!isNaN(t)&&!isNaN(r)&&r<=t}return!1}}])})(),NOT_NULLRule=(()=>{function t(e){return _classCallCheck(this,t),_callSuper(this,t,[e])}return _inherits(t,PropertiesRule),_createClass(t,[{key:"executeWhen",value:function(e,t){return!0}}])})(),NULLRule=(()=>{function t(e){return _classCallCheck(this,t),_callSuper(this,t,[e])}return _inherits(t,PropertiesRule),_createClass(t,[{key:"evaluate",value:function(e){return!!(this.columnName&&this.columnType&&this.symbol&&this.ftv)&&(e=e[this.columnName],logger.info("CalcuSymbol: "+this.symbol+" ColumnName: "+this.columnName+" Value: "+e+" Ftv:"+this.ftv+" Result: "+(e=void 0===e)),e)}}])})(),RANGERule=(()=>{function r(e,t){return _classCallCheck(this,r),(e=_callSuper(this,r,[e])).zoneOffset=t,e}return _inherits(r,PropertiesRule),_createClass(r,[{key:"executeWhen",value:function(e,t){if(2<=this.ftv.length){var r,n,i;if(this.columnType===Config.INTEGER_TYPE||this.columnType===Config.BIGINT_TYPE||this.columnType===Config.DOUBLE_TYPE||this.columnType===Config.DECIMAL_TYPE)return n=Number(e),r=Number(this.ftv[0]),i=Number(this.ftv[1]),r<=n&&n<=i;if(this.columnType===Config.DATE_TYPE)return r=e.toString(),n=t[Config.EVENT_ZONE_OFFSET],i=_.convertToTimestamp(r,n),e=_.convertToTimestamp(this.ftv[0],this.zoneOffset),t=_.convertToTimestamp(this.ftv[1],this.zoneOffset),!(isNaN(i)||isNaN(e)||isNaN(t))&&e<=i&&i<=t}return!1}}])})(),INCLUDERule=(()=>{function t(e){return _classCallCheck(this,t),_callSuper(this,t,[e])}return _inherits(t,PropertiesRule),_createClass(t,[{key:"executeWhen",value:function(e,t){if(this.columnType===Config.STR_TYPE)for(var r=e.toString(),n=0;n<this.ftv.length;n++){var i=String(this.ftv[n]);if(r.includes(i))return!0}return!1}}])})(),UN_INCLUDERule=(()=>{function t(e){return _classCallCheck(this,t),_callSuper(this,t,[e])}return _inherits(t,PropertiesRule),_createClass(t,[{key:"executeWhen",value:function(e,t){if(this.columnType!==Config.STR_TYPE)return!1;for(var r=e.toString(),n=!1,i=0;i<this.ftv.length;i++){var a=String(this.ftv[i]);if(r.includes(a)){n=!0;break}}return!n}}])})(),BOOLEAN_TRUERule=(()=>{function t(e){return _classCallCheck(this,t),_callSuper(this,t,[e])}return _inherits(t,PropertiesRule),_createClass(t,[{key:"executeWhen",value:function(e,t){return this.columnType===Config.BOOLEAN_TYPE&&!0===_.toBoolean(e)}}])})(),BOOLEAN_FALSERule=(()=>{function t(e){return _classCallCheck(this,t),_callSuper(this,t,[e])}return _inherits(t,PropertiesRule),_createClass(t,[{key:"executeWhen",value:function(e,t){return this.columnType===Config.BOOLEAN_TYPE&&!1===_.toBoolean(e)}}])})(),REGULAR_MATCHRule=(()=>{function t(e){return _classCallCheck(this,t),_callSuper(this,t,[e])}return _inherits(t,PropertiesRule),_createClass(t,[{key:"executeWhen",value:function(e,t){var r;return!(this.ftv.length<=0)&&this.columnType===Config.STR_TYPE&&(e=e.toString(),r=String(this.ftv[0]),new RegExp(r,"i").test(e))}}])})(),UN_REGULAR_MATCHRule=(()=>{function t(e){return _classCallCheck(this,t),_callSuper(this,t,[e])}return _inherits(t,PropertiesRule),_createClass(t,[{key:"executeWhen",value:function(e,t){var r;return!(this.ftv.length<=0||this.columnType!==Config.STR_TYPE||(e=e.toString(),r=String(this.ftv[0]),new RegExp(r,"i").test(e)))}}])})(),RELATIVE_CURRENT_TIMERule=(()=>{function t(e){return _classCallCheck(this,t),_callSuper(this,t,[e])}return _inherits(t,PropertiesRule),_createClass(t,[{key:"executeWhen",value:function(e,t){if(this.columnType===Config.DATE_TYPE){e=e.toString(),t=t[Config.EVENT_ZONE_OFFSET],e=_.convertToTimestamp(e,t);if(isNaN(e))return!1;t=this.getTargetTimeStamp();if(1===this.ftv.length){var r=Number(this.ftv[0]);if(r!==Number.NaN)return e<=t-24*r*60*60*1e3}else if(2===this.ftv.length){var r=Number(this.ftv[0]),n=Number(this.ftv[1]);if(r!==Number.NaN&&n!==Number.NaN)return t+24*r*60*60*1e3<=e&&e<t+24*(n+1)*60*60*1e3}}return!1}},{key:"getTargetTimeStamp",value:function(){var e=AnalyticUtil.getCurrentDate();return e.setHours(0,0,0,0),e.getTime()}}])})(),RELATIVE_EVENT_TIMERule=(()=>{function t(e){return _classCallCheck(this,t),_callSuper(this,t,[e])}return _inherits(t,PropertiesRule),_createClass(t,[{key:"executeWhen",value:function(e,t){if(this.columnType===Config.DATE_TYPE){var e=e.toString(),r=t[Config.EVENT_ZONE_OFFSET],e=_.convertToTimestamp(e,r);if(isNaN(e))return!1;r=this.ruleJson.timeRelative;if("range"===r){if(2===this.ftv.length){var n=this.getTargetTimeStamp(t),i=Number(this.ftv[0]),a=Number(this.ftv[1]);if(i!==Number.NaN&&a!==Number.NaN)return n+i*(i=this.getMillis())<=e&&e<=n+a*i}}else{n={};if("that_day"===r?n=this.getDayTimeStamp(t):"that_week"===r?n=this.getWeekTimeStamp(t):"that_month"===r&&(n=this.getMonthTimeStamp(t)),void 0!==n.first)return e>=n.first&&e<n.second}}return!1}},{key:"getTargetTimeStamp",value:function(e){return _.convertToTimestamp(e[Config.EVENT_TIME_KEY],e[Config.EVENT_ZONE_OFFSET])}},{key:"getMillis",value:function(){var e=_.getTimeCycleUnit(this.ruleJson.timeUnit);return void 0===e?0:e===TimeCycleUnit.DAY?864e5:e===TimeCycleUnit.HOUR?36e5:e===TimeCycleUnit.MINUTE?6e4:0}},{key:"getDayTimeStamp",value:function(e){e=new Date(this.getTargetTimeStamp(e));return e.setHours(0,0,0,0),{first:e.getTime(),second:e.getTime()+864e5}}},{key:"getWeekTimeStamp",value:function(e){var e=new Date(this.getTargetTimeStamp(e)),t=e.getDay(),e=new Date(e.getFullYear(),e.getMonth(),e.getDate()-t);return e.setHours(0,0,0,0),{first:e.getTime(),second:e.getTime()+6048e5}}},{key:"getMonthTimeStamp",value:function(e){var e=new Date(this.getTargetTimeStamp(e)),t=e.getFullYear(),e=e.getMonth(),r=new Date(t,e,1),t=(r.setHours(0,0,0,0),new Date(t,e+1,1));return t.setHours(0,0,0,0),{first:r.getTime(),second:t.getTime()}}}])})(),_parseCompound=function(e,t,r,n){if(t&&0!==t.length){var i=new(1===e?UnitRuleGroup:ActivationRuleGroup);if(i)for(var a=0;a<t.length;a++){var s=t[a];s&&(s.filterType?i.addRule(_parseCompound(s.relation,s.filts,r)):(n&&n.push(s.columnName),i.addRule(createFilterRule(s,r))))}return i}},createFilterRule=function(e,t){if(e)switch(e.calcuSymbol){case"C00":return new EQRule(e);case"C01":return new UN_EQRule(e);case"C02":return new LTRule(e);case"C020":return new LTERule(e,t);case"C03":return new GTRule(e);case"C030":return new GTERule(e,t);case"C04":return new NOT_NULLRule(e);case"C05":return new NULLRule(e);case"C06":return new RANGERule(e,t);case"C07":return new INCLUDERule(e);case"C08":return new UN_INCLUDERule(e);case"C09":return new BOOLEAN_TRUERule(e);case"C10":return new BOOLEAN_FALSERule(e);case"C11":return new REGULAR_MATCHRule(e);case"C12":return new UN_REGULAR_MATCHRule(e);case"C13":return new RELATIVE_CURRENT_TIMERule(e);case"C14":return new RELATIVE_EVENT_TIMERule(e);default:return}},TargetAudience=(()=>{return _createClass(function e(t,r,n,i){_classCallCheck(this,e),this.flow=t,this.isTargetUser=r,this.pushId=i,this.columns=[],this.compositeRule=_parseCompound(n.relation,n.filts,t.zoneOffset,this.columns)},[{key:"isTargetAudience",value:(t=_asyncToGenerator(_regenerator().m(function e(t){var r,n,i,a,s;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(this.isTargetUser){e.n=1;break}return this.flow.triggerRecord.status=TARGET_USER_IS_FALSE,AnalyticUtil.trackTriggerEvent(this.flow.triggerRecord),e.a(2,!1);case 1:for(n=0;n<this.columns.length;n++)i=this.columns[n],void 0!==(a=AnalyticUtil.getConfigValue(i))&&(t[i]=a);if(this.compositeRule)return logger.info("TargetAudience------start trigger rules------"),e.n=2,this.compositeRule.evaluate(t);e.n=3;break;case 2:r=e.v,logger.info("TargetAudience------end trigger rules------result is "+r),e.n=4;break;case 3:r=!0;case 4:if(r){e.n=5;break}return this.flow.triggerRecord.status=CLIENT_QP_IS_FALSE,AnalyticUtil.trackTriggerEvent(this.flow.triggerRecord),e.a(2,!1);case 5:if(s=this.getPushId(t),this.flow.triggerRecord.pushId=s,logger.info("Push ID :"+s),s){e.n=6;break}return this.flow.triggerRecord.status=PUSH_ID_IS_NULL,AnalyticUtil.trackTriggerEvent(this.flow.triggerRecord),e.a(2,!1);case 6:return e.a(2,!0)}},e,this)})),function(e){return t.apply(this,arguments)})},{key:"getPushId",value:function(e){var t;return this.pushId?this.pushId.includes("client:")?!((t=this.pushId.split(":")).length<2)&&void 0!==(t=void 0===(t=e[e=t[1]])?AnalyticUtil.getConfigValue(e):t)?t.toString():"":this.pushId:""}}]);var t})(),ExpConfig=(()=>_createClass(function e(t,r){_classCallCheck(this,e);var n=t.expConfig;n&&(this.enableExp=n.enableExp,this.enableExp)&&(this.expSampleOut=n.expSampleOut,this.expEntityIdExist=n.expEntityIdExist,this.expType=n.expType,this.expReleasePushStarted=n.expReleasePushStarted,this.expStartTimeStamp=_.convertToTimestamp1(n.expStartDate,r),this.expEndTimeStamp=_.convertToTimestamp1(n.expEndDate,r),isNaN(this.expStartTimeStamp)||isNaN(this.expEndTimeStamp)?this.enableExp=!1:(n=t.groupContentList,_.isArray(n)&&0<n.length&&(r=n[0])&&(this.expGroupId=r.expGroupId,this.isPush=r.isPush)))},[{key:"isGapExp",value:function(){return!this.enableExp||this.expReleasePushStarted}},{key:"isExpGroupIdExist",value:function(e){var t=!this.expGroupId&&!this.expEntityIdExist;return t&&(e.status=WITHOUT_SPLIT_FLOW_ID,AnalyticUtil.trackTriggerEvent(e)),t}},{key:"isExpSampleOut",value:function(){return!this.isGapExp()&&this.expSampleOut}},{key:"isSkipPush",value:function(){return!this.isGapExp()&&!this.isPush}},{key:"isExpRelease",value:function(e){var t;return e.expGroupId=this.expGroupId,!!this.isGapExp()||!this.isExpGroupIdExist(e)&&(t=AnalyticUtil.getCurrentTimeStamp(),1===this.expType?t>=this.expStartTimeStamp&&t<=this.expEndTimeStamp:!(2!==this.expType||(t<this.expStartTimeStamp?(logger.info("Exp type: "+this.expType+" is less than start time"),1):t>this.expEndTimeStamp&&(e.status=RACE_SKIP_PUSH,AnalyticUtil.trackTriggerEvent(e),1))))}}]))(),AbstractTimeCycle=(()=>_createClass(function e(t,r){_classCallCheck(this,e),t&&(void 0!==t.periodStartStamp&&void 0!==t.periodEndStamp?(this.startTime=t.periodStartStamp,this.endTime=t.periodEndStamp):(this.startTime=_.convertToTimestamp(t.periodStart,t.zoneOffset),this.endTime=_.convertToTimestamp(t.periodEnd,t.zoneOffset))),(isNaN(this.startTime)||isNaN(this.endTime))&&(this.startTime=AnalyticUtil.getCurrentTimeStamp(),this.endTime=AnalyticUtil.getCurrentTimeStamp()),this.scrollInfo=r,this.checkScrollInfo()},[{key:"checkScrollInfo",value:function(){}},{key:"isWithInPeriod",value:function(){var e=AnalyticUtil.getCurrentTimeStamp();return e>=this.startTime&&e<=this.endTime}}]))(),StartEndLimit=(()=>{function t(e){return _classCallCheck(this,t),_callSuper(this,t,[e,void 0])}return _inherits(t,AbstractTimeCycle),_createClass(t,[{key:"getCurrentTimeCycle",value:function(){return{start:this.startTime,end:this.endTime}}}])})(),DailyScrollTimeCycle=(()=>{function r(e,t){return _classCallCheck(this,r),_callSuper(this,r,[e,t])}return _inherits(r,AbstractTimeCycle),_createClass(r,[{key:"checkScrollInfo",value:function(){this.scrollInfo?((void 0===this.scrollInfo.timeCycleNumber||this.scrollInfo.timeCycleNumber<1)&&(this.scrollInfo.timeCycleNumber=1),(void 0===this.scrollInfo.startHour||this.scrollInfo.startHour<0||24<this.scrollInfo.startHour)&&(this.scrollInfo.startHour=0),(void 0===this.scrollInfo.startMinute||this.scrollInfo.startMinute<0||60<this.scrollInfo.startMinute)&&(this.scrollInfo.startMinute=0)):this.scrollInfo={timeCycleNumber:1,timeCycleUnit:TimeCycleUnit.DAY,startHour:0,startMinute:0}}},{key:"getCurrentTimeCycle",value:function(){var e=this.getStartOfTimestamp()+24*this.getStartDay()*3600*1e3+3600*this.scrollInfo.startHour*1e3+60*this.scrollInfo.startMinute*1e3,t=this.getNextCycleTimeStamp(e),r=AnalyticUtil.getCurrentTimeStamp();if(r<e)return this.startTime<=e?{start:this.startTime,end:e}:{start:0,end:0};for(var n=r<=t;!n;)e=t,n=r<=(t=this.getNextCycleTimeStamp(e));return{start:e=e<this.startTime?this.startTime:e,end:t=t>this.endTime?this.endTime:t}}},{key:"getStartOfTimestamp",value:function(){var e=new Date(this.startTime);return e.setHours(0,0,0,0),e.getTime()}},{key:"getStartDay",value:function(){return 0}},{key:"getNextCycleTimeStamp",value:function(e){return e+24*this.scrollInfo.timeCycleNumber*3600*1e3}}])})(),WeekScrollTimeCycle=(()=>{function r(e,t){return _classCallCheck(this,r),_callSuper(this,r,[e,t])}return _inherits(r,DailyScrollTimeCycle),_createClass(r,[{key:"checkScrollInfo",value:function(){this.scrollInfo?((void 0===this.scrollInfo.timeCycleNumber||this.scrollInfo.timeCycleNumber<1)&&(this.scrollInfo.timeCycleNumber=1),(void 0===this.scrollInfo.startHour||this.scrollInfo.startHour<0||24<this.scrollInfo.startHour)&&(this.scrollInfo.startHour=0),(void 0===this.scrollInfo.startMinute||this.scrollInfo.startMinute<0||60<this.scrollInfo.startMinute)&&(this.scrollInfo.startMinute=0),(void 0===this.scrollInfo.startNumber||this.scrollInfo.startNumber<1||7<this.scrollInfo.startNumber)&&(this.scrollInfo.startNumber=0)):this.scrollInfo={timeCycleNumber:1,timeCycleUnit:TimeCycleUnit.WEEK,startHour:0,startMinute:0,startNumber:0}}},{key:"getStartOfTimestamp",value:function(){var e=new Date(this.startTime),e=new Date(e.getFullYear(),e.getMonth(),e.getDate()-e.getDay());return e.setHours(0,0,0,0),e.getTime()}},{key:"getStartDay",value:function(){return this.scrollInfo.startNumber}},{key:"getNextCycleTimeStamp",value:function(e){return e+7*this.scrollInfo.timeCycleNumber*24*3600*1e3}}])})(),MonthScrollTimeCycle=(()=>{function r(e,t){return _classCallCheck(this,r),_callSuper(this,r,[e,t])}return _inherits(r,DailyScrollTimeCycle),_createClass(r,[{key:"checkScrollInfo",value:function(){this.scrollInfo?((void 0===this.scrollInfo.timeCycleNumber||this.scrollInfo.timeCycleNumber<1)&&(this.scrollInfo.timeCycleNumber=1),(void 0===this.scrollInfo.startHour||this.scrollInfo.startHour<0||24<this.scrollInfo.startHour)&&(this.scrollInfo.startHour=0),(void 0===this.scrollInfo.startMinute||this.scrollInfo.startMinute<0||60<this.scrollInfo.startMinute)&&(this.scrollInfo.startMinute=0),(void 0===this.scrollInfo.startNumber||this.scrollInfo.startNumber<1||28<this.scrollInfo.startNumber)&&(this.scrollInfo.startNumber=1)):this.scrollInfo={timeCycleNumber:1,timeCycleUnit:TimeCycleUnit.MONTH,startHour:0,startMinute:0,startNumber:1}}},{key:"getStartOfTimestamp",value:function(){var e=new Date(this.startTime),t=e.getFullYear(),e=e.getMonth(),t=new Date(t,e,1);return t.setHours(0,0,0,0),t.getTime()}},{key:"getStartDay",value:function(){return this.scrollInfo.startNumber-1}},{key:"getNextCycleTimeStamp",value:function(e){e=new Date(e);return e.setMonth(e.getMonth()+this.scrollInfo.timeCycleNumber),e.getTime()}}])})(),SlideTimeCycle=(()=>{function r(e,t){return _classCallCheck(this,r),_callSuper(this,r,[e,t])}return _inherits(r,AbstractTimeCycle),_createClass(r,[{key:"getCurrentTimeCycle",value:function(){var e=AnalyticUtil.getCurrentTimeStamp(),t=this.getMinutes();return t?{start:t=(t=e-60*t*1e3)<this.startTime?this.startTime:t,end:e=e>this.endTime?this.endTime:e}:{start:this.startTime,end:this.endTime}}},{key:"getMinutes",value:function(){return this.scrollInfo?this.scrollInfo.timeCycleUnit===TimeCycleUnit.WEEK?7*this.scrollInfo.timeCycleNumber*24*60:this.scrollInfo.timeCycleUnit===TimeCycleUnit.DAY?24*this.scrollInfo.timeCycleNumber*60:this.scrollInfo.timeCycleUnit===TimeCycleUnit.HOUR?60*this.scrollInfo.timeCycleNumber:this.scrollInfo.timeCycleUnit===TimeCycleUnit.MINUTE?this.scrollInfo.timeCycleNumber:0:0}}])})(),ClientStartTimeCycle=(()=>{function t(e){return _classCallCheck(this,t),_callSuper(this,t,[e,void 0])}return _inherits(t,AbstractTimeCycle),_createClass(t,[{key:"getCurrentTimeCycle",value:function(){return{start:t.clientStartTime,end:this.endTime}}}])})(),AbstractTaskLimit=(()=>{return _createClass(function e(t){_classCallCheck(this,e),this.taskFlow=t,this.mLimits=[],this.mClientUserId=t.clientUserId,this.enableLimit=!1,this.parseLimitInfo(t.taskJson)},[{key:"parseLimitInfo",value:function(e){}},{key:"isLimit",value:(e=_asyncToGenerator(_regenerator().m(function e(){var t,r,n,i,a;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(this.enableLimit){e.n=1;break}return e.a(2,!1);case 1:t=!1,r=0;case 2:if(!(r<this.mLimits.length)){e.n=6;break}if(n=this.mLimits[r],(i=n.first).isWithInPeriod()){e.n=3;break}return e.a(3,5);case 3:return a=i.getCurrentTimeCycle(),e.n=4,this.getLimitCount(a.start,a.end);case 4:if(a=e.v,a+=1,logger.info("Current Count: "+a+" Target Count: "+n.second),t=a>n.second)return e.a(3,6);e.n=5;break;case 5:r++,e.n=2;break;case 6:return e.a(2,t)}},e,this)})),function(){return e.apply(this,arguments)})},{key:"getLimitCount",value:(r=_asyncToGenerator(_regenerator().m(function e(t,r){return _regenerator().w(function(e){for(;;)if(0===e.n)return e.a(2,0)},e)})),function(e,t){return r.apply(this,arguments)})}]);var r,e})(),FrequencyLimit=(()=>{function t(e){return _classCallCheck(this,t),_callSuper(this,t,[e])}return _inherits(t,AbstractTaskLimit),_createClass(t,[{key:"parseLimitInfo",value:function(e){var t,e=e.frequencyLimits;e&&(e=JSON.parse(e),_.isObject(e))&&(this.enableLimit=e.enableFrequencyLimits,this.enableLimit)&&(e=e.ruleList,_.isArray(e))&&0<e.length&&(e=e[0])&&(t=e.maxTimes||0,!(e=this.createFrequencyLimitCycle(e))||t<=0||this.mLimits.push({first:e,second:t}))}},{key:"getLimitCount",value:(r=_asyncToGenerator(_regenerator().m(function e(t,r){return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return logger.info("Frequency Limit UserID: "+this.mClientUserId+" Start : "+_.getFormatDataByLog(t)+" End : "+_.getFormatDataByLog(r)),e.n=1,getFrequencyLimitCount({appId:this.taskFlow.appId,clientUserId:this.mClientUserId,taskId:this.taskFlow.taskId,start:t,end:r});case 1:return e.a(2,e.v)}},e,this)})),function(e,t){return r.apply(this,arguments)})},{key:"addLimitCount",value:(e=_asyncToGenerator(_regenerator().m(function e(){return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(this.enableLimit&&0<this.mLimits.length)return e.n=1,addFrequencyLimit({appId:this.taskFlow.appId,clientUserId:this.mClientUserId,taskId:this.taskFlow.taskId,triggerTime:AnalyticUtil.getCurrentTimeStamp()});e.n=1;break;case 1:return e.a(2)}},e,this)})),function(){return e.apply(this,arguments)})},{key:"createFrequencyLimitCycle",value:function(e){var t,r=e.ruleType,n=this.taskFlow.taskTimeCycle.getCurrentTimeCycle(),i={periodStartStamp:n.start,periodEndStamp:n.end};switch(r){case"TASK":t=new StartEndLimit(i);break;case"TIME_CYCLE":t=new SlideTimeCycle(i,{timeCycleNumber:e.timeCycleNumber,timeCycleUnit:_.getTimeCycleUnit(e.timeCycleUnit)});break;case"CLIENT_START":t=new ClientStartTimeCycle(i);break;case"TIME_CYCLE_ROLL":var a={timeCycleNumber:e.timeCycleNumber,timeCycleUnit:_.getTimeCycleUnit(e.timeCycleUnit)},s=e.timeCycleDef;s&&(a.startNumber=s.startDay,s=_.parseStartTime(s.startTime),a.startHour=s.hour,a.startMinute=s.minute),a.timeCycleUnit===TimeCycleUnit.DAY?t=new DailyScrollTimeCycle(i,a):a.timeCycleUnit===TimeCycleUnit.WEEK?t=new WeekScrollTimeCycle(i,a):a.timeCycleUnit===TimeCycleUnit.MONTH&&(t=new MonthScrollTimeCycle(i,a))}return t}}]);var e,r})(),UserFatigueControl=(()=>{function t(e){return _classCallCheck(this,t),_callSuper(this,t,[e])}return _inherits(t,AbstractTaskLimit),_createClass(t,[{key:"parseLimitInfo",value:function(e){if(this.enableLimit=e.enableChannelTouchLimits,this.enableLimit){e=e.channelTouchLimitsRuleDef;if(e){var t=JSON.parse(e);if(_.isArray(t))for(var e=this.taskFlow.taskTimeCycle.getCurrentTimeCycle(),r={periodStartStamp:e.start,periodEndStamp:e.end},n=0;n<t.length;n++){var i,a=t[n];a&&((i=a.maxTimes||0)<=0||this.mLimits.push({first:new SlideTimeCycle(r,{timeCycleNumber:a.timeCycleNumber,timeCycleUnit:_.getTimeCycleUnit(a.timeCycleUnit)}),second:i}))}}}}},{key:"getLimitCount",value:(r=_asyncToGenerator(_regenerator().m(function e(t,r){return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return logger.info("Touch Limit PushID: : "+this.taskFlow.triggerRecord.pushId+" Start : "+_.getFormatDataByLog(t)+" End : "+_.getFormatDataByLog(r)),e.n=1,getTouchLimitCount({appId:this.taskFlow.appId,pushId:this.taskFlow.triggerRecord.pushId,channelId:this.taskFlow.channelId,start:t,end:r});case 1:return e.a(2,e.v)}},e,this)})),function(e,t){return r.apply(this,arguments)})},{key:"addLimitCount",value:(e=_asyncToGenerator(_regenerator().m(function e(){return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(this.enableLimit&&0<this.mLimits.length)return e.n=1,addTouchLimit({appId:this.taskFlow.appId,pushId:this.taskFlow.triggerRecord.pushId,channelId:this.taskFlow.channelId,triggerTime:AnalyticUtil.getCurrentTimeStamp()});e.n=1;break;case 1:return e.a(2)}},e,this)})),function(){return e.apply(this,arguments)})}]);var e,r})(),PushResult=(()=>_createClass(function e(t){_classCallCheck(this,e),this.flow=t;t=this.flow.taskJson.groupContentList;_.isArray(t)&&0<t.length&&(t=t[0])&&(this.contentJson=t.content),this.contentJson||(this.contentJson={}),this.userParamsList=this.flow.taskJson.channelUserParamsList,_.isArray(this.userParamsList)||(this.userParamsList=[])},[{key:"calculate",value:function(e){var t={appId:this.flow.appId,taskId:this.flow.taskId,channelMsgType:this.flow.channelMsgType,pushId:this.flow.triggerRecord.pushId};return t.userParams=this.buildUserParamsMap(e),t.opsProperties=this.buildOpsProperties(),t.content=this.buildContentMap(e),t}},{key:"buildContentMap",value:function(s){var o=this,u={};return _.each(this.contentJson,function(e,t){if(_.isString(e)){var r=o.getClientValue(e,s);(r=o.getOccasionValue(r,s))&&(u[t]=r)}else if(_.isObject(e)){r=o.getOccasionJson(e,s);r&&(u[t]=r)}else if(_.isArray(e)){for(var n,i=[],a=0;a<e.length;a++)_.isObject(e[a])?(n=o.getOccasionJson(e[a],s))&&i.push(n):i.push(e[a]);u[t]=i}else u[t]=e}),u}},{key:"getOccasionJson",value:function(e,n){var i,a=this;if(_.isObject(e))return i={},_.each(e,function(e,t){var r;_.isString(e)?(r=a.getOccasionValue(e,n))&&(i[t]=r):i[t]=e}),i}},{key:"getOccasionValue",value:function(e,r){var n=this,e=e.replace(/\$\[(.*?)\]/g,function(e,t){return n.getOccasionColumnValue(r,t)});if(e.trim())return e}},{key:"getOccasionColumnValue",value:function(e,t){var r,n,i,a;return!t||(t=t.split(":")).length<3?" ":t[1]!==e[Config.EVENT_NAME_KEY]?"":(r=t[2])?(r.includes(".")?2===(i=r.split(".")).length&&(a=e[i[0]],_.isObject(a))&&(n=a[i[1]]):n=e[r],n||(4===t.length&&void 0!==t[3]?t[3]:" ")):" "}},{key:"getClientValue",value:function(e,r){var n=this;return e.replace(/\$\((.*?)\)/g,function(e,t){return n.getContentColumnValue(r,t)})}},{key:"getContentColumnValue",value:function(e,t){return t?(t=t.split(":"),e=(e=this.getColumnValue(e,t))||(3===t.length&&void 0!==t[2]?t[2]:""),_.isDate(e)?_.formatDate(e):e):""}},{key:"buildOpsProperties",value:function(){return{"#ops_receipt_properties":{ops_project_id:this.flow.projectId,ops_task_id:this.flow.taskId,ops_exp_group_id:this.flow.triggerRecord.expGroupId,ops_trigger_time:this.flow.triggerRecord.triggerTime,ops_task_exec_detail_id:_.UUID()}}}},{key:"buildUserParamsMap",value:function(e){for(var t={},r=0;r<this.userParamsList.length;r++){var n=this.userParamsList[r];n&&(t[n.key]=n.value||this.getUserParamsValue(e,n.columnName,n.defaultValue))}return t}},{key:"getUserParamsValue",value:function(e,t,r){return t&&(t=t.split(":"),this.getColumnValue(e,t))||r}},{key:"getColumnValue",value:function(e,t){var r;if(t&&!(t.length<2))return(r=(t=t[1])&&t.startsWith("#")?e[t]:r)||AnalyticUtil.getConfigValue(t)}}]))(),EventCountRule=(()=>{return _createClass(function e(t,r){_classCallCheck(this,e),this.key=t.key,this.num=t.num,this.eventName=t.eventName,this.triggerRule=r},[{key:"evaluate",value:(t=_asyncToGenerator(_regenerator().m(function e(t){var r,n,i,a,s,o,u;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(r=this.triggerRule.getTimeCycle()){e.n=1;break}return e.a(2,!1);case 1:return n=r.getCurrentTimeCycle(),logger.info("EventName: "+this.eventName+" Start : "+_.getFormatDataByLog(n.start)+" End : "+_.getFormatDataByLog(n.end)),e.n=2,queryTriggerResult();case 2:return i=e.v,o=this.getTriggerResultList(i,{appId:this.triggerRule.taskFlow.appId,clientUserId:this.triggerRule.clientUserId,taskId:this.triggerRule.taskFlow.taskId,triggerId:this.triggerRule.triggerId,start:n.start,end:n.end}),a=this.getRelationProperties(t),e.n=3,this.getEventCount(o,a);case 3:return s=e.v,o=s.count,this.triggerRule.isWithInPeriod()&&o++,logger.info("EventName: "+this.eventName+" Trigger Count: "+o+" Target Count: "+this.num),u=!1,o>=this.num?(u=!0,i=i.filter(function(e){return!s.ids.includes(e.id)})):i.push({appId:this.triggerRule.taskFlow.appId,clientUserId:this.triggerRule.clientUserId,taskId:this.triggerRule.taskFlow.taskId,triggerId:this.triggerRule.triggerId,id:_.generateUniqueId(),key:this.key,num:1,event:a,eventTime:AnalyticUtil.getCurrentTimeStamp()}),e.n=4,insertTriggerResult(i);case 4:return e.a(2,u)}},e,this)})),function(e){return t.apply(this,arguments)})},{key:"getTriggerResultList",value:function(e,t){for(var r=[],n=0;n<e.length;n++){var i=e[n];i.appId===t.appId&&i.clientUserId===t.clientUserId&&i.taskId===t.taskId&&i.triggerId===t.triggerId&&i.eventTime>=t.start&&i.eventTime<=t.end&&r.push(e[n])}return r}},{key:"getEventCount",value:(n=_asyncToGenerator(_regenerator().m(function e(t,r){var n,i,a,s,o;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:n=[],i=0,a=t.length-1;case 1:if(0<=a){if(s=t[a],o=s.key===this.key)return e.n=2,this.isRelationEq(r,s.event);e.n=3}else e.n=6;break;case 2:o=e.v;case 3:o?(i++,n.push(s.id),e.n=5):e.n=4;break;case 4:if(this.triggerRule.disableEventList.includes(s.key))return e.a(3,6);e.n=5;break;case 5:a--,e.n=1;break;case 6:return e.a(2,{count:i,ids:n})}},e,this)})),function(e,t){return n.apply(this,arguments)})},{key:"isRelationEq",value:(r=_asyncToGenerator(_regenerator().m(function e(t,r){var n,i,a,s,o;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(0===this.triggerRule.relationProperties.length)return e.a(2,!0);e.n=1;break;case 1:if(this.triggerRule.relationProperties.length!==Object.keys(r).length)return logger.info("TriggerID: "+this.triggerRule.triggerId+"relation properties length is not equal"),e.a(2,!1);e.n=2;break;case 2:n=new UnitRuleGroup,i=0;case 3:if(!(i<this.triggerRule.relationProperties.length)){e.n=7;break}if(a=this.triggerRule.relationProperties[i]){e.n=4;break}return e.a(3,6);case 4:if(s=a.columnName){e.n=5;break}return e.a(3,6);case 5:n.addRule(new EQRule({calcuSymbol:"C00",columnName:s,columnType:a.columnType,ftv:[r[s]]}));case 6:i++,e.n=3;break;case 7:return logger.info("TriggerID: "+this.triggerRule.triggerId+"------start relation properties------"),e.n=8,n.evaluate(t);case 8:return o=e.v,logger.info("TriggerID: "+this.triggerRule.triggerId+"------end relation properties------result is "+o),e.a(2,o)}},e,this)})),function(e,t){return r.apply(this,arguments)})},{key:"getRelationProperties",value:function(e){for(var t={},r=0;r<this.triggerRule.relationProperties.length;r++){var n,i=this.triggerRule.relationProperties[r];i&&(n=e[i.columnName])&&(t[i.columnName]=n)}return t}}]);var r,n,t})(),createAnalyticsRule=function(e,t){var r=e.taPropQuota;return r&&"A200"===r.analysis?new EventCountRule(e,t):void 0},EveryTriggerRule=(()=>{return _createClass(function e(t,r,n){_classCallCheck(this,e),this.targetEventList=[],this.taskFlow=t,this.clientUserId=this.taskFlow.clientUserId,this.triggerId=n,this.mEventFilters=new ActivationRuleGroup,this.mTriggerTimeCycle=this.createTriggerTimeCycle(r),this.relationProperties=[],this.disableEventList=[],this.parseFilters(r)},[{key:"isWithInPeriod",value:function(){return!!this.mTriggerTimeCycle&&this.mTriggerTimeCycle.isWithInPeriod()}},{key:"parseFilters",value:function(e){this.parseEventFilters(e)}},{key:"parseEventFilters",value:function(e){var t=e.events;if(_.isArray(t))for(var r=0;r<t.length;r++){var n,i,a=t[r];a&&(this.targetEventList.push(a.eventName),n=createAnalyticsRule(a,this))&&((i=new UnitRuleGroup).addRule(new EQRule(_.buildEventNameRule(a.eventName))),i.addRule(_parseCompound(a.relation,a.filts,this.taskFlow.zoneOffset)),i.addRule(n),this.mEventFilters.addRule(i))}}},{key:"isTargetEvent",value:function(e){return this.targetEventList.includes(e)}},{key:"triggerEventRules",value:(t=_asyncToGenerator(_regenerator().m(function e(t){var r;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(t){e.n=1;break}return e.a(2,!1);case 1:return logger.info("TriggerID: "+this.triggerId+"------start trigger rules------"),e.n=2,this.mEventFilters.evaluate(t);case 2:return r=e.v,logger.info("TriggerID "+this.triggerId+"------end trigger rules------result is "+r),e.a(2,r)}},e,this)})),function(e){return t.apply(this,arguments)})},{key:"getTimeCycle",value:function(){return this.mTriggerTimeCycle}},{key:"createTriggerTimeCycle",value:function(e){var t,r={periodStart:e.periodStart,periodEnd:e.periodEnd,zoneOffset:this.taskFlow.zoneOffset},n={timeCycleNumber:1};switch(e.periodTimeSymbol){case"TS01":n.timeCycleUnit=TimeCycleUnit.DAY;var i=_.parseStartTime(e.dayStartTime);return n.startHour=i.hour,n.startMinute=i.minute,new DailyScrollTimeCycle(r,n);case"TS02":t=new StartEndLimit(r);break;case"TS03":n.timeCycleUnit=TimeCycleUnit.WEEK,n.startNumber=e.startDay;i=_.parseStartTime(e.dayStartTime);return n.startHour=i.hour,n.startMinute=i.minute,new WeekScrollTimeCycle(r,n);case"TS04":return n.timeCycleUnit=TimeCycleUnit.MONTH,n.startNumber=e.startDay,new MonthScrollTimeCycle(r,n)}return t}}]);var t})(),ContinueTriggerRule=(()=>{function i(e,t,r){return _classCallCheck(this,i),_callSuper(this,i,[e,t,r])}return _inherits(i,EveryTriggerRule),_createClass(i,[{key:"parseFilters",value:function(e){_superPropGet(i,"parseFilters",this,3)([e]),this.parseTimeCycleHour(e),this.parseRelationProperties(e),this.parseDisableEvent(e)}},{key:"parseTimeCycleHour",value:function(e){var t=e.windowGap,e=_.getTimeCycleUnit(e.windowGapTimeUnit);0<t&&e&&(this.periodScrollInfo={timeCycleNumber:t,timeCycleUnit:e})}},{key:"parseRelationProperties",value:function(e){this.relationProperties=e.relationProps,_.isArray(this.relationProperties)||(this.relationProperties=[])}},{key:"parseDisableEvent",value:function(e){this.blackListGroup=new ActivationRuleGroup;var t=e.blackList;if(_.isArray(t))for(var r=0;r<t.length;r++){var n,i,a=t[r];a&&(n=a.eventName,this.disableEventList.push(n),(i=new UnitRuleGroup).addRule(new EQRule(_.buildEventNameRule(n))),i.addRule(_parseCompound(a.relation,a.filts,this.taskFlow.zoneOffset)),this.blackListGroup.addRule(i))}}},{key:"isTargetEvent",value:function(e){return _superPropGet(i,"isTargetEvent",this,3)([e])||this.disableEventList.includes(e)}},{key:"triggerEventRules",value:(t=_asyncToGenerator(_regenerator().m(function e(t){var r,n;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(r=t[Config.EVENT_NAME_KEY],this.disableEventList.includes(r))return logger.info("BlackList Event:"+r+"------start trigger rules------"),e.n=1,this.blackListGroup.evaluate(t);e.n=3;break;case 1:if(n=e.v,logger.info("BlackList Event:"+r+"------end trigger rules------result is "+n),n)return e.n=2,addTriggerResult({appId:this.taskFlow.appId,clientUserId:this.clientUserId,taskId:this.taskFlow.taskId,triggerId:this.triggerId,id:_.generateUniqueId(),key:r,num:1,event:{},eventTime:AnalyticUtil.getCurrentTimeStamp()});e.n=2;break;case 2:return e.a(2,!1);case 3:return e.n=4,_superPropGet(i,"triggerEventRules",this,3)([t]);case 4:return e.a(2,e.v)}},e,this)})),function(e){return t.apply(this,arguments)})},{key:"getTimeCycle",value:function(){var e;return this.periodScrollInfo?(e={periodStartStamp:(e=this.mTriggerTimeCycle.getCurrentTimeCycle()).start,periodEndStamp:e.end},new SlideTimeCycle(e,this.periodScrollInfo)):this.mTriggerTimeCycle}}]);var t})(),TaskFlow=(()=>{return _createClass(function e(t,r,n){_classCallCheck(this,e),this.appId=t,this.clientUserId=r,this.taskJson=n,this.triggerRules=[],this.parseTaskInfo(),this.parseTriggerRule(),this.parseExpConfig(),this.parseTargetAudience(),this.parseTaskLimit(),this.parseContentList()},[{key:"parseTaskInfo",value:function(){this.taskId=this.taskJson.taskId,this.projectId=this.taskJson.projectId,this.zoneOffset=this.taskJson.tzOffset,this.taskVersion=this.taskJson.currentVersion,this.channelId=this.taskJson.channelId,this.channelMsgType=this.taskJson.channelMsgType,this.taskMode=this.taskJson.pushMode,this.eventTimeout=this.taskJson.eventTimeout||5e3,this.taskTimeCycle=new StartEndLimit({periodStart:this.taskJson.startDate,periodEnd:this.taskJson.endDate,zoneOffset:this.zoneOffset})}},{key:"parseTriggerRule",value:function(){if(this.taskJson.triggerRule){var e=JSON.parse(this.taskJson.triggerRule);if(_.isArray(e))for(var t=0;t<e.length;t++){var r,n=e[t];if(n){switch(n.eventTriggerType){case 1:r=new ContinueTriggerRule(this,n,t);break;case 3:r=new EveryTriggerRule(this,n,t)}r&&this.triggerRules.push(r)}}}}},{key:"parseExpConfig",value:function(){this.mExpConfig=new ExpConfig(this.taskJson,this.zoneOffset)}},{key:"parseTargetAudience",value:function(){var e,t=this.taskJson.clientQp;t&&(e=JSON.parse(t)),_.isObject(e)||(e={}),this.mTargetAudience=new TargetAudience(this,this.taskJson.isTargetUser,e,this.taskJson.pushId)}},{key:"parseTaskLimit",value:function(){this.mTaskFrequencyLimit=new FrequencyLimit(this),this.mTaskTouchLimit=new UserFatigueControl(this)}},{key:"parseContentList",value:function(){this.mPushResult=new PushResult(this)}},{key:"startClientRecord",value:function(){this.triggerRecord={appId:this.appId,clientUserId:this.clientUserId,taskId:this.taskId,isTestTask:this.isTestTask()}}},{key:"isTargetEvent",value:function(e){if(AnalyticUtil.isWhiteEvent(e))return!0;for(var t=!1,r=0;r<this.triggerRules.length;r++)if(this.triggerRules[r].isTargetEvent(e)){t=!0;break}return t&&logger.info("Task ("+this.taskId+") contains target event"),t}},{key:"isEventTimeout",value:function(e){return 0!==e&&AnalyticUtil.getCurrentTimeStamp-e>this.eventTimeout}},{key:"isValidityPeriod",value:function(){var e;return!!this.isChannelTestTask()||((e=this.taskTimeCycle.isWithInPeriod())||logger.info("Task ("+this.taskId+") is not in the validity period"),e)}},{key:"triggerEvent",value:(n=_asyncToGenerator(_regenerator().m(function e(t){var r,n;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:r=!1,this.isChannelTestTask()?(r=!0,e.n=5):e.n=1;break;case 1:n=0;case 2:if(n<this.triggerRules.length)return e.n=3,this.triggerRules[n].triggerEventRules(t);e.n=5;break;case 3:if(e.v)return r=!0,e.a(3,5);e.n=4;break;case 4:n++,e.n=2;break;case 5:return r&&(this.triggerRecord.triggerTime=AnalyticUtil.getCurrentDate()),e.a(2,r)}},e,this)})),function(e){return n.apply(this,arguments)})},{key:"isTargetAudience",value:(r=_asyncToGenerator(_regenerator().m(function e(t){var r;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,this.mTargetAudience.isTargetAudience(t);case 1:return r=e.v,e.a(2,r)}},e,this)})),function(e){return r.apply(this,arguments)})},{key:"isTaskLimit",value:(e=_asyncToGenerator(_regenerator().m(function e(){return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,this.mTaskFrequencyLimit.isLimit();case 1:if(e.v)return this.triggerRecord.status=FREQUENCY_CONTROL,AnalyticUtil.trackTriggerEvent(this.triggerRecord),e.a(2,!0);e.n=2;break;case 2:if(this.mExpConfig.isExpSampleOut())return this.triggerRecord.status=SAMPLE,AnalyticUtil.trackTriggerEvent(this.triggerRecord),logger.info("Task ("+this.taskId+") is sampling and elimination"),e.a(2,!0);e.n=3;break;case 3:return e.n=4,this.mTaskTouchLimit.isLimit();case 4:if(e.v)return this.triggerRecord.status=FATIGUE_CONTROL,AnalyticUtil.trackTriggerEvent(this.triggerRecord),e.a(2,!0);e.n=5;break;case 5:if(this.mExpConfig.isSkipPush())return this.triggerRecord.status=EXP_SKIP_PUSH,AnalyticUtil.trackTriggerEvent(this.triggerRecord),logger.info("Task ("+this.taskId+") is skip push"),e.a(2,!0);e.n=6;break;case 6:return e.a(2,!1)}},e,this)})),function(){return e.apply(this,arguments)})},{key:"finishClientRecord",value:(t=_asyncToGenerator(_regenerator().m(function e(t){return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return this.triggerRecord.actualPushTime=AnalyticUtil.getCurrentDate(),e.n=1,this.mTaskFrequencyLimit.addLimitCount();case 1:return e.n=2,this.mTaskTouchLimit.addLimitCount();case 2:this.triggerRecord.status=t?SUCCESS:FAIL,AnalyticUtil.trackTriggerEvent(this.triggerRecord);case 3:return e.a(2)}},e,this)})),function(e){return t.apply(this,arguments)})},{key:"isExpRelease",value:function(){return this.mExpConfig.isExpRelease(this.triggerRecord)}},{key:"calculate",value:function(e){return this.mPushResult.calculate(e)}},{key:"isChannelTestTask",value:function(){return 3===this.taskMode}},{key:"isTestTask",value:function(){return 2===this.taskMode||3===this.taskMode}}]);var t,e,r,n})(),TD_SYSTEM_CONFIG="td_system_config",STRATEGY_CLIENT="strategy_client",SystemConfig=(()=>{function e(){_classCallCheck(this,e),this.loadSuccess=!1,this.systemConfigs=[]}return _createClass(e,[{key:"loadLocalConfig",value:(t=_asyncToGenerator(_regenerator().m(function e(){var t,r,n;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(this.loadSuccess)return e.a(2);e.n=1;break;case 1:return e.n=2,PlatformAPI.getStorage(TD_SYSTEM_CONFIG);case 2:if(t=e.v,_.isArray(t))for(r=0;r<t.length;r++)(n=t[r]).plat===STRATEGY_CLIENT&&this.systemConfigs.push(n);this.loadSuccess=!0;case 3:return e.a(2)}},e,this)})),function(){return t.apply(this,arguments)})},{key:"isStratetyStop",value:function(e){for(var t=0;t<this.systemConfigs.length;t++){var r=this.systemConfigs[t];if(r.appId===e)return!!r.disabled||!!_.isArray(r.disabledVersionList)&&r.disabledVersionList.includes(Config.LIB_VERSION)}return!1}}],[{key:"getInstance",value:function(){return e.instance=e.instance?e.instance:new e}}]);var t})(),TaskFlowManager=(()=>{function r(e){_classCallCheck(this,r),this.appId=e,this.taskFlows=new Map,this.mDebugTriggerList=[],this.preEventCaches=[]}return _createClass(r,[{key:"loadLocalTask",value:(t=_asyncToGenerator(_regenerator().m(function e(t){var r,n,i=this;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(0<this.taskFlows.size)return e.a(2);e.n=1;break;case 1:return _.isFunction(t)&&(this.triggerListener=t),ClientStartTimeCycle.clientStartTime=AnalyticUtil.getCurrentTimeStamp(),e.n=2,deleteTaskByLimit(this.appId,Config.DATA_BASE_LIMIT);case 2:return e.n=3,deleteTriggerResultLimit(Config.DATA_BASE_LIMIT);case 3:return e.n=4,deleteFrequencyByLimit(Config.DATA_BASE_LIMIT);case 4:return e.n=5,deleteTouchLimitByTime(Config.DATA_TIME_LIMIT);case 5:return e.n=6,AnalyticUtil.getClientUserId(this.appId);case 6:return r=e.v,e.n=7,getTasks(this.appId,r);case 7:return n=e.v,_.each(n,function(e,t){i.taskFlows.set(e.taskId,new TaskFlow(i.appId,r,e.task))}),e.n=8,getTaskStatus({appId:this.appId,clientUserId:r});case 8:return this.mTaskStop=e.v,e.n=9,this.clearPreEvent();case 9:return e.a(2)}},e,this)})),function(e){return t.apply(this,arguments)})},{key:"stopTasks",value:(s=_asyncToGenerator(_regenerator().m(function e(t,r){return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(this.mTaskStop)return e.a(2);e.n=1;break;case 1:if(SystemConfig.getInstance().isStratetyStop(this.appId))return e.a(2);e.n=2;break;case 2:if(t!==Config.STRATEGY_TEMPLATE_CODE)return e.a(2);e.n=3;break;case 3:return this.taskFlows.clear(),this.mTaskStop=!0,e.n=4,updateTaskStatus({appId:this.appId,clientUserId:r,status:!0});case 4:return e.a(2)}},e,this)})),function(e,t){return s.apply(this,arguments)})},{key:"applyNewConfig",value:(a=_asyncToGenerator(_regenerator().m(function e(t,n){var r,i,a,s,o,u,l,c,f,h,g,p,m,T,y,d,v,E=this;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(SystemConfig.getInstance().isStratetyStop(this.appId))return e.a(2);e.n=1;break;case 1:if(t!==Config.STRATEGY_TEMPLATE_CODE)return e.a(2);e.n=2;break;case 2:return this.mTaskStop=!1,e.n=3,updateTaskStatus({appId:this.appId,clientUserId:n,status:!1});case 3:return r=(r=AnalyticUtil.getStrategyInfo(this.appId))||[],e.n=4,getTasks(this.appId,n);case 4:i=e.v,a=[],s=[],o=[],u=[],l=0;case 5:if(!(l<r.length)){e.n=10;break}if(c=r[l]){e.n=6;break}return e.a(3,9);case 6:if(f=c.taskId,h=c.currentVersion,1!==c.status)return o.push(f),a.push({taskId:f,taskVersion:h,clientUserId:n,task:""}),e.a(3,9);e.n=7;break;case 7:if((g=i[f])&&h>g.taskVersion)return e.n=8,deleteTriggerResult({appId:this.appId,clientUserId:n,taskId:f});e.n=8;break;case 8:s.push(f),a.push({taskId:f,taskVersion:h,clientUserId:n,task:c}),(!(g=this.taskFlows[f])||h>=g.taskVersion)&&(g=new TaskFlow(this.appId,n,c),this.taskFlows.set(f,g)),g.isTestTask()&&u.push(f);case 9:l++,e.n=5;break;case 10:return e.n=11,updateTask(this.appId,n,a);case 11:_.each(i,(()=>{var r=_asyncToGenerator(_regenerator().m(function e(t,r){return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(s.includes(r)||o.includes(r)){e.n=2;break}return e.n=1,deleteTriggerResult({appId:E.appId,clientUserId:n,taskId:r});case 1:return e.n=2,deleteFrequencyLimit({appId:E.appId,clientUserId:n,taskId:r});case 2:return e.a(2)}},e)}));return function(e,t){return r.apply(this,arguments)}})()),p=_createForOfIteratorHelper(this.taskFlows);try{for(p.s();!(m=p.n()).done;)T=_slicedToArray(m.value,2),y=T[0],s.includes(y)||this.taskFlows.delete(y)}catch(e){p.e(e)}finally{p.f()}return e.n=12,this.clearPreEvent();case 12:AnalyticUtil.trackClientDebugEvent(this.appId,u),d=0;case 13:if(!(d<u.length)){e.n=17;break}if(v=this.taskFlows.get(u[d])){e.n=14;break}return e.a(3,16);case 14:if(v.isChannelTestTask()){e.n=15;break}return e.a(3,16);case 15:return e.n=16,this.taskTriggerFlow(v,CHANNEL_TEST_EVENT,AnalyticUtil.buildAnalyticPresetFacts(this.appId));case 16:d++,e.n=13;break;case 17:return e.a(2)}},e,this)})),function(e,t){return a.apply(this,arguments)})},{key:"clearPreEvent",value:(e=_asyncToGenerator(_regenerator().m(function e(){var t;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(this.taskFlows.size<=0)return e.a(2);e.n=1;break;case 1:this.loadTaskSuccess=!0,t=0;case 2:if(t<this.preEventCaches.length)return e.n=3,this.triggerEvent(this.preEventCaches[t].event,this.preEventCaches[t].time);e.n=4;break;case 3:t++,e.n=2;break;case 4:this.preEventCaches=[];case 5:return e.a(2)}},e,this)})),function(){return e.apply(this,arguments)})},{key:"triggerEvent",value:(n=_asyncToGenerator(_regenerator().m(function e(t,r){var n,i,a,s;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(SystemConfig.getInstance().isStratetyStop(this.appId))return e.a(2);e.n=1;break;case 1:if(t){e.n=2;break}return e.a(2);case 2:if(this.mTaskStop)return e.a(2);e.n=3;break;case 3:if("track"!==t[Config.EVENT_TYPE_KEY]||t[Config.FIRST_CHECK_ID_KEY])return e.a(2);e.n=4;break;case 4:if(n=t[Config.EVENT_NAME_KEY]){e.n=5;break}return e.a(2);case 5:if(this.loadTaskSuccess){e.n=6;break}return this.preEventCaches.length<20&&this.preEventCaches.push({time:AnalyticUtil.getCurrentTimeStamp(),event:t}),e.a(2);case 6:if(AnalyticUtil.isBlackEvent(n))return e.a(2);e.n=7;break;case 7:i=_.jsonToFacts(t),logger.info("Event received:"+n),a=_createForOfIteratorHelper(this.taskFlows),e.p=8,a.s();case 9:if((s=a.n()).done){e.n=11;break}return s=_slicedToArray(s.value,2),s[0],s=s[1],e.n=10,this.taskTriggerFlow(s,n,i,r);case 10:e.n=9;break;case 11:e.n=13;break;case 12:e.p=12,s=e.v,a.e(s);case 13:return e.p=13,a.f(),e.f(13);case 14:return e.a(2)}},e,this,[[8,12,13,14]])})),function(e,t){return n.apply(this,arguments)})},{key:"taskTriggerFlow",value:(i=_asyncToGenerator(_regenerator().m(function e(t,r,n,i){var a,s;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(this.mDebugTriggerList.includes(t.taskId))return e.a(2);e.n=1;break;case 1:if(t.startClientRecord(),t.isTargetEvent(r)){e.n=2;break}return e.a(2);case 2:if(t.isEventTimeout(i))return e.a(2);e.n=3;break;case 3:if(t.isValidityPeriod()){e.n=4;break}return e.a(2);case 4:return e.n=5,t.triggerEvent(n);case 5:if(e.v){e.n=6;break}return e.a(2);case 6:return e.n=7,t.isTargetAudience(n);case 7:if(e.v){e.n=8;break}return e.a(2);case 8:if(t.isExpRelease()){e.n=9;break}return e.a(2);case 9:return e.n=10,t.isTaskLimit();case 10:if(e.v)return e.a(2);e.n=11;break;case 11:return a=t.calculate(n),logger.info("Task ("+t.taskId+") will be pushed soon"),s=!1,this.triggerListener&&(this.triggerListener(a),s=!0),t.isChannelTestTask()&&this.mDebugTriggerList.push(t.taskId),e.n=12,t.finishClientRecord(s);case 12:return e.a(2)}},e,this)})),function(e,t,r,n){return i.apply(this,arguments)})}],[{key:"getInstance",value:function(e){var t=(r.instances=r.instances?r.instances:{})[e];return t||(t=new r(e),r.instances[e]=t),t}}]);var i,n,e,a,s,t})(),StrategyTaskQueue=(()=>{function e(){_classCallCheck(this,e),this.tasks=[],this.timeStamp=0}return _createClass(e,[{key:"addTask",value:function(e){var t=function(){return e.apply(this)}.bind(this);this.tasks.push(t),this.run()}},{key:"run",value:(t=_asyncToGenerator(_regenerator().m(function e(){var t;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(this.tasks.length<=0)return e.a(2);e.n=1;break;case 1:if(0===this.timeStamp||3e3<Date.now()-this.timeStamp)return this.timeStamp=Date.now(),t=this.tasks.shift(),e.n=2,t();e.n=3;break;case 2:this.timeStamp=0,this.run();case 3:return e.a(2)}},e,this)})),function(){return t.apply(this,arguments)})}],[{key:"getInstance",value:function(){return e.instance=e.instance?e.instance:new e}}]);var t})(),TDAnalytics$1=PlatformAPI.getAnalyticGlobalData(),TDRemoteConfig$1=PlatformAPI.getConfigGlobalData(),TDStrategy=(()=>{function r(){_classCallCheck(this,r)}return _createClass(r,null,[{key:"init",value:(t=_asyncToGenerator(_regenerator().m(function e(t){return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(t=_.checkSettings(t)){e.n=1;break}return e.a(2);case 1:if((r.initAppIds=r.initAppIds?r.initAppIds:[]).includes(t.appId))return e.a(2);e.n=2;break;case 2:return TDAnalytics$1.registerAnalyticsObserver(function(e,t){"onDataEnqueue"===e&&StrategyTaskQueue.getInstance().addTask(_asyncToGenerator(_regenerator().m(function e(){return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,TaskFlowManager.getInstance(t.appId).triggerEvent(t.event,0);case 1:return e.a(2)}},e)})))},t.appId),t.remoteconfigObserver=function(e,t){"onConfigApplySuccess"===e?StrategyTaskQueue.getInstance().addTask(_asyncToGenerator(_regenerator().m(function e(){return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,TaskFlowManager.getInstance(t.appId).applyNewConfig(t.templateCode,t.clientUserId);case 1:return e.a(2)}},e)}))):"onConfigChanged"===e&&StrategyTaskQueue.getInstance().addTask(_asyncToGenerator(_regenerator().m(function e(){return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,TaskFlowManager.getInstance(t.appId).stopTasks(t.templateCode,t.clientUserId);case 1:return e.a(2)}},e)})))},e.n=3,SystemConfig.getInstance().loadLocalConfig();case 3:if(SystemConfig.getInstance().isStratetyStop(t.appId))return e.a(2);e.n=4;break;case 4:TDRemoteConfig$1.init(t),StrategyTaskQueue.getInstance().addTask(_asyncToGenerator(_regenerator().m(function e(){return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,TaskFlowManager.getInstance(t.appId).loadLocalTask(t.triggerListener);case 1:logger.info("TDStrategy SDK init success with appId = "+t.appId+" and version = "+Config.LIB_VERSION);case 2:return e.a(2)}},e)}))),r.initAppIds.push(t.appId);case 5:return e.a(2)}},e)})),function(e){return t.apply(this,arguments)})},{key:"setLogPrintListener",value:function(e){logger.listener=e}},{key:"addClientParams",value:function(t){StrategyTaskQueue.getInstance().addTask(_asyncToGenerator(_regenerator().m(function e(){return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,TDClientValueManager.addClientParams(t);case 1:return e.a(2)}},e)})))}},{key:"removeClientParam",value:function(t){StrategyTaskQueue.getInstance().addTask(_asyncToGenerator(_regenerator().m(function e(){return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,TDClientValueManager.removeClientParam(t);case 1:return e.a(2)}},e)})))}}]);var t})();PlatformAPI.setGlobalData(TDStrategy),module.exports=TDStrategy;