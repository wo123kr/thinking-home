function _arrayLikeToArray(r,a){(null==a||a>r.length)&&(a=r.length);for(var e=0,n=Array(a);e<a;e++)n[e]=r[e];return n}function _arrayWithHoles(r){if(Array.isArray(r))return r}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function asyncGeneratorStep(n,t,e,r,o,a,c){try{var i=n[a](c),u=i.value}catch(n){return void e(n)}i.done?t(u):Promise.resolve(u).then(r,o)}function _asyncToGenerator(n){return function(){var t=this,e=arguments;return new Promise((function(r,o){var a=n.apply(t,e);function _next(n){asyncGeneratorStep(a,r,o,_next,_throw,"next",n)}function _throw(n){asyncGeneratorStep(a,r,o,_next,_throw,"throw",n)}_next(void 0)}))}}function _callSuper(t,o,e){return o=_getPrototypeOf(o),_possibleConstructorReturn(t,_isNativeReflectConstruct()?Reflect.construct(o,e||[],_getPrototypeOf(t).constructor):o.apply(t,e))}function _classCallCheck(a,n){if(!(a instanceof n))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var o=r[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,_toPropertyKey(o.key),o)}}function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function _createForOfIteratorHelper(r,e){var t="undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=_unsupportedIterableToArray(r))||e&&r&&"number"==typeof r.length){t&&(r=t);var n=0,F=function(){};return{s:F,n:function(){return n>=r.length?{done:!0}:{done:!1,value:r[n++]}},e:function(r){throw r},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,u=!1;return{s:function(){t=t.call(r)},n:function(){var r=t.next();return a=r.done,r},e:function(r){u=!0,o=r},f:function(){try{a||null==t.return||t.return()}finally{if(u)throw o}}}}function _defineProperty(e,r,t){return(r=_toPropertyKey(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var p=_superPropBase(e,t);if(p){var n=Object.getOwnPropertyDescriptor(p,t);return n.get?n.get.call(arguments.length<3?e:r):n.value}},_get.apply(null,arguments)}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},_getPrototypeOf(t)}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&_setPrototypeOf(t,e)}function _isNativeReflectConstruct(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(_isNativeReflectConstruct=function(){return!!t})()}function _iterableToArrayLimit(r,l){var t=null==r?null:"undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(null!=t){var e,n,i,u,a=[],f=!0,o=!1;try{if(i=(t=t.call(r)).next,0===l){if(Object(t)!==t)return;f=!1}else for(;!(f=(e=i.call(t)).done)&&(a.push(e.value),a.length!==l);f=!0);}catch(r){o=!0,n=r}finally{try{if(!f&&null!=t.return&&(u=t.return(),Object(u)!==u))return}finally{if(o)throw n}}return a}}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _possibleConstructorReturn(t,e){if(e&&("object"==typeof e||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(t)}function _regenerator(){
/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */
var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function i(r,n,o,i){var c=n&&n.prototype instanceof Generator?n:Generator,u=Object.create(c.prototype);return _regeneratorDefine(u,"_invoke",function(r,n,o){var i,c,u,f=0,p=o||[],y=!1,G={p:0,n:0,v:e,a:d,f:d.bind(e,4),d:function(t,r){return i=t,c=0,u=e,G.n=r,a}};function d(r,n){for(c=r,u=n,t=0;!y&&f&&!o&&t<p.length;t++){var o,i=p[t],d=G.p,l=i[2];r>3?(o=l===n)&&(u=i[(c=i[4])?5:(c=3,3)],i[4]=i[5]=e):i[0]<=d&&((o=r<2&&d<i[1])?(c=0,G.v=n,G.n=i[1]):d<l&&(o=r<3||i[0]>n||n>l)&&(i[4]=r,i[5]=n,G.n=l,c=0))}if(o||r>1)return a;throw y=!0,n}return function(o,p,l){if(f>1)throw TypeError("Generator is already running");for(y&&1===p&&d(p,l),c=p,u=l;(t=c<2?e:u)||!y;){i||(c?c<3?(c>1&&(G.n=-1),d(c,u)):G.n=u:G.v=u);try{if(f=2,i){if(c||(o="next"),t=i[o]){if(!(t=t.call(i,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,c<2&&(c=0)}else 1===c&&(t=i.return)&&t.call(i),c<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),c=1);i=e}else if((t=(y=G.n<0)?u:r.call(n,G))!==a)break}catch(t){i=e,c=1,u=t}finally{f=1}}return{value:t,done:y}}}(r,o,i),!0),u}var a={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}t=Object.getPrototypeOf;var c=[][n]?t(t([][n]())):(_regeneratorDefine(t={},n,(function(){return this})),t),u=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(c);function f(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,GeneratorFunctionPrototype):(e.__proto__=GeneratorFunctionPrototype,_regeneratorDefine(e,o,"GeneratorFunction")),e.prototype=Object.create(u),e}return GeneratorFunction.prototype=GeneratorFunctionPrototype,_regeneratorDefine(u,"constructor",GeneratorFunctionPrototype),_regeneratorDefine(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName="GeneratorFunction",_regeneratorDefine(GeneratorFunctionPrototype,o,"GeneratorFunction"),_regeneratorDefine(u),_regeneratorDefine(u,o,"Generator"),_regeneratorDefine(u,n,(function(){return this})),_regeneratorDefine(u,"toString",(function(){return"[object Generator]"})),(_regenerator=function(){return{w:i,m:f}})()}function _regeneratorDefine(e,r,n,t){var i=Object.defineProperty;try{i({},"",{})}catch(e){i=0}_regeneratorDefine=function(e,r,n,t){if(r)i?i(e,r,{value:n,enumerable:!t,configurable:!t,writable:!t}):e[r]=n;else{function o(r,n){_regeneratorDefine(e,r,(function(e){return this._invoke(r,n,e)}))}o("next",0),o("throw",1),o("return",2)}},_regeneratorDefine(e,r,n,t)}function _setPrototypeOf(t,e){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},_setPrototypeOf(t,e)}function _slicedToArray(r,e){return _arrayWithHoles(r)||_iterableToArrayLimit(r,e)||_unsupportedIterableToArray(r,e)||_nonIterableRest()}function _superPropBase(t,o){for(;!{}.hasOwnProperty.call(t,o)&&null!==(t=_getPrototypeOf(t)););return t}function _superPropGet(t,o,e,r){var p=_get(_getPrototypeOf(1&r?t.prototype:t),o,e);return 2&r&&"function"==typeof p?function(t){return p.apply(e,t)}:p}function _toPrimitive(t,r){if("object"!=typeof t||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,r||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}function _toPropertyKey(t){var i=_toPrimitive(t,"string");return"symbol"==typeof i?i:i+""}function _typeof(o){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o},_typeof(o)}function _unsupportedIterableToArray(r,a){if(r){if("string"==typeof r)return _arrayLikeToArray(r,a);var t={}.toString.call(r).slice(8,-1);return"Object"===t&&r.constructor&&(t=r.constructor.name),"Map"===t||"Set"===t?Array.from(r):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(r,a):void 0}}var Config={LIB_VERSION:"1.1.1",STRATEGY_TEMPLATE_CODE:"td_strategy",STR_TYPE:"varchar",DATE_TYPE:"timestamp",BOOLEAN_TYPE:"boolean",INTEGER_TYPE:"integer",BIGINT_TYPE:"bigint",DOUBLE_TYPE:"double",DECIMAL_TYPE:"decimal",ARRAY_VARCHAR_TYPE:"array(varchar)",EVENT_NAME_KEY:"#event_name",EVENT_TYPE_KEY:"#type",FIRST_CHECK_ID_KEY:"#first_check_id",EVENT_ZONE_OFFSET:"#zone_offset",EVENT_TIME_KEY:"#time",DATA_BASE_LIMIT:900,DATA_TIME_LIMIT:31};var TimeCycleUnit={DAY:"day",WEEK:"week",MONTH:"month",HOUR:"hour",MINUTE:"minute"};var runtime=function(exports){var Op=Object.prototype;var hasOwn=Op.hasOwnProperty;var defineProperty=Object.defineProperty||function(obj,key,desc){obj[key]=desc.value};var undefined$1;var $Symbol=typeof Symbol==="function"?Symbol:{};var iteratorSymbol=$Symbol.iterator||"@@iterator";var asyncIteratorSymbol=$Symbol.asyncIterator||"@@asyncIterator";var toStringTagSymbol=$Symbol.toStringTag||"@@toStringTag";function define(obj,key,value){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});return obj[key]}try{define({},"")}catch(err){define=function(obj,key,value){return obj[key]=value}}function wrap(innerFn,outerFn,self,tryLocsList){var protoGenerator=outerFn&&outerFn.prototype instanceof Generator?outerFn:Generator;var generator=Object.create(protoGenerator.prototype);var context=new Context(tryLocsList||[]);defineProperty(generator,"_invoke",{value:makeInvokeMethod(innerFn,self,context)});return generator}exports.wrap=wrap;function tryCatch(fn,obj,arg){try{return{type:"normal",arg:fn.call(obj,arg)}}catch(err){return{type:"throw",arg:err}}}var GenStateSuspendedStart="suspendedStart";var GenStateSuspendedYield="suspendedYield";var GenStateExecuting="executing";var GenStateCompleted="completed";var ContinueSentinel={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var IteratorPrototype={};define(IteratorPrototype,iteratorSymbol,(function(){return this}));var getProto=Object.getPrototypeOf;var NativeIteratorPrototype=getProto&&getProto(getProto(values([])));if(NativeIteratorPrototype&&NativeIteratorPrototype!==Op&&hasOwn.call(NativeIteratorPrototype,iteratorSymbol)){IteratorPrototype=NativeIteratorPrototype}var Gp=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(IteratorPrototype);GeneratorFunction.prototype=GeneratorFunctionPrototype;defineProperty(Gp,"constructor",{value:GeneratorFunctionPrototype,configurable:true});defineProperty(GeneratorFunctionPrototype,"constructor",{value:GeneratorFunction,configurable:true});GeneratorFunction.displayName=define(GeneratorFunctionPrototype,toStringTagSymbol,"GeneratorFunction");function defineIteratorMethods(prototype){["next","throw","return"].forEach((function(method){define(prototype,method,(function(arg){return this._invoke(method,arg)}))}))}exports.isGeneratorFunction=function(genFun){var ctor=typeof genFun==="function"&&genFun.constructor;return ctor?ctor===GeneratorFunction||(ctor.displayName||ctor.name)==="GeneratorFunction":false};exports.mark=function(genFun){if(Object.setPrototypeOf){Object.setPrototypeOf(genFun,GeneratorFunctionPrototype)}else{genFun.__proto__=GeneratorFunctionPrototype;define(genFun,toStringTagSymbol,"GeneratorFunction")}genFun.prototype=Object.create(Gp);return genFun};exports.awrap=function(arg){return{__await:arg}};function AsyncIterator(generator,PromiseImpl){function invoke(method,arg,resolve,reject){var record=tryCatch(generator[method],generator,arg);if(record.type==="throw"){reject(record.arg)}else{var result=record.arg;var value=result.value;if(value&&typeof value==="object"&&hasOwn.call(value,"__await")){return PromiseImpl.resolve(value.__await).then((function(value){invoke("next",value,resolve,reject)}),(function(err){invoke("throw",err,resolve,reject)}))}return PromiseImpl.resolve(value).then((function(unwrapped){result.value=unwrapped;resolve(result)}),(function(error){return invoke("throw",error,resolve,reject)}))}}var previousPromise;function enqueue(method,arg){function callInvokeWithMethodAndArg(){return new PromiseImpl((function(resolve,reject){invoke(method,arg,resolve,reject)}))}return previousPromise=previousPromise?previousPromise.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}defineProperty(this,"_invoke",{value:enqueue})}defineIteratorMethods(AsyncIterator.prototype);define(AsyncIterator.prototype,asyncIteratorSymbol,(function(){return this}));exports.AsyncIterator=AsyncIterator;exports.async=function(innerFn,outerFn,self,tryLocsList,PromiseImpl){if(PromiseImpl===void 0)PromiseImpl=Promise;var iter=new AsyncIterator(wrap(innerFn,outerFn,self,tryLocsList),PromiseImpl);return exports.isGeneratorFunction(outerFn)?iter:iter.next().then((function(result){return result.done?result.value:iter.next()}))};function makeInvokeMethod(innerFn,self,context){var state=GenStateSuspendedStart;return function invoke(method,arg){if(state===GenStateExecuting){throw new Error("Generator is already running")}if(state===GenStateCompleted){if(method==="throw"){throw arg}return doneResult()}context.method=method;context.arg=arg;while(true){var delegate=context.delegate;if(delegate){var delegateResult=maybeInvokeDelegate(delegate,context);if(delegateResult){if(delegateResult===ContinueSentinel)continue;return delegateResult}}if(context.method==="next"){context.sent=context._sent=context.arg}else if(context.method==="throw"){if(state===GenStateSuspendedStart){state=GenStateCompleted;throw context.arg}context.dispatchException(context.arg)}else if(context.method==="return"){context.abrupt("return",context.arg)}state=GenStateExecuting;var record=tryCatch(innerFn,self,context);if(record.type==="normal"){state=context.done?GenStateCompleted:GenStateSuspendedYield;if(record.arg===ContinueSentinel){continue}return{value:record.arg,done:context.done}}else if(record.type==="throw"){state=GenStateCompleted;context.method="throw";context.arg=record.arg}}}}function maybeInvokeDelegate(delegate,context){var methodName=context.method;var method=delegate.iterator[methodName];if(method===undefined$1){context.delegate=null;if(methodName==="throw"&&delegate.iterator["return"]){context.method="return";context.arg=undefined$1;maybeInvokeDelegate(delegate,context);if(context.method==="throw"){return ContinueSentinel}}if(methodName!=="return"){context.method="throw";context.arg=new TypeError("The iterator does not provide a '"+methodName+"' method")}return ContinueSentinel}var record=tryCatch(method,delegate.iterator,context.arg);if(record.type==="throw"){context.method="throw";context.arg=record.arg;context.delegate=null;return ContinueSentinel}var info=record.arg;if(!info){context.method="throw";context.arg=new TypeError("iterator result is not an object");context.delegate=null;return ContinueSentinel}if(info.done){context[delegate.resultName]=info.value;context.next=delegate.nextLoc;if(context.method!=="return"){context.method="next";context.arg=undefined$1}}else{return info}context.delegate=null;return ContinueSentinel}defineIteratorMethods(Gp);define(Gp,toStringTagSymbol,"Generator");define(Gp,iteratorSymbol,(function(){return this}));define(Gp,"toString",(function(){return"[object Generator]"}));function pushTryEntry(locs){var entry={tryLoc:locs[0]};if(1 in locs){entry.catchLoc=locs[1]}if(2 in locs){entry.finallyLoc=locs[2];entry.afterLoc=locs[3]}this.tryEntries.push(entry)}function resetTryEntry(entry){var record=entry.completion||{};record.type="normal";delete record.arg;entry.completion=record}function Context(tryLocsList){this.tryEntries=[{tryLoc:"root"}];tryLocsList.forEach(pushTryEntry,this);this.reset(true)}exports.keys=function(val){var object=Object(val);var keys=[];for(var key in object){keys.push(key)}keys.reverse();return function next(){while(keys.length){var key=keys.pop();if(key in object){next.value=key;next.done=false;return next}}next.done=true;return next}};function values(iterable){if(iterable!=null){var iteratorMethod=iterable[iteratorSymbol];if(iteratorMethod){return iteratorMethod.call(iterable)}if(typeof iterable.next==="function"){return iterable}if(!isNaN(iterable.length)){var i=-1,next=function next(){while(++i<iterable.length){if(hasOwn.call(iterable,i)){next.value=iterable[i];next.done=false;return next}}next.value=undefined$1;next.done=true;return next};return next.next=next}}throw new TypeError(typeof iterable+" is not iterable")}exports.values=values;function doneResult(){return{value:undefined$1,done:true}}Context.prototype={constructor:Context,reset:function(skipTempReset){this.prev=0;this.next=0;this.sent=this._sent=undefined$1;this.done=false;this.delegate=null;this.method="next";this.arg=undefined$1;this.tryEntries.forEach(resetTryEntry);if(!skipTempReset){for(var name in this){if(name.charAt(0)==="t"&&hasOwn.call(this,name)&&!isNaN(+name.slice(1))){this[name]=undefined$1}}}},stop:function(){this.done=true;var rootEntry=this.tryEntries[0];var rootRecord=rootEntry.completion;if(rootRecord.type==="throw"){throw rootRecord.arg}return this.rval},dispatchException:function(exception){if(this.done){throw exception}var context=this;function handle(loc,caught){record.type="throw";record.arg=exception;context.next=loc;if(caught){context.method="next";context.arg=undefined$1}return!!caught}for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];var record=entry.completion;if(entry.tryLoc==="root"){return handle("end")}if(entry.tryLoc<=this.prev){var hasCatch=hasOwn.call(entry,"catchLoc");var hasFinally=hasOwn.call(entry,"finallyLoc");if(hasCatch&&hasFinally){if(this.prev<entry.catchLoc){return handle(entry.catchLoc,true)}else if(this.prev<entry.finallyLoc){return handle(entry.finallyLoc)}}else if(hasCatch){if(this.prev<entry.catchLoc){return handle(entry.catchLoc,true)}}else if(hasFinally){if(this.prev<entry.finallyLoc){return handle(entry.finallyLoc)}}else{throw new Error("try statement without catch or finally")}}}},abrupt:function(type,arg){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc<=this.prev&&hasOwn.call(entry,"finallyLoc")&&this.prev<entry.finallyLoc){var finallyEntry=entry;break}}if(finallyEntry&&(type==="break"||type==="continue")&&finallyEntry.tryLoc<=arg&&arg<=finallyEntry.finallyLoc){finallyEntry=null}var record=finallyEntry?finallyEntry.completion:{};record.type=type;record.arg=arg;if(finallyEntry){this.method="next";this.next=finallyEntry.finallyLoc;return ContinueSentinel}return this.complete(record)},complete:function(record,afterLoc){if(record.type==="throw"){throw record.arg}if(record.type==="break"||record.type==="continue"){this.next=record.arg}else if(record.type==="return"){this.rval=this.arg=record.arg;this.method="return";this.next="end"}else if(record.type==="normal"&&afterLoc){this.next=afterLoc}return ContinueSentinel},finish:function(finallyLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.finallyLoc===finallyLoc){this.complete(entry.completion,entry.afterLoc);resetTryEntry(entry);return ContinueSentinel}}},catch:function(tryLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc===tryLoc){var record=entry.completion;if(record.type==="throw"){var thrown=record.arg;resetTryEntry(entry)}return thrown}}throw new Error("illegal catch attempt")},delegateYield:function(iterable,resultName,nextLoc){this.delegate={iterator:values(iterable),resultName:resultName,nextLoc:nextLoc};if(this.method==="next"){this.arg=undefined$1}return ContinueSentinel}};return exports}(typeof module==="object"?module.exports:{});try{regeneratorRuntime=runtime}catch(accidentalStrictMode){if(typeof globalThis==="object"){globalThis.regeneratorRuntime=runtime}}var DB_NAME="thinkingdata";var TABLE_NAME="data";var PlatformProxy=function(){function PlatformProxy(api){_classCallCheck(this,PlatformProxy);this.api=api}return _createClass(PlatformProxy,[{key:"openDb",value:function openDb(){return new Promise((function(resolve,_reject){var request=indexedDB.open(DB_NAME,1);request.onerror=function(_event){resolve(undefined)};request.onsuccess=function(event){resolve(event.target.result)};request.onupgradeneeded=function(event){var db=event.target.result;var objectStore=db.createObjectStore(TABLE_NAME,{keyPath:"id",autoIncrement:true});objectStore.createIndex("key","key",{unique:true})}}))}},{key:"setStorage",value:function(){var _setStorage=_asyncToGenerator(_regenerator().m((function _callee(name,value){var _this=this;return _regenerator().w((function(_context){while(1)switch(_context.n){case 0:if(this.db){_context.n=2;break}_context.n=1;return this.openDb();case 1:this.db=_context.v;case 2:return _context.a(2,new Promise((function(resolve,_reject){var transaction=_this.db.transaction(TABLE_NAME,"readwrite");var store=transaction.objectStore(TABLE_NAME);var index=store.index("key");var request=index.get(name);request.onsuccess=function(event){var result=event.target.result;if(result){result.value=value;var updateRequest=store.put(result);updateRequest.onsuccess=function(){resolve(true)};updateRequest.onerror=function(_event){resolve(false)}}else{var addRequest=store.add({key:name,value:value});addRequest.onsuccess=function(){resolve(true)};addRequest.onerror=function(_event){resolve(false)}}};request.onerror=function(_event){resolve(false)}})))}}),_callee,this)})));function setStorage(_x,_x2){return _setStorage.apply(this,arguments)}return setStorage}()},{key:"getStorage",value:function(){var _getStorage=_asyncToGenerator(_regenerator().m((function _callee2(name){var _this2=this;return _regenerator().w((function(_context2){while(1)switch(_context2.n){case 0:if(this.db){_context2.n=2;break}_context2.n=1;return this.openDb();case 1:this.db=_context2.v;case 2:return _context2.a(2,new Promise((function(resolve,_reject){var transaction=_this2.db.transaction(TABLE_NAME,"readonly");var store=transaction.objectStore(TABLE_NAME);var index=store.index("key");var request=index.get(name);request.onsuccess=function(event){var result=event.target.result;if(result){resolve(result.value)}else{resolve(undefined)}};request.onerror=function(_event){resolve(undefined)}})))}}),_callee2,this)})));function getStorage(_x3){return _getStorage.apply(this,arguments)}return getStorage}()},{key:"getStorageSync",value:function getStorageSync(_name){return{}}},{key:"getAnalyticGlobalData",value:function getAnalyticGlobalData(){return this.api.tdanalytics2024}},{key:"getConfigGlobalData",value:function getConfigGlobalData(){return this.api.tdremoteconfig2024}},{key:"setGlobalData",value:function setGlobalData(data){this.api.tdstrategy2024=data}}],[{key:"createInstance",value:function createInstance(){return new PlatformProxy(window)}}])}();var PlatformAPI=function(){function PlatformAPI(){_classCallCheck(this,PlatformAPI)}return _createClass(PlatformAPI,null,[{key:"_getCurrentPlatform",value:function _getCurrentPlatform(){return this.currentPlatform||(this.currentPlatform=PlatformProxy.createInstance())}},{key:"setStorage",value:function setStorage(name,value){return this._getCurrentPlatform().setStorage(name,value)}},{key:"getStorage",value:function getStorage(name){return this._getCurrentPlatform().getStorage(name)}},{key:"getStorageSync",value:function getStorageSync(name){return this._getCurrentPlatform().getStorageSync(name)}},{key:"getAnalyticGlobalData",value:function getAnalyticGlobalData(){return this._getCurrentPlatform().getAnalyticGlobalData()}},{key:"getConfigGlobalData",value:function getConfigGlobalData(){return this._getCurrentPlatform().getConfigGlobalData()}},{key:"setGlobalData",value:function setGlobalData(data){this._getCurrentPlatform().setGlobalData(data)}}])}();var _={};var ArrayProto=Array.prototype,ObjProto=Object.prototype,slice=ArrayProto.slice,nativeToString=ObjProto.toString,nativeHasOwnProperty=Object.prototype.hasOwnProperty,nativeForEach=ArrayProto.forEach,nativeIsArray=Array.isArray,breaker={};_.checkSettings=function(config){if(!config)return undefined;if(_.isStrEmpty(config.appId)||_.isStrEmpty(config.serverUrl))return undefined;config.appId=_.checkAppId(config.appId);config.templateCode=Config.STRATEGY_TEMPLATE_CODE;logger.enabled=config.enableLog;return config};_.checkAppId=function(appId){appId=appId.replace(/\s*/g,"");return appId};_.isStrEmpty=function(str){return!str||str.length===0};_.isDate=function(obj){return nativeToString.call(obj)==="[object Date]"};_.isString=function(obj){return nativeToString.call(obj)==="[object String]"};_.isBoolean=function(obj){return nativeToString.call(obj)==="[object Boolean]"};_.isNumber=function(obj){return nativeToString.call(obj)==="[object Number]"&&/[\d\.]+/.test(String(obj))};_.isObject=function(obj){return nativeToString.call(obj)==="[object Object]"&&obj!==null&&obj!==undefined};_.isArray=nativeIsArray||function(obj){return nativeToString.call(obj)==="[object Array]"};_.stringToBoolean=function(str){switch(str.toLowerCase().trim()){case"true":return true;case"false":return false;default:return undefined}};_.toBoolean=function(value){if(_.isBoolean(value)){return value}else if(_.isString(value)){return _.stringToBoolean(value)}return undefined};_.each=function(obj,iterator,context){if(obj===null||obj===undefined){return false}if(nativeForEach&&obj.forEach===nativeForEach){obj.forEach(iterator,context)}else if(obj.length===+obj.length){for(var i=0,l=obj.length;i<l;i++){if(i in obj&&iterator.call(context,obj[i],i,obj)===breaker){return false}}}else{for(var key in obj){if(nativeHasOwnProperty.call(obj,key)){if(iterator.call(context,obj[key],key,obj)===breaker){return false}}}}};_.extend=function(obj){_.each(slice.call(arguments,1),(function(source){for(var prop in source){if(source[prop]!==void 0){obj[prop]=source[prop]}}}));return obj};_.convertToTimestamp=function(dateTimeStr,zoneOffset){if(!dateTimeStr)return Number.NaN;var _dateTimeStr$split=dateTimeStr.split(" "),_dateTimeStr$split2=_slicedToArray(_dateTimeStr$split,2),date=_dateTimeStr$split2[0],timeWithMilliseconds=_dateTimeStr$split2[1];if(!date||!timeWithMilliseconds)return Number.NaN;var _date$split$map=date.split("-").map(Number),_date$split$map2=_slicedToArray(_date$split$map,3),year=_date$split$map2[0],month=_date$split$map2[1],day=_date$split$map2[2];var _timeWithMilliseconds=timeWithMilliseconds.split("."),_timeWithMilliseconds2=_slicedToArray(_timeWithMilliseconds,2),time=_timeWithMilliseconds2[0],milliseconds=_timeWithMilliseconds2[1];var _time$split$map=time.split(":").map(Number),_time$split$map2=_slicedToArray(_time$split$map,3),hour=_time$split$map2[0],minute=_time$split$map2[1],second=_time$split$map2[2];var ms=milliseconds?Number(milliseconds):0;if(isNaN(year)||isNaN(month)||isNaN(day)||isNaN(hour)||isNaN(minute)||isNaN(second)||isNaN(ms)){return Number.NaN}var dateUTC=new Date(Date.UTC(year,month-1,day,hour,minute,second,ms));var localTime=new Date(dateUTC.getTime()-zoneOffset*60*6e4);return localTime.getTime()};_.convertToTimestamp1=function(dateTimeStr,zoneOffset){if(!dateTimeStr)return Number.NaN;var _dateTimeStr$split3=dateTimeStr.split(" "),_dateTimeStr$split4=_slicedToArray(_dateTimeStr$split3,2),date=_dateTimeStr$split4[0],time=_dateTimeStr$split4[1];if(!date||!time)return Number.NaN;var _date$split$map3=date.split("-").map(Number),_date$split$map4=_slicedToArray(_date$split$map3,3),year=_date$split$map4[0],month=_date$split$map4[1],day=_date$split$map4[2];var _time$split$map3=time.split(":").map(Number),_time$split$map4=_slicedToArray(_time$split$map3,3),hour=_time$split$map4[0],minute=_time$split$map4[1],second=_time$split$map4[2];if(isNaN(year)||isNaN(month)||isNaN(day)||isNaN(hour)||isNaN(minute)||isNaN(second)){return Number.NaN}var dateUTC=new Date(Date.UTC(year,month-1,day,hour,minute,second));var localTime=new Date(dateUTC.getTime()-zoneOffset*60*6e4);return localTime.getTime()};_.generateUniqueId=function(){return Date.now().toString(36)+Math.random().toString(36).substring(2)};_.buildEventNameRule=function(eventName){return{calcuSymbol:"C00",columnName:Config.EVENT_NAME_KEY,columnType:Config.STR_TYPE,ftv:[eventName]}};_.jsonToFacts=function(eventJson){var facts={};_.each(eventJson,(function(value,key){if(key==="properties"){_.each(value,(function(value,key){facts[key.toLowerCase()]=value}))}else{facts[key]=value}}));return facts};_.getTimeCycleUnit=function(unit){if(!unit)return undefined;return unit.toLowerCase()};_.formatDate=function(d){function pad(n){return n<10?"0"+n:n}function secondPad(n){if(n<100&&n>9)return"0"+n;else if(n<10)return"00"+n;else return n}return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate())+" "+pad(d.getHours())+":"+pad(d.getMinutes())+":"+pad(d.getSeconds())+"."+secondPad(d.getMilliseconds())};_.getFormatDataByLog=function(timeStamp){if(logger.enabled){return _.formatDate(new Date(timeStamp))}else{return timeStamp}};_.parseStartTime=function(startTime){if(!startTime){return{hour:0,minute:0}}var _startTime$split$map=startTime.split(":").map(Number),_startTime$split$map2=_slicedToArray(_startTime$split$map,2),hour=_startTime$split$map2[0],minute=_startTime$split$map2[1];if(isNaN(hour)||isNaN(minute)){return{hour:0,minute:0}}return{hour:hour,minute:minute}};_.UUID=function(){var visitTime=Date.now();var uuid=""+String(Math.random()).replace(".","").slice(1,11)+"-"+visitTime;return uuid};_.isFunction=function(f){try{return typeof f==="function"}catch(x){return false}};var logger=_typeof(logger)==="object"?logger:{};logger.info=function(){if((typeof console==="undefined"?"undefined":_typeof(console))==="object"&&console.log&&logger.enabled){try{arguments[0]="[ThinkingData] Info: "+arguments[0];if(logger.listener){logger.listener(arguments[0])}return console.log.apply(console,arguments)}catch(e){if(logger.listener){logger.listener(arguments[0])}console.log("[ThinkingData] Info: "+arguments[0])}}};logger.info1=function(prefix,obj){if(logger.enabled){if(logger.listener){logger.listener(prefix+JSON.stringify(obj))}logger.info(prefix+JSON.stringify(obj,null,4))}};logger.warn=function(){if((typeof console==="undefined"?"undefined":_typeof(console))==="object"&&console.log&&logger.enabled){try{arguments[0]="[ThinkingData] Warning: "+arguments[0];return console.warn.apply(console,arguments)}catch(e){console.warn("[ThinkingData] Warning: "+arguments[0])}}};var TABLE_NAME_STRATEGY_INFO="t_strategy_info";var KEY_CLIENT_VALUE="client_value";var TDClientValueManager={addClientParams:function(){var _addClientParams=_asyncToGenerator(_regenerator().m((function _callee(params){return _regenerator().w((function(_context){while(1)switch(_context.n){case 0:if(params){_context.n=1;break}return _context.a(2);case 1:_context.n=2;return this.loadLocalClientParams();case 2:_.extend(this.mClientValueParams,params);_context.n=3;return PlatformAPI.setStorage(TABLE_NAME_STRATEGY_INFO,_defineProperty({},KEY_CLIENT_VALUE,this.mClientValueParams));case 3:return _context.a(2)}}),_callee,this)})));function addClientParams(_x){return _addClientParams.apply(this,arguments)}return addClientParams}(),removeClientParam:function(){var _removeClientParam=_asyncToGenerator(_regenerator().m((function _callee2(key){return _regenerator().w((function(_context2){while(1)switch(_context2.n){case 0:if(!(key===undefined)){_context2.n=1;break}return _context2.a(2);case 1:_context2.n=2;return this.loadLocalClientParams();case 2:delete this.mClientValueParams[key];_context2.n=3;return PlatformAPI.setStorage(TABLE_NAME_STRATEGY_INFO,_defineProperty({},KEY_CLIENT_VALUE,this.mClientValueParams));case 3:return _context2.a(2)}}),_callee2,this)})));function removeClientParam(_x2){return _removeClientParam.apply(this,arguments)}return removeClientParam}(),get:function get(key){if(key===undefined)return undefined;if(!this.mClientValueParams){var strategyInfo=PlatformAPI.getStorageSync(TABLE_NAME_STRATEGY_INFO);if(strategyInfo){this.mClientValueParams=strategyInfo[KEY_CLIENT_VALUE]}}if(!this.mClientValueParams){this.mClientValueParams={}}return this.mClientValueParams[key]},loadLocalClientParams:function(){var _loadLocalClientParams=_asyncToGenerator(_regenerator().m((function _callee3(){var strategyInfo;return _regenerator().w((function(_context3){while(1)switch(_context3.n){case 0:if(this.mClientValueParams){_context3.n=2;break}_context3.n=1;return PlatformAPI.getStorage(TABLE_NAME_STRATEGY_INFO);case 1:strategyInfo=_context3.v;if(strategyInfo){this.mClientValueParams=strategyInfo[KEY_CLIENT_VALUE]}case 2:if(!this.mClientValueParams){this.mClientValueParams={}}case 3:return _context3.a(2)}}),_callee3,this)})));function loadLocalClientParams(){return _loadLocalClientParams.apply(this,arguments)}return loadLocalClientParams}()};var TDAnalytics=PlatformAPI.getAnalyticGlobalData();var TDRemoteConfig=PlatformAPI.getConfigGlobalData();var AnalyticUtil={};var FAIL=5;var SUCCESS=6;var FREQUENCY_CONTROL=2;var FATIGUE_CONTROL=3;var PUSH_ID_IS_NULL=13;var WITHOUT_SPLIT_FLOW_ID=12;var RACE_SKIP_PUSH=10;var SAMPLE=8;var EXP_SKIP_PUSH=9;var TARGET_USER_IS_FALSE=101;var CLIENT_QP_IS_FALSE=102;var TRIGGER_EVENT_NAME="te_ops_client_trigger_record";var CLIENT_DEBUG_EVENT="te_ops_client_debug_test";var RISK_RECORD_EVENT="te_ops_client_risk_record";var CHANNEL_TEST_EVENT="ta_channel_test_event";var eventBlackList=[TRIGGER_EVENT_NAME,CLIENT_DEBUG_EVENT,RISK_RECORD_EVENT];var eventWhiteList=[CHANNEL_TEST_EVENT];AnalyticUtil.getCurrentTimeStamp=function(){return Date.now()};AnalyticUtil.getCurrentDate=function(){return new Date(Date.now())};AnalyticUtil.getAccountId=function(appId){if(!TDAnalytics)return"";return TDAnalytics.getAccountId(appId)};AnalyticUtil.getDistinctId=function(appId){if(!TDAnalytics)return"";return TDAnalytics.getDistinctId(appId)};AnalyticUtil.getClientUserId=function(){var _ref=_asyncToGenerator(_regenerator().m((function _callee(appId){var userList,aid,did,i;return _regenerator().w((function(_context){while(1)switch(_context.n){case 0:_context.n=1;return PlatformAPI.getStorage(appId+"_users");case 1:userList=_context.v;if(!_.isArray(userList)){_context.n=6;break}aid=this.getAccountId(appId);did=this.getDistinctId(appId);i=0;case 2:if(!(i<userList.length)){_context.n=6;break}if(!aid){_context.n=4;break}if(!(aid===userList[i].accountId)){_context.n=3;break}return _context.a(2,userList[i].clientUserId);case 3:_context.n=5;break;case 4:if(!(did===userList[i].distinctId)){_context.n=5;break}return _context.a(2,userList[i].clientUserId);case 5:i++;_context.n=2;break;case 6:return _context.a(2,"")}}),_callee,this)})));return function(_x){return _ref.apply(this,arguments)}}();AnalyticUtil.trackTriggerEvent=function(triggerRecord){if(!TDAnalytics)return;if(!triggerRecord.isTestTask&&(triggerRecord.status===TARGET_USER_IS_FALSE||triggerRecord.status===CLIENT_QP_IS_FALSE))return;TDAnalytics.trackInternal({eventName:TRIGGER_EVENT_NAME,properties:{"#client_user_id":triggerRecord.clientUserId,"#ops_task_id":triggerRecord.taskId,"#ops_push_id":triggerRecord.pushId,"#ops_exp_group_id":triggerRecord.expGroupId,"#ops_trigger_time":triggerRecord.triggerTime,"#ops_actual_push_time":triggerRecord.actualPushTime,"#ops_push_status":triggerRecord.status},debugMode:triggerRecord.isTestTask?"debugOnly":"none"},triggerRecord.appId);TDAnalytics.flush()};AnalyticUtil.isBlackEvent=function(eventName){return eventBlackList.includes(eventName)};AnalyticUtil.isWhiteEvent=function(eventName){return eventWhiteList.includes(eventName)};AnalyticUtil.trackClientDebugEvent=function(appId,taskIdList){if(!TDAnalytics)return;if(!_.isArray(AnalyticUtil.hasTrackTestTaskIds)){AnalyticUtil.hasTrackTestTaskIds=[]}var list=[];for(var i=0;i<taskIdList.length;i++){if(!AnalyticUtil.hasTrackTestTaskIds.includes(taskIdList[i])){AnalyticUtil.hasTrackTestTaskIds.push(taskIdList[i]);list.push(taskIdList[i])}}if(list.length<=0)return;TDAnalytics.trackInternal({eventName:CLIENT_DEBUG_EVENT,properties:{"#rcc_pull_result":{business_type:1,is_pull_success:true,ops_task_id_list:list}},debugMode:"debugOnly"},appId)};AnalyticUtil.buildAnalyticPresetFacts=function(appId){if(!TDAnalytics)return{};var presetProperties=TDAnalytics.getPresetProperties(appId).toEventPresetProperties();presetProperties["#account_id"]=this.getAccountId(appId);presetProperties["#distinct_id"]=this.getDistinctId(appId);return presetProperties};AnalyticUtil.getStrategyInfo=function(appId){if(!TDRemoteConfig)return[];return TDRemoteConfig.getData(appId,Config.STRATEGY_TEMPLATE_CODE).get("td_strategy_info").arrayValue()};AnalyticUtil.getConfigValue=function(key){return TDClientValueManager.get(key)};var TABLE_NAME_TASK="t_task_";var TABLE_NAME_EVENT="t_event";var TABLE_NAME_LIMIT="t_task_trigger";var TABLE_NAME_TOUCH_LIMIT="t_channel_trigger";var TABLE_NAME_STATUS="t_task_status";var getTasks=function(){var _ref=_asyncToGenerator(_regenerator().m((function _callee(appId,clientUserId){var tasks,map,i,t;return _regenerator().w((function(_context){while(1)switch(_context.n){case 0:_context.n=1;return PlatformAPI.getStorage(TABLE_NAME_TASK+appId);case 1:tasks=_context.v;if(!tasks){tasks=[]}map={};for(i=0;i<tasks.length;i++){t=tasks[i];if(t.clientUserId===clientUserId&&t.task){map[t.taskId]=t}}return _context.a(2,map)}}),_callee)})));return function getTasks(_x,_x2){return _ref.apply(this,arguments)}}();var updateTask=function(){var _ref2=_asyncToGenerator(_regenerator().m((function _callee2(appId,clientUserId,taskList){var tasks;return _regenerator().w((function(_context2){while(1)switch(_context2.n){case 0:_context2.n=1;return PlatformAPI.getStorage(TABLE_NAME_TASK+appId);case 1:tasks=_context2.v;if(!tasks){tasks=[]}tasks=tasks.filter((function(item){return item.clientUserId!==clientUserId}));_context2.n=2;return PlatformAPI.setStorage(TABLE_NAME_TASK+appId,tasks.concat(taskList));case 2:return _context2.a(2)}}),_callee2)})));return function updateTask(_x3,_x4,_x5){return _ref2.apply(this,arguments)}}();var deleteTaskByLimit=function(){var _ref3=_asyncToGenerator(_regenerator().m((function _callee3(appId,limit){var tasks,count;return _regenerator().w((function(_context3){while(1)switch(_context3.n){case 0:_context3.n=1;return PlatformAPI.getStorage(TABLE_NAME_TASK+appId);case 1:tasks=_context3.v;if(!(_.isArray(tasks)&&tasks.length>limit)){_context3.n=2;break}count=tasks.length-limit;tasks.splice(0,count);_context3.n=2;return PlatformAPI.setStorage(TABLE_NAME_TASK+appId,tasks);case 2:return _context3.a(2)}}),_callee3)})));return function deleteTaskByLimit(_x6,_x7){return _ref3.apply(this,arguments)}}();var queryTriggerResult=function(){var _ref4=_asyncToGenerator(_regenerator().m((function _callee4(){var events;return _regenerator().w((function(_context4){while(1)switch(_context4.n){case 0:_context4.n=1;return PlatformAPI.getStorage(TABLE_NAME_EVENT);case 1:events=_context4.v;if(!_.isArray(events)){_context4.n=2;break}return _context4.a(2,events);case 2:return _context4.a(2,[])}}),_callee4)})));return function queryTriggerResult(){return _ref4.apply(this,arguments)}}();var insertTriggerResult=function(){var _ref5=_asyncToGenerator(_regenerator().m((function _callee5(lists){return _regenerator().w((function(_context5){while(1)switch(_context5.n){case 0:_context5.n=1;return PlatformAPI.setStorage(TABLE_NAME_EVENT,lists);case 1:return _context5.a(2)}}),_callee5)})));return function insertTriggerResult(_x8){return _ref5.apply(this,arguments)}}();var addTriggerResult=function(){var _ref6=_asyncToGenerator(_regenerator().m((function _callee6(info){var events;return _regenerator().w((function(_context6){while(1)switch(_context6.n){case 0:_context6.n=1;return PlatformAPI.getStorage(TABLE_NAME_EVENT);case 1:events=_context6.v;if(!events){events=[]}events.push(info);_context6.n=2;return PlatformAPI.setStorage(TABLE_NAME_EVENT,events);case 2:return _context6.a(2)}}),_callee6)})));return function addTriggerResult(_x9){return _ref6.apply(this,arguments)}}();var deleteTriggerResult=function(){var _ref7=_asyncToGenerator(_regenerator().m((function _callee7(info){var events;return _regenerator().w((function(_context7){while(1)switch(_context7.n){case 0:_context7.n=1;return PlatformAPI.getStorage(TABLE_NAME_EVENT);case 1:events=_context7.v;if(_.isArray(events)){events=events.filter((function(item){return!(info.appId===item.appId&&info.clientUserId===item.clientUserId&&info.taskId===item.taskId)}))}_context7.n=2;return PlatformAPI.setStorage(TABLE_NAME_EVENT,events);case 2:return _context7.a(2)}}),_callee7)})));return function deleteTriggerResult(_x0){return _ref7.apply(this,arguments)}}();var deleteTriggerResultLimit=function(){var _ref8=_asyncToGenerator(_regenerator().m((function _callee8(limit){var events,count;return _regenerator().w((function(_context8){while(1)switch(_context8.n){case 0:_context8.n=1;return PlatformAPI.getStorage(TABLE_NAME_EVENT);case 1:events=_context8.v;if(!(_.isArray(events)&&events.length>limit)){_context8.n=2;break}count=events.length-limit;events.splice(0,count);_context8.n=2;return PlatformAPI.setStorage(TABLE_NAME_EVENT,events);case 2:return _context8.a(2)}}),_callee8)})));return function deleteTriggerResultLimit(_x1){return _ref8.apply(this,arguments)}}();var getFrequencyLimitCount=function(){var _ref9=_asyncToGenerator(_regenerator().m((function _callee9(info){var triggers;return _regenerator().w((function(_context9){while(1)switch(_context9.n){case 0:_context9.n=1;return PlatformAPI.getStorage(TABLE_NAME_LIMIT);case 1:triggers=_context9.v;if(_.isArray(triggers)){_context9.n=2;break}return _context9.a(2,0);case 2:triggers=triggers.filter((function(item){return info.appId===item.appId&&info.clientUserId===item.clientUserId&&info.taskId===item.taskId&&item.triggerTime>=info.start&&item.triggerTime<=info.end}));return _context9.a(2,triggers.length)}}),_callee9)})));return function getFrequencyLimitCount(_x10){return _ref9.apply(this,arguments)}}();var addFrequencyLimit=function(){var _ref0=_asyncToGenerator(_regenerator().m((function _callee0(info){var triggers;return _regenerator().w((function(_context0){while(1)switch(_context0.n){case 0:_context0.n=1;return PlatformAPI.getStorage(TABLE_NAME_LIMIT);case 1:triggers=_context0.v;if(!_.isArray(triggers)){triggers=[]}triggers.push(info);_context0.n=2;return PlatformAPI.setStorage(TABLE_NAME_LIMIT,triggers);case 2:return _context0.a(2)}}),_callee0)})));return function addFrequencyLimit(_x11){return _ref0.apply(this,arguments)}}();var deleteFrequencyLimit=function(){var _ref1=_asyncToGenerator(_regenerator().m((function _callee1(info){var triggers;return _regenerator().w((function(_context1){while(1)switch(_context1.n){case 0:_context1.n=1;return PlatformAPI.getStorage(TABLE_NAME_LIMIT);case 1:triggers=_context1.v;if(_.isArray(triggers)){_context1.n=2;break}return _context1.a(2);case 2:triggers=triggers.filter((function(item){return!(info.appId===item.appId&&info.clientUserId===item.clientUserId&&info.taskId===item.taskId)}));_context1.n=3;return PlatformAPI.setStorage(TABLE_NAME_LIMIT,triggers);case 3:return _context1.a(2)}}),_callee1)})));return function deleteFrequencyLimit(_x12){return _ref1.apply(this,arguments)}}();var deleteFrequencyByLimit=function(){var _ref10=_asyncToGenerator(_regenerator().m((function _callee10(limit){var triggers,count;return _regenerator().w((function(_context10){while(1)switch(_context10.n){case 0:_context10.n=1;return PlatformAPI.getStorage(TABLE_NAME_LIMIT);case 1:triggers=_context10.v;if(!(_.isArray(triggers)&&triggers.length>limit)){_context10.n=2;break}count=triggers.length-limit;triggers.splice(0,count);_context10.n=2;return PlatformAPI.setStorage(TABLE_NAME_LIMIT,triggers);case 2:return _context10.a(2)}}),_callee10)})));return function deleteFrequencyByLimit(_x13){return _ref10.apply(this,arguments)}}();var getTouchLimitCount=function(){var _ref11=_asyncToGenerator(_regenerator().m((function _callee11(info){var touchs;return _regenerator().w((function(_context11){while(1)switch(_context11.n){case 0:_context11.n=1;return PlatformAPI.getStorage(TABLE_NAME_TOUCH_LIMIT);case 1:touchs=_context11.v;if(_.isArray(touchs)){_context11.n=2;break}return _context11.a(2,0);case 2:touchs=touchs.filter((function(item){return info.appId===item.appId&&info.pushId===item.pushId&&info.channelId===item.channelId&&item.triggerTime>=info.start&&item.triggerTime<=info.end}));return _context11.a(2,touchs.length)}}),_callee11)})));return function getTouchLimitCount(_x14){return _ref11.apply(this,arguments)}}();var addTouchLimit=function(){var _ref12=_asyncToGenerator(_regenerator().m((function _callee12(info){var touchs;return _regenerator().w((function(_context12){while(1)switch(_context12.n){case 0:_context12.n=1;return PlatformAPI.getStorage(TABLE_NAME_TOUCH_LIMIT);case 1:touchs=_context12.v;if(!_.isArray(touchs)){touchs=[]}touchs.push(info);_context12.n=2;return PlatformAPI.setStorage(TABLE_NAME_TOUCH_LIMIT,touchs);case 2:return _context12.a(2)}}),_callee12)})));return function addTouchLimit(_x15){return _ref12.apply(this,arguments)}}();var deleteTouchLimitByTime=function(){var _ref14=_asyncToGenerator(_regenerator().m((function _callee14(day){var touchs,invalidTime;return _regenerator().w((function(_context14){while(1)switch(_context14.n){case 0:_context14.n=1;return PlatformAPI.getStorage(TABLE_NAME_TOUCH_LIMIT);case 1:touchs=_context14.v;if(!_.isArray(touchs)){_context14.n=2;break}invalidTime=AnalyticUtil.getCurrentTimeStamp()-day*24*60*60*1e3;touchs=touchs.filter((function(item){return item.triggerTime>invalidTime}));_context14.n=2;return PlatformAPI.setStorage(TABLE_NAME_TOUCH_LIMIT,touchs);case 2:return _context14.a(2)}}),_callee14)})));return function deleteTouchLimitByTime(_x17){return _ref14.apply(this,arguments)}}();var updateTaskStatus=function(){var _ref15=_asyncToGenerator(_regenerator().m((function _callee15(info){var status,isFind,i,s;return _regenerator().w((function(_context15){while(1)switch(_context15.n){case 0:_context15.n=1;return PlatformAPI.getStorage(TABLE_NAME_STATUS);case 1:status=_context15.v;if(!_.isArray(status)){status=[]}isFind=false;i=0;case 2:if(!(i<status.length)){_context15.n=4;break}s=status[i];if(!(s.appId===info.appId&&s.clientUserId===info.clientUserId)){_context15.n=3;break}s.status=info.status;isFind=true;return _context15.a(3,4);case 3:i++;_context15.n=2;break;case 4:if(!isFind){status.push(info)}_context15.n=5;return PlatformAPI.setStorage(TABLE_NAME_STATUS,status);case 5:return _context15.a(2)}}),_callee15)})));return function updateTaskStatus(_x18){return _ref15.apply(this,arguments)}}();var getTaskStatus=function(){var _ref16=_asyncToGenerator(_regenerator().m((function _callee16(info){var status,i,s;return _regenerator().w((function(_context16){while(1)switch(_context16.n){case 0:_context16.n=1;return PlatformAPI.getStorage(TABLE_NAME_STATUS);case 1:status=_context16.v;if(_.isArray(status)){_context16.n=2;break}return _context16.a(2,false);case 2:i=0;case 3:if(!(i<status.length)){_context16.n=5;break}s=status[i];if(!(s.appId===info.appId&&s.clientUserId===info.clientUserId)){_context16.n=4;break}return _context16.a(2,s.status);case 4:i++;_context16.n=3;break;case 5:return _context16.a(2,false)}}),_callee16)})));return function getTaskStatus(_x19){return _ref16.apply(this,arguments)}}();var CompositeRule=function(){function CompositeRule(){_classCallCheck(this,CompositeRule);this.rules=[]}return _createClass(CompositeRule,[{key:"addRule",value:function addRule(rule){if(rule){this.rules.push(rule)}}},{key:"evaluate",value:function evaluate(_facts){return false}}])}();var ActivationRuleGroup=function(_CompositeRule){function ActivationRuleGroup(){_classCallCheck(this,ActivationRuleGroup);return _callSuper(this,ActivationRuleGroup)}_inherits(ActivationRuleGroup,_CompositeRule);return _createClass(ActivationRuleGroup,[{key:"evaluate",value:function(){var _evaluate=_asyncToGenerator(_regenerator().m((function _callee(facts){var i,result;return _regenerator().w((function(_context){while(1)switch(_context.n){case 0:i=0;case 1:if(!(i<this.rules.length)){_context.n=4;break}_context.n=2;return this.rules[i].evaluate(facts);case 2:result=_context.v;if(!result){_context.n=3;break}return _context.a(2,true);case 3:i++;_context.n=1;break;case 4:return _context.a(2,false)}}),_callee,this)})));function evaluate(_x){return _evaluate.apply(this,arguments)}return evaluate}()}])}(CompositeRule);var UnitRuleGroup=function(_CompositeRule2){function UnitRuleGroup(){_classCallCheck(this,UnitRuleGroup);return _callSuper(this,UnitRuleGroup)}_inherits(UnitRuleGroup,_CompositeRule2);return _createClass(UnitRuleGroup,[{key:"evaluate",value:function(){var _evaluate2=_asyncToGenerator(_regenerator().m((function _callee2(facts){var i,result;return _regenerator().w((function(_context2){while(1)switch(_context2.n){case 0:if(!(this.rules.length<=0)){_context2.n=1;break}return _context2.a(2,false);case 1:i=0;case 2:if(!(i<this.rules.length)){_context2.n=5;break}_context2.n=3;return this.rules[i].evaluate(facts);case 3:result=_context2.v;if(result){_context2.n=4;break}return _context2.a(2,false);case 4:i++;_context2.n=2;break;case 5:return _context2.a(2,true)}}),_callee2,this)})));function evaluate(_x2){return _evaluate2.apply(this,arguments)}return evaluate}()}])}(CompositeRule);var PropertiesRule=function(){function PropertiesRule(ruleJson){_classCallCheck(this,PropertiesRule);this.ruleJson=ruleJson;this.columnName=ruleJson.columnName;this.columnType=ruleJson.columnType;this.symbol=ruleJson.calcuSymbol;this.ftv=ruleJson.ftv?ruleJson.ftv:[]}return _createClass(PropertiesRule,[{key:"evaluate",value:function evaluate(facts){return this.isCondition(facts)}},{key:"isCondition",value:function isCondition(facts){if(!this.columnName||!this.columnType||!this.symbol||!this.ftv)return false;var value=facts[this.columnName];if(value===undefined){var isPreset=this.isPresetProperties();logger.info("CalcuSymbol: "+this.symbol+" Value is null and ColumnName: "+this.columnName+" is Preset: "+isPreset);return isPreset}var isWhen=this.executeWhen(value,facts);logger.info("CalcuSymbol: "+this.symbol+" ColumnName: "+this.columnName+" Value: "+value+" Ftv:"+this.ftv+" Result: "+isWhen);return isWhen}},{key:"executeWhen",value:function executeWhen(_value,_facts){return false}},{key:"isPresetProperties",value:function isPresetProperties(){return this.columnName.includes("#")}}])}();var EQRule=function(_PropertiesRule){function EQRule(ruleJson){_classCallCheck(this,EQRule);return _callSuper(this,EQRule,[ruleJson])}_inherits(EQRule,_PropertiesRule);return _createClass(EQRule,[{key:"executeWhen",value:function executeWhen(value,_facts){if(this.columnType===Config.STR_TYPE||this.columnType===Config.DATE_TYPE){var v=value.toString();for(var i=0;i<this.ftv.length;i++){var t=String(this.ftv[i]);if(v===t){return true}}}else if(this.columnType===Config.INTEGER_TYPE||this.columnType===Config.BIGINT_TYPE||this.columnType===Config.DOUBLE_TYPE||this.columnType===Config.DECIMAL_TYPE){var _v=Number(value);for(var _i=0;_i<this.ftv.length;_i++){var _t=Number(this.ftv[_i]);if(_v===_t){return true}}}else if(this.columnType===Config.BOOLEAN_TYPE){var _v2=_.toBoolean(value);for(var _i2=0;_i2<this.ftv.length;_i2++){var _t2=_.toBoolean(this.ftv[_i2]);if(_v2===_t2){return true}}}else if(this.columnType===Config.ARRAY_VARCHAR_TYPE){var _v3=value.toString();for(var _i3=0;_i3<this.ftv.length;_i3++){var _t3=this.ftv[_i3].toString();if(_v3===_t3){return true}}}return false}}])}(PropertiesRule);var UN_EQRule=function(_PropertiesRule2){function UN_EQRule(ruleJson){_classCallCheck(this,UN_EQRule);return _callSuper(this,UN_EQRule,[ruleJson])}_inherits(UN_EQRule,_PropertiesRule2);return _createClass(UN_EQRule,[{key:"executeWhen",value:function executeWhen(value,_facts){if(this.columnType===Config.STR_TYPE||this.columnType===Config.DATE_TYPE){var v=value.toString();var isFind=false;for(var i=0;i<this.ftv.length;i++){var t=String(this.ftv[i]);if(v===t){isFind=true;break}}return!isFind}else if(this.columnType===Config.INTEGER_TYPE||this.columnType===Config.BIGINT_TYPE||this.columnType===Config.DOUBLE_TYPE||this.columnType===Config.DECIMAL_TYPE){var _v4=Number(value);var _isFind=false;for(var _i4=0;_i4<this.ftv.length;_i4++){var _t4=Number(this.ftv[_i4]);if(_v4===_t4){_isFind=true;break}}return!_isFind}else if(this.columnType===Config.BOOLEAN_TYPE){var _v5=_.toBoolean(value);var _isFind2=false;for(var _i5=0;_i5<this.ftv.length;_i5++){var _t5=_.toBoolean(this.ftv[_i5]);if(_v5===_t5){_isFind2=true;break}}return!_isFind2}return false}}])}(PropertiesRule);var LTRule=function(_PropertiesRule3){function LTRule(ruleJson){_classCallCheck(this,LTRule);return _callSuper(this,LTRule,[ruleJson])}_inherits(LTRule,_PropertiesRule3);return _createClass(LTRule,[{key:"executeWhen",value:function executeWhen(value,_facts){if(this.ftv.length>0){if(this.columnType===Config.INTEGER_TYPE||this.columnType===Config.BIGINT_TYPE||this.columnType===Config.DOUBLE_TYPE||this.columnType===Config.DECIMAL_TYPE){var v=Number(value);var tValue=Number(this.ftv[0]);return v<tValue}}return false}}])}(PropertiesRule);var LTERule=function(_PropertiesRule4){function LTERule(ruleJson,zoneOffset){var _this;_classCallCheck(this,LTERule);_this=_callSuper(this,LTERule,[ruleJson]);_this.zoneOffset=zoneOffset;return _this}_inherits(LTERule,_PropertiesRule4);return _createClass(LTERule,[{key:"executeWhen",value:function executeWhen(value,facts){if(this.ftv.length>0){if(this.columnType===Config.INTEGER_TYPE||this.columnType===Config.BIGINT_TYPE||this.columnType===Config.DOUBLE_TYPE||this.columnType===Config.DECIMAL_TYPE){var v=Number(value);var tValue=Number(this.ftv[0]);return v<=tValue}else if(this.columnType===Config.DATE_TYPE){var _v6=value.toString();var eventTimeZoneOffset=facts[Config.EVENT_ZONE_OFFSET];var timeStamp=_.convertToTimestamp(_v6,eventTimeZoneOffset);var _tValue=_.convertToTimestamp(this.ftv[0],this.zoneOffset);if(isNaN(timeStamp)||isNaN(_tValue))return false;return timeStamp<=_tValue}}return false}}])}(PropertiesRule);var GTRule=function(_PropertiesRule5){function GTRule(ruleJson){_classCallCheck(this,GTRule);return _callSuper(this,GTRule,[ruleJson])}_inherits(GTRule,_PropertiesRule5);return _createClass(GTRule,[{key:"executeWhen",value:function executeWhen(value,_facts){if(this.ftv.length>0){if(this.columnType===Config.INTEGER_TYPE||this.columnType===Config.BIGINT_TYPE||this.columnType===Config.DOUBLE_TYPE||this.columnType===Config.DECIMAL_TYPE){var v=Number(value);var tValue=Number(this.ftv[0]);return v>tValue}}return false}}])}(PropertiesRule);var GTERule=function(_PropertiesRule6){function GTERule(ruleJson,zoneOffset){var _this2;_classCallCheck(this,GTERule);_this2=_callSuper(this,GTERule,[ruleJson]);_this2.zoneOffset=zoneOffset;return _this2}_inherits(GTERule,_PropertiesRule6);return _createClass(GTERule,[{key:"executeWhen",value:function executeWhen(value,facts){if(this.ftv.length>0){if(this.columnType===Config.INTEGER_TYPE||this.columnType===Config.BIGINT_TYPE||this.columnType===Config.DOUBLE_TYPE||this.columnType===Config.DECIMAL_TYPE){var v=Number(value);var tValue=Number(this.ftv[0]);return v>=tValue}else if(this.columnType===Config.DATE_TYPE){var _v7=value.toString();var eventTimeZoneOffset=facts[Config.EVENT_ZONE_OFFSET];var timeStamp=_.convertToTimestamp(_v7,eventTimeZoneOffset);var _tValue2=_.convertToTimestamp(this.ftv[0],this.zoneOffset);if(isNaN(timeStamp)||isNaN(_tValue2))return false;return timeStamp>=_tValue2}}return false}}])}(PropertiesRule);var NOT_NULLRule=function(_PropertiesRule7){function NOT_NULLRule(ruleJson){_classCallCheck(this,NOT_NULLRule);return _callSuper(this,NOT_NULLRule,[ruleJson])}_inherits(NOT_NULLRule,_PropertiesRule7);return _createClass(NOT_NULLRule,[{key:"executeWhen",value:function executeWhen(_value,_facts){return true}}])}(PropertiesRule);var NULLRule=function(_PropertiesRule8){function NULLRule(ruleJson){_classCallCheck(this,NULLRule);return _callSuper(this,NULLRule,[ruleJson])}_inherits(NULLRule,_PropertiesRule8);return _createClass(NULLRule,[{key:"evaluate",value:function evaluate(facts){if(!this.columnName||!this.columnType||!this.symbol||!this.ftv)return false;var value=facts[this.columnName];var isWhen=value===undefined;logger.info("CalcuSymbol: "+this.symbol+" ColumnName: "+this.columnName+" Value: "+value+" Ftv:"+this.ftv+" Result: "+isWhen);return isWhen}}])}(PropertiesRule);var RANGERule=function(_PropertiesRule9){function RANGERule(ruleJson,zoneOffset){var _this3;_classCallCheck(this,RANGERule);_this3=_callSuper(this,RANGERule,[ruleJson]);_this3.zoneOffset=zoneOffset;return _this3}_inherits(RANGERule,_PropertiesRule9);return _createClass(RANGERule,[{key:"executeWhen",value:function executeWhen(value,facts){if(this.ftv.length>=2){if(this.columnType===Config.INTEGER_TYPE||this.columnType===Config.BIGINT_TYPE||this.columnType===Config.DOUBLE_TYPE||this.columnType===Config.DECIMAL_TYPE){var v=Number(value);var tValue1=Number(this.ftv[0]);var tValue2=Number(this.ftv[1]);return v>=tValue1&&v<=tValue2}else if(this.columnType===Config.DATE_TYPE){var _v8=value.toString();var eventTimeZoneOffset=facts[Config.EVENT_ZONE_OFFSET];var timeStamp=_.convertToTimestamp(_v8,eventTimeZoneOffset);var _tValue3=_.convertToTimestamp(this.ftv[0],this.zoneOffset);var _tValue4=_.convertToTimestamp(this.ftv[1],this.zoneOffset);if(isNaN(timeStamp)||isNaN(_tValue3)||isNaN(_tValue4))return false;return timeStamp>=_tValue3&&timeStamp<=_tValue4}}return false}}])}(PropertiesRule);var INCLUDERule=function(_PropertiesRule0){function INCLUDERule(ruleJson){_classCallCheck(this,INCLUDERule);return _callSuper(this,INCLUDERule,[ruleJson])}_inherits(INCLUDERule,_PropertiesRule0);return _createClass(INCLUDERule,[{key:"executeWhen",value:function executeWhen(value,_facts){if(this.columnType===Config.STR_TYPE){var v=value.toString();for(var i=0;i<this.ftv.length;i++){var t=String(this.ftv[i]);if(v.includes(t)){return true}}}return false}}])}(PropertiesRule);var UN_INCLUDERule=function(_PropertiesRule1){function UN_INCLUDERule(ruleJson){_classCallCheck(this,UN_INCLUDERule);return _callSuper(this,UN_INCLUDERule,[ruleJson])}_inherits(UN_INCLUDERule,_PropertiesRule1);return _createClass(UN_INCLUDERule,[{key:"executeWhen",value:function executeWhen(value,_facts){if(this.columnType===Config.STR_TYPE){var v=value.toString();var isFind=false;for(var i=0;i<this.ftv.length;i++){var t=String(this.ftv[i]);if(v.includes(t)){isFind=true;break}}return!isFind}return false}}])}(PropertiesRule);var BOOLEAN_TRUERule=function(_PropertiesRule10){function BOOLEAN_TRUERule(ruleJson){_classCallCheck(this,BOOLEAN_TRUERule);return _callSuper(this,BOOLEAN_TRUERule,[ruleJson])}_inherits(BOOLEAN_TRUERule,_PropertiesRule10);return _createClass(BOOLEAN_TRUERule,[{key:"executeWhen",value:function executeWhen(value,_facts){if(this.columnType===Config.BOOLEAN_TYPE){var v=_.toBoolean(value);return v===true}return false}}])}(PropertiesRule);var BOOLEAN_FALSERule=function(_PropertiesRule11){function BOOLEAN_FALSERule(ruleJson){_classCallCheck(this,BOOLEAN_FALSERule);return _callSuper(this,BOOLEAN_FALSERule,[ruleJson])}_inherits(BOOLEAN_FALSERule,_PropertiesRule11);return _createClass(BOOLEAN_FALSERule,[{key:"executeWhen",value:function executeWhen(value,_facts){if(this.columnType===Config.BOOLEAN_TYPE){var v=_.toBoolean(value);return v===false}return false}}])}(PropertiesRule);var REGULAR_MATCHRule=function(_PropertiesRule12){function REGULAR_MATCHRule(ruleJson){_classCallCheck(this,REGULAR_MATCHRule);return _callSuper(this,REGULAR_MATCHRule,[ruleJson])}_inherits(REGULAR_MATCHRule,_PropertiesRule12);return _createClass(REGULAR_MATCHRule,[{key:"executeWhen",value:function executeWhen(value,_facts){if(this.ftv.length<=0)return false;if(this.columnType===Config.STR_TYPE){var v=value.toString();var tValue=String(this.ftv[0]);var pattern=new RegExp(tValue,"i");return pattern.test(v)}return false}}])}(PropertiesRule);var UN_REGULAR_MATCHRule=function(_PropertiesRule13){function UN_REGULAR_MATCHRule(ruleJson){_classCallCheck(this,UN_REGULAR_MATCHRule);return _callSuper(this,UN_REGULAR_MATCHRule,[ruleJson])}_inherits(UN_REGULAR_MATCHRule,_PropertiesRule13);return _createClass(UN_REGULAR_MATCHRule,[{key:"executeWhen",value:function executeWhen(value,_facts){if(this.ftv.length<=0)return false;if(this.columnType===Config.STR_TYPE){var v=value.toString();var tValue=String(this.ftv[0]);var pattern=new RegExp(tValue,"i");return!pattern.test(v)}return false}}])}(PropertiesRule);var RELATIVE_CURRENT_TIMERule=function(_PropertiesRule14){function RELATIVE_CURRENT_TIMERule(ruleJson){_classCallCheck(this,RELATIVE_CURRENT_TIMERule);return _callSuper(this,RELATIVE_CURRENT_TIMERule,[ruleJson])}_inherits(RELATIVE_CURRENT_TIMERule,_PropertiesRule14);return _createClass(RELATIVE_CURRENT_TIMERule,[{key:"executeWhen",value:function executeWhen(value,facts){if(this.columnType===Config.DATE_TYPE){var v=value.toString();var eventTimeZoneOffset=facts[Config.EVENT_ZONE_OFFSET];var timeStamp=_.convertToTimestamp(v,eventTimeZoneOffset);if(isNaN(timeStamp))return false;var targetTimeStamp=this.getTargetTimeStamp();if(this.ftv.length===1){var dayBefore=Number(this.ftv[0]);if(dayBefore!==Number.NaN){var beforeTimeStamp=targetTimeStamp-dayBefore*24*60*60*1e3;return timeStamp<=beforeTimeStamp}}else if(this.ftv.length===2){var _dayBefore=Number(this.ftv[0]);var dayAfter=Number(this.ftv[1]);if(_dayBefore!==Number.NaN&&dayAfter!==Number.NaN){var start=targetTimeStamp+_dayBefore*24*60*60*1e3;var end=targetTimeStamp+(dayAfter+1)*24*60*60*1e3;return timeStamp>=start&&timeStamp<end}}}return false}},{key:"getTargetTimeStamp",value:function getTargetTimeStamp(){var now=AnalyticUtil.getCurrentDate();now.setHours(0,0,0,0);return now.getTime()}}])}(PropertiesRule);var RELATIVE_EVENT_TIMERule=function(_PropertiesRule15){function RELATIVE_EVENT_TIMERule(ruleJson){_classCallCheck(this,RELATIVE_EVENT_TIMERule);return _callSuper(this,RELATIVE_EVENT_TIMERule,[ruleJson])}_inherits(RELATIVE_EVENT_TIMERule,_PropertiesRule15);return _createClass(RELATIVE_EVENT_TIMERule,[{key:"executeWhen",value:function executeWhen(value,facts){if(this.columnType===Config.DATE_TYPE){var v=value.toString();var eventTimeZoneOffset=facts[Config.EVENT_ZONE_OFFSET];var timeStamp=_.convertToTimestamp(v,eventTimeZoneOffset);if(isNaN(timeStamp))return false;var timeRelative=this.ruleJson.timeRelative;if(timeRelative==="range"){if(this.ftv.length===2){var targetTimeStamp=this.getTargetTimeStamp(facts);var before=Number(this.ftv[0]);var after=Number(this.ftv[1]);if(before!==Number.NaN&&after!==Number.NaN){var millis=this.getMillis();var start=targetTimeStamp+before*millis;var end=targetTimeStamp+after*millis;return timeStamp>=start&&timeStamp<=end}}}else{var pair={};if(timeRelative==="that_day"){pair=this.getDayTimeStamp(facts)}else if(timeRelative==="that_week"){pair=this.getWeekTimeStamp(facts)}else if(timeRelative==="that_month"){pair=this.getMonthTimeStamp(facts)}if(pair.first!==undefined){return timeStamp>=pair.first&&timeStamp<pair.second}}}return false}},{key:"getTargetTimeStamp",value:function getTargetTimeStamp(facts){return _.convertToTimestamp(facts[Config.EVENT_TIME_KEY],facts[Config.EVENT_ZONE_OFFSET])}},{key:"getMillis",value:function getMillis(){var timeUnit=_.getTimeCycleUnit(this.ruleJson.timeUnit);if(timeUnit===undefined)return 0;if(timeUnit===TimeCycleUnit.DAY){return 24*60*60*1e3}else if(timeUnit===TimeCycleUnit.HOUR){return 60*60*1e3}else if(timeUnit===TimeCycleUnit.MINUTE){return 60*1e3}return 0}},{key:"getDayTimeStamp",value:function getDayTimeStamp(facts){var now=new Date(this.getTargetTimeStamp(facts));now.setHours(0,0,0,0);return{first:now.getTime(),second:now.getTime()+24*60*60*1e3}}},{key:"getWeekTimeStamp",value:function getWeekTimeStamp(facts){var now=new Date(this.getTargetTimeStamp(facts));var dayOfWeek=now.getDay();var startOfWeek=new Date(now.getFullYear(),now.getMonth(),now.getDate()-dayOfWeek);startOfWeek.setHours(0,0,0,0);return{first:startOfWeek.getTime(),second:startOfWeek.getTime()+7*24*60*60*1e3}}},{key:"getMonthTimeStamp",value:function getMonthTimeStamp(facts){var now=new Date(this.getTargetTimeStamp(facts));var year=now.getFullYear();var month=now.getMonth();var startOfMonth=new Date(year,month,1);startOfMonth.setHours(0,0,0,0);var endOfMonth=new Date(year,month+1,1);endOfMonth.setHours(0,0,0,0);return{first:startOfMonth.getTime(),second:endOfMonth.getTime()}}}])}(PropertiesRule);var _parseCompound=function parseCompound(relation,filters,zoneOffset,columns){if(!filters||filters.length===0)return undefined;var compositeRule;if(relation===1){compositeRule=new UnitRuleGroup}else{compositeRule=new ActivationRuleGroup}if(compositeRule){for(var i=0;i<filters.length;i++){var fit=filters[i];if(!fit)continue;if(fit.filterType){compositeRule.addRule(_parseCompound(fit.relation,fit.filts,zoneOffset))}else{if(columns){columns.push(fit.columnName)}compositeRule.addRule(createFilterRule(fit,zoneOffset))}}}return compositeRule};var createFilterRule=function createFilterRule(fitItem,zoneOffset){if(!fitItem)return undefined;switch(fitItem.calcuSymbol){case"C00":return new EQRule(fitItem);case"C01":return new UN_EQRule(fitItem);case"C02":return new LTRule(fitItem);case"C020":return new LTERule(fitItem,zoneOffset);case"C03":return new GTRule(fitItem);case"C030":return new GTERule(fitItem,zoneOffset);case"C04":return new NOT_NULLRule(fitItem);case"C05":return new NULLRule(fitItem);case"C06":return new RANGERule(fitItem,zoneOffset);case"C07":return new INCLUDERule(fitItem);case"C08":return new UN_INCLUDERule(fitItem);case"C09":return new BOOLEAN_TRUERule(fitItem);case"C10":return new BOOLEAN_FALSERule(fitItem);case"C11":return new REGULAR_MATCHRule(fitItem);case"C12":return new UN_REGULAR_MATCHRule(fitItem);case"C13":return new RELATIVE_CURRENT_TIMERule(fitItem);case"C14":return new RELATIVE_EVENT_TIMERule(fitItem);default:return undefined}};var TargetAudience=function(){function TargetAudience(flow,isTargetUser,clientQp,pushId){_classCallCheck(this,TargetAudience);this.flow=flow;this.isTargetUser=isTargetUser;this.pushId=pushId;this.columns=[];this.compositeRule=_parseCompound(clientQp.relation,clientQp.filts,flow.zoneOffset,this.columns)}return _createClass(TargetAudience,[{key:"isTargetAudience",value:function(){var _isTargetAudience=_asyncToGenerator(_regenerator().m((function _callee(facts){var isTargetRule,i,key,value,pId;return _regenerator().w((function(_context){while(1)switch(_context.n){case 0:if(this.isTargetUser){_context.n=1;break}this.flow.triggerRecord.status=TARGET_USER_IS_FALSE;AnalyticUtil.trackTriggerEvent(this.flow.triggerRecord);return _context.a(2,false);case 1:for(i=0;i<this.columns.length;i++){key=this.columns[i];value=AnalyticUtil.getConfigValue(key);if(value!==undefined){facts[key]=value}}if(!this.compositeRule){_context.n=3;break}logger.info("TargetAudience------start trigger rules------");_context.n=2;return this.compositeRule.evaluate(facts);case 2:isTargetRule=_context.v;logger.info("TargetAudience------end trigger rules------result is "+isTargetRule);_context.n=4;break;case 3:isTargetRule=true;case 4:if(isTargetRule){_context.n=5;break}this.flow.triggerRecord.status=CLIENT_QP_IS_FALSE;AnalyticUtil.trackTriggerEvent(this.flow.triggerRecord);return _context.a(2,false);case 5:pId=this.getPushId(facts);this.flow.triggerRecord.pushId=pId;logger.info("Push ID :"+pId);if(pId){_context.n=6;break}this.flow.triggerRecord.status=PUSH_ID_IS_NULL;AnalyticUtil.trackTriggerEvent(this.flow.triggerRecord);return _context.a(2,false);case 6:return _context.a(2,true)}}),_callee,this)})));function isTargetAudience(_x){return _isTargetAudience.apply(this,arguments)}return isTargetAudience}()},{key:"getPushId",value:function getPushId(facts){if(!this.pushId)return"";if(!this.pushId.includes("client:")){return this.pushId}var splits=this.pushId.split(":");if(splits.length<2)return"";var columnName=splits[1];var s1=facts[columnName];if(s1===undefined){s1=AnalyticUtil.getConfigValue(columnName)}if(s1!==undefined){return s1.toString()}return""}}])}();var ExpConfig=function(){function ExpConfig(taskJson,zoneOffset){_classCallCheck(this,ExpConfig);var expConfigJson=taskJson.expConfig;if(!expConfigJson)return;this.enableExp=expConfigJson.enableExp;if(!this.enableExp)return;this.expSampleOut=expConfigJson.expSampleOut;this.expEntityIdExist=expConfigJson.expEntityIdExist;this.expType=expConfigJson.expType;this.expReleasePushStarted=expConfigJson.expReleasePushStarted;this.expStartTimeStamp=_.convertToTimestamp1(expConfigJson.expStartDate,zoneOffset);this.expEndTimeStamp=_.convertToTimestamp1(expConfigJson.expEndDate,zoneOffset);if(isNaN(this.expStartTimeStamp)||isNaN(this.expEndTimeStamp)){this.enableExp=false;return}var groupContentList=taskJson.groupContentList;if(_.isArray(groupContentList)&&groupContentList.length>0){var groupContent=groupContentList[0];if(groupContent){this.expGroupId=groupContent.expGroupId;this.isPush=groupContent.isPush}}}return _createClass(ExpConfig,[{key:"isGapExp",value:function isGapExp(){return!this.enableExp||this.expReleasePushStarted}},{key:"isExpGroupIdExist",value:function isExpGroupIdExist(record){var isNotExits=!this.expGroupId&&!this.expEntityIdExist;if(isNotExits){record.status=WITHOUT_SPLIT_FLOW_ID;AnalyticUtil.trackTriggerEvent(record)}return isNotExits}},{key:"isExpSampleOut",value:function isExpSampleOut(){if(this.isGapExp())return false;return this.expSampleOut}},{key:"isSkipPush",value:function isSkipPush(){if(this.isGapExp())return false;return!this.isPush}},{key:"isExpRelease",value:function isExpRelease(record){record.expGroupId=this.expGroupId;if(this.isGapExp())return true;if(this.isExpGroupIdExist(record))return false;var currentTimeStamp=AnalyticUtil.getCurrentTimeStamp();if(this.expType===1){return currentTimeStamp>=this.expStartTimeStamp&&currentTimeStamp<=this.expEndTimeStamp}else if(this.expType===2){if(currentTimeStamp<this.expStartTimeStamp){logger.info("Exp type: "+this.expType+" is less than start time");return false}if(currentTimeStamp>this.expEndTimeStamp){record.status=RACE_SKIP_PUSH;AnalyticUtil.trackTriggerEvent(record);return false}return true}return false}}])}();var AbstractTimeCycle=function(){function AbstractTimeCycle(periodInfo,scrollInfo){_classCallCheck(this,AbstractTimeCycle);if(periodInfo){if(periodInfo.periodStartStamp!==undefined&&periodInfo.periodEndStamp!==undefined){this.startTime=periodInfo.periodStartStamp;this.endTime=periodInfo.periodEndStamp}else{this.startTime=_.convertToTimestamp(periodInfo.periodStart,periodInfo.zoneOffset);this.endTime=_.convertToTimestamp(periodInfo.periodEnd,periodInfo.zoneOffset)}}if(isNaN(this.startTime)||isNaN(this.endTime)){this.startTime=AnalyticUtil.getCurrentTimeStamp();this.endTime=AnalyticUtil.getCurrentTimeStamp()}this.scrollInfo=scrollInfo;this.checkScrollInfo()}return _createClass(AbstractTimeCycle,[{key:"checkScrollInfo",value:function checkScrollInfo(){}},{key:"isWithInPeriod",value:function isWithInPeriod(){var currentTime=AnalyticUtil.getCurrentTimeStamp();return currentTime>=this.startTime&&currentTime<=this.endTime}}])}();var StartEndLimit=function(_AbstractTimeCycle){function StartEndLimit(periodInfo){_classCallCheck(this,StartEndLimit);return _callSuper(this,StartEndLimit,[periodInfo,undefined])}_inherits(StartEndLimit,_AbstractTimeCycle);return _createClass(StartEndLimit,[{key:"getCurrentTimeCycle",value:function getCurrentTimeCycle(){return{start:this.startTime,end:this.endTime}}}])}(AbstractTimeCycle);var DailyScrollTimeCycle=function(_AbstractTimeCycle2){function DailyScrollTimeCycle(periodInfo,sInfo){_classCallCheck(this,DailyScrollTimeCycle);return _callSuper(this,DailyScrollTimeCycle,[periodInfo,sInfo])}_inherits(DailyScrollTimeCycle,_AbstractTimeCycle2);return _createClass(DailyScrollTimeCycle,[{key:"checkScrollInfo",value:function checkScrollInfo(){if(this.scrollInfo){if(this.scrollInfo.timeCycleNumber===undefined||this.scrollInfo.timeCycleNumber<1){this.scrollInfo.timeCycleNumber=1}if(this.scrollInfo.startHour===undefined||this.scrollInfo.startHour<0||this.scrollInfo.startHour>24){this.scrollInfo.startHour=0}if(this.scrollInfo.startMinute===undefined||this.scrollInfo.startMinute<0||this.scrollInfo.startMinute>60){this.scrollInfo.startMinute=0}}else{this.scrollInfo={timeCycleNumber:1,timeCycleUnit:TimeCycleUnit.DAY,startHour:0,startMinute:0}}}},{key:"getCurrentTimeCycle",value:function getCurrentTimeCycle(){var startTimeStamp=this.getStartOfTimestamp()+this.getStartDay()*24*3600*1e3+this.scrollInfo.startHour*3600*1e3+this.scrollInfo.startMinute*60*1e3;var endTimeStamp=this.getNextCycleTimeStamp(startTimeStamp);var currentTimeStamp=AnalyticUtil.getCurrentTimeStamp();if(currentTimeStamp<startTimeStamp){if(this.startTime<=startTimeStamp){return{start:this.startTime,end:startTimeStamp}}else{return{start:0,end:0}}}var isInCycle=currentTimeStamp<=endTimeStamp;while(!isInCycle){startTimeStamp=endTimeStamp;endTimeStamp=this.getNextCycleTimeStamp(startTimeStamp);isInCycle=currentTimeStamp<=endTimeStamp}if(startTimeStamp<this.startTime){startTimeStamp=this.startTime}if(endTimeStamp>this.endTime){endTimeStamp=this.endTime}return{start:startTimeStamp,end:endTimeStamp}}},{key:"getStartOfTimestamp",value:function getStartOfTimestamp(){var now=new Date(this.startTime);now.setHours(0,0,0,0);return now.getTime()}},{key:"getStartDay",value:function getStartDay(){return 0}},{key:"getNextCycleTimeStamp",value:function getNextCycleTimeStamp(start){return start+this.scrollInfo.timeCycleNumber*24*3600*1e3}}])}(AbstractTimeCycle);var WeekScrollTimeCycle=function(_DailyScrollTimeCycle){function WeekScrollTimeCycle(periodInfo,sInfo){_classCallCheck(this,WeekScrollTimeCycle);return _callSuper(this,WeekScrollTimeCycle,[periodInfo,sInfo])}_inherits(WeekScrollTimeCycle,_DailyScrollTimeCycle);return _createClass(WeekScrollTimeCycle,[{key:"checkScrollInfo",value:function checkScrollInfo(){if(this.scrollInfo){if(this.scrollInfo.timeCycleNumber===undefined||this.scrollInfo.timeCycleNumber<1){this.scrollInfo.timeCycleNumber=1}if(this.scrollInfo.startHour===undefined||this.scrollInfo.startHour<0||this.scrollInfo.startHour>24){this.scrollInfo.startHour=0}if(this.scrollInfo.startMinute===undefined||this.scrollInfo.startMinute<0||this.scrollInfo.startMinute>60){this.scrollInfo.startMinute=0}if(this.scrollInfo.startNumber===undefined||this.scrollInfo.startNumber<1||this.scrollInfo.startNumber>7){this.scrollInfo.startNumber=0}}else{this.scrollInfo={timeCycleNumber:1,timeCycleUnit:TimeCycleUnit.WEEK,startHour:0,startMinute:0,startNumber:0}}}},{key:"getStartOfTimestamp",value:function getStartOfTimestamp(){var now=new Date(this.startTime);var startOfWeek=new Date(now.getFullYear(),now.getMonth(),now.getDate()-now.getDay());startOfWeek.setHours(0,0,0,0);return startOfWeek.getTime()}},{key:"getStartDay",value:function getStartDay(){return this.scrollInfo.startNumber}},{key:"getNextCycleTimeStamp",value:function getNextCycleTimeStamp(start){return start+this.scrollInfo.timeCycleNumber*7*24*3600*1e3}}])}(DailyScrollTimeCycle);var MonthScrollTimeCycle=function(_DailyScrollTimeCycle2){function MonthScrollTimeCycle(periodInfo,sInfo){_classCallCheck(this,MonthScrollTimeCycle);return _callSuper(this,MonthScrollTimeCycle,[periodInfo,sInfo])}_inherits(MonthScrollTimeCycle,_DailyScrollTimeCycle2);return _createClass(MonthScrollTimeCycle,[{key:"checkScrollInfo",value:function checkScrollInfo(){if(this.scrollInfo){if(this.scrollInfo.timeCycleNumber===undefined||this.scrollInfo.timeCycleNumber<1){this.scrollInfo.timeCycleNumber=1}if(this.scrollInfo.startHour===undefined||this.scrollInfo.startHour<0||this.scrollInfo.startHour>24){this.scrollInfo.startHour=0}if(this.scrollInfo.startMinute===undefined||this.scrollInfo.startMinute<0||this.scrollInfo.startMinute>60){this.scrollInfo.startMinute=0}if(this.scrollInfo.startNumber===undefined||this.scrollInfo.startNumber<1||this.scrollInfo.startNumber>28){this.scrollInfo.startNumber=1}}else{this.scrollInfo={timeCycleNumber:1,timeCycleUnit:TimeCycleUnit.MONTH,startHour:0,startMinute:0,startNumber:1}}}},{key:"getStartOfTimestamp",value:function getStartOfTimestamp(){var now=new Date(this.startTime);var year=now.getFullYear();var month=now.getMonth();var startOfMonth=new Date(year,month,1);startOfMonth.setHours(0,0,0,0);return startOfMonth.getTime()}},{key:"getStartDay",value:function getStartDay(){return this.scrollInfo.startNumber-1}},{key:"getNextCycleTimeStamp",value:function getNextCycleTimeStamp(start){var startDate=new Date(start);startDate.setMonth(startDate.getMonth()+this.scrollInfo.timeCycleNumber);return startDate.getTime()}}])}(DailyScrollTimeCycle);var SlideTimeCycle=function(_AbstractTimeCycle3){function SlideTimeCycle(periodInfo,sInfo){_classCallCheck(this,SlideTimeCycle);return _callSuper(this,SlideTimeCycle,[periodInfo,sInfo])}_inherits(SlideTimeCycle,_AbstractTimeCycle3);return _createClass(SlideTimeCycle,[{key:"getCurrentTimeCycle",value:function getCurrentTimeCycle(){var currentTimeStamp=AnalyticUtil.getCurrentTimeStamp();var minutes=this.getMinutes();if(!minutes){return{start:this.startTime,end:this.endTime}}var beforeTimestamp=currentTimeStamp-minutes*60*1e3;if(beforeTimestamp<this.startTime){beforeTimestamp=this.startTime}if(currentTimeStamp>this.endTime){currentTimeStamp=this.endTime}return{start:beforeTimestamp,end:currentTimeStamp}}},{key:"getMinutes",value:function getMinutes(){if(!this.scrollInfo)return 0;if(this.scrollInfo.timeCycleUnit===TimeCycleUnit.WEEK){return this.scrollInfo.timeCycleNumber*7*24*60}else if(this.scrollInfo.timeCycleUnit===TimeCycleUnit.DAY){return this.scrollInfo.timeCycleNumber*24*60}else if(this.scrollInfo.timeCycleUnit===TimeCycleUnit.HOUR){return this.scrollInfo.timeCycleNumber*60}else if(this.scrollInfo.timeCycleUnit===TimeCycleUnit.MINUTE){return this.scrollInfo.timeCycleNumber}return 0}}])}(AbstractTimeCycle);var ClientStartTimeCycle=function(_AbstractTimeCycle4){function ClientStartTimeCycle(periodInfo){_classCallCheck(this,ClientStartTimeCycle);return _callSuper(this,ClientStartTimeCycle,[periodInfo,undefined])}_inherits(ClientStartTimeCycle,_AbstractTimeCycle4);return _createClass(ClientStartTimeCycle,[{key:"getCurrentTimeCycle",value:function getCurrentTimeCycle(){return{start:ClientStartTimeCycle.clientStartTime,end:this.endTime}}}])}(AbstractTimeCycle);var AbstractTaskLimit=function(){function AbstractTaskLimit(taskFlow){_classCallCheck(this,AbstractTaskLimit);this.taskFlow=taskFlow;this.mLimits=[];this.mClientUserId=taskFlow.clientUserId;this.enableLimit=false;this.parseLimitInfo(taskFlow.taskJson)}return _createClass(AbstractTaskLimit,[{key:"parseLimitInfo",value:function parseLimitInfo(_json){}},{key:"isLimit",value:function(){var _isLimit=_asyncToGenerator(_regenerator().m((function _callee(){var limit,i,item,timeCycle,pair,count;return _regenerator().w((function(_context){while(1)switch(_context.n){case 0:if(this.enableLimit){_context.n=1;break}return _context.a(2,false);case 1:limit=false;i=0;case 2:if(!(i<this.mLimits.length)){_context.n=6;break}item=this.mLimits[i];timeCycle=item.first;if(timeCycle.isWithInPeriod()){_context.n=3;break}return _context.a(3,5);case 3:pair=timeCycle.getCurrentTimeCycle();_context.n=4;return this.getLimitCount(pair.start,pair.end);case 4:count=_context.v;count=count+1;logger.info("Current Count: "+count+" Target Count: "+item.second);limit=count>item.second;if(!limit){_context.n=5;break}return _context.a(3,6);case 5:i++;_context.n=2;break;case 6:return _context.a(2,limit)}}),_callee,this)})));function isLimit(){return _isLimit.apply(this,arguments)}return isLimit}()},{key:"getLimitCount",value:function(){var _getLimitCount=_asyncToGenerator(_regenerator().m((function _callee2(_start,_end){return _regenerator().w((function(_context2){while(1)switch(_context2.n){case 0:return _context2.a(2,0)}}),_callee2)})));function getLimitCount(_x,_x2){return _getLimitCount.apply(this,arguments)}return getLimitCount}()}])}();var FrequencyLimit=function(_AbstractTaskLimit){function FrequencyLimit(taskFlow){_classCallCheck(this,FrequencyLimit);return _callSuper(this,FrequencyLimit,[taskFlow])}_inherits(FrequencyLimit,_AbstractTaskLimit);return _createClass(FrequencyLimit,[{key:"parseLimitInfo",value:function parseLimitInfo(json){var frequencyLimitStr=json.frequencyLimits;if(!frequencyLimitStr)return;var frequencyLimitJson=JSON.parse(frequencyLimitStr);if(!_.isObject(frequencyLimitJson))return;this.enableLimit=frequencyLimitJson.enableFrequencyLimits;if(!this.enableLimit)return;var ruleList=frequencyLimitJson.ruleList;if(_.isArray(ruleList)&&ruleList.length>0){var limitRule=ruleList[0];if(!limitRule)return;var maxTimes=limitRule.maxTimes?limitRule.maxTimes:0;var timeCycle=this.createFrequencyLimitCycle(limitRule);if(!timeCycle||maxTimes<=0)return;this.mLimits.push({first:timeCycle,second:maxTimes})}}},{key:"getLimitCount",value:function(){var _getLimitCount2=_asyncToGenerator(_regenerator().m((function _callee3(start,end){return _regenerator().w((function(_context3){while(1)switch(_context3.n){case 0:logger.info("Frequency Limit UserID: "+this.mClientUserId+" Start : "+_.getFormatDataByLog(start)+" End : "+_.getFormatDataByLog(end));_context3.n=1;return getFrequencyLimitCount({appId:this.taskFlow.appId,clientUserId:this.mClientUserId,taskId:this.taskFlow.taskId,start:start,end:end});case 1:return _context3.a(2,_context3.v)}}),_callee3,this)})));function getLimitCount(_x3,_x4){return _getLimitCount2.apply(this,arguments)}return getLimitCount}()},{key:"addLimitCount",value:function(){var _addLimitCount=_asyncToGenerator(_regenerator().m((function _callee4(){return _regenerator().w((function(_context4){while(1)switch(_context4.n){case 0:if(!(this.enableLimit&&this.mLimits.length>0)){_context4.n=1;break}_context4.n=1;return addFrequencyLimit({appId:this.taskFlow.appId,clientUserId:this.mClientUserId,taskId:this.taskFlow.taskId,triggerTime:AnalyticUtil.getCurrentTimeStamp()});case 1:return _context4.a(2)}}),_callee4,this)})));function addLimitCount(){return _addLimitCount.apply(this,arguments)}return addLimitCount}()},{key:"createFrequencyLimitCycle",value:function createFrequencyLimitCycle(limitRule){var timeCycle;var ruleType=limitRule.ruleType;var pair=this.taskFlow.taskTimeCycle.getCurrentTimeCycle();var tInfo={periodStartStamp:pair.start,periodEndStamp:pair.end};switch(ruleType){case"TASK":timeCycle=new StartEndLimit(tInfo);break;case"TIME_CYCLE":timeCycle=new SlideTimeCycle(tInfo,{timeCycleNumber:limitRule.timeCycleNumber,timeCycleUnit:_.getTimeCycleUnit(limitRule.timeCycleUnit)});break;case"CLIENT_START":timeCycle=new ClientStartTimeCycle(tInfo);break;case"TIME_CYCLE_ROLL":{var scrollInfo={timeCycleNumber:limitRule.timeCycleNumber,timeCycleUnit:_.getTimeCycleUnit(limitRule.timeCycleUnit)};var timeCycleDef=limitRule.timeCycleDef;if(timeCycleDef){scrollInfo.startNumber=timeCycleDef.startDay;var dayStartTime=_.parseStartTime(timeCycleDef.startTime);scrollInfo.startHour=dayStartTime.hour;scrollInfo.startMinute=dayStartTime.minute}if(scrollInfo.timeCycleUnit===TimeCycleUnit.DAY){timeCycle=new DailyScrollTimeCycle(tInfo,scrollInfo)}else if(scrollInfo.timeCycleUnit===TimeCycleUnit.WEEK){timeCycle=new WeekScrollTimeCycle(tInfo,scrollInfo)}else if(scrollInfo.timeCycleUnit===TimeCycleUnit.MONTH){timeCycle=new MonthScrollTimeCycle(tInfo,scrollInfo)}break}}return timeCycle}}])}(AbstractTaskLimit);var UserFatigueControl=function(_AbstractTaskLimit2){function UserFatigueControl(taskFlow){_classCallCheck(this,UserFatigueControl);return _callSuper(this,UserFatigueControl,[taskFlow])}_inherits(UserFatigueControl,_AbstractTaskLimit2);return _createClass(UserFatigueControl,[{key:"parseLimitInfo",value:function parseLimitInfo(json){this.enableLimit=json.enableChannelTouchLimits;if(!this.enableLimit)return;var ruleDefStr=json.channelTouchLimitsRuleDef;if(!ruleDefStr)return;var touchLists=JSON.parse(ruleDefStr);if(!_.isArray(touchLists))return;var pair=this.taskFlow.taskTimeCycle.getCurrentTimeCycle();var tInfo={periodStartStamp:pair.start,periodEndStamp:pair.end};for(var i=0;i<touchLists.length;i++){var item=touchLists[i];if(!item)continue;var maxTimes=item.maxTimes?item.maxTimes:0;if(maxTimes<=0)continue;this.mLimits.push({first:new SlideTimeCycle(tInfo,{timeCycleNumber:item.timeCycleNumber,timeCycleUnit:_.getTimeCycleUnit(item.timeCycleUnit)}),second:maxTimes})}}},{key:"getLimitCount",value:function(){var _getLimitCount3=_asyncToGenerator(_regenerator().m((function _callee5(start,end){return _regenerator().w((function(_context5){while(1)switch(_context5.n){case 0:logger.info("Touch Limit PushID: : "+this.taskFlow.triggerRecord.pushId+" Start : "+_.getFormatDataByLog(start)+" End : "+_.getFormatDataByLog(end));_context5.n=1;return getTouchLimitCount({appId:this.taskFlow.appId,pushId:this.taskFlow.triggerRecord.pushId,channelId:this.taskFlow.channelId,start:start,end:end});case 1:return _context5.a(2,_context5.v)}}),_callee5,this)})));function getLimitCount(_x5,_x6){return _getLimitCount3.apply(this,arguments)}return getLimitCount}()},{key:"addLimitCount",value:function(){var _addLimitCount2=_asyncToGenerator(_regenerator().m((function _callee6(){return _regenerator().w((function(_context6){while(1)switch(_context6.n){case 0:if(!(this.enableLimit&&this.mLimits.length>0)){_context6.n=1;break}_context6.n=1;return addTouchLimit({appId:this.taskFlow.appId,pushId:this.taskFlow.triggerRecord.pushId,channelId:this.taskFlow.channelId,triggerTime:AnalyticUtil.getCurrentTimeStamp()});case 1:return _context6.a(2)}}),_callee6,this)})));function addLimitCount(){return _addLimitCount2.apply(this,arguments)}return addLimitCount}()}])}(AbstractTaskLimit);var PushResult=function(){function PushResult(flow){_classCallCheck(this,PushResult);this.flow=flow;var groupContentList=this.flow.taskJson.groupContentList;if(_.isArray(groupContentList)&&groupContentList.length>0){var contentItem=groupContentList[0];if(contentItem){this.contentJson=contentItem.content}}if(!this.contentJson){this.contentJson={}}this.userParamsList=this.flow.taskJson.channelUserParamsList;if(!_.isArray(this.userParamsList)){this.userParamsList=[]}}return _createClass(PushResult,[{key:"calculate",value:function calculate(facts){var result={appId:this.flow.appId,taskId:this.flow.taskId,channelMsgType:this.flow.channelMsgType,pushId:this.flow.triggerRecord.pushId};result.userParams=this.buildUserParamsMap(facts);result.opsProperties=this.buildOpsProperties();result.content=this.buildContentMap(facts);return result}},{key:"buildContentMap",value:function buildContentMap(facts){var _this=this;var contents={};_.each(this.contentJson,(function(value,key){if(_.isString(value)){var v=_this.getClientValue(value,facts);v=_this.getOccasionValue(v,facts);if(v){contents[key]=v}}else if(_.isObject(value)){var j=_this.getOccasionJson(value,facts);if(j){contents[key]=j}}else if(_.isArray(value)){var newArray=[];for(var i=0;i<value.length;i++){if(_.isObject(value[i])){var _j=_this.getOccasionJson(value[i],facts);if(_j){newArray.push(_j)}}else{newArray.push(value[i])}}contents[key]=newArray}else{contents[key]=value}}));return contents}},{key:"getOccasionJson",value:function getOccasionJson(valueJson,facts){var _this2=this;if(!_.isObject(valueJson))return undefined;var newJson={};_.each(valueJson,(function(value,key){if(_.isString(value)){var s=_this2.getOccasionValue(value,facts);if(s){newJson[key]=s}}else{newJson[key]=value}}));return newJson}},{key:"getOccasionValue",value:function getOccasionValue(value,facts){var _this3=this;var pattern=/\$\[(.*?)\]/g;var result=value.replace(pattern,(function(match,placeholderContent){return _this3.getOccasionColumnValue(facts,placeholderContent)}));if(!result.trim()){return undefined}return result}},{key:"getOccasionColumnValue",value:function getOccasionColumnValue(facts,placeContent){if(!placeContent)return" ";var splits=placeContent.split(":");if(splits.length<3)return" ";if(splits[1]!==facts[Config.EVENT_NAME_KEY])return"";var columnName=splits[2];if(!columnName)return" ";var value;if(columnName.includes(".")){var columns=columnName.split(".");if(columns.length===2){var obj=facts[columns[0]];if(_.isObject(obj)){value=obj[columns[1]]}}}else{value=facts[columnName]}if(!value){if(splits.length===4&&splits[3]!==undefined){value=splits[3]}else{value=" "}}return value}},{key:"getClientValue",value:function getClientValue(value,facts){var _this4=this;var pattern=/\$\((.*?)\)/g;var result=value.replace(pattern,(function(match,placeholderContent){return _this4.getContentColumnValue(facts,placeholderContent)}));return result}},{key:"getContentColumnValue",value:function getContentColumnValue(facts,placeContent){if(!placeContent)return"";var splits=placeContent.split(":");var value=this.getColumnValue(facts,splits);if(!value){if(splits.length===3&&splits[2]!==undefined){value=splits[2]}else{value=""}}if(_.isDate(value)){value=_.formatDate(value)}return value}},{key:"buildOpsProperties",value:function buildOpsProperties(){return{"#ops_receipt_properties":{ops_project_id:this.flow.projectId,ops_task_id:this.flow.taskId,ops_exp_group_id:this.flow.triggerRecord.expGroupId,ops_trigger_time:this.flow.triggerRecord.triggerTime,ops_task_exec_detail_id:_.UUID()}}}},{key:"buildUserParamsMap",value:function buildUserParamsMap(facts){var userParams={};for(var i=0;i<this.userParamsList.length;i++){var jsonItem=this.userParamsList[i];if(!jsonItem)continue;var key=jsonItem.key;var value=jsonItem.value;if(value){userParams[key]=value}else{userParams[key]=this.getUserParamsValue(facts,jsonItem.columnName,jsonItem.defaultValue)}}return userParams}},{key:"getUserParamsValue",value:function getUserParamsValue(facts,placeContent,defaultValue){if(!placeContent)return defaultValue;var splits=placeContent.split(":");var value=this.getColumnValue(facts,splits);if(!value){return defaultValue}return value}},{key:"getColumnValue",value:function getColumnValue(facts,splits){if(!splits||splits.length<2)return undefined;var columnName=splits[1];var value;if(columnName&&columnName.startsWith("#")){value=facts[columnName]}if(!value){value=AnalyticUtil.getConfigValue(columnName)}return value}}])}();var EventCountRule=function(){function EventCountRule(ruleJson,triggerRule){_classCallCheck(this,EventCountRule);this.key=ruleJson.key;this.num=ruleJson.num;this.eventName=ruleJson.eventName;this.triggerRule=triggerRule}return _createClass(EventCountRule,[{key:"evaluate",value:function(){var _evaluate=_asyncToGenerator(_regenerator().m((function _callee(facts){var timeCycle,pair,events,lists,relationProperties,countPairs,count,isTrigger;return _regenerator().w((function(_context){while(1)switch(_context.n){case 0:timeCycle=this.triggerRule.getTimeCycle();if(timeCycle){_context.n=1;break}return _context.a(2,false);case 1:pair=timeCycle.getCurrentTimeCycle();logger.info("EventName: "+this.eventName+" Start : "+_.getFormatDataByLog(pair.start)+" End : "+_.getFormatDataByLog(pair.end));_context.n=2;return queryTriggerResult();case 2:events=_context.v;lists=this.getTriggerResultList(events,{appId:this.triggerRule.taskFlow.appId,clientUserId:this.triggerRule.clientUserId,taskId:this.triggerRule.taskFlow.taskId,triggerId:this.triggerRule.triggerId,start:pair.start,end:pair.end});relationProperties=this.getRelationProperties(facts);_context.n=3;return this.getEventCount(lists,relationProperties);case 3:countPairs=_context.v;count=countPairs.count;if(this.triggerRule.isWithInPeriod()){count++}logger.info("EventName: "+this.eventName+" Trigger Count: "+count+" Target Count: "+this.num);isTrigger=false;if(count>=this.num){isTrigger=true;events=events.filter((function(item){return!countPairs.ids.includes(item.id)}))}else{events.push({appId:this.triggerRule.taskFlow.appId,clientUserId:this.triggerRule.clientUserId,taskId:this.triggerRule.taskFlow.taskId,triggerId:this.triggerRule.triggerId,id:_.generateUniqueId(),key:this.key,num:1,event:relationProperties,eventTime:AnalyticUtil.getCurrentTimeStamp()})}_context.n=4;return insertTriggerResult(events);case 4:return _context.a(2,isTrigger)}}),_callee,this)})));function evaluate(_x){return _evaluate.apply(this,arguments)}return evaluate}()},{key:"getTriggerResultList",value:function getTriggerResultList(events,info){var lists=[];for(var i=0;i<events.length;i++){var item=events[i];if(item.appId===info.appId&&item.clientUserId===info.clientUserId&&item.taskId===info.taskId&&item.triggerId===info.triggerId&&item.eventTime>=info.start&&item.eventTime<=info.end){lists.push(events[i])}}return lists}},{key:"getEventCount",value:function(){var _getEventCount=_asyncToGenerator(_regenerator().m((function _callee2(lists,relationJson){var ids,count,i,info,_t;return _regenerator().w((function(_context2){while(1)switch(_context2.n){case 0:ids=[];count=0;i=lists.length-1;case 1:if(!(i>=0)){_context2.n=6;break}info=lists[i];_t=info.key===this.key;if(!_t){_context2.n=3;break}_context2.n=2;return this.isRelationEq(relationJson,info.event);case 2:_t=_context2.v;case 3:if(!_t){_context2.n=4;break}count++;ids.push(info.id);_context2.n=5;break;case 4:if(!this.triggerRule.disableEventList.includes(info.key)){_context2.n=5;break}return _context2.a(3,6);case 5:i--;_context2.n=1;break;case 6:return _context2.a(2,{count:count,ids:ids})}}),_callee2,this)})));function getEventCount(_x2,_x3){return _getEventCount.apply(this,arguments)}return getEventCount}()},{key:"isRelationEq",value:function(){var _isRelationEq=_asyncToGenerator(_regenerator().m((function _callee3(relationJson,relationProperties){var unitRuleGroup,i,relationProperty,columnName,isRelation;return _regenerator().w((function(_context3){while(1)switch(_context3.n){case 0:if(!(this.triggerRule.relationProperties.length===0)){_context3.n=1;break}return _context3.a(2,true);case 1:if(!(this.triggerRule.relationProperties.length!==Object.keys(relationProperties).length)){_context3.n=2;break}logger.info("TriggerID: "+this.triggerRule.triggerId+"relation properties length is not equal");return _context3.a(2,false);case 2:unitRuleGroup=new UnitRuleGroup;i=0;case 3:if(!(i<this.triggerRule.relationProperties.length)){_context3.n=7;break}relationProperty=this.triggerRule.relationProperties[i];if(relationProperty){_context3.n=4;break}return _context3.a(3,6);case 4:columnName=relationProperty.columnName;if(columnName){_context3.n=5;break}return _context3.a(3,6);case 5:unitRuleGroup.addRule(new EQRule({calcuSymbol:"C00",columnName:columnName,columnType:relationProperty.columnType,ftv:[relationProperties[columnName]]}));case 6:i++;_context3.n=3;break;case 7:logger.info("TriggerID: "+this.triggerRule.triggerId+"------start relation properties------");_context3.n=8;return unitRuleGroup.evaluate(relationJson);case 8:isRelation=_context3.v;logger.info("TriggerID: "+this.triggerRule.triggerId+"------end relation properties------result is "+isRelation);return _context3.a(2,isRelation)}}),_callee3,this)})));function isRelationEq(_x4,_x5){return _isRelationEq.apply(this,arguments)}return isRelationEq}()},{key:"getRelationProperties",value:function getRelationProperties(facts){var json={};for(var i=0;i<this.triggerRule.relationProperties.length;i++){var relationProperty=this.triggerRule.relationProperties[i];if(!relationProperty)continue;var obj=facts[relationProperty.columnName];if(!obj)continue;json[relationProperty.columnName]=obj}return json}}])}();var createAnalyticsRule=function createAnalyticsRule(analyticItem,triggerRule){var taPropQuota=analyticItem.taPropQuota;if(!taPropQuota)return undefined;switch(taPropQuota.analysis){case"A200":return new EventCountRule(analyticItem,triggerRule);default:return undefined}};var EveryTriggerRule=function(){function EveryTriggerRule(taskFlow,ruleJson,triggerId){_classCallCheck(this,EveryTriggerRule);this.targetEventList=[];this.taskFlow=taskFlow;this.clientUserId=this.taskFlow.clientUserId;this.triggerId=triggerId;this.mEventFilters=new ActivationRuleGroup;this.mTriggerTimeCycle=this.createTriggerTimeCycle(ruleJson);this.relationProperties=[];this.disableEventList=[];this.parseFilters(ruleJson)}return _createClass(EveryTriggerRule,[{key:"isWithInPeriod",value:function isWithInPeriod(){if(this.mTriggerTimeCycle){return this.mTriggerTimeCycle.isWithInPeriod()}return false}},{key:"parseFilters",value:function parseFilters(ruleJson){this.parseEventFilters(ruleJson)}},{key:"parseEventFilters",value:function parseEventFilters(json){var events=json.events;if(!_.isArray(events))return;for(var i=0;i<events.length;i++){var eventItem=events[i];if(!eventItem)continue;this.targetEventList.push(eventItem.eventName);var eventObj=createAnalyticsRule(eventItem,this);if(!eventObj)continue;var unitRuleGroup=new UnitRuleGroup;unitRuleGroup.addRule(new EQRule(_.buildEventNameRule(eventItem.eventName)));unitRuleGroup.addRule(_parseCompound(eventItem.relation,eventItem.filts,this.taskFlow.zoneOffset));unitRuleGroup.addRule(eventObj);this.mEventFilters.addRule(unitRuleGroup)}}},{key:"isTargetEvent",value:function isTargetEvent(event){return this.targetEventList.includes(event)}},{key:"triggerEventRules",value:function(){var _triggerEventRules=_asyncToGenerator(_regenerator().m((function _callee(facts){var isTrigger;return _regenerator().w((function(_context){while(1)switch(_context.n){case 0:if(facts){_context.n=1;break}return _context.a(2,false);case 1:logger.info("TriggerID: "+this.triggerId+"------start trigger rules------");_context.n=2;return this.mEventFilters.evaluate(facts);case 2:isTrigger=_context.v;logger.info("TriggerID "+this.triggerId+"------end trigger rules------result is "+isTrigger);return _context.a(2,isTrigger)}}),_callee,this)})));function triggerEventRules(_x){return _triggerEventRules.apply(this,arguments)}return triggerEventRules}()},{key:"getTimeCycle",value:function getTimeCycle(){return this.mTriggerTimeCycle}},{key:"createTriggerTimeCycle",value:function createTriggerTimeCycle(ruleJson){var timeCycle;var periodInfo={periodStart:ruleJson.periodStart,periodEnd:ruleJson.periodEnd,zoneOffset:this.taskFlow.zoneOffset};var scrollInfo={timeCycleNumber:1};switch(ruleJson.periodTimeSymbol){case"TS01":{scrollInfo.timeCycleUnit=TimeCycleUnit.DAY;var dayStartTime=_.parseStartTime(ruleJson.dayStartTime);scrollInfo.startHour=dayStartTime.hour;scrollInfo.startMinute=dayStartTime.minute;return new DailyScrollTimeCycle(periodInfo,scrollInfo)}case"TS02":timeCycle=new StartEndLimit(periodInfo);break;case"TS03":{scrollInfo.timeCycleUnit=TimeCycleUnit.WEEK;scrollInfo.startNumber=ruleJson.startDay;var dayStartTime1=_.parseStartTime(ruleJson.dayStartTime);scrollInfo.startHour=dayStartTime1.hour;scrollInfo.startMinute=dayStartTime1.minute;return new WeekScrollTimeCycle(periodInfo,scrollInfo)}case"TS04":scrollInfo.timeCycleUnit=TimeCycleUnit.MONTH;scrollInfo.startNumber=ruleJson.startDay;return new MonthScrollTimeCycle(periodInfo,scrollInfo)}return timeCycle}}])}();var ContinueTriggerRule=function(_EveryTriggerRule){function ContinueTriggerRule(taskFlow,ruleJson,triggerId){_classCallCheck(this,ContinueTriggerRule);return _callSuper(this,ContinueTriggerRule,[taskFlow,ruleJson,triggerId])}_inherits(ContinueTriggerRule,_EveryTriggerRule);return _createClass(ContinueTriggerRule,[{key:"parseFilters",value:function parseFilters(ruleJson){_superPropGet(ContinueTriggerRule,"parseFilters",this,3)([ruleJson]);this.parseTimeCycleHour(ruleJson);this.parseRelationProperties(ruleJson);this.parseDisableEvent(ruleJson)}},{key:"parseTimeCycleHour",value:function parseTimeCycleHour(rule){var windowGap=rule.windowGap;var timeUnit=_.getTimeCycleUnit(rule.windowGapTimeUnit);if(windowGap>0&&timeUnit){this.periodScrollInfo={timeCycleNumber:windowGap,timeCycleUnit:timeUnit}}}},{key:"parseRelationProperties",value:function parseRelationProperties(rule){this.relationProperties=rule.relationProps;if(!_.isArray(this.relationProperties)){this.relationProperties=[]}}},{key:"parseDisableEvent",value:function parseDisableEvent(rule){this.blackListGroup=new ActivationRuleGroup;var blackList=rule.blackList;if(!_.isArray(blackList))return;for(var i=0;i<blackList.length;i++){var item=blackList[i];if(!item)continue;var eventName=item.eventName;this.disableEventList.push(eventName);var unitRuleGroup=new UnitRuleGroup;unitRuleGroup.addRule(new EQRule(_.buildEventNameRule(eventName)));unitRuleGroup.addRule(_parseCompound(item.relation,item.filts,this.taskFlow.zoneOffset));this.blackListGroup.addRule(unitRuleGroup)}}},{key:"isTargetEvent",value:function isTargetEvent(event){return _superPropGet(ContinueTriggerRule,"isTargetEvent",this,3)([event])||this.disableEventList.includes(event)}},{key:"triggerEventRules",value:function(){var _triggerEventRules2=_asyncToGenerator(_regenerator().m((function _callee2(facts){var eventName,isBlackTrigger;return _regenerator().w((function(_context2){while(1)switch(_context2.n){case 0:eventName=facts[Config.EVENT_NAME_KEY];if(!this.disableEventList.includes(eventName)){_context2.n=3;break}logger.info("BlackList Event:"+eventName+"------start trigger rules------");_context2.n=1;return this.blackListGroup.evaluate(facts);case 1:isBlackTrigger=_context2.v;logger.info("BlackList Event:"+eventName+"------end trigger rules------result is "+isBlackTrigger);if(!isBlackTrigger){_context2.n=2;break}_context2.n=2;return addTriggerResult({appId:this.taskFlow.appId,clientUserId:this.clientUserId,taskId:this.taskFlow.taskId,triggerId:this.triggerId,id:_.generateUniqueId(),key:eventName,num:1,event:{},eventTime:AnalyticUtil.getCurrentTimeStamp()});case 2:return _context2.a(2,false);case 3:_context2.n=4;return _superPropGet(ContinueTriggerRule,"triggerEventRules",this,3)([facts]);case 4:return _context2.a(2,_context2.v)}}),_callee2,this)})));function triggerEventRules(_x2){return _triggerEventRules2.apply(this,arguments)}return triggerEventRules}()},{key:"getTimeCycle",value:function getTimeCycle(){if(!this.periodScrollInfo)return this.mTriggerTimeCycle;var pair=this.mTriggerTimeCycle.getCurrentTimeCycle();var tInfo={periodStartStamp:pair.start,periodEndStamp:pair.end};return new SlideTimeCycle(tInfo,this.periodScrollInfo)}}])}(EveryTriggerRule);var TaskFlow=function(){function TaskFlow(appId,clientUserId,taskJson){_classCallCheck(this,TaskFlow);this.appId=appId;this.clientUserId=clientUserId;this.taskJson=taskJson;this.triggerRules=[];this.parseTaskInfo();this.parseTriggerRule();this.parseExpConfig();this.parseTargetAudience();this.parseTaskLimit();this.parseContentList()}return _createClass(TaskFlow,[{key:"parseTaskInfo",value:function parseTaskInfo(){this.taskId=this.taskJson.taskId;this.projectId=this.taskJson.projectId;this.zoneOffset=this.taskJson.tzOffset;this.taskVersion=this.taskJson.currentVersion;this.channelId=this.taskJson.channelId;this.channelMsgType=this.taskJson.channelMsgType;this.taskMode=this.taskJson.pushMode;this.eventTimeout=this.taskJson.eventTimeout?this.taskJson.eventTimeout:5e3;this.taskTimeCycle=new StartEndLimit({periodStart:this.taskJson.startDate,periodEnd:this.taskJson.endDate,zoneOffset:this.zoneOffset})}},{key:"parseTriggerRule",value:function parseTriggerRule(){if(!this.taskJson.triggerRule)return;var ruleArray=JSON.parse(this.taskJson.triggerRule);if(!_.isArray(ruleArray))return;for(var i=0;i<ruleArray.length;i++){var item=ruleArray[i];if(!item)continue;var triggerRule;switch(item.eventTriggerType){case 1:triggerRule=new ContinueTriggerRule(this,item,i);break;case 3:triggerRule=new EveryTriggerRule(this,item,i);break}if(triggerRule){this.triggerRules.push(triggerRule)}}}},{key:"parseExpConfig",value:function parseExpConfig(){this.mExpConfig=new ExpConfig(this.taskJson,this.zoneOffset)}},{key:"parseTargetAudience",value:function parseTargetAudience(){var clientQpStr=this.taskJson.clientQp;var clientQpJson;if(clientQpStr){clientQpJson=JSON.parse(clientQpStr)}if(!_.isObject(clientQpJson)){clientQpJson={}}this.mTargetAudience=new TargetAudience(this,this.taskJson.isTargetUser,clientQpJson,this.taskJson.pushId)}},{key:"parseTaskLimit",value:function parseTaskLimit(){this.mTaskFrequencyLimit=new FrequencyLimit(this);this.mTaskTouchLimit=new UserFatigueControl(this)}},{key:"parseContentList",value:function parseContentList(){this.mPushResult=new PushResult(this)}},{key:"startClientRecord",value:function startClientRecord(){this.triggerRecord={appId:this.appId,clientUserId:this.clientUserId,taskId:this.taskId,isTestTask:this.isTestTask()}}},{key:"isTargetEvent",value:function isTargetEvent(eventName){if(AnalyticUtil.isWhiteEvent(eventName))return true;var isTargetEvent=false;for(var i=0;i<this.triggerRules.length;i++){if(this.triggerRules[i].isTargetEvent(eventName)){isTargetEvent=true;break}}if(isTargetEvent){logger.info("Task ("+this.taskId+") contains target event")}return isTargetEvent}},{key:"isEventTimeout",value:function isEventTimeout(enqueueTime){if(enqueueTime===0)return false;return AnalyticUtil.getCurrentTimeStamp-enqueueTime>this.eventTimeout}},{key:"isValidityPeriod",value:function isValidityPeriod(){if(this.isChannelTestTask())return true;var isInPeriod=this.taskTimeCycle.isWithInPeriod();if(!isInPeriod){logger.info("Task ("+this.taskId+") is not in the validity period")}return isInPeriod}},{key:"triggerEvent",value:function(){var _triggerEvent=_asyncToGenerator(_regenerator().m((function _callee(facts){var isTrigger,i;return _regenerator().w((function(_context){while(1)switch(_context.n){case 0:isTrigger=false;if(!this.isChannelTestTask()){_context.n=1;break}isTrigger=true;_context.n=5;break;case 1:i=0;case 2:if(!(i<this.triggerRules.length)){_context.n=5;break}_context.n=3;return this.triggerRules[i].triggerEventRules(facts);case 3:if(!_context.v){_context.n=4;break}isTrigger=true;return _context.a(3,5);case 4:i++;_context.n=2;break;case 5:if(isTrigger){this.triggerRecord.triggerTime=AnalyticUtil.getCurrentDate()}return _context.a(2,isTrigger)}}),_callee,this)})));function triggerEvent(_x){return _triggerEvent.apply(this,arguments)}return triggerEvent}()},{key:"isTargetAudience",value:function(){var _isTargetAudience=_asyncToGenerator(_regenerator().m((function _callee2(facts){var isTarget;return _regenerator().w((function(_context2){while(1)switch(_context2.n){case 0:_context2.n=1;return this.mTargetAudience.isTargetAudience(facts);case 1:isTarget=_context2.v;return _context2.a(2,isTarget)}}),_callee2,this)})));function isTargetAudience(_x2){return _isTargetAudience.apply(this,arguments)}return isTargetAudience}()},{key:"isTaskLimit",value:function(){var _isTaskLimit=_asyncToGenerator(_regenerator().m((function _callee3(){return _regenerator().w((function(_context3){while(1)switch(_context3.n){case 0:_context3.n=1;return this.mTaskFrequencyLimit.isLimit();case 1:if(!_context3.v){_context3.n=2;break}this.triggerRecord.status=FREQUENCY_CONTROL;AnalyticUtil.trackTriggerEvent(this.triggerRecord);return _context3.a(2,true);case 2:if(!this.mExpConfig.isExpSampleOut()){_context3.n=3;break}this.triggerRecord.status=SAMPLE;AnalyticUtil.trackTriggerEvent(this.triggerRecord);logger.info("Task ("+this.taskId+") is sampling and elimination");return _context3.a(2,true);case 3:_context3.n=4;return this.mTaskTouchLimit.isLimit();case 4:if(!_context3.v){_context3.n=5;break}this.triggerRecord.status=FATIGUE_CONTROL;AnalyticUtil.trackTriggerEvent(this.triggerRecord);return _context3.a(2,true);case 5:if(!this.mExpConfig.isSkipPush()){_context3.n=6;break}this.triggerRecord.status=EXP_SKIP_PUSH;AnalyticUtil.trackTriggerEvent(this.triggerRecord);logger.info("Task ("+this.taskId+") is skip push");return _context3.a(2,true);case 6:return _context3.a(2,false)}}),_callee3,this)})));function isTaskLimit(){return _isTaskLimit.apply(this,arguments)}return isTaskLimit}()},{key:"finishClientRecord",value:function(){var _finishClientRecord=_asyncToGenerator(_regenerator().m((function _callee4(isPushSuccess){return _regenerator().w((function(_context4){while(1)switch(_context4.n){case 0:this.triggerRecord.actualPushTime=AnalyticUtil.getCurrentDate();_context4.n=1;return this.mTaskFrequencyLimit.addLimitCount();case 1:_context4.n=2;return this.mTaskTouchLimit.addLimitCount();case 2:if(isPushSuccess){this.triggerRecord.status=SUCCESS}else{this.triggerRecord.status=FAIL}AnalyticUtil.trackTriggerEvent(this.triggerRecord);case 3:return _context4.a(2)}}),_callee4,this)})));function finishClientRecord(_x3){return _finishClientRecord.apply(this,arguments)}return finishClientRecord}()},{key:"isExpRelease",value:function isExpRelease(){return this.mExpConfig.isExpRelease(this.triggerRecord)}},{key:"calculate",value:function calculate(facts){return this.mPushResult.calculate(facts)}},{key:"isChannelTestTask",value:function isChannelTestTask(){return this.taskMode===3}},{key:"isTestTask",value:function isTestTask(){return this.taskMode===2||this.taskMode===3}}])}();var TD_SYSTEM_CONFIG="td_system_config";var STRATEGY_CLIENT="strategy_client";var SystemConfig=function(){function SystemConfig(){_classCallCheck(this,SystemConfig);this.loadSuccess=false;this.systemConfigs=[]}return _createClass(SystemConfig,[{key:"loadLocalConfig",value:function(){var _loadLocalConfig=_asyncToGenerator(_regenerator().m((function _callee(){var configList,i,conf;return _regenerator().w((function(_context){while(1)switch(_context.n){case 0:if(!this.loadSuccess){_context.n=1;break}return _context.a(2);case 1:_context.n=2;return PlatformAPI.getStorage(TD_SYSTEM_CONFIG);case 2:configList=_context.v;if(_.isArray(configList)){for(i=0;i<configList.length;i++){conf=configList[i];if(conf.plat===STRATEGY_CLIENT){this.systemConfigs.push(conf)}}}this.loadSuccess=true;case 3:return _context.a(2)}}),_callee,this)})));function loadLocalConfig(){return _loadLocalConfig.apply(this,arguments)}return loadLocalConfig}()},{key:"isStratetyStop",value:function isStratetyStop(appId){for(var i=0;i<this.systemConfigs.length;i++){var conf=this.systemConfigs[i];if(conf.appId===appId){if(conf.disabled)return true;if(!_.isArray(conf.disabledVersionList))return false;return conf.disabledVersionList.includes(Config.LIB_VERSION)}}return false}}],[{key:"getInstance",value:function getInstance(){if(!SystemConfig.instance){SystemConfig.instance=new SystemConfig}return SystemConfig.instance}}])}();var TaskFlowManager=function(){function TaskFlowManager(appId){_classCallCheck(this,TaskFlowManager);this.appId=appId;this.taskFlows=new Map;this.mDebugTriggerList=[];this.preEventCaches=[]}return _createClass(TaskFlowManager,[{key:"loadLocalTask",value:function(){var _loadLocalTask=_asyncToGenerator(_regenerator().m((function _callee(callback){var _this=this;var clientUserId,taskMap;return _regenerator().w((function(_context){while(1)switch(_context.n){case 0:if(!(this.taskFlows.size>0)){_context.n=1;break}return _context.a(2);case 1:if(_.isFunction(callback)){this.triggerListener=callback}ClientStartTimeCycle.clientStartTime=AnalyticUtil.getCurrentTimeStamp();_context.n=2;return deleteTaskByLimit(this.appId,Config.DATA_BASE_LIMIT);case 2:_context.n=3;return deleteTriggerResultLimit(Config.DATA_BASE_LIMIT);case 3:_context.n=4;return deleteFrequencyByLimit(Config.DATA_BASE_LIMIT);case 4:_context.n=5;return deleteTouchLimitByTime(Config.DATA_TIME_LIMIT);case 5:_context.n=6;return AnalyticUtil.getClientUserId(this.appId);case 6:clientUserId=_context.v;_context.n=7;return getTasks(this.appId,clientUserId);case 7:taskMap=_context.v;_.each(taskMap,(function(value,_key){_this.taskFlows.set(value.taskId,new TaskFlow(_this.appId,clientUserId,value.task))}));_context.n=8;return getTaskStatus({appId:this.appId,clientUserId:clientUserId});case 8:this.mTaskStop=_context.v;_context.n=9;return this.clearPreEvent();case 9:return _context.a(2)}}),_callee,this)})));function loadLocalTask(_x){return _loadLocalTask.apply(this,arguments)}return loadLocalTask}()},{key:"stopTasks",value:function(){var _stopTasks=_asyncToGenerator(_regenerator().m((function _callee2(templateCode,userId){return _regenerator().w((function(_context2){while(1)switch(_context2.n){case 0:if(!this.mTaskStop){_context2.n=1;break}return _context2.a(2);case 1:if(!SystemConfig.getInstance().isStratetyStop(this.appId)){_context2.n=2;break}return _context2.a(2);case 2:if(!(templateCode!==Config.STRATEGY_TEMPLATE_CODE)){_context2.n=3;break}return _context2.a(2);case 3:this.taskFlows.clear();this.mTaskStop=true;_context2.n=4;return updateTaskStatus({appId:this.appId,clientUserId:userId,status:true});case 4:return _context2.a(2)}}),_callee2,this)})));function stopTasks(_x2,_x3){return _stopTasks.apply(this,arguments)}return stopTasks}()},{key:"applyNewConfig",value:function(){var _applyNewConfig=_asyncToGenerator(_regenerator().m((function _callee4(templateCode,userId){var _this2=this;var taskJson,taskMap,taskList,taskIds,pauseTaskIds,channelTestIds,i,tJson,taskId,version,taskItem,flow,_iterator,_step,_step$value,key,value,j,t;return _regenerator().w((function(_context4){while(1)switch(_context4.n){case 0:if(!SystemConfig.getInstance().isStratetyStop(this.appId)){_context4.n=1;break}return _context4.a(2);case 1:if(!(templateCode!==Config.STRATEGY_TEMPLATE_CODE)){_context4.n=2;break}return _context4.a(2);case 2:this.mTaskStop=false;_context4.n=3;return updateTaskStatus({appId:this.appId,clientUserId:userId,status:false});case 3:taskJson=AnalyticUtil.getStrategyInfo(this.appId);if(!taskJson){taskJson=[]}_context4.n=4;return getTasks(this.appId,userId);case 4:taskMap=_context4.v;taskList=[];taskIds=[];pauseTaskIds=[];channelTestIds=[];i=0;case 5:if(!(i<taskJson.length)){_context4.n=10;break}tJson=taskJson[i];if(tJson){_context4.n=6;break}return _context4.a(3,9);case 6:taskId=tJson.taskId;version=tJson.currentVersion;if(!(tJson.status!==1)){_context4.n=7;break}pauseTaskIds.push(taskId);taskList.push({taskId:taskId,taskVersion:version,clientUserId:userId,task:""});return _context4.a(3,9);case 7:taskItem=taskMap[taskId];if(!(taskItem&&version>taskItem.taskVersion)){_context4.n=8;break}_context4.n=8;return deleteTriggerResult({appId:this.appId,clientUserId:userId,taskId:taskId});case 8:taskIds.push(taskId);taskList.push({taskId:taskId,taskVersion:version,clientUserId:userId,task:tJson});flow=this.taskFlows[taskId];if(!flow||version>=flow.taskVersion){flow=new TaskFlow(this.appId,userId,tJson);this.taskFlows.set(taskId,flow)}if(flow.isTestTask()){channelTestIds.push(taskId)}case 9:i++;_context4.n=5;break;case 10:_context4.n=11;return updateTask(this.appId,userId,taskList);case 11:_.each(taskMap,function(){var _ref=_asyncToGenerator(_regenerator().m((function _callee3(value,key){return _regenerator().w((function(_context3){while(1)switch(_context3.n){case 0:if(!(!taskIds.includes(key)&&!pauseTaskIds.includes(key))){_context3.n=2;break}_context3.n=1;return deleteTriggerResult({appId:_this2.appId,clientUserId:userId,taskId:key});case 1:_context3.n=2;return deleteFrequencyLimit({appId:_this2.appId,clientUserId:userId,taskId:key});case 2:return _context3.a(2)}}),_callee3)})));return function(_x6,_x7){return _ref.apply(this,arguments)}}());_iterator=_createForOfIteratorHelper(this.taskFlows);try{for(_iterator.s();!(_step=_iterator.n()).done;){_step$value=_slicedToArray(_step.value,2),key=_step$value[0],value=_step$value[1];if(!taskIds.includes(key)){this.taskFlows["delete"](key)}}}catch(err){_iterator.e(err)}finally{_iterator.f()}_context4.n=12;return this.clearPreEvent();case 12:AnalyticUtil.trackClientDebugEvent(this.appId,channelTestIds);j=0;case 13:if(!(j<channelTestIds.length)){_context4.n=17;break}t=this.taskFlows.get(channelTestIds[j]);if(t){_context4.n=14;break}return _context4.a(3,16);case 14:if(t.isChannelTestTask()){_context4.n=15;break}return _context4.a(3,16);case 15:_context4.n=16;return this.taskTriggerFlow(t,CHANNEL_TEST_EVENT,AnalyticUtil.buildAnalyticPresetFacts(this.appId));case 16:j++;_context4.n=13;break;case 17:return _context4.a(2)}}),_callee4,this)})));function applyNewConfig(_x4,_x5){return _applyNewConfig.apply(this,arguments)}return applyNewConfig}()},{key:"clearPreEvent",value:function(){var _clearPreEvent=_asyncToGenerator(_regenerator().m((function _callee5(){var i;return _regenerator().w((function(_context5){while(1)switch(_context5.n){case 0:if(!(this.taskFlows.size<=0)){_context5.n=1;break}return _context5.a(2);case 1:this.loadTaskSuccess=true;i=0;case 2:if(!(i<this.preEventCaches.length)){_context5.n=4;break}_context5.n=3;return this.triggerEvent(this.preEventCaches[i].event,this.preEventCaches[i].time);case 3:i++;_context5.n=2;break;case 4:this.preEventCaches=[];case 5:return _context5.a(2)}}),_callee5,this)})));function clearPreEvent(){return _clearPreEvent.apply(this,arguments)}return clearPreEvent}()},{key:"triggerEvent",value:function(){var _triggerEvent=_asyncToGenerator(_regenerator().m((function _callee6(eventJson,eventEnqueueTime){var eventName,facts,_iterator2,_step2,_step2$value,key,value,_t;return _regenerator().w((function(_context6){while(1)switch(_context6.n){case 0:if(!SystemConfig.getInstance().isStratetyStop(this.appId)){_context6.n=1;break}return _context6.a(2);case 1:if(eventJson){_context6.n=2;break}return _context6.a(2);case 2:if(!this.mTaskStop){_context6.n=3;break}return _context6.a(2);case 3:if(eventJson[Config.EVENT_TYPE_KEY]==="track"&&!eventJson[Config.FIRST_CHECK_ID_KEY]){_context6.n=4;break}return _context6.a(2);case 4:eventName=eventJson[Config.EVENT_NAME_KEY];if(eventName){_context6.n=5;break}return _context6.a(2);case 5:if(this.loadTaskSuccess){_context6.n=6;break}if(this.preEventCaches.length<20){this.preEventCaches.push({time:AnalyticUtil.getCurrentTimeStamp(),event:eventJson})}return _context6.a(2);case 6:if(!AnalyticUtil.isBlackEvent(eventName)){_context6.n=7;break}return _context6.a(2);case 7:facts=_.jsonToFacts(eventJson);logger.info("Event received:"+eventName);_iterator2=_createForOfIteratorHelper(this.taskFlows);_context6.p=8;_iterator2.s();case 9:if((_step2=_iterator2.n()).done){_context6.n=11;break}_step2$value=_slicedToArray(_step2.value,2),key=_step2$value[0],value=_step2$value[1];_context6.n=10;return this.taskTriggerFlow(value,eventName,facts,eventEnqueueTime);case 10:_context6.n=9;break;case 11:_context6.n=13;break;case 12:_context6.p=12;_t=_context6.v;_iterator2.e(_t);case 13:_context6.p=13;_iterator2.f();return _context6.f(13);case 14:return _context6.a(2)}}),_callee6,this,[[8,12,13,14]])})));function triggerEvent(_x8,_x9){return _triggerEvent.apply(this,arguments)}return triggerEvent}()},{key:"taskTriggerFlow",value:function(){var _taskTriggerFlow=_asyncToGenerator(_regenerator().m((function _callee7(flow,eventName,facts,eventEnqueueTime){var result,isPushSuccess;return _regenerator().w((function(_context7){while(1)switch(_context7.n){case 0:if(!this.mDebugTriggerList.includes(flow.taskId)){_context7.n=1;break}return _context7.a(2);case 1:flow.startClientRecord();if(flow.isTargetEvent(eventName)){_context7.n=2;break}return _context7.a(2);case 2:if(!flow.isEventTimeout(eventEnqueueTime)){_context7.n=3;break}return _context7.a(2);case 3:if(flow.isValidityPeriod()){_context7.n=4;break}return _context7.a(2);case 4:_context7.n=5;return flow.triggerEvent(facts);case 5:if(_context7.v){_context7.n=6;break}return _context7.a(2);case 6:_context7.n=7;return flow.isTargetAudience(facts);case 7:if(_context7.v){_context7.n=8;break}return _context7.a(2);case 8:if(flow.isExpRelease()){_context7.n=9;break}return _context7.a(2);case 9:_context7.n=10;return flow.isTaskLimit();case 10:if(!_context7.v){_context7.n=11;break}return _context7.a(2);case 11:result=flow.calculate(facts);logger.info("Task ("+flow.taskId+") will be pushed soon");isPushSuccess=false;if(this.triggerListener){this.triggerListener(result);isPushSuccess=true}if(flow.isChannelTestTask()){this.mDebugTriggerList.push(flow.taskId)}_context7.n=12;return flow.finishClientRecord(isPushSuccess);case 12:return _context7.a(2)}}),_callee7,this)})));function taskTriggerFlow(_x0,_x1,_x10,_x11){return _taskTriggerFlow.apply(this,arguments)}return taskTriggerFlow}()}],[{key:"getInstance",value:function getInstance(appId){if(!TaskFlowManager.instances){TaskFlowManager.instances={}}var instance=TaskFlowManager.instances[appId];if(!instance){instance=new TaskFlowManager(appId);TaskFlowManager.instances[appId]=instance}return instance}}])}();var StrategyTaskQueue=function(){function StrategyTaskQueue(){_classCallCheck(this,StrategyTaskQueue);this.tasks=[];this.timeStamp=0}return _createClass(StrategyTaskQueue,[{key:"addTask",value:function addTask(taskFunc){var task=function(){return taskFunc.apply(this)}.bind(this);this.tasks.push(task);this.run()}},{key:"run",value:function(){var _run=_asyncToGenerator(_regenerator().m((function _callee(){var task;return _regenerator().w((function(_context){while(1)switch(_context.n){case 0:if(!(this.tasks.length<=0)){_context.n=1;break}return _context.a(2);case 1:if(!(this.timeStamp===0||Date.now()-this.timeStamp>3e3)){_context.n=3;break}this.timeStamp=Date.now();task=this.tasks.shift();_context.n=2;return task();case 2:this.timeStamp=0;this.run();case 3:return _context.a(2)}}),_callee,this)})));function run(){return _run.apply(this,arguments)}return run}()}],[{key:"getInstance",value:function getInstance(){if(!StrategyTaskQueue.instance){StrategyTaskQueue.instance=new StrategyTaskQueue}return StrategyTaskQueue.instance}}])}();var TDAnalytics$1=PlatformAPI.getAnalyticGlobalData();var TDRemoteConfig$1=PlatformAPI.getConfigGlobalData();var TDStrategy=function(){function TDStrategy(){_classCallCheck(this,TDStrategy)}return _createClass(TDStrategy,null,[{key:"init",value:function(){var _init=_asyncToGenerator(_regenerator().m((function _callee5(config){return _regenerator().w((function(_context5){while(1)switch(_context5.n){case 0:config=_.checkSettings(config);if(config){_context5.n=1;break}return _context5.a(2);case 1:if(!TDStrategy.initAppIds){TDStrategy.initAppIds=[]}if(!TDStrategy.initAppIds.includes(config.appId)){_context5.n=2;break}return _context5.a(2);case 2:TDAnalytics$1.registerAnalyticsObserver((function(type,obj){if(type==="onDataEnqueue"){StrategyTaskQueue.getInstance().addTask(_asyncToGenerator(_regenerator().m((function _callee(){return _regenerator().w((function(_context){while(1)switch(_context.n){case 0:_context.n=1;return TaskFlowManager.getInstance(obj.appId).triggerEvent(obj.event,0);case 1:return _context.a(2)}}),_callee)}))))}}),config.appId);config.remoteconfigObserver=function(type,obj){if(type==="onConfigApplySuccess"){StrategyTaskQueue.getInstance().addTask(_asyncToGenerator(_regenerator().m((function _callee2(){return _regenerator().w((function(_context2){while(1)switch(_context2.n){case 0:_context2.n=1;return TaskFlowManager.getInstance(obj.appId).applyNewConfig(obj.templateCode,obj.clientUserId);case 1:return _context2.a(2)}}),_callee2)}))))}else if(type==="onConfigChanged"){StrategyTaskQueue.getInstance().addTask(_asyncToGenerator(_regenerator().m((function _callee3(){return _regenerator().w((function(_context3){while(1)switch(_context3.n){case 0:_context3.n=1;return TaskFlowManager.getInstance(obj.appId).stopTasks(obj.templateCode,obj.clientUserId);case 1:return _context3.a(2)}}),_callee3)}))))}};_context5.n=3;return SystemConfig.getInstance().loadLocalConfig();case 3:if(!SystemConfig.getInstance().isStratetyStop(config.appId)){_context5.n=4;break}return _context5.a(2);case 4:TDRemoteConfig$1.init(config);StrategyTaskQueue.getInstance().addTask(_asyncToGenerator(_regenerator().m((function _callee4(){return _regenerator().w((function(_context4){while(1)switch(_context4.n){case 0:_context4.n=1;return TaskFlowManager.getInstance(config.appId).loadLocalTask(config.triggerListener);case 1:logger.info("TDStrategy SDK init success with appId = "+config.appId+" and version = "+Config.LIB_VERSION);case 2:return _context4.a(2)}}),_callee4)}))));TDStrategy.initAppIds.push(config.appId);case 5:return _context5.a(2)}}),_callee5)})));function init(_x){return _init.apply(this,arguments)}return init}()},{key:"setLogPrintListener",value:function setLogPrintListener(listener){logger.listener=listener}},{key:"addClientParams",value:function addClientParams(params){StrategyTaskQueue.getInstance().addTask(_asyncToGenerator(_regenerator().m((function _callee6(){return _regenerator().w((function(_context6){while(1)switch(_context6.n){case 0:_context6.n=1;return TDClientValueManager.addClientParams(params);case 1:return _context6.a(2)}}),_callee6)}))))}},{key:"removeClientParam",value:function removeClientParam(key){StrategyTaskQueue.getInstance().addTask(_asyncToGenerator(_regenerator().m((function _callee7(){return _regenerator().w((function(_context7){while(1)switch(_context7.n){case 0:_context7.n=1;return TDClientValueManager.removeClientParam(key);case 1:return _context7.a(2)}}),_callee7)}))))}}])}();PlatformAPI.setGlobalData(TDStrategy);export default TDStrategy;