((t,e)=>{"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).TDStrategy=e()})(this,function(){function F(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=Array(e);r<e;r++)n[r]=t[r];return n}function j(t,e,r,n,i,s,a){try{var u=t[s](a),o=u.value}catch(t){return r(t)}u.done?e(o):Promise.resolve(o).then(n,i)}function b(u){return function(){var t=this,a=arguments;return new Promise(function(e,r){var n=u.apply(t,a);function i(t){j(n,e,r,i,s,"next",t)}function s(t){j(n,e,r,i,s,"throw",t)}i(void 0)})}}function n(t,e,r){e=s(e);var n=t,e=J()?Reflect.construct(e,r||[],s(t).constructor):e.apply(t,r);if(!e||"object"!=typeof e&&"function"!=typeof e){if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");if(void 0===(e=n))throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return e}function u(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function A(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,B(n.key),n)}}function o(t,e,r){return e&&A(t.prototype,e),r&&A(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function M(t,e){var r,n,i,s,a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(a)return i=!(n=!0),{s:function(){a=a.call(t)},n:function(){var t=a.next();return n=t.done,t},e:function(t){i=!0,r=t},f:function(){try{n||null==a.return||a.return()}finally{if(i)throw r}}};if(Array.isArray(t)||(a=z(t))||e&&t&&"number"==typeof t.length)return a&&(t=a),s=0,{s:e=function(){},n:function(){return s>=t.length?{done:!0}:{done:!1,value:t[s++]}},e:function(t){throw t},f:e};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function V(t,e,r){return(e=B(e))in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function G(){return(G="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,r){var n=((t,e)=>{for(;!{}.hasOwnProperty.call(t,e)&&null!==(t=s(t)););return t})(t,e);if(n)return(n=Object.getOwnPropertyDescriptor(n,e)).get?n.get.call(arguments.length<3?t:r):n.value}).apply(null,arguments)}function s(t){return(s=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&W(t,e)}function J(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(t){}return(J=function(){return!!t})()}function I(){var m,t="function"==typeof Symbol?Symbol:{},e=t.iterator||"@@iterator",r=t.toStringTag||"@@toStringTag";function n(t,e,r,n){var i,s,a,u,o,c,l,h,f,e=e&&e.prototype instanceof d?e:d,e=Object.create(e.prototype);return y(e,"_invoke",(i=t,s=r,l=n||[],h=!1,f={p:c=0,n:0,v:m,a:p,f:p.bind(m,4),d:function(t,e){return a=t,u=0,o=m,f.n=e,g}},function(t,e,r){if(1<c)throw TypeError("Generator is already running");for(h&&1===e&&p(e,r),u=e,o=r;(v=u<2?m:o)||!h;){a||(u?u<3?(1<u&&(f.n=-1),p(u,o)):f.n=o:f.v=o);try{if(c=2,a){if(v=a[t=u?t:"next"]){if(!(v=v.call(a,o)))throw TypeError("iterator result is not an object");if(!v.done)return v;o=v.value,u<2&&(u=0)}else 1===u&&(v=a.return)&&v.call(a),u<2&&(o=TypeError("The iterator does not provide a '"+t+"' method"),u=1);a=m}else if((v=(h=f.n<0)?o:i.call(s,f))!==g)break}catch(t){a=m,u=1,o=t}finally{c=1}}return{value:v,done:h}}),!0),e;function p(t,e){for(u=t,o=e,v=0;!h&&c&&!r&&v<l.length;v++){var r,n=l[v],i=f.p,s=n[2];3<t?(r=s===e)&&(o=n[(u=n[4])?5:u=3],n[4]=n[5]=m):n[0]<=i&&((r=t<2&&i<n[1])?(u=0,f.v=e,f.n=n[1]):i<s&&(r=t<3||n[0]>e||s<e)&&(n[4]=t,n[5]=e,f.n=s,u=0))}if(r||1<t)return g;throw h=!0,e}}var g={};function d(){}function i(){}function s(){}var v=Object.getPrototypeOf,t=[][e]?v(v([][e]())):(y(v={},e,function(){return this}),v),a=s.prototype=d.prototype=Object.create(t);function u(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,s):(t.__proto__=s,y(t,r,"GeneratorFunction")),t.prototype=Object.create(a),t}return y(a,"constructor",i.prototype=s),y(s,"constructor",i),y(s,r,i.displayName="GeneratorFunction"),y(a),y(a,r,"Generator"),y(a,e,function(){return this}),y(a,"toString",function(){return"[object Generator]"}),(I=function(){return{w:n,m:u}})()}function y(t,e,r,n){var s=Object.defineProperty;try{s({},"",{})}catch(t){s=0}(y=function(t,e,r,n){function i(e,r){y(t,e,function(t){return this._invoke(e,r,t)})}e?s?s(t,e,{value:r,enumerable:!n,configurable:!n,writable:!n}):t[e]=r:(i("next",0),i("throw",1),i("return",2))})(t,e,r,n)}function W(t,e){return(W=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t})(t,e)}function w(t,e){return(t=>{if(Array.isArray(t))return t})(t)||((t,e)=>{var r=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=r){var n,i,s,a,u=[],o=!0,c=!1;try{if(s=(r=r.call(t)).next,0===e){if(Object(r)!==r)return;o=!1}else for(;!(o=(n=s.call(r)).done)&&(u.push(n.value),u.length!==e);o=!0);}catch(t){c=!0,i=t}finally{try{if(!o&&null!=r.return&&(a=r.return(),Object(a)!==a))return}finally{if(c)throw i}}return u}})(t,e)||z(t,e)||(()=>{throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")})()}function H(t,e,r,n){var i=G(s(1&n?t.prototype:t),e,r);return 2&n&&"function"==typeof i?function(t){return i.apply(r,t)}:i}function B(t){t=((t,e)=>{if("object"!=typeof t||!t)return t;var r=t[Symbol.toPrimitive];if(void 0===r)return("string"===e?String:Number)(t);if("object"!=typeof(r=r.call(t,e||"default")))return r;throw new TypeError("@@toPrimitive must return a primitive value.")})(t,"string");return"symbol"==typeof t?t:t+""}function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function z(t,e){var r;if(t)return"string"==typeof t?F(t,e):"Map"===(r="Object"===(r={}.toString.call(t).slice(8,-1))&&t.constructor?t.constructor.name:r)||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?F(t,e):void 0}var q="1.1.1",C="td_strategy",h="varchar",f="timestamp",p="boolean",m="integer",g="bigint",d="double",v="decimal",Y="array(varchar)",c="#event_name",$="#type",K="#first_check_id",l="#zone_offset",Q="#time",X=900,Z=31,k="day",tt="week",et="month",rt="hour",nt="minute",r=(a=>{var o,t=Object.prototype,c=t.hasOwnProperty,l=Object.defineProperty||function(t,e,r){t[e]=r.value},e="function"==typeof Symbol?Symbol:{},n=e.iterator||"@@iterator",r=e.asyncIterator||"@@asyncIterator",i=e.toStringTag||"@@toStringTag";function s(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{s({},"")}catch(t){s=function(t,e,r){return t[e]=r}}function u(t,e,r,n){var i,s,a,u,e=e&&e.prototype instanceof v?e:v,e=Object.create(e.prototype),n=new N(n||[]);return l(e,"_invoke",{value:(i=t,s=r,a=n,u=f,function(t,e){if(u===m)throw new Error("Generator is already running");if(u===g){if("throw"===t)throw e;return{value:o,done:!0}}for(a.method=t,a.arg=e;;){var r=a.delegate;if(r){r=function t(e,r){var n=r.method;var i=e.iterator[n];if(i===o)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=o,t(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),d;n=h(i,e.iterator,r.arg);if("throw"===n.type)return r.method="throw",r.arg=n.arg,r.delegate=null,d;i=n.arg;if(!i)return r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,d;{if(!i.done)return i;r[e.resultName]=i.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=o)}r.delegate=null;return d}(r,a);if(r){if(r===d)continue;return r}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if(u===f)throw u=g,a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);u=m;r=h(i,s,a);if("normal"===r.type){if(u=a.done?g:p,r.arg!==d)return{value:r.arg,done:a.done}}else"throw"===r.type&&(u=g,a.method="throw",a.arg=r.arg)}})}),e}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}a.wrap=u;var f="suspendedStart",p="suspendedYield",m="executing",g="completed",d={};function v(){}function y(){}function k(){}s(e={},n,function(){return this});var T=Object.getPrototypeOf,b=((T=T&&T(T(E([]))))&&T!==t&&c.call(T,n)&&(e=T),k.prototype=v.prototype=Object.create(e));function I(t){["next","throw","return"].forEach(function(e){s(t,e,function(t){return this._invoke(e,t)})})}function w(a,u){var e;l(this,"_invoke",{value:function(r,n){function t(){return new u(function(t,e){!function e(t,r,n,i){var s,t=h(a[t],a,r);if("throw"!==t.type)return(r=(s=t.arg).value)&&"object"==typeof r&&c.call(r,"__await")?u.resolve(r.__await).then(function(t){e("next",t,n,i)},function(t){e("throw",t,n,i)}):u.resolve(r).then(function(t){s.value=t,n(s)},function(t){return e("throw",t,n,i)});i(t.arg)}(r,n,t,e)})}return e=e?e.then(t,t):t()}})}function C(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function S(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function N(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(C,this),this.reset(!0)}function E(e){if(null!=e){var r,t=e[n];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length))return r=-1,(t=function t(){for(;++r<e.length;)if(c.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=o,t.done=!0,t}).next=t}throw new TypeError(typeof e+" is not iterable")}return l(b,"constructor",{value:y.prototype=k,configurable:!0}),l(k,"constructor",{value:y,configurable:!0}),y.displayName=s(k,i,"GeneratorFunction"),a.isGeneratorFunction=function(t){t="function"==typeof t&&t.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},a.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,k):(t.__proto__=k,s(t,i,"GeneratorFunction")),t.prototype=Object.create(b),t},a.awrap=function(t){return{__await:t}},I(w.prototype),s(w.prototype,r,function(){return this}),a.AsyncIterator=w,a.async=function(t,e,r,n,i){void 0===i&&(i=Promise);var s=new w(u(t,e,r,n),i);return a.isGeneratorFunction(e)?s:s.next().then(function(t){return t.done?t.value:s.next()})},I(b),s(b,i,"Generator"),s(b,n,function(){return this}),s(b,"toString",function(){return"[object Generator]"}),a.keys=function(t){var e,r=Object(t),n=[];for(e in r)n.push(e);return n.reverse(),function t(){for(;n.length;){var e=n.pop();if(e in r)return t.value=e,t.done=!1,t}return t.done=!0,t}},a.values=E,N.prototype={constructor:N,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=o,this.done=!1,this.delegate=null,this.method="next",this.arg=o,this.tryEntries.forEach(S),!t)for(var e in this)"t"===e.charAt(0)&&c.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=o)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(r){if(this.done)throw r;var n=this;function t(t,e){return s.type="throw",s.arg=r,n.next=t,e&&(n.method="next",n.arg=o),!!e}for(var e=this.tryEntries.length-1;0<=e;--e){var i=this.tryEntries[e],s=i.completion;if("root"===i.tryLoc)return t("end");if(i.tryLoc<=this.prev){var a=c.call(i,"catchLoc"),u=c.call(i,"finallyLoc");if(a&&u){if(this.prev<i.catchLoc)return t(i.catchLoc,!0);if(this.prev<i.finallyLoc)return t(i.finallyLoc)}else if(a){if(this.prev<i.catchLoc)return t(i.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return t(i.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;0<=r;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&c.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var i=n;break}}var s=(i=i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc?null:i)?i.completion:{};return s.type=t,s.arg=e,i?(this.method="next",this.next=i.finallyLoc,d):this.complete(s)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),d},finish:function(t){for(var e=this.tryEntries.length-1;0<=e;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),S(r),d}},catch:function(t){for(var e=this.tryEntries.length-1;0<=e;--e){var r,n,i=this.tryEntries[e];if(i.tryLoc===t)return"throw"===(r=i.completion).type&&(n=r.arg,S(i)),n}throw new Error("illegal catch attempt")},delegateYield:function(t,e,r){return this.delegate={iterator:E(t),resultName:e,nextLoc:r},"next"===this.method&&(this.arg=o),d}},a})("object"==typeof module?module.exports:{});try{regeneratorRuntime=r}catch(t){"object"==typeof globalThis&&(globalThis.regeneratorRuntime=r)}var it,st,at,T="data",ut=(()=>{function e(t){u(this,e),this.api=t}return o(e,[{key:"openDb",value:function(){return new Promise(function(e,t){var r=indexedDB.open("thinkingdata",1);r.onerror=function(t){e(void 0)},r.onsuccess=function(t){e(t.target.result)},r.onupgradeneeded=function(t){t.target.result.createObjectStore(T,{keyPath:"id",autoIncrement:!0}).createIndex("key","key",{unique:!0})}})}},{key:"setStorage",value:(n=b(I().m(function t(i,s){var a=this;return I().w(function(t){for(;;)switch(t.n){case 0:if(this.db){t.n=2;break}return t.n=1,this.openDb();case 1:this.db=t.v;case 2:return t.a(2,new Promise(function(e,t){var r=a.db.transaction(T,"readwrite").objectStore(T),n=r.index("key").get(i);n.onsuccess=function(t){var t=t.target.result;t?(t.value=s,(t=r.put(t)).onsuccess=function(){e(!0)},t.onerror=function(t){e(!1)}):((t=r.add({key:i,value:s})).onsuccess=function(){e(!0)},t.onerror=function(t){e(!1)})},n.onerror=function(t){e(!1)}}))}},t,this)})),function(t,e){return n.apply(this,arguments)})},{key:"getStorage",value:(r=b(I().m(function t(n){var i=this;return I().w(function(t){for(;;)switch(t.n){case 0:if(this.db){t.n=2;break}return t.n=1,this.openDb();case 1:this.db=t.v;case 2:return t.a(2,new Promise(function(e,t){var r=i.db.transaction(T,"readonly").objectStore(T).index("key").get(n);r.onsuccess=function(t){t=t.target.result;e(t?t.value:void 0)},r.onerror=function(t){e(void 0)}}))}},t,this)})),function(t){return r.apply(this,arguments)})},{key:"getStorageSync",value:function(t){return{}}},{key:"getAnalyticGlobalData",value:function(){return this.api.tdanalytics2024}},{key:"getConfigGlobalData",value:function(){return this.api.tdremoteconfig2024}},{key:"setGlobalData",value:function(t){this.api.tdstrategy2024=t}}],[{key:"createInstance",value:function(){return new e(window)}}]);var r,n})(),S=(()=>o(function t(){u(this,t)},null,[{key:"_getCurrentPlatform",value:function(){return this.currentPlatform||(this.currentPlatform=ut.createInstance())}},{key:"setStorage",value:function(t,e){return this._getCurrentPlatform().setStorage(t,e)}},{key:"getStorage",value:function(t){return this._getCurrentPlatform().getStorage(t)}},{key:"getStorageSync",value:function(t){return this._getCurrentPlatform().getStorageSync(t)}},{key:"getAnalyticGlobalData",value:function(){return this._getCurrentPlatform().getAnalyticGlobalData()}},{key:"getConfigGlobalData",value:function(){return this._getCurrentPlatform().getConfigGlobalData()}},{key:"setGlobalData",value:function(t){this._getCurrentPlatform().setGlobalData(t)}}]))(),N={},r=Array.prototype,ot=Object.prototype,ct=r.slice,i=ot.toString,lt=Object.prototype.hasOwnProperty,ht=r.forEach,ot=Array.isArray,ft={},E=(N.checkSettings=function(t){if(t&&!N.isStrEmpty(t.appId)&&!N.isStrEmpty(t.serverUrl))return t.appId=N.checkAppId(t.appId),t.templateCode=C,E.enabled=t.enableLog,t},N.checkAppId=function(t){return t=t.replace(/\s*/g,"")},N.isStrEmpty=function(t){return!t||0===t.length},N.isDate=function(t){return"[object Date]"===i.call(t)},N.isString=function(t){return"[object String]"===i.call(t)},N.isBoolean=function(t){return"[object Boolean]"===i.call(t)},N.isNumber=function(t){return"[object Number]"===i.call(t)&&/[\d\.]+/.test(String(t))},N.isObject=function(t){return"[object Object]"===i.call(t)&&null!=t},N.isArray=ot||function(t){return"[object Array]"===i.call(t)},N.stringToBoolean=function(t){switch(t.toLowerCase().trim()){case"true":return!0;case"false":return!1;default:return}},N.toBoolean=function(t){return N.isBoolean(t)?t:N.isString(t)?N.stringToBoolean(t):void 0},N.each=function(t,e,r){if(null==t)return!1;if(ht&&t.forEach===ht)t.forEach(e,r);else if(t.length===+t.length){for(var n=0,i=t.length;n<i;n++)if(n in t&&e.call(r,t[n],n,t)===ft)return!1}else for(var s in t)if(lt.call(t,s)&&e.call(r,t[s],s,t)===ft)return!1},N.extend=function(r){return N.each(ct.call(arguments,1),function(t){for(var e in t)void 0!==t[e]&&(r[e]=t[e])}),r},N.convertToTimestamp=function(t,e){var r,n,i,s,a,u;return!t||(n=(t=w(t.split(" "),2))[0],t=t[1],!n)||!t||(u=(n=w(n.split("-").map(Number),3))[0],r=n[1],n=n[2],a=(t=w(t.split("."),2))[0],t=t[1],i=(a=w(a.split(":").map(Number),3))[0],s=a[1],a=a[2],t=t?Number(t):0,isNaN(u))||isNaN(r)||isNaN(n)||isNaN(i)||isNaN(s)||isNaN(a)||isNaN(t)?Number.NaN:(u=new Date(Date.UTC(u,r-1,n,i,s,a,t)),new Date(u.getTime()-60*e*6e4).getTime())},N.convertToTimestamp1=function(t,e){var r,n,i,s,a;return!t||(n=(t=w(t.split(" "),2))[0],t=t[1],!n)||!t||(a=(n=w(n.split("-").map(Number),3))[0],r=n[1],n=n[2],i=(t=w(t.split(":").map(Number),3))[0],s=t[1],t=t[2],isNaN(a))||isNaN(r)||isNaN(n)||isNaN(i)||isNaN(s)||isNaN(t)?Number.NaN:(a=new Date(Date.UTC(a,r-1,n,i,s,t)),new Date(a.getTime()-60*e*6e4).getTime())},N.generateUniqueId=function(){return Date.now().toString(36)+Math.random().toString(36).substring(2)},N.buildEventNameRule=function(t){return{calcuSymbol:"C00",columnName:c,columnType:h,ftv:[t]}},N.jsonToFacts=function(t){var r={};return N.each(t,function(t,e){"properties"===e?N.each(t,function(t,e){r[e.toLowerCase()]=t}):r[e]=t}),r},N.getTimeCycleUnit=function(t){if(t)return t.toLowerCase()},N.formatDate=function(t){function e(t){return t<10?"0"+t:t}return t.getFullYear()+"-"+e(t.getMonth()+1)+"-"+e(t.getDate())+" "+e(t.getHours())+":"+e(t.getMinutes())+":"+e(t.getSeconds())+"."+((t=t.getMilliseconds())<100&&9<t?"0"+t:t<10?"00"+t:t)},N.getFormatDataByLog=function(t){return E.enabled?N.formatDate(new Date(t)):t},N.parseStartTime=function(t){var e;return!t||(e=(t=w(t.split(":").map(Number),2))[0],t=t[1],isNaN(e))||isNaN(t)?{hour:0,minute:0}:{hour:e,minute:t}},N.UUID=function(){var t=Date.now();return String(Math.random()).replace(".","").slice(1,11)+"-"+t},N.isFunction=function(t){try{return"function"==typeof t}catch(t){return!1}},"object"===e(E)?E:{}),pt=(E.info=function(){if("object"===("undefined"==typeof console?"undefined":e(console))&&console.log&&E.enabled)try{return arguments[0]="[ThinkingData] Info: "+arguments[0],E.listener&&E.listener(arguments[0]),console.log.apply(console,arguments)}catch(t){E.listener&&E.listener(arguments[0]),console.log("[ThinkingData] Info: "+arguments[0])}},E.info1=function(t,e){E.enabled&&(E.listener&&E.listener(t+JSON.stringify(e)),E.info(t+JSON.stringify(e,null,4)))},E.warn=function(){if("object"===("undefined"==typeof console?"undefined":e(console))&&console.log&&E.enabled)try{return arguments[0]="[ThinkingData] Warning: "+arguments[0],console.warn.apply(console,arguments)}catch(t){console.warn("[ThinkingData] Warning: "+arguments[0])}},"t_strategy_info"),mt="client_value",gt={addClientParams:(at=b(I().m(function t(e){return I().w(function(t){for(;;)switch(t.n){case 0:if(e){t.n=1;break}return t.a(2);case 1:return t.n=2,this.loadLocalClientParams();case 2:return N.extend(this.mClientValueParams,e),t.n=3,S.setStorage(pt,V({},mt,this.mClientValueParams));case 3:return t.a(2)}},t,this)})),function(t){return at.apply(this,arguments)}),removeClientParam:(st=b(I().m(function t(e){return I().w(function(t){for(;;)switch(t.n){case 0:if(void 0===e)return t.a(2);t.n=1;break;case 1:return t.n=2,this.loadLocalClientParams();case 2:return delete this.mClientValueParams[e],t.n=3,S.setStorage(pt,V({},mt,this.mClientValueParams));case 3:return t.a(2)}},t,this)})),function(t){return st.apply(this,arguments)}),get:function(t){var e;if(void 0!==t)return this.mClientValueParams||(e=S.getStorageSync(pt))&&(this.mClientValueParams=e[mt]),this.mClientValueParams||(this.mClientValueParams={}),this.mClientValueParams[t]},loadLocalClientParams:(it=b(I().m(function t(){var e;return I().w(function(t){for(;;)switch(t.n){case 0:if(this.mClientValueParams){t.n=2;break}return t.n=1,S.getStorage(pt);case 1:(e=t.v)&&(this.mClientValueParams=e[mt]);case 2:this.mClientValueParams||(this.mClientValueParams={});case 3:return t.a(2)}},t,this)})),function(){return it.apply(this,arguments)})},L=S.getAnalyticGlobalData(),dt=S.getConfigGlobalData(),P={},vt="te_ops_client_trigger_record",yt="te_ops_client_debug_test",kt="ta_channel_test_event",Tt=[vt,yt,"te_ops_client_risk_record"],bt=[kt],x=(P.getCurrentTimeStamp=function(){return Date.now()},P.getCurrentDate=function(){return new Date(Date.now())},P.getAccountId=function(t){return L?L.getAccountId(t):""},P.getDistinctId=function(t){return L?L.getDistinctId(t):""},P.getClientUserId=(()=>{var e=b(I().m(function t(e){var r,n,i,s;return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,S.getStorage(e+"_users");case 1:if(r=t.v,!N.isArray(r)){t.n=6;break}n=this.getAccountId(e),i=this.getDistinctId(e),s=0;case 2:if(s<r.length)if(n){if(n===r[s].accountId)return t.a(2,r[s].clientUserId);t.n=3}else t.n=4;else t.n=6;break;case 3:t.n=5;break;case 4:if(i===r[s].distinctId)return t.a(2,r[s].clientUserId);t.n=5;break;case 5:s++,t.n=2;break;case 6:return t.a(2,"")}},t,this)}));return function(t){return e.apply(this,arguments)}})(),P.trackTriggerEvent=function(t){L&&(t.isTestTask||101!==t.status&&102!==t.status)&&(L.trackInternal({eventName:vt,properties:{"#client_user_id":t.clientUserId,"#ops_task_id":t.taskId,"#ops_push_id":t.pushId,"#ops_exp_group_id":t.expGroupId,"#ops_trigger_time":t.triggerTime,"#ops_actual_push_time":t.actualPushTime,"#ops_push_status":t.status},debugMode:t.isTestTask?"debugOnly":"none"},t.appId),L.flush())},P.isBlackEvent=function(t){return Tt.includes(t)},P.isWhiteEvent=function(t){return bt.includes(t)},P.trackClientDebugEvent=function(t,e){if(L){N.isArray(P.hasTrackTestTaskIds)||(P.hasTrackTestTaskIds=[]);for(var r=[],n=0;n<e.length;n++)P.hasTrackTestTaskIds.includes(e[n])||(P.hasTrackTestTaskIds.push(e[n]),r.push(e[n]));r.length<=0||L.trackInternal({eventName:yt,properties:{"#rcc_pull_result":{business_type:1,is_pull_success:!0,ops_task_id_list:r}},debugMode:"debugOnly"},t)}},P.buildAnalyticPresetFacts=function(t){var e;return L?((e=L.getPresetProperties(t).toEventPresetProperties())["#account_id"]=this.getAccountId(t),e["#distinct_id"]=this.getDistinctId(t),e):{}},P.getStrategyInfo=function(t){return dt?dt.getData(t,C).get("td_strategy_info").arrayValue():[]},P.getConfigValue=function(t){return gt.get(t)},"t_task_"),_="t_event",R="t_task_trigger",D="t_channel_trigger",It="t_task_status",wt=(()=>{var r=b(I().m(function t(e,r){var n,i,s,a;return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,S.getStorage(x+e);case 1:for(n=(n=t.v)||[],i={},s=0;s<n.length;s++)(a=n[s]).clientUserId===r&&a.task&&(i[a.taskId]=a);return t.a(2,i)}},t)}));return function(t,e){return r.apply(this,arguments)}})(),Ct=(()=>{var n=b(I().m(function t(e,r,n){var i;return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,S.getStorage(x+e);case 1:return i=(i=(i=t.v)||[]).filter(function(t){return t.clientUserId!==r}),t.n=2,S.setStorage(x+e,i.concat(n));case 2:return t.a(2)}},t)}));return function(t,e,r){return n.apply(this,arguments)}})(),St=(()=>{var r=b(I().m(function t(e,r){var n,i;return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,S.getStorage(x+e);case 1:if(n=t.v,N.isArray(n)&&n.length>r)return i=n.length-r,n.splice(0,i),t.n=2,S.setStorage(x+e,n);t.n=2;break;case 2:return t.a(2)}},t)}));return function(t,e){return r.apply(this,arguments)}})(),Nt=(()=>{var t=b(I().m(function t(){var e;return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,S.getStorage(_);case 1:if(e=t.v,N.isArray(e))return t.a(2,e);t.n=2;break;case 2:return t.a(2,[])}},t)}));return function(){return t.apply(this,arguments)}})(),Et=(()=>{var e=b(I().m(function t(e){return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,S.setStorage(_,e);case 1:return t.a(2)}},t)}));return function(t){return e.apply(this,arguments)}})(),Lt=(()=>{var e=b(I().m(function t(e){var r;return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,S.getStorage(_);case 1:return(r=(r=t.v)||[]).push(e),t.n=2,S.setStorage(_,r);case 2:return t.a(2)}},t)}));return function(t){return e.apply(this,arguments)}})(),Pt=(()=>{var e=b(I().m(function t(e){var r;return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,S.getStorage(_);case 1:return r=t.v,N.isArray(r)&&(r=r.filter(function(t){return!(e.appId===t.appId&&e.clientUserId===t.clientUserId&&e.taskId===t.taskId)})),t.n=2,S.setStorage(_,r);case 2:return t.a(2)}},t)}));return function(t){return e.apply(this,arguments)}})(),xt=(()=>{var e=b(I().m(function t(e){var r,n;return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,S.getStorage(_);case 1:if(r=t.v,N.isArray(r)&&r.length>e)return n=r.length-e,r.splice(0,n),t.n=2,S.setStorage(_,r);t.n=2;break;case 2:return t.a(2)}},t)}));return function(t){return e.apply(this,arguments)}})(),_t=(()=>{var e=b(I().m(function t(e){var r;return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,S.getStorage(R);case 1:if(r=t.v,N.isArray(r)){t.n=2;break}return t.a(2,0);case 2:return r=r.filter(function(t){return e.appId===t.appId&&e.clientUserId===t.clientUserId&&e.taskId===t.taskId&&t.triggerTime>=e.start&&t.triggerTime<=e.end}),t.a(2,r.length)}},t)}));return function(t){return e.apply(this,arguments)}})(),Rt=(()=>{var e=b(I().m(function t(e){var r;return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,S.getStorage(R);case 1:return r=t.v,(r=N.isArray(r)?r:[]).push(e),t.n=2,S.setStorage(R,r);case 2:return t.a(2)}},t)}));return function(t){return e.apply(this,arguments)}})(),Dt=(()=>{var e=b(I().m(function t(e){var r;return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,S.getStorage(R);case 1:if(r=t.v,N.isArray(r)){t.n=2;break}return t.a(2);case 2:return r=r.filter(function(t){return!(e.appId===t.appId&&e.clientUserId===t.clientUserId&&e.taskId===t.taskId)}),t.n=3,S.setStorage(R,r);case 3:return t.a(2)}},t)}));return function(t){return e.apply(this,arguments)}})(),Ot=(()=>{var e=b(I().m(function t(e){var r,n;return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,S.getStorage(R);case 1:if(r=t.v,N.isArray(r)&&r.length>e)return n=r.length-e,r.splice(0,n),t.n=2,S.setStorage(R,r);t.n=2;break;case 2:return t.a(2)}},t)}));return function(t){return e.apply(this,arguments)}})(),Ut=(()=>{var e=b(I().m(function t(e){var r;return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,S.getStorage(D);case 1:if(r=t.v,N.isArray(r)){t.n=2;break}return t.a(2,0);case 2:return r=r.filter(function(t){return e.appId===t.appId&&e.pushId===t.pushId&&e.channelId===t.channelId&&t.triggerTime>=e.start&&t.triggerTime<=e.end}),t.a(2,r.length)}},t)}));return function(t){return e.apply(this,arguments)}})(),Ft=(()=>{var e=b(I().m(function t(e){var r;return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,S.getStorage(D);case 1:return r=t.v,(r=N.isArray(r)?r:[]).push(e),t.n=2,S.setStorage(D,r);case 2:return t.a(2)}},t)}));return function(t){return e.apply(this,arguments)}})(),jt=(()=>{var e=b(I().m(function t(e){var r,n;return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,S.getStorage(D);case 1:if(r=t.v,N.isArray(r))return n=P.getCurrentTimeStamp()-24*e*60*60*1e3,r=r.filter(function(t){return t.triggerTime>n}),t.n=2,S.setStorage(D,r);t.n=2;break;case 2:return t.a(2)}},t)}));return function(t){return e.apply(this,arguments)}})(),At=(()=>{var e=b(I().m(function t(e){var r,n,i,s;return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,S.getStorage(It);case 1:r=t.v,N.isArray(r)||(r=[]),n=!1,i=0;case 2:if(i<r.length){if((s=r[i]).appId===e.appId&&s.clientUserId===e.clientUserId)return s.status=e.status,n=!0,t.a(3,4);t.n=3}else t.n=4;break;case 3:i++,t.n=2;break;case 4:return n||r.push(e),t.n=5,S.setStorage(It,r);case 5:return t.a(2)}},t)}));return function(t){return e.apply(this,arguments)}})(),Mt=(()=>{var e=b(I().m(function t(e){var r,n,i;return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,S.getStorage(It);case 1:if(r=t.v,N.isArray(r)){t.n=2;break}return t.a(2,!1);case 2:n=0;case 3:if(n<r.length){if((i=r[n]).appId===e.appId&&i.clientUserId===e.clientUserId)return t.a(2,i.status);t.n=4}else t.n=5;break;case 4:n++,t.n=3;break;case 5:return t.a(2,!1)}},t)}));return function(t){return e.apply(this,arguments)}})(),Vt=(()=>o(function t(){u(this,t),this.rules=[]},[{key:"addRule",value:function(t){t&&this.rules.push(t)}},{key:"evaluate",value:function(t){return!1}}]))(),Gt=(()=>{function t(){return u(this,t),n(this,t)}return a(t,Vt),o(t,[{key:"evaluate",value:(e=b(I().m(function t(e){var r;return I().w(function(t){for(;;)switch(t.n){case 0:r=0;case 1:if(r<this.rules.length)return t.n=2,this.rules[r].evaluate(e);t.n=4;break;case 2:if(t.v)return t.a(2,!0);t.n=3;break;case 3:r++,t.n=1;break;case 4:return t.a(2,!1)}},t,this)})),function(t){return e.apply(this,arguments)})}]);var e})(),Jt=(()=>{function t(){return u(this,t),n(this,t)}return a(t,Vt),o(t,[{key:"evaluate",value:(e=b(I().m(function t(e){var r;return I().w(function(t){for(;;)switch(t.n){case 0:if(this.rules.length<=0)return t.a(2,!1);t.n=1;break;case 1:r=0;case 2:if(r<this.rules.length)return t.n=3,this.rules[r].evaluate(e);t.n=5;break;case 3:if(t.v){t.n=4;break}return t.a(2,!1);case 4:r++,t.n=2;break;case 5:return t.a(2,!0)}},t,this)})),function(t){return e.apply(this,arguments)})}]);var e})(),t=(()=>o(function t(e){u(this,t),this.ruleJson=e,this.columnName=e.columnName,this.columnType=e.columnType,this.symbol=e.calcuSymbol,this.ftv=e.ftv||[]},[{key:"evaluate",value:function(t){return this.isCondition(t)}},{key:"isCondition",value:function(t){var e,r;return!!(this.columnName&&this.columnType&&this.symbol&&this.ftv)&&(void 0===(e=t[this.columnName])?(r=this.isPresetProperties(),E.info("CalcuSymbol: "+this.symbol+" Value is null and ColumnName: "+this.columnName+" is Preset: "+r),r):(r=this.executeWhen(e,t),E.info("CalcuSymbol: "+this.symbol+" ColumnName: "+this.columnName+" Value: "+e+" Ftv:"+this.ftv+" Result: "+r),r))}},{key:"executeWhen",value:function(t,e){return!1}},{key:"isPresetProperties",value:function(){return this.columnName.includes("#")}}]))(),Wt=(()=>{function e(t){return u(this,e),n(this,e,[t])}return a(e,t),o(e,[{key:"executeWhen",value:function(t,e){if(this.columnType===h||this.columnType===f){for(var r=t.toString(),n=0;n<this.ftv.length;n++)if(r===String(this.ftv[n]))return!0}else if(this.columnType===m||this.columnType===g||this.columnType===d||this.columnType===v){for(var i=Number(t),s=0;s<this.ftv.length;s++)if(i===Number(this.ftv[s]))return!0}else if(this.columnType===p){for(var a=N.toBoolean(t),u=0;u<this.ftv.length;u++)if(a===N.toBoolean(this.ftv[u]))return!0}else if(this.columnType===Y)for(var o=t.toString(),c=0;c<this.ftv.length;c++)if(o===this.ftv[c].toString())return!0;return!1}}])})(),Ht=(()=>{function e(t){return u(this,e),n(this,e,[t])}return a(e,t),o(e,[{key:"executeWhen",value:function(t,e){if(this.columnType===h||this.columnType===f){for(var r=t.toString(),n=!1,i=0;i<this.ftv.length;i++)if(r===String(this.ftv[i])){n=!0;break}return!n}if(this.columnType===m||this.columnType===g||this.columnType===d||this.columnType===v){for(var s=Number(t),a=!1,u=0;u<this.ftv.length;u++)if(s===Number(this.ftv[u])){a=!0;break}return!a}if(this.columnType!==p)return!1;for(var o=N.toBoolean(t),c=!1,l=0;l<this.ftv.length;l++)if(o===N.toBoolean(this.ftv[l])){c=!0;break}return!c}}])})(),Bt=(()=>{function e(t){return u(this,e),n(this,e,[t])}return a(e,t),o(e,[{key:"executeWhen",value:function(t,e){if(0<this.ftv.length&&(this.columnType===m||this.columnType===g||this.columnType===d||this.columnType===v))return Number(t)<Number(this.ftv[0]);return!1}}])})(),zt=(()=>{function r(t,e){return u(this,r),(t=n(this,r,[t])).zoneOffset=e,t}return a(r,t),o(r,[{key:"executeWhen",value:function(t,e){if(0<this.ftv.length){if(this.columnType===m||this.columnType===g||this.columnType===d||this.columnType===v)return Number(t)<=Number(this.ftv[0]);if(this.columnType===f)return t=t.toString(),e=e[l],t=N.convertToTimestamp(t,e),e=N.convertToTimestamp(this.ftv[0],this.zoneOffset),!isNaN(t)&&!isNaN(e)&&t<=e}return!1}}])})(),qt=(()=>{function e(t){return u(this,e),n(this,e,[t])}return a(e,t),o(e,[{key:"executeWhen",value:function(t,e){if(0<this.ftv.length&&(this.columnType===m||this.columnType===g||this.columnType===d||this.columnType===v))return t=Number(t),Number(this.ftv[0])<t;return!1}}])})(),Yt=(()=>{function r(t,e){return u(this,r),(t=n(this,r,[t])).zoneOffset=e,t}return a(r,t),o(r,[{key:"executeWhen",value:function(t,e){if(0<this.ftv.length){var r;if(this.columnType===m||this.columnType===g||this.columnType===d||this.columnType===v)return r=Number(t),Number(this.ftv[0])<=r;if(this.columnType===f)return r=t.toString(),t=e[l],e=N.convertToTimestamp(r,t),r=N.convertToTimestamp(this.ftv[0],this.zoneOffset),!isNaN(e)&&!isNaN(r)&&r<=e}return!1}}])})(),$t=(()=>{function e(t){return u(this,e),n(this,e,[t])}return a(e,t),o(e,[{key:"executeWhen",value:function(t,e){return!0}}])})(),Kt=(()=>{function e(t){return u(this,e),n(this,e,[t])}return a(e,t),o(e,[{key:"evaluate",value:function(t){return!!(this.columnName&&this.columnType&&this.symbol&&this.ftv)&&(t=t[this.columnName],E.info("CalcuSymbol: "+this.symbol+" ColumnName: "+this.columnName+" Value: "+t+" Ftv:"+this.ftv+" Result: "+(t=void 0===t)),t)}}])})(),Qt=(()=>{function r(t,e){return u(this,r),(t=n(this,r,[t])).zoneOffset=e,t}return a(r,t),o(r,[{key:"executeWhen",value:function(t,e){if(2<=this.ftv.length){var r,n,i;if(this.columnType===m||this.columnType===g||this.columnType===d||this.columnType===v)return n=Number(t),r=Number(this.ftv[0]),i=Number(this.ftv[1]),r<=n&&n<=i;if(this.columnType===f)return r=t.toString(),n=e[l],i=N.convertToTimestamp(r,n),t=N.convertToTimestamp(this.ftv[0],this.zoneOffset),e=N.convertToTimestamp(this.ftv[1],this.zoneOffset),!(isNaN(i)||isNaN(t)||isNaN(e))&&t<=i&&i<=e}return!1}}])})(),Xt=(()=>{function e(t){return u(this,e),n(this,e,[t])}return a(e,t),o(e,[{key:"executeWhen",value:function(t,e){if(this.columnType===h)for(var r=t.toString(),n=0;n<this.ftv.length;n++){var i=String(this.ftv[n]);if(r.includes(i))return!0}return!1}}])})(),Zt=(()=>{function e(t){return u(this,e),n(this,e,[t])}return a(e,t),o(e,[{key:"executeWhen",value:function(t,e){if(this.columnType!==h)return!1;for(var r=t.toString(),n=!1,i=0;i<this.ftv.length;i++){var s=String(this.ftv[i]);if(r.includes(s)){n=!0;break}}return!n}}])})(),te=(()=>{function e(t){return u(this,e),n(this,e,[t])}return a(e,t),o(e,[{key:"executeWhen",value:function(t,e){return this.columnType===p&&!0===N.toBoolean(t)}}])})(),ee=(()=>{function e(t){return u(this,e),n(this,e,[t])}return a(e,t),o(e,[{key:"executeWhen",value:function(t,e){return this.columnType===p&&!1===N.toBoolean(t)}}])})(),re=(()=>{function e(t){return u(this,e),n(this,e,[t])}return a(e,t),o(e,[{key:"executeWhen",value:function(t,e){var r;return!(this.ftv.length<=0)&&this.columnType===h&&(t=t.toString(),r=String(this.ftv[0]),new RegExp(r,"i").test(t))}}])})(),ne=(()=>{function e(t){return u(this,e),n(this,e,[t])}return a(e,t),o(e,[{key:"executeWhen",value:function(t,e){var r;return!(this.ftv.length<=0||this.columnType!==h||(t=t.toString(),r=String(this.ftv[0]),new RegExp(r,"i").test(t)))}}])})(),ie=(()=>{function e(t){return u(this,e),n(this,e,[t])}return a(e,t),o(e,[{key:"executeWhen",value:function(t,e){if(this.columnType===f){t=t.toString(),e=e[l],t=N.convertToTimestamp(t,e);if(isNaN(t))return!1;e=this.getTargetTimeStamp();if(1===this.ftv.length){var r=Number(this.ftv[0]);if(r!==Number.NaN)return t<=e-24*r*60*60*1e3}else if(2===this.ftv.length){var r=Number(this.ftv[0]),n=Number(this.ftv[1]);if(r!==Number.NaN&&n!==Number.NaN)return e+24*r*60*60*1e3<=t&&t<e+24*(n+1)*60*60*1e3}}return!1}},{key:"getTargetTimeStamp",value:function(){var t=P.getCurrentDate();return t.setHours(0,0,0,0),t.getTime()}}])})(),se=(()=>{function e(t){return u(this,e),n(this,e,[t])}return a(e,t),o(e,[{key:"executeWhen",value:function(t,e){if(this.columnType===f){var t=t.toString(),r=e[l],t=N.convertToTimestamp(t,r);if(isNaN(t))return!1;r=this.ruleJson.timeRelative;if("range"===r){if(2===this.ftv.length){var n=this.getTargetTimeStamp(e),i=Number(this.ftv[0]),s=Number(this.ftv[1]);if(i!==Number.NaN&&s!==Number.NaN)return n+i*(i=this.getMillis())<=t&&t<=n+s*i}}else{n={};if("that_day"===r?n=this.getDayTimeStamp(e):"that_week"===r?n=this.getWeekTimeStamp(e):"that_month"===r&&(n=this.getMonthTimeStamp(e)),void 0!==n.first)return t>=n.first&&t<n.second}}return!1}},{key:"getTargetTimeStamp",value:function(t){return N.convertToTimestamp(t[Q],t[l])}},{key:"getMillis",value:function(){var t=N.getTimeCycleUnit(this.ruleJson.timeUnit);return void 0===t?0:t===k?864e5:t===rt?36e5:t===nt?6e4:0}},{key:"getDayTimeStamp",value:function(t){t=new Date(this.getTargetTimeStamp(t));return t.setHours(0,0,0,0),{first:t.getTime(),second:t.getTime()+864e5}}},{key:"getWeekTimeStamp",value:function(t){var t=new Date(this.getTargetTimeStamp(t)),e=t.getDay(),t=new Date(t.getFullYear(),t.getMonth(),t.getDate()-e);return t.setHours(0,0,0,0),{first:t.getTime(),second:t.getTime()+6048e5}}},{key:"getMonthTimeStamp",value:function(t){var t=new Date(this.getTargetTimeStamp(t)),e=t.getFullYear(),t=t.getMonth(),r=new Date(e,t,1),e=(r.setHours(0,0,0,0),new Date(e,t+1,1));return e.setHours(0,0,0,0),{first:r.getTime(),second:e.getTime()}}}])})(),ae=function(t,e,r,n){if(e&&0!==e.length){var i=new(1===t?Jt:Gt);if(i)for(var s=0;s<e.length;s++){var a=e[s];a&&(a.filterType?i.addRule(ae(a.relation,a.filts,r)):(n&&n.push(a.columnName),i.addRule(ue(a,r))))}return i}},ue=function(t,e){if(t)switch(t.calcuSymbol){case"C00":return new Wt(t);case"C01":return new Ht(t);case"C02":return new Bt(t);case"C020":return new zt(t,e);case"C03":return new qt(t);case"C030":return new Yt(t,e);case"C04":return new $t(t);case"C05":return new Kt(t);case"C06":return new Qt(t,e);case"C07":return new Xt(t);case"C08":return new Zt(t);case"C09":return new te(t);case"C10":return new ee(t);case"C11":return new re(t);case"C12":return new ne(t);case"C13":return new ie(t);case"C14":return new se(t);default:return}},oe=(()=>{return o(function t(e,r,n,i){u(this,t),this.flow=e,this.isTargetUser=r,this.pushId=i,this.columns=[],this.compositeRule=ae(n.relation,n.filts,e.zoneOffset,this.columns)},[{key:"isTargetAudience",value:(e=b(I().m(function t(e){var r,n,i,s,a;return I().w(function(t){for(;;)switch(t.n){case 0:if(this.isTargetUser){t.n=1;break}return this.flow.triggerRecord.status=101,P.trackTriggerEvent(this.flow.triggerRecord),t.a(2,!1);case 1:for(n=0;n<this.columns.length;n++)i=this.columns[n],void 0!==(s=P.getConfigValue(i))&&(e[i]=s);if(this.compositeRule)return E.info("TargetAudience------start trigger rules------"),t.n=2,this.compositeRule.evaluate(e);t.n=3;break;case 2:r=t.v,E.info("TargetAudience------end trigger rules------result is "+r),t.n=4;break;case 3:r=!0;case 4:if(r){t.n=5;break}return this.flow.triggerRecord.status=102,P.trackTriggerEvent(this.flow.triggerRecord),t.a(2,!1);case 5:if(a=this.getPushId(e),this.flow.triggerRecord.pushId=a,E.info("Push ID :"+a),a){t.n=6;break}return this.flow.triggerRecord.status=13,P.trackTriggerEvent(this.flow.triggerRecord),t.a(2,!1);case 6:return t.a(2,!0)}},t,this)})),function(t){return e.apply(this,arguments)})},{key:"getPushId",value:function(t){var e;return this.pushId?this.pushId.includes("client:")?!((e=this.pushId.split(":")).length<2)&&void 0!==(e=void 0===(e=t[t=e[1]])?P.getConfigValue(t):e)?e.toString():"":this.pushId:""}}]);var e})(),ce=(()=>o(function t(e,r){u(this,t);var n=e.expConfig;n&&(this.enableExp=n.enableExp,this.enableExp)&&(this.expSampleOut=n.expSampleOut,this.expEntityIdExist=n.expEntityIdExist,this.expType=n.expType,this.expReleasePushStarted=n.expReleasePushStarted,this.expStartTimeStamp=N.convertToTimestamp1(n.expStartDate,r),this.expEndTimeStamp=N.convertToTimestamp1(n.expEndDate,r),isNaN(this.expStartTimeStamp)||isNaN(this.expEndTimeStamp)?this.enableExp=!1:(n=e.groupContentList,N.isArray(n)&&0<n.length&&(r=n[0])&&(this.expGroupId=r.expGroupId,this.isPush=r.isPush)))},[{key:"isGapExp",value:function(){return!this.enableExp||this.expReleasePushStarted}},{key:"isExpGroupIdExist",value:function(t){var e=!this.expGroupId&&!this.expEntityIdExist;return e&&(t.status=12,P.trackTriggerEvent(t)),e}},{key:"isExpSampleOut",value:function(){return!this.isGapExp()&&this.expSampleOut}},{key:"isSkipPush",value:function(){return!this.isGapExp()&&!this.isPush}},{key:"isExpRelease",value:function(t){var e;return t.expGroupId=this.expGroupId,!!this.isGapExp()||!this.isExpGroupIdExist(t)&&(e=P.getCurrentTimeStamp(),1===this.expType?e>=this.expStartTimeStamp&&e<=this.expEndTimeStamp:!(2!==this.expType||(e<this.expStartTimeStamp?(E.info("Exp type: "+this.expType+" is less than start time"),1):e>this.expEndTimeStamp&&(t.status=10,P.trackTriggerEvent(t),1))))}}]))(),le=(()=>o(function t(e,r){u(this,t),e&&(void 0!==e.periodStartStamp&&void 0!==e.periodEndStamp?(this.startTime=e.periodStartStamp,this.endTime=e.periodEndStamp):(this.startTime=N.convertToTimestamp(e.periodStart,e.zoneOffset),this.endTime=N.convertToTimestamp(e.periodEnd,e.zoneOffset))),(isNaN(this.startTime)||isNaN(this.endTime))&&(this.startTime=P.getCurrentTimeStamp(),this.endTime=P.getCurrentTimeStamp()),this.scrollInfo=r,this.checkScrollInfo()},[{key:"checkScrollInfo",value:function(){}},{key:"isWithInPeriod",value:function(){var t=P.getCurrentTimeStamp();return t>=this.startTime&&t<=this.endTime}}]))(),he=(()=>{function e(t){return u(this,e),n(this,e,[t,void 0])}return a(e,le),o(e,[{key:"getCurrentTimeCycle",value:function(){return{start:this.startTime,end:this.endTime}}}])})(),fe=(()=>{function r(t,e){return u(this,r),n(this,r,[t,e])}return a(r,le),o(r,[{key:"checkScrollInfo",value:function(){this.scrollInfo?((void 0===this.scrollInfo.timeCycleNumber||this.scrollInfo.timeCycleNumber<1)&&(this.scrollInfo.timeCycleNumber=1),(void 0===this.scrollInfo.startHour||this.scrollInfo.startHour<0||24<this.scrollInfo.startHour)&&(this.scrollInfo.startHour=0),(void 0===this.scrollInfo.startMinute||this.scrollInfo.startMinute<0||60<this.scrollInfo.startMinute)&&(this.scrollInfo.startMinute=0)):this.scrollInfo={timeCycleNumber:1,timeCycleUnit:k,startHour:0,startMinute:0}}},{key:"getCurrentTimeCycle",value:function(){var t=this.getStartOfTimestamp()+24*this.getStartDay()*3600*1e3+3600*this.scrollInfo.startHour*1e3+60*this.scrollInfo.startMinute*1e3,e=this.getNextCycleTimeStamp(t),r=P.getCurrentTimeStamp();if(r<t)return this.startTime<=t?{start:this.startTime,end:t}:{start:0,end:0};for(var n=r<=e;!n;)t=e,n=r<=(e=this.getNextCycleTimeStamp(t));return{start:t=t<this.startTime?this.startTime:t,end:e=e>this.endTime?this.endTime:e}}},{key:"getStartOfTimestamp",value:function(){var t=new Date(this.startTime);return t.setHours(0,0,0,0),t.getTime()}},{key:"getStartDay",value:function(){return 0}},{key:"getNextCycleTimeStamp",value:function(t){return t+24*this.scrollInfo.timeCycleNumber*3600*1e3}}])})(),pe=(()=>{function r(t,e){return u(this,r),n(this,r,[t,e])}return a(r,fe),o(r,[{key:"checkScrollInfo",value:function(){this.scrollInfo?((void 0===this.scrollInfo.timeCycleNumber||this.scrollInfo.timeCycleNumber<1)&&(this.scrollInfo.timeCycleNumber=1),(void 0===this.scrollInfo.startHour||this.scrollInfo.startHour<0||24<this.scrollInfo.startHour)&&(this.scrollInfo.startHour=0),(void 0===this.scrollInfo.startMinute||this.scrollInfo.startMinute<0||60<this.scrollInfo.startMinute)&&(this.scrollInfo.startMinute=0),(void 0===this.scrollInfo.startNumber||this.scrollInfo.startNumber<1||7<this.scrollInfo.startNumber)&&(this.scrollInfo.startNumber=0)):this.scrollInfo={timeCycleNumber:1,timeCycleUnit:tt,startHour:0,startMinute:0,startNumber:0}}},{key:"getStartOfTimestamp",value:function(){var t=new Date(this.startTime),t=new Date(t.getFullYear(),t.getMonth(),t.getDate()-t.getDay());return t.setHours(0,0,0,0),t.getTime()}},{key:"getStartDay",value:function(){return this.scrollInfo.startNumber}},{key:"getNextCycleTimeStamp",value:function(t){return t+7*this.scrollInfo.timeCycleNumber*24*3600*1e3}}])})(),me=(()=>{function r(t,e){return u(this,r),n(this,r,[t,e])}return a(r,fe),o(r,[{key:"checkScrollInfo",value:function(){this.scrollInfo?((void 0===this.scrollInfo.timeCycleNumber||this.scrollInfo.timeCycleNumber<1)&&(this.scrollInfo.timeCycleNumber=1),(void 0===this.scrollInfo.startHour||this.scrollInfo.startHour<0||24<this.scrollInfo.startHour)&&(this.scrollInfo.startHour=0),(void 0===this.scrollInfo.startMinute||this.scrollInfo.startMinute<0||60<this.scrollInfo.startMinute)&&(this.scrollInfo.startMinute=0),(void 0===this.scrollInfo.startNumber||this.scrollInfo.startNumber<1||28<this.scrollInfo.startNumber)&&(this.scrollInfo.startNumber=1)):this.scrollInfo={timeCycleNumber:1,timeCycleUnit:et,startHour:0,startMinute:0,startNumber:1}}},{key:"getStartOfTimestamp",value:function(){var t=new Date(this.startTime),e=t.getFullYear(),t=t.getMonth(),e=new Date(e,t,1);return e.setHours(0,0,0,0),e.getTime()}},{key:"getStartDay",value:function(){return this.scrollInfo.startNumber-1}},{key:"getNextCycleTimeStamp",value:function(t){t=new Date(t);return t.setMonth(t.getMonth()+this.scrollInfo.timeCycleNumber),t.getTime()}}])})(),ge=(()=>{function r(t,e){return u(this,r),n(this,r,[t,e])}return a(r,le),o(r,[{key:"getCurrentTimeCycle",value:function(){var t=P.getCurrentTimeStamp(),e=this.getMinutes();return e?{start:e=(e=t-60*e*1e3)<this.startTime?this.startTime:e,end:t=t>this.endTime?this.endTime:t}:{start:this.startTime,end:this.endTime}}},{key:"getMinutes",value:function(){return this.scrollInfo?this.scrollInfo.timeCycleUnit===tt?7*this.scrollInfo.timeCycleNumber*24*60:this.scrollInfo.timeCycleUnit===k?24*this.scrollInfo.timeCycleNumber*60:this.scrollInfo.timeCycleUnit===rt?60*this.scrollInfo.timeCycleNumber:this.scrollInfo.timeCycleUnit===nt?this.scrollInfo.timeCycleNumber:0:0}}])})(),de=(()=>{function e(t){return u(this,e),n(this,e,[t,void 0])}return a(e,le),o(e,[{key:"getCurrentTimeCycle",value:function(){return{start:e.clientStartTime,end:this.endTime}}}])})(),ve=(()=>{return o(function t(e){u(this,t),this.taskFlow=e,this.mLimits=[],this.mClientUserId=e.clientUserId,this.enableLimit=!1,this.parseLimitInfo(e.taskJson)},[{key:"parseLimitInfo",value:function(t){}},{key:"isLimit",value:(t=b(I().m(function t(){var e,r,n,i,s;return I().w(function(t){for(;;)switch(t.n){case 0:if(this.enableLimit){t.n=1;break}return t.a(2,!1);case 1:e=!1,r=0;case 2:if(!(r<this.mLimits.length)){t.n=6;break}if(n=this.mLimits[r],(i=n.first).isWithInPeriod()){t.n=3;break}return t.a(3,5);case 3:return s=i.getCurrentTimeCycle(),t.n=4,this.getLimitCount(s.start,s.end);case 4:if(s=t.v,s+=1,E.info("Current Count: "+s+" Target Count: "+n.second),e=s>n.second)return t.a(3,6);t.n=5;break;case 5:r++,t.n=2;break;case 6:return t.a(2,e)}},t,this)})),function(){return t.apply(this,arguments)})},{key:"getLimitCount",value:(r=b(I().m(function t(e,r){return I().w(function(t){for(;;)if(0===t.n)return t.a(2,0)},t)})),function(t,e){return r.apply(this,arguments)})}]);var r,t})(),ye=(()=>{function e(t){return u(this,e),n(this,e,[t])}return a(e,ve),o(e,[{key:"parseLimitInfo",value:function(t){var e,t=t.frequencyLimits;t&&(t=JSON.parse(t),N.isObject(t))&&(this.enableLimit=t.enableFrequencyLimits,this.enableLimit)&&(t=t.ruleList,N.isArray(t))&&0<t.length&&(t=t[0])&&(e=t.maxTimes||0,!(t=this.createFrequencyLimitCycle(t))||e<=0||this.mLimits.push({first:t,second:e}))}},{key:"getLimitCount",value:(r=b(I().m(function t(e,r){return I().w(function(t){for(;;)switch(t.n){case 0:return E.info("Frequency Limit UserID: "+this.mClientUserId+" Start : "+N.getFormatDataByLog(e)+" End : "+N.getFormatDataByLog(r)),t.n=1,_t({appId:this.taskFlow.appId,clientUserId:this.mClientUserId,taskId:this.taskFlow.taskId,start:e,end:r});case 1:return t.a(2,t.v)}},t,this)})),function(t,e){return r.apply(this,arguments)})},{key:"addLimitCount",value:(t=b(I().m(function t(){return I().w(function(t){for(;;)switch(t.n){case 0:if(this.enableLimit&&0<this.mLimits.length)return t.n=1,Rt({appId:this.taskFlow.appId,clientUserId:this.mClientUserId,taskId:this.taskFlow.taskId,triggerTime:P.getCurrentTimeStamp()});t.n=1;break;case 1:return t.a(2)}},t,this)})),function(){return t.apply(this,arguments)})},{key:"createFrequencyLimitCycle",value:function(t){var e,r=t.ruleType,n=this.taskFlow.taskTimeCycle.getCurrentTimeCycle(),i={periodStartStamp:n.start,periodEndStamp:n.end};switch(r){case"TASK":e=new he(i);break;case"TIME_CYCLE":e=new ge(i,{timeCycleNumber:t.timeCycleNumber,timeCycleUnit:N.getTimeCycleUnit(t.timeCycleUnit)});break;case"CLIENT_START":e=new de(i);break;case"TIME_CYCLE_ROLL":var s={timeCycleNumber:t.timeCycleNumber,timeCycleUnit:N.getTimeCycleUnit(t.timeCycleUnit)},a=t.timeCycleDef;a&&(s.startNumber=a.startDay,a=N.parseStartTime(a.startTime),s.startHour=a.hour,s.startMinute=a.minute),s.timeCycleUnit===k?e=new fe(i,s):s.timeCycleUnit===tt?e=new pe(i,s):s.timeCycleUnit===et&&(e=new me(i,s))}return e}}]);var t,r})(),ke=(()=>{function e(t){return u(this,e),n(this,e,[t])}return a(e,ve),o(e,[{key:"parseLimitInfo",value:function(t){if(this.enableLimit=t.enableChannelTouchLimits,this.enableLimit){t=t.channelTouchLimitsRuleDef;if(t){var e=JSON.parse(t);if(N.isArray(e))for(var t=this.taskFlow.taskTimeCycle.getCurrentTimeCycle(),r={periodStartStamp:t.start,periodEndStamp:t.end},n=0;n<e.length;n++){var i,s=e[n];s&&((i=s.maxTimes||0)<=0||this.mLimits.push({first:new ge(r,{timeCycleNumber:s.timeCycleNumber,timeCycleUnit:N.getTimeCycleUnit(s.timeCycleUnit)}),second:i}))}}}}},{key:"getLimitCount",value:(r=b(I().m(function t(e,r){return I().w(function(t){for(;;)switch(t.n){case 0:return E.info("Touch Limit PushID: : "+this.taskFlow.triggerRecord.pushId+" Start : "+N.getFormatDataByLog(e)+" End : "+N.getFormatDataByLog(r)),t.n=1,Ut({appId:this.taskFlow.appId,pushId:this.taskFlow.triggerRecord.pushId,channelId:this.taskFlow.channelId,start:e,end:r});case 1:return t.a(2,t.v)}},t,this)})),function(t,e){return r.apply(this,arguments)})},{key:"addLimitCount",value:(t=b(I().m(function t(){return I().w(function(t){for(;;)switch(t.n){case 0:if(this.enableLimit&&0<this.mLimits.length)return t.n=1,Ft({appId:this.taskFlow.appId,pushId:this.taskFlow.triggerRecord.pushId,channelId:this.taskFlow.channelId,triggerTime:P.getCurrentTimeStamp()});t.n=1;break;case 1:return t.a(2)}},t,this)})),function(){return t.apply(this,arguments)})}]);var t,r})(),Te=(()=>o(function t(e){u(this,t),this.flow=e;e=this.flow.taskJson.groupContentList;N.isArray(e)&&0<e.length&&(e=e[0])&&(this.contentJson=e.content),this.contentJson||(this.contentJson={}),this.userParamsList=this.flow.taskJson.channelUserParamsList,N.isArray(this.userParamsList)||(this.userParamsList=[])},[{key:"calculate",value:function(t){var e={appId:this.flow.appId,taskId:this.flow.taskId,channelMsgType:this.flow.channelMsgType,pushId:this.flow.triggerRecord.pushId};return e.userParams=this.buildUserParamsMap(t),e.opsProperties=this.buildOpsProperties(),e.content=this.buildContentMap(t),e}},{key:"buildContentMap",value:function(a){var u=this,o={};return N.each(this.contentJson,function(t,e){if(N.isString(t)){var r=u.getClientValue(t,a);(r=u.getOccasionValue(r,a))&&(o[e]=r)}else if(N.isObject(t)){r=u.getOccasionJson(t,a);r&&(o[e]=r)}else if(N.isArray(t)){for(var n,i=[],s=0;s<t.length;s++)N.isObject(t[s])?(n=u.getOccasionJson(t[s],a))&&i.push(n):i.push(t[s]);o[e]=i}else o[e]=t}),o}},{key:"getOccasionJson",value:function(t,n){var i,s=this;if(N.isObject(t))return i={},N.each(t,function(t,e){var r;N.isString(t)?(r=s.getOccasionValue(t,n))&&(i[e]=r):i[e]=t}),i}},{key:"getOccasionValue",value:function(t,r){var n=this,t=t.replace(/\$\[(.*?)\]/g,function(t,e){return n.getOccasionColumnValue(r,e)});if(t.trim())return t}},{key:"getOccasionColumnValue",value:function(t,e){var r,n,i,s;return!e||(e=e.split(":")).length<3?" ":e[1]!==t[c]?"":(r=e[2])?(r.includes(".")?2===(i=r.split(".")).length&&(s=t[i[0]],N.isObject(s))&&(n=s[i[1]]):n=t[r],n||(4===e.length&&void 0!==e[3]?e[3]:" ")):" "}},{key:"getClientValue",value:function(t,r){var n=this;return t.replace(/\$\((.*?)\)/g,function(t,e){return n.getContentColumnValue(r,e)})}},{key:"getContentColumnValue",value:function(t,e){return e?(e=e.split(":"),t=(t=this.getColumnValue(t,e))||(3===e.length&&void 0!==e[2]?e[2]:""),N.isDate(t)?N.formatDate(t):t):""}},{key:"buildOpsProperties",value:function(){return{"#ops_receipt_properties":{ops_project_id:this.flow.projectId,ops_task_id:this.flow.taskId,ops_exp_group_id:this.flow.triggerRecord.expGroupId,ops_trigger_time:this.flow.triggerRecord.triggerTime,ops_task_exec_detail_id:N.UUID()}}}},{key:"buildUserParamsMap",value:function(t){for(var e={},r=0;r<this.userParamsList.length;r++){var n=this.userParamsList[r];n&&(e[n.key]=n.value||this.getUserParamsValue(t,n.columnName,n.defaultValue))}return e}},{key:"getUserParamsValue",value:function(t,e,r){return e&&(e=e.split(":"),this.getColumnValue(t,e))||r}},{key:"getColumnValue",value:function(t,e){var r;if(e&&!(e.length<2))return(r=(e=e[1])&&e.startsWith("#")?t[e]:r)||P.getConfigValue(e)}}]))(),be=(()=>{return o(function t(e,r){u(this,t),this.key=e.key,this.num=e.num,this.eventName=e.eventName,this.triggerRule=r},[{key:"evaluate",value:(e=b(I().m(function t(e){var r,n,i,s,a,u,o;return I().w(function(t){for(;;)switch(t.n){case 0:if(r=this.triggerRule.getTimeCycle()){t.n=1;break}return t.a(2,!1);case 1:return n=r.getCurrentTimeCycle(),E.info("EventName: "+this.eventName+" Start : "+N.getFormatDataByLog(n.start)+" End : "+N.getFormatDataByLog(n.end)),t.n=2,Nt();case 2:return i=t.v,u=this.getTriggerResultList(i,{appId:this.triggerRule.taskFlow.appId,clientUserId:this.triggerRule.clientUserId,taskId:this.triggerRule.taskFlow.taskId,triggerId:this.triggerRule.triggerId,start:n.start,end:n.end}),s=this.getRelationProperties(e),t.n=3,this.getEventCount(u,s);case 3:return a=t.v,u=a.count,this.triggerRule.isWithInPeriod()&&u++,E.info("EventName: "+this.eventName+" Trigger Count: "+u+" Target Count: "+this.num),o=!1,u>=this.num?(o=!0,i=i.filter(function(t){return!a.ids.includes(t.id)})):i.push({appId:this.triggerRule.taskFlow.appId,clientUserId:this.triggerRule.clientUserId,taskId:this.triggerRule.taskFlow.taskId,triggerId:this.triggerRule.triggerId,id:N.generateUniqueId(),key:this.key,num:1,event:s,eventTime:P.getCurrentTimeStamp()}),t.n=4,Et(i);case 4:return t.a(2,o)}},t,this)})),function(t){return e.apply(this,arguments)})},{key:"getTriggerResultList",value:function(t,e){for(var r=[],n=0;n<t.length;n++){var i=t[n];i.appId===e.appId&&i.clientUserId===e.clientUserId&&i.taskId===e.taskId&&i.triggerId===e.triggerId&&i.eventTime>=e.start&&i.eventTime<=e.end&&r.push(t[n])}return r}},{key:"getEventCount",value:(n=b(I().m(function t(e,r){var n,i,s,a,u;return I().w(function(t){for(;;)switch(t.n){case 0:n=[],i=0,s=e.length-1;case 1:if(0<=s){if(a=e[s],u=a.key===this.key)return t.n=2,this.isRelationEq(r,a.event);t.n=3}else t.n=6;break;case 2:u=t.v;case 3:u?(i++,n.push(a.id),t.n=5):t.n=4;break;case 4:if(this.triggerRule.disableEventList.includes(a.key))return t.a(3,6);t.n=5;break;case 5:s--,t.n=1;break;case 6:return t.a(2,{count:i,ids:n})}},t,this)})),function(t,e){return n.apply(this,arguments)})},{key:"isRelationEq",value:(r=b(I().m(function t(e,r){var n,i,s,a,u;return I().w(function(t){for(;;)switch(t.n){case 0:if(0===this.triggerRule.relationProperties.length)return t.a(2,!0);t.n=1;break;case 1:if(this.triggerRule.relationProperties.length!==Object.keys(r).length)return E.info("TriggerID: "+this.triggerRule.triggerId+"relation properties length is not equal"),t.a(2,!1);t.n=2;break;case 2:n=new Jt,i=0;case 3:if(!(i<this.triggerRule.relationProperties.length)){t.n=7;break}if(s=this.triggerRule.relationProperties[i]){t.n=4;break}return t.a(3,6);case 4:if(a=s.columnName){t.n=5;break}return t.a(3,6);case 5:n.addRule(new Wt({calcuSymbol:"C00",columnName:a,columnType:s.columnType,ftv:[r[a]]}));case 6:i++,t.n=3;break;case 7:return E.info("TriggerID: "+this.triggerRule.triggerId+"------start relation properties------"),t.n=8,n.evaluate(e);case 8:return u=t.v,E.info("TriggerID: "+this.triggerRule.triggerId+"------end relation properties------result is "+u),t.a(2,u)}},t,this)})),function(t,e){return r.apply(this,arguments)})},{key:"getRelationProperties",value:function(t){for(var e={},r=0;r<this.triggerRule.relationProperties.length;r++){var n,i=this.triggerRule.relationProperties[r];i&&(n=t[i.columnName])&&(e[i.columnName]=n)}return e}}]);var r,n,e})(),Ie=(()=>{return o(function t(e,r,n){u(this,t),this.targetEventList=[],this.taskFlow=e,this.clientUserId=this.taskFlow.clientUserId,this.triggerId=n,this.mEventFilters=new Gt,this.mTriggerTimeCycle=this.createTriggerTimeCycle(r),this.relationProperties=[],this.disableEventList=[],this.parseFilters(r)},[{key:"isWithInPeriod",value:function(){return!!this.mTriggerTimeCycle&&this.mTriggerTimeCycle.isWithInPeriod()}},{key:"parseFilters",value:function(t){this.parseEventFilters(t)}},{key:"parseEventFilters",value:function(t){var e=t.events;if(N.isArray(e))for(var r,n=0;n<e.length;n++){var i,s,a=e[n];a&&(this.targetEventList.push(a.eventName),r=this,i=void 0,i=(i=(s=a).taPropQuota)&&"A200"===i.analysis?new be(s,r):void 0)&&((s=new Jt).addRule(new Wt(N.buildEventNameRule(a.eventName))),s.addRule(ae(a.relation,a.filts,this.taskFlow.zoneOffset)),s.addRule(i),this.mEventFilters.addRule(s))}}},{key:"isTargetEvent",value:function(t){return this.targetEventList.includes(t)}},{key:"triggerEventRules",value:(e=b(I().m(function t(e){var r;return I().w(function(t){for(;;)switch(t.n){case 0:if(e){t.n=1;break}return t.a(2,!1);case 1:return E.info("TriggerID: "+this.triggerId+"------start trigger rules------"),t.n=2,this.mEventFilters.evaluate(e);case 2:return r=t.v,E.info("TriggerID "+this.triggerId+"------end trigger rules------result is "+r),t.a(2,r)}},t,this)})),function(t){return e.apply(this,arguments)})},{key:"getTimeCycle",value:function(){return this.mTriggerTimeCycle}},{key:"createTriggerTimeCycle",value:function(t){var e,r={periodStart:t.periodStart,periodEnd:t.periodEnd,zoneOffset:this.taskFlow.zoneOffset},n={timeCycleNumber:1};switch(t.periodTimeSymbol){case"TS01":n.timeCycleUnit=k;var i=N.parseStartTime(t.dayStartTime);return n.startHour=i.hour,n.startMinute=i.minute,new fe(r,n);case"TS02":e=new he(r);break;case"TS03":n.timeCycleUnit=tt,n.startNumber=t.startDay;i=N.parseStartTime(t.dayStartTime);return n.startHour=i.hour,n.startMinute=i.minute,new pe(r,n);case"TS04":return n.timeCycleUnit=et,n.startNumber=t.startDay,new me(r,n)}return e}}]);var e})(),we=(()=>{function i(t,e,r){return u(this,i),n(this,i,[t,e,r])}return a(i,Ie),o(i,[{key:"parseFilters",value:function(t){H(i,"parseFilters",this,3)([t]),this.parseTimeCycleHour(t),this.parseRelationProperties(t),this.parseDisableEvent(t)}},{key:"parseTimeCycleHour",value:function(t){var e=t.windowGap,t=N.getTimeCycleUnit(t.windowGapTimeUnit);0<e&&t&&(this.periodScrollInfo={timeCycleNumber:e,timeCycleUnit:t})}},{key:"parseRelationProperties",value:function(t){this.relationProperties=t.relationProps,N.isArray(this.relationProperties)||(this.relationProperties=[])}},{key:"parseDisableEvent",value:function(t){this.blackListGroup=new Gt;var e=t.blackList;if(N.isArray(e))for(var r=0;r<e.length;r++){var n,i,s=e[r];s&&(n=s.eventName,this.disableEventList.push(n),(i=new Jt).addRule(new Wt(N.buildEventNameRule(n))),i.addRule(ae(s.relation,s.filts,this.taskFlow.zoneOffset)),this.blackListGroup.addRule(i))}}},{key:"isTargetEvent",value:function(t){return H(i,"isTargetEvent",this,3)([t])||this.disableEventList.includes(t)}},{key:"triggerEventRules",value:(e=b(I().m(function t(e){var r,n;return I().w(function(t){for(;;)switch(t.n){case 0:if(r=e[c],this.disableEventList.includes(r))return E.info("BlackList Event:"+r+"------start trigger rules------"),t.n=1,this.blackListGroup.evaluate(e);t.n=3;break;case 1:if(n=t.v,E.info("BlackList Event:"+r+"------end trigger rules------result is "+n),n)return t.n=2,Lt({appId:this.taskFlow.appId,clientUserId:this.clientUserId,taskId:this.taskFlow.taskId,triggerId:this.triggerId,id:N.generateUniqueId(),key:r,num:1,event:{},eventTime:P.getCurrentTimeStamp()});t.n=2;break;case 2:return t.a(2,!1);case 3:return t.n=4,H(i,"triggerEventRules",this,3)([e]);case 4:return t.a(2,t.v)}},t,this)})),function(t){return e.apply(this,arguments)})},{key:"getTimeCycle",value:function(){var t;return this.periodScrollInfo?(t={periodStartStamp:(t=this.mTriggerTimeCycle.getCurrentTimeCycle()).start,periodEndStamp:t.end},new ge(t,this.periodScrollInfo)):this.mTriggerTimeCycle}}]);var e})(),Ce=(()=>{return o(function t(e,r,n){u(this,t),this.appId=e,this.clientUserId=r,this.taskJson=n,this.triggerRules=[],this.parseTaskInfo(),this.parseTriggerRule(),this.parseExpConfig(),this.parseTargetAudience(),this.parseTaskLimit(),this.parseContentList()},[{key:"parseTaskInfo",value:function(){this.taskId=this.taskJson.taskId,this.projectId=this.taskJson.projectId,this.zoneOffset=this.taskJson.tzOffset,this.taskVersion=this.taskJson.currentVersion,this.channelId=this.taskJson.channelId,this.channelMsgType=this.taskJson.channelMsgType,this.taskMode=this.taskJson.pushMode,this.eventTimeout=this.taskJson.eventTimeout||5e3,this.taskTimeCycle=new he({periodStart:this.taskJson.startDate,periodEnd:this.taskJson.endDate,zoneOffset:this.zoneOffset})}},{key:"parseTriggerRule",value:function(){if(this.taskJson.triggerRule){var t=JSON.parse(this.taskJson.triggerRule);if(N.isArray(t))for(var e=0;e<t.length;e++){var r,n=t[e];if(n){switch(n.eventTriggerType){case 1:r=new we(this,n,e);break;case 3:r=new Ie(this,n,e)}r&&this.triggerRules.push(r)}}}}},{key:"parseExpConfig",value:function(){this.mExpConfig=new ce(this.taskJson,this.zoneOffset)}},{key:"parseTargetAudience",value:function(){var t,e=this.taskJson.clientQp;e&&(t=JSON.parse(e)),N.isObject(t)||(t={}),this.mTargetAudience=new oe(this,this.taskJson.isTargetUser,t,this.taskJson.pushId)}},{key:"parseTaskLimit",value:function(){this.mTaskFrequencyLimit=new ye(this),this.mTaskTouchLimit=new ke(this)}},{key:"parseContentList",value:function(){this.mPushResult=new Te(this)}},{key:"startClientRecord",value:function(){this.triggerRecord={appId:this.appId,clientUserId:this.clientUserId,taskId:this.taskId,isTestTask:this.isTestTask()}}},{key:"isTargetEvent",value:function(t){if(P.isWhiteEvent(t))return!0;for(var e=!1,r=0;r<this.triggerRules.length;r++)if(this.triggerRules[r].isTargetEvent(t)){e=!0;break}return e&&E.info("Task ("+this.taskId+") contains target event"),e}},{key:"isEventTimeout",value:function(t){return 0!==t&&P.getCurrentTimeStamp-t>this.eventTimeout}},{key:"isValidityPeriod",value:function(){var t;return!!this.isChannelTestTask()||((t=this.taskTimeCycle.isWithInPeriod())||E.info("Task ("+this.taskId+") is not in the validity period"),t)}},{key:"triggerEvent",value:(n=b(I().m(function t(e){var r,n;return I().w(function(t){for(;;)switch(t.n){case 0:r=!1,this.isChannelTestTask()?(r=!0,t.n=5):t.n=1;break;case 1:n=0;case 2:if(n<this.triggerRules.length)return t.n=3,this.triggerRules[n].triggerEventRules(e);t.n=5;break;case 3:if(t.v)return r=!0,t.a(3,5);t.n=4;break;case 4:n++,t.n=2;break;case 5:return r&&(this.triggerRecord.triggerTime=P.getCurrentDate()),t.a(2,r)}},t,this)})),function(t){return n.apply(this,arguments)})},{key:"isTargetAudience",value:(r=b(I().m(function t(e){var r;return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,this.mTargetAudience.isTargetAudience(e);case 1:return r=t.v,t.a(2,r)}},t,this)})),function(t){return r.apply(this,arguments)})},{key:"isTaskLimit",value:(t=b(I().m(function t(){return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,this.mTaskFrequencyLimit.isLimit();case 1:if(t.v)return this.triggerRecord.status=2,P.trackTriggerEvent(this.triggerRecord),t.a(2,!0);t.n=2;break;case 2:if(this.mExpConfig.isExpSampleOut())return this.triggerRecord.status=8,P.trackTriggerEvent(this.triggerRecord),E.info("Task ("+this.taskId+") is sampling and elimination"),t.a(2,!0);t.n=3;break;case 3:return t.n=4,this.mTaskTouchLimit.isLimit();case 4:if(t.v)return this.triggerRecord.status=3,P.trackTriggerEvent(this.triggerRecord),t.a(2,!0);t.n=5;break;case 5:if(this.mExpConfig.isSkipPush())return this.triggerRecord.status=9,P.trackTriggerEvent(this.triggerRecord),E.info("Task ("+this.taskId+") is skip push"),t.a(2,!0);t.n=6;break;case 6:return t.a(2,!1)}},t,this)})),function(){return t.apply(this,arguments)})},{key:"finishClientRecord",value:(e=b(I().m(function t(e){return I().w(function(t){for(;;)switch(t.n){case 0:return this.triggerRecord.actualPushTime=P.getCurrentDate(),t.n=1,this.mTaskFrequencyLimit.addLimitCount();case 1:return t.n=2,this.mTaskTouchLimit.addLimitCount();case 2:this.triggerRecord.status=e?6:5,P.trackTriggerEvent(this.triggerRecord);case 3:return t.a(2)}},t,this)})),function(t){return e.apply(this,arguments)})},{key:"isExpRelease",value:function(){return this.mExpConfig.isExpRelease(this.triggerRecord)}},{key:"calculate",value:function(t){return this.mPushResult.calculate(t)}},{key:"isChannelTestTask",value:function(){return 3===this.taskMode}},{key:"isTestTask",value:function(){return 2===this.taskMode||3===this.taskMode}}]);var e,t,r,n})(),O=(()=>{function t(){u(this,t),this.loadSuccess=!1,this.systemConfigs=[]}return o(t,[{key:"loadLocalConfig",value:(e=b(I().m(function t(){var e,r,n;return I().w(function(t){for(;;)switch(t.n){case 0:if(this.loadSuccess)return t.a(2);t.n=1;break;case 1:return t.n=2,S.getStorage("td_system_config");case 2:if(e=t.v,N.isArray(e))for(r=0;r<e.length;r++)"strategy_client"===(n=e[r]).plat&&this.systemConfigs.push(n);this.loadSuccess=!0;case 3:return t.a(2)}},t,this)})),function(){return e.apply(this,arguments)})},{key:"isStratetyStop",value:function(t){for(var e=0;e<this.systemConfigs.length;e++){var r=this.systemConfigs[e];if(r.appId===t)return!!r.disabled||!!N.isArray(r.disabledVersionList)&&r.disabledVersionList.includes(q)}return!1}}],[{key:"getInstance",value:function(){return t.instance=t.instance?t.instance:new t}}]);var e})(),Se=(()=>{function r(t){u(this,r),this.appId=t,this.taskFlows=new Map,this.mDebugTriggerList=[],this.preEventCaches=[]}return o(r,[{key:"loadLocalTask",value:(e=b(I().m(function t(e){var r,n,i=this;return I().w(function(t){for(;;)switch(t.n){case 0:if(0<this.taskFlows.size)return t.a(2);t.n=1;break;case 1:return N.isFunction(e)&&(this.triggerListener=e),de.clientStartTime=P.getCurrentTimeStamp(),t.n=2,St(this.appId,X);case 2:return t.n=3,xt(X);case 3:return t.n=4,Ot(X);case 4:return t.n=5,jt(Z);case 5:return t.n=6,P.getClientUserId(this.appId);case 6:return r=t.v,t.n=7,wt(this.appId,r);case 7:return n=t.v,N.each(n,function(t,e){i.taskFlows.set(t.taskId,new Ce(i.appId,r,t.task))}),t.n=8,Mt({appId:this.appId,clientUserId:r});case 8:return this.mTaskStop=t.v,t.n=9,this.clearPreEvent();case 9:return t.a(2)}},t,this)})),function(t){return e.apply(this,arguments)})},{key:"stopTasks",value:(a=b(I().m(function t(e,r){return I().w(function(t){for(;;)switch(t.n){case 0:if(this.mTaskStop)return t.a(2);t.n=1;break;case 1:if(O.getInstance().isStratetyStop(this.appId))return t.a(2);t.n=2;break;case 2:if(e!==C)return t.a(2);t.n=3;break;case 3:return this.taskFlows.clear(),this.mTaskStop=!0,t.n=4,At({appId:this.appId,clientUserId:r,status:!0});case 4:return t.a(2)}},t,this)})),function(t,e){return a.apply(this,arguments)})},{key:"applyNewConfig",value:(s=b(I().m(function t(e,n){var r,i,s,a,u,o,c,l,h,f,p,m,g,d,v,y,k,T=this;return I().w(function(t){for(;;)switch(t.n){case 0:if(O.getInstance().isStratetyStop(this.appId))return t.a(2);t.n=1;break;case 1:if(e!==C)return t.a(2);t.n=2;break;case 2:return this.mTaskStop=!1,t.n=3,At({appId:this.appId,clientUserId:n,status:!1});case 3:return r=(r=P.getStrategyInfo(this.appId))||[],t.n=4,wt(this.appId,n);case 4:i=t.v,s=[],a=[],u=[],o=[],c=0;case 5:if(!(c<r.length)){t.n=10;break}if(l=r[c]){t.n=6;break}return t.a(3,9);case 6:if(h=l.taskId,f=l.currentVersion,1!==l.status)return u.push(h),s.push({taskId:h,taskVersion:f,clientUserId:n,task:""}),t.a(3,9);t.n=7;break;case 7:if((p=i[h])&&f>p.taskVersion)return t.n=8,Pt({appId:this.appId,clientUserId:n,taskId:h});t.n=8;break;case 8:a.push(h),s.push({taskId:h,taskVersion:f,clientUserId:n,task:l}),(!(p=this.taskFlows[h])||f>=p.taskVersion)&&(p=new Ce(this.appId,n,l),this.taskFlows.set(h,p)),p.isTestTask()&&o.push(h);case 9:c++,t.n=5;break;case 10:return t.n=11,Ct(this.appId,n,s);case 11:N.each(i,(()=>{var r=b(I().m(function t(e,r){return I().w(function(t){for(;;)switch(t.n){case 0:if(a.includes(r)||u.includes(r)){t.n=2;break}return t.n=1,Pt({appId:T.appId,clientUserId:n,taskId:r});case 1:return t.n=2,Dt({appId:T.appId,clientUserId:n,taskId:r});case 2:return t.a(2)}},t)}));return function(t,e){return r.apply(this,arguments)}})()),m=M(this.taskFlows);try{for(m.s();!(g=m.n()).done;)d=w(g.value,2),v=d[0],a.includes(v)||this.taskFlows.delete(v)}catch(t){m.e(t)}finally{m.f()}return t.n=12,this.clearPreEvent();case 12:P.trackClientDebugEvent(this.appId,o),y=0;case 13:if(!(y<o.length)){t.n=17;break}if(k=this.taskFlows.get(o[y])){t.n=14;break}return t.a(3,16);case 14:if(k.isChannelTestTask()){t.n=15;break}return t.a(3,16);case 15:return t.n=16,this.taskTriggerFlow(k,kt,P.buildAnalyticPresetFacts(this.appId));case 16:y++,t.n=13;break;case 17:return t.a(2)}},t,this)})),function(t,e){return s.apply(this,arguments)})},{key:"clearPreEvent",value:(t=b(I().m(function t(){var e;return I().w(function(t){for(;;)switch(t.n){case 0:if(this.taskFlows.size<=0)return t.a(2);t.n=1;break;case 1:this.loadTaskSuccess=!0,e=0;case 2:if(e<this.preEventCaches.length)return t.n=3,this.triggerEvent(this.preEventCaches[e].event,this.preEventCaches[e].time);t.n=4;break;case 3:e++,t.n=2;break;case 4:this.preEventCaches=[];case 5:return t.a(2)}},t,this)})),function(){return t.apply(this,arguments)})},{key:"triggerEvent",value:(n=b(I().m(function t(e,r){var n,i,s,a;return I().w(function(t){for(;;)switch(t.n){case 0:if(O.getInstance().isStratetyStop(this.appId))return t.a(2);t.n=1;break;case 1:if(e){t.n=2;break}return t.a(2);case 2:if(this.mTaskStop)return t.a(2);t.n=3;break;case 3:if("track"!==e[$]||e[K])return t.a(2);t.n=4;break;case 4:if(n=e[c]){t.n=5;break}return t.a(2);case 5:if(this.loadTaskSuccess){t.n=6;break}return this.preEventCaches.length<20&&this.preEventCaches.push({time:P.getCurrentTimeStamp(),event:e}),t.a(2);case 6:if(P.isBlackEvent(n))return t.a(2);t.n=7;break;case 7:i=N.jsonToFacts(e),E.info("Event received:"+n),s=M(this.taskFlows),t.p=8,s.s();case 9:if((a=s.n()).done){t.n=11;break}return a=w(a.value,2),a[0],a=a[1],t.n=10,this.taskTriggerFlow(a,n,i,r);case 10:t.n=9;break;case 11:t.n=13;break;case 12:t.p=12,a=t.v,s.e(a);case 13:return t.p=13,s.f(),t.f(13);case 14:return t.a(2)}},t,this,[[8,12,13,14]])})),function(t,e){return n.apply(this,arguments)})},{key:"taskTriggerFlow",value:(i=b(I().m(function t(e,r,n,i){var s,a;return I().w(function(t){for(;;)switch(t.n){case 0:if(this.mDebugTriggerList.includes(e.taskId))return t.a(2);t.n=1;break;case 1:if(e.startClientRecord(),e.isTargetEvent(r)){t.n=2;break}return t.a(2);case 2:if(e.isEventTimeout(i))return t.a(2);t.n=3;break;case 3:if(e.isValidityPeriod()){t.n=4;break}return t.a(2);case 4:return t.n=5,e.triggerEvent(n);case 5:if(t.v){t.n=6;break}return t.a(2);case 6:return t.n=7,e.isTargetAudience(n);case 7:if(t.v){t.n=8;break}return t.a(2);case 8:if(e.isExpRelease()){t.n=9;break}return t.a(2);case 9:return t.n=10,e.isTaskLimit();case 10:if(t.v)return t.a(2);t.n=11;break;case 11:return s=e.calculate(n),E.info("Task ("+e.taskId+") will be pushed soon"),a=!1,this.triggerListener&&(this.triggerListener(s),a=!0),e.isChannelTestTask()&&this.mDebugTriggerList.push(e.taskId),t.n=12,e.finishClientRecord(a);case 12:return t.a(2)}},t,this)})),function(t,e,r,n){return i.apply(this,arguments)})}],[{key:"getInstance",value:function(t){var e=(r.instances=r.instances?r.instances:{})[t];return e||(e=new r(t),r.instances[t]=e),e}}]);var i,n,t,s,a,e})(),U=(()=>{function t(){u(this,t),this.tasks=[],this.timeStamp=0}return o(t,[{key:"addTask",value:function(t){var e=function(){return t.apply(this)}.bind(this);this.tasks.push(e),this.run()}},{key:"run",value:(e=b(I().m(function t(){var e;return I().w(function(t){for(;;)switch(t.n){case 0:if(this.tasks.length<=0)return t.a(2);t.n=1;break;case 1:if(0===this.timeStamp||3e3<Date.now()-this.timeStamp)return this.timeStamp=Date.now(),e=this.tasks.shift(),t.n=2,e();t.n=3;break;case 2:this.timeStamp=0,this.run();case 3:return t.a(2)}},t,this)})),function(){return e.apply(this,arguments)})}],[{key:"getInstance",value:function(){return t.instance=t.instance?t.instance:new t}}]);var e})(),Ne=S.getAnalyticGlobalData(),Ee=S.getConfigGlobalData(),r=(()=>{function r(){u(this,r)}return o(r,null,[{key:"init",value:(e=b(I().m(function t(e){return I().w(function(t){for(;;)switch(t.n){case 0:if(e=N.checkSettings(e)){t.n=1;break}return t.a(2);case 1:if((r.initAppIds=r.initAppIds?r.initAppIds:[]).includes(e.appId))return t.a(2);t.n=2;break;case 2:return Ne.registerAnalyticsObserver(function(t,e){"onDataEnqueue"===t&&U.getInstance().addTask(b(I().m(function t(){return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,Se.getInstance(e.appId).triggerEvent(e.event,0);case 1:return t.a(2)}},t)})))},e.appId),e.remoteconfigObserver=function(t,e){"onConfigApplySuccess"===t?U.getInstance().addTask(b(I().m(function t(){return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,Se.getInstance(e.appId).applyNewConfig(e.templateCode,e.clientUserId);case 1:return t.a(2)}},t)}))):"onConfigChanged"===t&&U.getInstance().addTask(b(I().m(function t(){return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,Se.getInstance(e.appId).stopTasks(e.templateCode,e.clientUserId);case 1:return t.a(2)}},t)})))},t.n=3,O.getInstance().loadLocalConfig();case 3:if(O.getInstance().isStratetyStop(e.appId))return t.a(2);t.n=4;break;case 4:Ee.init(e),U.getInstance().addTask(b(I().m(function t(){return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,Se.getInstance(e.appId).loadLocalTask(e.triggerListener);case 1:E.info("TDStrategy SDK init success with appId = "+e.appId+" and version = "+q);case 2:return t.a(2)}},t)}))),r.initAppIds.push(e.appId);case 5:return t.a(2)}},t)})),function(t){return e.apply(this,arguments)})},{key:"setLogPrintListener",value:function(t){E.listener=t}},{key:"addClientParams",value:function(e){U.getInstance().addTask(b(I().m(function t(){return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,gt.addClientParams(e);case 1:return t.a(2)}},t)})))}},{key:"removeClientParam",value:function(e){U.getInstance().addTask(b(I().m(function t(){return I().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,gt.removeClientParam(e);case 1:return t.a(2)}},t)})))}}]);var e})();return S.setGlobalData(r),r});