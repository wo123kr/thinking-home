---
alwaysApply: true
---
<!-- âœ… Thinking Data 2 -->
<script src="https://cdn.jsdelivr.net/npm/thinkingdata-browser@2.0.3/thinkingdata.umd.min.js"></script>
<script src="https://te-receiver-naver.thinkingdata.kr/te-sdk/latest/ta.js"></script>

<script>
    // âœ… ThinkingData SDK ì´ˆê¸°í™”
    var config = {
        appId: "cf003f81e4564662955fc0e0d914cef9",
        serverUrl: "https://te-receiver-naver.thinkingdata.kr/sync_js",
        autoTrack: {
            pageShow: true,  // í˜ì´ì§€ ì§„ì… ìë™ ì¶”ì 
            pageHide: true   // í˜ì´ì§€ ì´íƒˆ ìë™ ì¶”ì 
        }
    };

    window.te = thinkingdata;
    te.init(config);  // âœ… SDK ì´ˆê¸°í™” ì™„ë£Œ
    console.log("âœ… ThinkingData SDK initialized:", config);

    
    /* ================================
       ğŸ“ âœ… ì„¸ì…˜ ê´€ë¦¬ ë° ê³µí†µ ì†ì„± ì„¤ì •
    ================================= */
    
    // ì„¸ì…˜ ê´€ë¦¬ ë³€ìˆ˜
    let sessionId = null;
    let sessionNumber = parseInt(localStorage.getItem('te_session_number') || '0');
    let sessionStartTime = null;
    let isEngagedSession = false;
    let interactionCount = 0;
    let lastActivityTime = Date.now();
    const SESSION_TIMEOUT = 30 * 60 * 1000; // 30ë¶„ (ì›¹ ê¸°ì¤€)
    
    // ì„¸ì…˜ ID ìƒì„±
    function generateSessionId() {
        return Date.now(); // Epoch ì‹œê°„ ì‚¬ìš© (Amplitude ê¶Œì¥)
    }
    
    // ì„¸ì…˜ ì‹œì‘
    function startSession() {
        sessionId = generateSessionId();
        sessionNumber++;
        sessionStartTime = Date.now();
        isEngagedSession = false;
        interactionCount = 0;
        
        localStorage.setItem('te_session_number', sessionNumber.toString());
        localStorage.setItem('te_session_id', sessionId.toString());
        localStorage.setItem('te_session_start_time', sessionStartTime.toString());
        
        // ê³µí†µ ì†ì„± ì—…ë°ì´íŠ¸ (ìƒˆ ì„¸ì…˜ ì •ë³´ ë°˜ì˜)
        setSuperProperties();
        
        // ì„¸ì…˜ ì‹œì‘ ì´ë²¤íŠ¸ ì „ì†¡
        te.track('te_session_start', {
            session_id: sessionId,
            session_number: sessionNumber,
            is_engaged_session: isEngagedSession
        });
        
        console.log('âœ… Session started:', sessionId, 'Session Number:', sessionNumber);
    }
    
    // ì„¸ì…˜ í™œë™ ì—…ë°ì´íŠ¸
    function updateSessionActivity() {
        lastActivityTime = Date.now();
        interactionCount++;
        
        // ì¸ê²Œì´ì§€ ì„¸ì…˜ ì¡°ê±´: 10ì´ˆ ì´ìƒ ë˜ëŠ” 2íšŒ ì´ìƒ ìƒí˜¸ì‘ìš©
        if (!isEngagedSession) {
            const timeSpent = Date.now() - sessionStartTime;
            if (timeSpent >= 10000 || interactionCount >= 2) {
                isEngagedSession = true;
                console.log('âœ… Session became engaged');
            }
        }
    }
    
    // ì„¸ì…˜ ë§Œë£Œ ì²´í¬
    function checkSessionExpiry() {
        if (Date.now() - lastActivityTime > SESSION_TIMEOUT) {
            startSession(); // ìƒˆ ì„¸ì…˜ ì‹œì‘
        }
    }
    
            // ê¸°ì¡´ ì„¸ì…˜ ë³µì› ë˜ëŠ” ìƒˆ ì„¸ì…˜ ì‹œì‘
        function initializeSession() {
            const storedSessionId = localStorage.getItem('te_session_id');
            const storedStartTime = localStorage.getItem('te_session_start_time');
            
            if (storedSessionId && storedStartTime) {
                const timeSinceStart = Date.now() - parseInt(storedStartTime);
                if (timeSinceStart < SESSION_TIMEOUT) {
                    // ê¸°ì¡´ ì„¸ì…˜ ë³µì›
                    sessionId = parseInt(storedSessionId);
                    sessionStartTime = parseInt(storedStartTime);
                    sessionNumber = parseInt(localStorage.getItem('te_session_number') || '1');
                    console.log('âœ… Session restored:', sessionId, 'Session Number:', sessionNumber);
                } else {
                    startSession(); // ìƒˆ ì„¸ì…˜ ì‹œì‘
                }
            } else {
                startSession(); // ìƒˆ ì„¸ì…˜ ì‹œì‘
            }
        }
    
    // ê³µí†µ ì†ì„± ì„¤ì • (ëª¨ë“  ì´ë²¤íŠ¸ì— ìë™ ì¶”ê°€)
    function setSuperProperties() {
        const superProperties = {
            // ì„¸ì…˜ ê´€ë ¨ (ì»¤ìŠ¤í…€)
            session_id: sessionId,
            session_number: sessionNumber,
            
            // í˜ì´ì§€ ì •ë³´ (SDK ìë™ìˆ˜ì§‘ #url, #url_path, #titleê³¼ ë³„ê°œ)
            page_host: window.location.hostname,
            page_protocol: window.location.protocol,
            page_hash: window.location.hash || null,
            page_query: window.location.search || null,
            
            // ë·°í¬íŠ¸ ì •ë³´ (SDKì˜ #screen_width/heightì™€ ë‹¤ë¦„ - ì‹¤ì œ ë¸Œë¼ìš°ì € ì°½ í¬ê¸°)
            viewport_width: window.innerWidth,
            viewport_height: window.innerHeight,
            viewport_ratio: Math.round((window.innerWidth / window.innerHeight) * 100) / 100,
            
            // ë””ë°”ì´ìŠ¤ ì •ë³´ (SDK ìë™ìˆ˜ì§‘ ì™¸ ì¶”ê°€ ì •ë³´)
            device_pixel_ratio: window.devicePixelRatio || 1,
            orientation: window.innerHeight > window.innerWidth ? 'portrait' : 'landscape',
            
            // í™˜ê²½ ê°ì§€ (SDKì—ì„œ ì œê³µí•˜ì§€ ì•ŠëŠ” ì •ë³´)
            is_mobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            is_touch_device: 'ontouchstart' in window || navigator.maxTouchPoints > 0,
            is_tablet: /iPad|Android|Tablet/i.test(navigator.userAgent) && window.innerWidth >= 768,
            
            // ë¸Œë¼ìš°ì € ê¸°ëŠ¥ ì§€ì› (ê¸°ìˆ ì  ì œì•½ì‚¬í•­)
            local_storage_enabled: (function() {
                try {
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                    return true;
                } catch (e) {
                    return false;
                }
            })(),
            cookies_enabled: navigator.cookieEnabled,
            webgl_enabled: (function() {
                try {
                    const canvas = document.createElement('canvas');
                    return !!(canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));
                } catch (e) {
                    return false;
                }
            })(),
            
            // ë„¤íŠ¸ì›Œí¬ ì •ë³´ (ì§€ì›í•˜ëŠ” ë¸Œë¼ìš°ì €ë§Œ)
            connection_type: navigator.connection ? navigator.connection.effectiveType : null,
            connection_downlink: navigator.connection ? navigator.connection.downlink : null,
            is_online: navigator.onLine,
            
            // íƒ€ì´ë° ì •ë³´
            timestamp: Date.now(),
            local_time: new Date().toISOString(),
            
            // ì„±ëŠ¥ ì •ë³´ (ì˜ë¯¸ìˆëŠ” ì§€í‘œë§Œ)
            dom_ready_state: document.readyState,
            performance_now: Math.round(performance.now()),
            connection_rtt: navigator.connection ? navigator.connection.rtt : null, // ë„¤íŠ¸ì›Œí¬ ì§€ì—°ì‹œê°„
            memory_used: performance.memory && performance.memory.usedJSHeapSize ? 
                Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) : null // MB ë‹¨ìœ„
        };
        
        // UTM íŒŒë¼ë¯¸í„° ì¶”ì¶œ (ë§ˆì¼€íŒ… ìº í˜ì¸ ì¶”ì  - SDK #utmê³¼ ë³„ê°œ)
        const urlParams = new URLSearchParams(window.location.search);
        ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content', 'utm_id'].forEach(function(param) {
            const value = urlParams.get(param);
            if (value) {
                superProperties[param] = value;
            }
        });
        
        // ì»¤ìŠ¤í…€ ì¶”ì  IDë“¤
        ['gclid', 'fbclid', 'msclkid', '_ga'].forEach(function(param) {
            const value = urlParams.get(param);
            if (value) {
                superProperties[param] = value;
            }
        });
        
        te.setSuperProperties(superProperties);
        console.log('âœ… Super properties set:', superProperties);
    }
    
    // ì„¸ì…˜ ì´ˆê¸°í™”
    initializeSession();
    setSuperProperties();
    
    /* ================================
       ğŸ“ âœ… í˜ì´ì§€ ë·° ì´ë²¤íŠ¸
    ================================= */
    
    // í˜ì´ì§€ ë·° ì´ë²¤íŠ¸ ì „ì†¡
    function trackPageView() {
        const pageViewProperties = {
            page_url: window.location.href,
            page_path: window.location.pathname,
            page_title: document.title
        };
        
        // referrer ì •ë³´ê°€ ìˆì„ ë•Œë§Œ ì¶”ê°€
        if (document.referrer) {
            pageViewProperties.referrer = document.referrer;
            try {
                pageViewProperties.referrer_host = new URL(document.referrer).hostname;
            } catch (e) {
                // URL íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
            }
        }
        
        te.track('te_page_view', pageViewProperties);
    }
    
    trackPageView();
    
    /* ================================
       ğŸ“ âœ… íŒì—… ì¶”ì 
    ================================= */
    
    // íŒì—… ê´€ë ¨ ì¶”ì 
    function trackPopupEvents() {
        // íŒì—… í‘œì‹œ ê°ì§€
        const popupObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1) { // Element node
                        // íŒì—…ìœ¼ë¡œ ì¶”ì •ë˜ëŠ” ìš”ì†Œë“¤ ê°ì§€
                        if (node.classList && (
                            node.classList.contains('modal') ||
                            node.classList.contains('popup') ||
                            node.classList.contains('overlay') ||
                            node.getAttribute('role') === 'dialog'
                        )) {
                            te.track('popup_shown', {
                                popup_type: 'benefit_check',
                                popup_id: node.id || 'unknown',
                                popup_class: Array.from(node.classList).join(' ')
                            });
                        }
                    }
                });
            });
        });
        
        popupObserver.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        // íŒì—… ë‹«ê¸° ë²„íŠ¼ ì¶”ì 
        document.addEventListener('click', function(event) {
            const target = event.target;
            
            // í˜œíƒ í™•ì¸í•˜ê¸° ë²„íŠ¼ ê°ì§€
            if (target.textContent && target.textContent.includes('í˜œíƒ í™•ì¸í•˜ê¸°')) {
                updateSessionActivity();
                te.track('popup_action', {
                    action_type: 'benefit_check_click',
                    button_text: target.textContent.trim(),
                    element_id: target.id || null,
                    element_class: target.className || null
                });
            }
            
            // íŒì—… ë‹«ê¸° ë²„íŠ¼ ê°ì§€
            if (target.classList.contains('close') || 
                target.classList.contains('modal-close') ||
                target.getAttribute('aria-label') === 'Close' ||
                target.textContent === '+' ||
                target.closest('.popup-close')) {
                updateSessionActivity();
                te.track('popup_action', {
                    action_type: 'popup_close',
                    close_method: 'button_click',
                    element_id: target.id || null,
                    element_class: target.className || null
                });
            }
        });
        
        // ESC í‚¤ë¡œ íŒì—… ë‹«ê¸° ê°ì§€
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                updateSessionActivity();
                te.track('popup_action', {
                    action_type: 'popup_close',
                    close_method: 'escape_key'
                });
            }
        });
    }
    
    /* ================================
       ğŸ“ âœ… í´ë¦­ ì´ë²¤íŠ¸ ì¶”ì 
    ================================= */
    
    // ë²„íŠ¼ ë° ë§í¬ í´ë¦­ ì¶”ì 
    function trackClickEvents() {
        document.addEventListener('click', function(event) {
            const target = event.target;
            const closestClickable = target.closest('a, button, [role="button"], .btn, .button');
            
            if (closestClickable) {
                updateSessionActivity();
                
                const elementData = {
                    element_id: closestClickable.id || null,
                    element_class_list: closestClickable.className ? closestClickable.className.split(' ') : [],
                    element_name: closestClickable.textContent ? closestClickable.textContent.trim() : null,
                    element_tag_name: closestClickable.tagName.toLowerCase(),
                    element_target_url: closestClickable.href || null,
                    page_url: window.location.href,
                    click_coordinates_page: {
                        x_coordinate: event.pageX,
                        y_coordinate: event.pageY
                    }
                };
                
                // ë©”ë‰´ í´ë¦­ ê°ì§€ (GNB ë“±)
                if (closestClickable.closest('nav') || 
                    closestClickable.closest('.navigation') ||
                    closestClickable.closest('.menu') ||
                    closestClickable.closest('header')) {
                    
                    te.track('te_menu_click', {
                        ...elementData,
                        menu_id: closestClickable.id || elementData.element_name || 'unknown',
                        menu_name: elementData.element_name,
                        menu_depth: getMenuDepth(closestClickable),
                        menu_position: getMenuPosition(closestClickable),
                        menu_target_url: elementData.element_target_url
                    });
                }
                // ì™¸ë¶€ ë§í¬ í´ë¦­ ê°ì§€
                else if (closestClickable.href && isExternalLink(closestClickable.href)) {
                    te.track('te_outbound_link_click', {
                        outbound_url: closestClickable.href,
                        link_text: elementData.element_name,
                        link_id: elementData.element_id,
                        link_class_list: elementData.element_class_list
                    });
                }
                // ì¼ë°˜ ìš”ì†Œ í´ë¦­
                else {
                    te.track('te_element_click', elementData);
                }
            }
        });
    }
    
    // ë©”ë‰´ ê¹Šì´ íŒë‹¨
    function getMenuDepth(element) {
        let depth = 1;
        let parent = element.parentElement;
        
        while (parent && !parent.closest('nav, .navigation, .menu')) {
            if (parent.tagName === 'UL' || parent.tagName === 'OL') {
                depth++;
            }
            parent = parent.parentElement;
        }
        
        return depth + 'ì°¨';
    }
    
    // ë©”ë‰´ ìœ„ì¹˜ íŒë‹¨
    function getMenuPosition(element) {
        const nav = element.closest('nav, .navigation, .menu');
        if (!nav) return 'unknown';
        
        const rect = nav.getBoundingClientRect();
        if (rect.top < 100) return 'ìƒë‹¨';
        if (rect.left < 100) return 'ì‚¬ì´ë“œ';
        if (rect.bottom > window.innerHeight - 100) return 'í‘¸í„°';
        return 'ê¸°íƒ€';
    }
    
    // ì™¸ë¶€ ë§í¬ íŒë‹¨
    function isExternalLink(url) {
        try {
            const linkHost = new URL(url).hostname;
            const currentHost = window.location.hostname;
            return linkHost !== currentHost;
        } catch (e) {
            return false;
        }
    }
    
    /* ================================
       ğŸ“ âœ… ìŠ¤í¬ë¡¤ ê¹Šì´ ì¶”ì 
    ================================= */
    
    let scrollDepthTracked = new Set();
    let maxScrollDepth = 0;
    
    function trackScrollDepth() {
        const scrollDepthThresholds = [25, 50, 75, 90, 100];
        
        function calculateScrollDepth() {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const windowHeight = window.innerHeight;
            const documentHeight = Math.max(
                document.body.scrollHeight,
                document.body.offsetHeight,
                document.documentElement.clientHeight,
                document.documentElement.scrollHeight,
                document.documentElement.offsetHeight
            );
            
            const scrollDepthPercentage = Math.round(
                ((scrollTop + windowHeight) / documentHeight) * 100
            );
            
            return {
                percentage: Math.min(scrollDepthPercentage, 100),
                pixels: scrollTop,
                totalHeight: documentHeight
            };
        }
        
        function handleScroll() {
            updateSessionActivity();
            
            const scrollData = calculateScrollDepth();
            
            // ìµœëŒ€ ìŠ¤í¬ë¡¤ ê¹Šì´ ì—…ë°ì´íŠ¸
            if (scrollData.percentage > maxScrollDepth) {
                maxScrollDepth = scrollData.percentage;
            }
            
            // ì„ê³„ê°’ ë„ë‹¬ ì‹œ ì´ë²¤íŠ¸ ì „ì†¡
            scrollDepthThresholds.forEach(threshold => {
                if (scrollData.percentage >= threshold && !scrollDepthTracked.has(threshold)) {
                    scrollDepthTracked.add(threshold);
                    
                    te.track('te_scroll_depth', {
                        scroll_depth_percentage: threshold,
                        scroll_depth_pixels: scrollData.pixels,
                        page_total_height_pixels: scrollData.totalHeight,
                        page_name: document.title,
                        page_url: window.location.href,
                        scroll_direction: 'vertical'
                    });
                }
            });
        }
        
        // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ë””ë°”ìš´ì‹± ì ìš©)
        let scrollTimeout;
        window.addEventListener('scroll', function() {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(handleScroll, 100);
        });
    }

    /* ================================
       ğŸ“ âœ… í¼ ì œì¶œ ì¶”ì 
    ================================= */

    function trackFormSubmissions() {
        document.addEventListener('submit', function(event) {
            const form = event.target;
            updateSessionActivity();
            
            // í¼ ë°ì´í„° ìˆ˜ì§‘ (ê°œì¸ì •ë³´ ì œì™¸)
            const formData = new FormData(form);
            const formFields = {};
            
            // ê°œì¸ì •ë³´ê°€ ì•„ë‹Œ í•„ë“œë§Œ ìˆ˜ì§‘
            for (let [key, value] of formData.entries()) {
                if (!isPersonalInfo(key)) {
                    formFields[key] = value;
                }
            }
            
            // ê°œì¸ì •ë³´ ë™ì˜ ì²´í¬ë°•ìŠ¤ í™•ì¸
            const privacyCheckbox = form.querySelector('input[type="checkbox"][name*="privacy"], input[type="checkbox"][name*="agreement"]');
            const privacyAgreed = privacyCheckbox ? privacyCheckbox.checked : null;
            
            // ThinkingData ê³µì‹ í¼ êµ¬ë¶„
            const formType = getThinkingDataFormType(form);
            
            const formSubmitData = {
                form_id: form.id || form.name || 'unknown_form',
                form_name: getFormName(form),
                form_type: formType, // 'demo_request', 'contact_inquiry', 'other'
                form_url: window.location.href,
                form_fields_submitted_info: {
                    name: formData.get('name') ? maskName(formData.get('name')) : null,
                    email: formData.get('email') ? maskEmail(formData.get('email')) : null,
                    phone: formData.get('phone') ? maskPhone(formData.get('phone')) : null,
                    company_name: formData.get('company') || formData.get('company_name') || null, // íšŒì‚¬ëª…ì€ ë§ˆìŠ¤í‚¹ ì•ˆí•¨
                    inquiry_source: formData.get('source') || formData.get('how_did_you_know') || null,
                    message_length: formData.get('message') ? formData.get('message').length : null // ë©”ì‹œì§€ ê¸¸ì´ë§Œ
                },
                privacy_agreement_checked: privacyAgreed,
                submission_status: 'pending'
            };
            
            te.track('te_form_submit', formSubmitData);
            
            // í¼ ì œì¶œ ê²°ê³¼ ì¶”ì  (AJAX ìš”ì²­ì¸ ê²½ìš°)
            setTimeout(() => {
                const submitButton = form.querySelector('button[type="submit"], input[type="submit"]');
                if (submitButton && submitButton.disabled) {
                    // ì„±ê³µìœ¼ë¡œ ê°€ì •
                    te.track('te_form_submit', {
                        ...formSubmitData,
                        submission_status: 'success'
                    });
                }
            }, 1000);
        });
        
        // í¼ ì œì¶œ ì˜¤ë¥˜ ì¶”ì 
        document.addEventListener('invalid', function(event) {
            updateSessionActivity();
            
            const form = event.target.closest('form');
            if (form) {
                te.track('te_form_submit_error', {
                    form_name: getFormName(form),
                    error_type: 'validation_error',
                    field_name: event.target.name || event.target.id,
                    error_message: event.target.validationMessage
                });
            }
        }, true);
    }
    
    // ê°œì¸ì •ë³´ í•„ë“œ íŒë‹¨
    function isPersonalInfo(fieldName) {
        const personalFields = ['email', 'phone', 'name', 'password', 'ssn', 'birthday'];
        return personalFields.some(field => fieldName.toLowerCase().includes(field));
    }
    
    // í¼ ì´ë¦„ ì¶”ì¶œ
    function getFormName(form) {
        return form.title || 
               form.getAttribute('data-form-name') ||
               form.closest('[data-form-name]')?.getAttribute('data-form-name') ||
               'ì•Œ ìˆ˜ ì—†ëŠ” í¼';
    }
    
    // ThinkingData ê³µì‹ í¼ íƒ€ì… êµ¬ë¶„
    function getThinkingDataFormType(form) {
        const submitButton = form.querySelector('input[type="submit"], button[type="submit"]');
        const url = window.location.href;
        
        // URLê³¼ ë²„íŠ¼ ID ê¸°ë°˜ìœ¼ë¡œ êµ¬ë¶„
        if (url.includes('/form-demo') || (submitButton && submitButton.id === 'demo_submit')) {
            return 'demo_request';
        } else if (url.includes('/form-ask') || (submitButton && submitButton.id === 'ask_submit')) {
            return 'contact_inquiry';
        } else {
            return 'other';
        }
    }
    
    // ğŸ­ ê°œì„ ëœ ë§ˆìŠ¤í‚¹ í•¨ìˆ˜ë“¤ (ì‹¤ì œ ë°ì´í„° íŒ¨í„´ ìœ ì§€í•˜ë©´ì„œ ë³´ì•ˆ)
    function maskEmail(email) {
        if (!email || typeof email !== 'string') return null;
        
        const parts = email.split('@');
        if (parts.length !== 2) return '***@***.***';
        
        const [localPart, domain] = parts;
        const domainParts = domain.split('.');
        
        // ì´ë©”ì¼ íŒ¨í„´: ì²«ê¸€ì + *** + @ë„ë©”ì¸ì²«ê¸€ì*** + .í™•ì¥ì
        const maskedLocal = localPart.length > 1 ? localPart[0] + '***' : '***';
        const maskedDomain = domainParts.length > 1 ? 
            domainParts[0][0] + '***.' + domainParts[domainParts.length - 1] : 
            '***.' + domainParts[0];
            
        return maskedLocal + '@' + maskedDomain;
    }
    
    function maskPhone(phone) {
        if (!phone || typeof phone !== 'string') return null;
        
        // ìˆ«ìë§Œ ì¶”ì¶œ
        const numbers = phone.replace(/\D/g, '');
        
        if (numbers.length >= 10) {
            // 010-****-1234 í˜•íƒœë¡œ ë§ˆìŠ¤í‚¹ (ì•3ìë¦¬, ë’¤4ìë¦¬ ë³´ì´ê³  ì¤‘ê°„ ë§ˆìŠ¤í‚¹)
            return numbers.substring(0, 3) + '-****-' + numbers.slice(-4);
        } else if (numbers.length >= 7) {
            return numbers.substring(0, 2) + '***' + numbers.slice(-2);
        } else {
            return '***-****-****';
        }
    }
    
    function maskName(name) {
        if (!name || typeof name !== 'string') return null;
        
        const trimmed = name.trim();
        if (trimmed.length <= 1) {
            return '*';
        } else if (trimmed.length === 2) {
            return trimmed[0] + '*';
        } else {
            // 3ê¸€ì ì´ìƒ: ì²«ê¸€ì + *** + ë§ˆì§€ë§‰ê¸€ì
            return trimmed[0] + '***' + trimmed[trimmed.length - 1];
        }
    }

    /* ================================
       ğŸ“ âœ… ìœ íŠœë¸Œ ë¹„ë””ì˜¤ ì¶”ì  (YouTube API í™œìš©)
    ================================= */

    // ë¹„ë””ì˜¤ ì„¸ì…˜ ì¶”ì ì„ ìœ„í•œ ë³€ìˆ˜ë“¤
    let videoSessions = new Map(); // ê° ë¹„ë””ì˜¤ë³„ ì„¸ì…˜ ì¶”ì 
    
    function trackVideoEvents() {
        console.log('ğŸ¬ ë¹„ë””ì˜¤ ì¶”ì  ì´ˆê¸°í™” ì‹œì‘...');
        
        // YouTube iframeì´ ìˆëŠ”ì§€ í™•ì¸
        const youtubeIframes = document.querySelectorAll('iframe[src*="youtube.com"], iframe[src*="youtu.be"]');
        console.log(`ğŸ¯ YouTube iframe ë°œê²¬: ${youtubeIframes.length}ê°œ`);
        
        if (youtubeIframes.length > 0) {
            // YouTube API ì¦‰ì‹œ ë¡œë“œ (ë” ì •í™•í•œ ì¶”ì ì„ ìœ„í•´)
            loadYouTubeAPI();
        } else {
            console.log('â„¹ï¸ YouTube iframeì´ ì—†ì–´ì„œ API ë¡œë“œí•˜ì§€ ì•ŠìŒ');
        }
    }
    
    // YouTube API ë™ì  ë¡œë“œ (ë” ì •í™•í•œ ì¶”ì ì„ ìœ„í•´)
    function loadYouTubeAPI() {
        // ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ì¤‘ë³µ ë¡œë“œ ë°©ì§€
        if (window.YT && window.YT.Player) {
            initializeYouTubePlayers();
            return;
        }
        
        // ì´ë¯¸ ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸
        if (document.querySelector('script[src*="youtube.com/iframe_api"]')) {
            return;
        }
        
        console.log('ğŸ¬ YouTube API ë¡œë“œ ì‹œì‘...');
        
        const script = document.createElement('script');
        script.src = 'https://www.youtube.com/iframe_api';
        script.async = true;
        script.onload = function() {
            console.log('âœ… YouTube API ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
        };
        script.onerror = function() {
            console.error('âŒ YouTube API ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨');
        };
        document.head.appendChild(script);
        
        // YouTube API ì¤€ë¹„ ì™„ë£Œ ì‹œ í˜¸ì¶œë  í•¨ìˆ˜
        window.onYouTubeIframeAPIReady = function() {
            console.log('âœ… YouTube API ì¤€ë¹„ ì™„ë£Œ!');
            initializeYouTubePlayers();
        };
    }
    
    // YouTube í”Œë ˆì´ì–´ ì´ˆê¸°í™”
    function initializeYouTubePlayers() {
        const youtubeIframes = document.querySelectorAll('iframe[src*="youtube.com"], iframe[src*="youtu.be"]');
        console.log(`ğŸ¯ YouTube iframe ë°œê²¬: ${youtubeIframes.length}ê°œ`);
        
        youtubeIframes.forEach((iframe, index) => {
            if (!iframe.id) {
                iframe.id = `youtube_player_${index}`;
            }
            
            console.log(`ğŸ¬ YouTube í”Œë ˆì´ì–´ ì´ˆê¸°í™”: ${iframe.id}`);
            
            try {
                const player = new YT.Player(iframe.id, {
                    events: {
                        'onReady': function(event) {
                            console.log(`âœ… YouTube í”Œë ˆì´ì–´ ì¤€ë¹„ ì™„ë£Œ: ${iframe.id}`);
                            
                            const videoData = {
                                video_name: event.target.getVideoData().title || `ìœ íŠœë¸Œ ë™ì˜ìƒ_${index + 1}`,
                                label_name: 'Youtube ë™ì˜ìƒ í”Œë ˆì´ì–´',
                                video_url: `https://www.youtube.com/watch?v=${event.target.getVideoData().video_id}`,
                                video_id: iframe.id,
                                platform: 'youtube'
                            };
                            
                            videoSessions.set(iframe.id, {
                                ...videoData,
                                player: event.target,
                                start_time: null,
                                pause_count: 0,
                                seek_count: 0,
                                completion_rate: 0,
                                total_watch_time: 0,
                                last_position: 0
                            });
                            
                            // í”Œë ˆì´ì–´ ì¤€ë¹„ ì™„ë£Œ ì´ë²¤íŠ¸
                            te.track('video_ready', {
                                ...videoData,
                                video_duration: Math.round(event.target.getDuration() || 0)
                            });
                        },
                        'onStateChange': function(event) {
                            const session = videoSessions.get(iframe.id);
                            if (!session) {
                                console.warn(`âš ï¸ ì„¸ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${iframe.id}`);
                                return;
                            }
                            
                            const currentTime = Math.round(session.player.getCurrentTime());
                            const duration = Math.round(session.player.getDuration());
                            const completionRate = duration > 0 ? Math.round((currentTime / duration) * 100) : 0;
                            
                            console.log(`ğŸ¬ YouTube ìƒíƒœ ë³€ê²½: ${getYouTubeStateText(event.data)} - ${currentTime}/${duration}ì´ˆ (${completionRate}%)`);
                            
                            switch (event.data) {
                                case YT.PlayerState.PLAYING:
                                    updateSessionActivity();
                                    session.start_time = Date.now();
                                    session.last_position = currentTime;
                                    
                                    te.track('video_play', {
                                        video_name: session.video_name,
                                        video_url: session.video_url,
                                        video_id: session.video_id,
                                        video_position: currentTime,
                                        video_duration: duration,
                                        completion_rate: completionRate,
                                        is_replay: currentTime > 5,
                                        platform: 'youtube'
                                    });
                                    break;
                                    
                                case YT.PlayerState.PAUSED:
                                    updateSessionActivity();
                                    
                                    // ì‹œì²­ ì‹œê°„ ê³„ì‚°
                                    if (session.start_time) {
                                        const watchTime = Math.round((Date.now() - session.start_time) / 1000);
                                        session.total_watch_time += watchTime;
                                    }
                                    
                                    session.pause_count++;
                                    session.completion_rate = Math.max(session.completion_rate, completionRate);
                                    
                                    te.track('video_pause', {
                                        video_name: session.video_name,
                                        video_url: session.video_url,
                                        video_id: session.video_id,
                                        video_position: currentTime,
                                        video_duration: duration,
                                        completion_rate: session.completion_rate,
                                        pause_count: session.pause_count,
                                        total_watch_time: session.total_watch_time,
                                        platform: 'youtube'
                                    });
                                    
                                    // ì§„í–‰ë¥  ë§ˆì¼ìŠ¤í†¤ ì²´í¬
                                    checkVideoProgress(session, completionRate);
                                    break;
                                    
                                case YT.PlayerState.ENDED:
                                    // ì‹œì²­ ì‹œê°„ ê³„ì‚°
                                    if (session.start_time) {
                                        const watchTime = Math.round((Date.now() - session.start_time) / 1000);
                                        session.total_watch_time += watchTime;
                                    }
                                    
                                    te.track('video_ended', {
                                        video_name: session.video_name,
                                        video_url: session.video_url,
                                        video_id: session.video_id,
                                        video_position: currentTime,
                                        video_duration: duration,
                                        completion_rate: 100,
                                        total_watch_time: session.total_watch_time,
                                        pause_count: session.pause_count,
                                        seek_count: session.seek_count,
                                        ended_naturally: true,
                                        platform: 'youtube'
                                    });
                                    
                                    // ì™„ë£Œ ì´ë²¤íŠ¸
                                    te.track('video_complete', {
                                        video_name: session.video_name,
                                        video_url: session.video_url,
                                        video_id: session.video_id,
                                        video_duration: duration,
                                        total_watch_time: session.total_watch_time,
                                        pause_count: session.pause_count,
                                        seek_count: session.seek_count,
                                        completion_rate: 100,
                                        platform: 'youtube'
                                    });
                                    break;
                                    
                                case YT.PlayerState.BUFFERING:
                                    te.track('video_buffering', {
                                        video_name: session.video_name,
                                        video_url: session.video_url,
                                        video_id: session.video_id,
                                        video_position: currentTime,
                                        video_duration: duration,
                                        platform: 'youtube'
                                    });
                                    break;
                                    
                                case YT.PlayerState.CUED:
                                    te.track('video_cued', {
                                        video_name: session.video_name,
                                        video_url: session.video_url,
                                        video_id: session.video_id,
                                        platform: 'youtube'
                                    });
                                    break;
                            }
                        },
                        'onError': function(event) {
                            console.error('âŒ YouTube í”Œë ˆì´ì–´ ì˜¤ë¥˜:', event.data);
                            te.track('video_error', {
                                video_id: iframe.id,
                                error_code: event.data,
                                platform: 'youtube'
                            });
                        }
                    }
                });
            } catch (error) {
                console.error('âŒ YouTube í”Œë ˆì´ì–´ ìƒì„± ì‹¤íŒ¨:', error);
            }
        });
    }
    
    // YouTube ìƒíƒœ í…ìŠ¤íŠ¸ ë³€í™˜
    function getYouTubeStateText(state) {
        const states = {
            [-1]: 'UNSTARTED',
            [0]: 'ENDED',
            [1]: 'PLAYING',
            [2]: 'PAUSED',
            [3]: 'BUFFERING',
            [5]: 'CUED'
        };
        return states[state] || `UNKNOWN(${state})`;
    }
    
    // ë¹„ë””ì˜¤ ì§„í–‰ë¥  ë§ˆì¼ìŠ¤í†¤ ì²´í¬ í•¨ìˆ˜
    function checkVideoProgress(session, currentRate) {
        const milestones = [25, 50, 75, 90];
        
        milestones.forEach(milestone => {
            if (currentRate >= milestone && session.completion_rate < milestone) {
                te.track('video_progress', {
                    video_name: session.video_name,
                    video_url: session.video_url,
                    video_id: session.video_id,
                    completion_rate: milestone,
                    milestone_reached: `${milestone}%`,
                    total_watch_time: session.total_watch_time,
                    platform: 'youtube'
                });
            }
        });
    }

    /* ================================
       ğŸ“ âœ… ë¦¬ì†ŒìŠ¤ ë‹¤ìš´ë¡œë“œ ì¶”ì 
    ================================= */

    function trackResourceDownloads() {
        document.addEventListener('click', function(event) {
            const target = event.target;
            const link = target.closest('a');
            
            if (link && link.href) {
                const url = link.href.toLowerCase();
                const downloadExtensions = ['.pdf', '.doc', '.docx', '.xls', '.xlsx', '.ppt', '.pptx', '.zip', '.rar'];
                
                if (downloadExtensions.some(ext => url.includes(ext))) {
                    updateSessionActivity();
                    
                    te.track('resource_download', {
                        page_name: document.title,
                        page_url: window.location.href,
                        download_url: link.href,
                        download_filename: link.href.split('/').pop(),
                        download_success: true // í´ë¦­ ì‹œì ì—ì„œëŠ” trueë¡œ ì„¤ì •
                    });
                }
            }
        });
    }
    
    /* ================================
       ğŸ“ âœ… í™œë™ ëª¨ë‹ˆí„°ë§ ë° ì´ë²¤íŠ¸ ì´ˆê¸°í™”
    ================================= */
  
    // ì£¼ê¸°ì ìœ¼ë¡œ ì„¸ì…˜ ë§Œë£Œ ì²´í¬
    setInterval(checkSessionExpiry, 60000); // 1ë¶„ë§ˆë‹¤ ì²´í¬
    
    // í˜ì´ì§€ ì¢…ë£Œ ì¶”ì  ì´ˆê¸°í™”
    initializePageExitTracking();
    
    // ğŸšª í˜ì´ì§€ ì¢…ë£Œ ì¶”ì  ì´ˆê¸°í™”
    function initializePageExitTracking() {
        let pageStartTime = Date.now();
        let isPageVisible = !document.hidden;
        let totalVisibleTime = 0;
        let lastVisibilityChange = Date.now();
        
        // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì¶”ì 
        function handleVisibilityChange() {
            const now = Date.now();
            
            if (document.hidden) {
                // í˜ì´ì§€ê°€ ìˆ¨ê²¨ì§ (íƒ­ ë³€ê²½, ìµœì†Œí™”, ë‹¤ë¥¸ ì•±ìœ¼ë¡œ ì „í™˜)
                if (isPageVisible) {
                    totalVisibleTime += now - lastVisibilityChange;
                    isPageVisible = false;
                    
                    te.track('te_page_visibility_change', {
                        visibility_state: 'hidden',
                        total_visible_time: Math.round(totalVisibleTime / 1000), // ì´ˆ ë‹¨ìœ„
                        session_duration: Math.round((now - pageStartTime) / 1000),
                        exit_reason: 'visibility_hidden'
                    });
                }
            } else {
                // í˜ì´ì§€ê°€ ë‹¤ì‹œ ë³´ì„
                isPageVisible = true;
                lastVisibilityChange = now;
                
                te.track('te_page_visibility_change', {
                    visibility_state: 'visible',
                    total_visible_time: Math.round(totalVisibleTime / 1000),
                    session_duration: Math.round((now - pageStartTime) / 1000),
                    exit_reason: 'page_returned'
                });
            }
            
            // ê¸°ì¡´ ì„¸ì…˜ í™œë™ ì—…ë°ì´íŠ¸
            if (!document.hidden) {
                updateSessionActivity();
            }
        }
        
        // Page Visibility API ì‚¬ìš©
        document.addEventListener('visibilitychange', handleVisibilityChange);
        
        // beforeunload: í˜ì´ì§€ ë– ë‚˜ê¸° ì „ (ìƒˆë¡œê³ ì¹¨, ë‹«ê¸°, ë‹¤ë¥¸ í˜ì´ì§€ ì´ë™)
        window.addEventListener('beforeunload', function() {
            const now = Date.now();
            if (isPageVisible) {
                totalVisibleTime += now - lastVisibilityChange;
            }
            
            // ì„¸ì…˜ ì •ë³´ ì €ì¥ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            localStorage.setItem('te_last_activity_time', Date.now().toString());
            localStorage.setItem('te_is_engaged_session', isEngagedSession.toString());
            
            // ë™ê¸°ì ìœ¼ë¡œ ì¦‰ì‹œ ì „ì†¡ (navigator.sendBeacon ì‚¬ìš©)
            const exitData = {
                exit_type: 'beforeunload',
                total_visible_time: Math.round(totalVisibleTime / 1000),
                session_duration: Math.round((now - pageStartTime) / 1000),
                page_url: window.location.href,
                exit_reason: 'page_unload',
                user_agent: navigator.userAgent
            };
            
            // ë™ê¸° ì „ì†¡ ì‹œë„
            try {
                const payload = JSON.stringify({
                    data: [{
                        "#type": "track",
                        "#time": new Date().toISOString().replace('T', ' ').slice(0, 23),
                        "#distinct_id": te.getDistinctId(),
                        "#event_name": "te_page_exit",
                        "properties": Object.assign(exitData, {
                            session_id: sessionId,
                            session_number: sessionNumber
                        })
                    }],
                    "#app_id": "test",
                    "#flush_time": Date.now()
                });
                
                // Beacon API ì‚¬ìš© (ê°€ì¥ ì•ˆì •ì )
                if (navigator.sendBeacon) {
                    navigator.sendBeacon(
                        'https://te-receiver-naver.thinkingdata.kr/sync_js',
                        payload
                    );
                }
            } catch (e) {
                console.warn('í˜ì´ì§€ ì¢…ë£Œ ì´ë²¤íŠ¸ ì „ì†¡ ì‹¤íŒ¨:', e);
            }
        });
        
        // unload: í˜ì´ì§€ ì™„ì „ ì–¸ë¡œë“œ (ì‹¤ì œ ë¸Œë¼ìš°ì €/íƒ­ ì¢…ë£Œ)
        window.addEventListener('unload', function() {
            const now = Date.now();
            if (isPageVisible) {
                totalVisibleTime += now - lastVisibilityChange;
            }
            
            // ìµœì¢… ì¢…ë£Œ ì´ë²¤íŠ¸ (ë§¤ìš° ì œí•œì ì¸ ì‹œê°„)
            try {
                if (navigator.sendBeacon) {
                    const payload = JSON.stringify({
                        data: [{
                            "#type": "track",
                            "#time": new Date().toISOString().replace('T', ' ').slice(0, 23),
                            "#distinct_id": te.getDistinctId(),
                            "#event_name": "te_browser_exit",
                            "properties": {
                                exit_type: 'unload',
                                total_visible_time: Math.round(totalVisibleTime / 1000),
                                session_duration: Math.round((now - pageStartTime) / 1000),
                                final_url: window.location.href,
                                session_id: sessionId,
                                session_number: sessionNumber
                            }
                        }],
                        "#app_id": "test",
                        "#flush_time": Date.now()
                    });
                    
                    navigator.sendBeacon(
                        'https://te-receiver-naver.thinkingdata.kr/sync_js',
                        payload
                    );
                }
            } catch (e) {
                // unloadì—ì„œëŠ” ë¡œê·¸ë„ ì¶œë ¥ ì•ˆë¨
            }
        });
        
        // pagehide: ëª¨ë°”ì¼ì—ì„œ ë” ì•ˆì •ì  (ë¸Œë¼ìš°ì € ìºì‹œ ë“±)
        window.addEventListener('pagehide', function(event) {
            const now = Date.now();
            if (isPageVisible) {
                totalVisibleTime += now - lastVisibilityChange;
            }
            
            const exitData = {
                exit_type: 'pagehide',
                is_persisted: event.persisted, // ë¸Œë¼ìš°ì € ìºì‹œì— ì €ì¥ë˜ëŠ”ì§€
                total_visible_time: Math.round(totalVisibleTime / 1000),
                session_duration: Math.round((now - pageStartTime) / 1000),
                page_url: window.location.href,
                session_id: sessionId,
                session_number: sessionNumber
            };
            
            // ìºì‹œë˜ì§€ ì•ŠëŠ” ê²½ìš°ë§Œ ì¢…ë£Œë¡œ ê°„ì£¼
            if (!event.persisted) {
                try {
                    if (navigator.sendBeacon) {
                        const payload = JSON.stringify({
                            data: [{
                                "#type": "track",
                                "#time": new Date().toISOString().replace('T', ' ').slice(0, 23),
                                "#distinct_id": te.getDistinctId(),
                                "#event_name": "te_page_final_exit",
                                "properties": exitData
                            }],
                            "#app_id": "test",
                            "#flush_time": Date.now()
                        });
                        
                        navigator.sendBeacon(
                            'https://te-receiver-naver.thinkingdata.kr/sync_js',
                            payload
                        );
                    }
                } catch (e) {
                    console.warn('ìµœì¢… í˜ì´ì§€ ì¢…ë£Œ ì´ë²¤íŠ¸ ì „ì†¡ ì‹¤íŒ¨:', e);
                }
            }
        });
        
        console.log('âœ… í˜ì´ì§€ ì¢…ë£Œ ì¶”ì  ì´ˆê¸°í™” ì™„ë£Œ');
    }
    
    // DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ë²¤íŠ¸ ì¶”ì  ì‹œì‘
    document.addEventListener('DOMContentLoaded', function() {
        trackPopupEvents();
        trackClickEvents();
        trackScrollDepth();
        trackFormSubmissions();
        trackVideoEvents();
        trackResourceDownloads();
        
        console.log('âœ… All tracking events initialized');
    });
    
    // í˜ì´ì§€ ë¡œë“œ ì¦‰ì‹œ ì‹¤í–‰ë˜ëŠ” ì¶”ì ë“¤
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            console.log('âœ… DOM loaded, tracking active');
        });
    } else {
        // DOMì´ ì´ë¯¸ ë¡œë“œëœ ê²½ìš°
        trackPopupEvents();
        trackClickEvents();
        trackScrollDepth();
        trackFormSubmissions();
        trackVideoEvents();
        trackResourceDownloads();
        
        console.log('âœ… All tracking events initialized (DOM already loaded)');
    }

    /* ================================
       ğŸ“ âœ… ìœ ì € ì†ì„± ì¶”ì  ì‹œìŠ¤í…œ (ìµëª… ì›¹ì‚¬ì´íŠ¸ìš©)
    ================================= */

    // ìœ ì € ì†ì„± ê´€ë¦¬ í´ë˜ìŠ¤
    class UserAttributeTracker {
        constructor() {
            this.storageKey = 'te_user_attributes';
            this.attributes = this.loadAttributes();
            this.sessionStartTime = Date.now();
            this.pageStartTime = Date.now();
            this.currentPageCategory = null;
            this.contentEngagementTimer = null;
            
                    // ThinkingData ì‹¤ì œ ë¸”ë¡œê·¸ ì¹´í…Œê³ ë¦¬ ë§¤í•‘ (ì›¹ì‚¬ì´íŠ¸ ê¸°ì¤€)
        this.contentCategories = {
            'analytics': 'ë¶„ì„',
            'feature': 'ê¸°ëŠ¥',
            'industry': 'ì‚°ì—…ì‹œë¦¬ì¦ˆ', 
            'playbook': 'í”Œë ˆì´ë¶'
        };
        
        // ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ì„¹ì…˜ë§Œ ë§¤í•‘
        this.sectionMapping = {
            '/blog': 'blog',
            '/user-case': 'user_case',
            '/company': 'company',
            '/culture': 'culture', 
            '/news': 'news'
        };
            
            this.initializeUser();
        }
        
        // ì†ì„± ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¡œë“œ
        loadAttributes() {
            try {
                const stored = localStorage.getItem(this.storageKey);
                return stored ? JSON.parse(stored) : {};
            } catch (e) {
                return {};
            }
        }
        
        // ì†ì„± ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
        saveAttributes() {
            try {
                localStorage.setItem(this.storageKey, JSON.stringify(this.attributes));
            } catch (e) {
                console.warn('Failed to save user attributes to localStorage');
            }
        }
        
        // ì‚¬ìš©ì ì´ˆê¸°í™”
        initializeUser() {
            const now = Date.now();
            const today = new Date().toISOString().split('T')[0];
            
            // 1. ìµœì´ˆ ë°©ë¬¸ ì‹œì  ê¸°ë¡ (í•œ ë²ˆë§Œ)
            if (!this.attributes.first_visit_timestamp) {
                te.userSetOnce({ first_visit_timestamp: now });
                this.attributes.first_visit_timestamp = now;
            }
            
            // 2. ì„¸ì…˜ ìˆ˜ ì¦ê°€
            te.userAdd({ total_sessions: 1 });
            this.attributes.total_sessions = (this.attributes.total_sessions || 0) + 1;
            
            // 3. ì˜¤ëŠ˜ ì„¸ì…˜ ìˆ˜ (ë‚ ì§œê°€ ë°”ë€Œë©´ ë¦¬ì…‹)
            const lastVisitDate = this.attributes.last_visit_date;
            if (lastVisitDate !== today) {
                te.userSet({ session_count_today: 1 });
                this.attributes.session_count_today = 1;
                this.attributes.last_visit_date = today;
            } else {
                te.userAdd({ session_count_today: 1 });
                this.attributes.session_count_today = (this.attributes.session_count_today || 0) + 1;
            }
            
            // 4. ì¬ë°©ë¬¸ì ì²´í¬ (2ë²ˆì§¸ ì„¸ì…˜ë¶€í„°)
            if (this.attributes.total_sessions >= 2) {
                te.userSet({ is_returning_visitor: true });
                this.attributes.is_returning_visitor = true;
            }
            
            // 5. ìµœì´ˆ ìœ ì… ì •ë³´ ê¸°ë¡ (í•œ ë²ˆë§Œ)
            this.recordFirstVisitSource();
            
            // 6. ê¸°ë³¸ ì‹œê°„ ì •ë³´ ì—…ë°ì´íŠ¸
            this.updateTimeAttributes();
            
            this.saveAttributes();
            console.log('âœ… User attributes initialized:', this.attributes);
        }
        
        // ìµœì´ˆ ìœ ì… ì†ŒìŠ¤ ê¸°ë¡
        recordFirstVisitSource() {
            const urlParams = new URLSearchParams(window.location.search);
            const utmSource = urlParams.get('utm_source') || this.inferTrafficSource();
            const utmCampaign = urlParams.get('utm_campaign');
            const referrerDomain = document.referrer ? new URL(document.referrer).hostname : 'direct';
            
            // ìµœì´ˆ ë°©ë¬¸ ì‹œì—ë§Œ ê¸°ë¡
            te.userSetOnce({
                first_utm_source: utmSource,
                first_utm_campaign: utmCampaign,
                first_referrer_domain: referrerDomain
            });
            
            // ì‚¬ìš©í•œ ìœ ì… ì†ŒìŠ¤ ëˆ„ì  (ì¤‘ë³µ ì œê±°)
            te.userUniqAppend({
                traffic_sources_used: [utmSource]
            });
            
            // ë¡œì»¬ì—ë„ ì €ì¥
            if (!this.attributes.first_utm_source) {
                this.attributes.first_utm_source = utmSource;
                this.attributes.first_utm_campaign = utmCampaign;
                this.attributes.first_referrer_domain = referrerDomain;
            }
            
            this.attributes.traffic_sources_used = this.attributes.traffic_sources_used || [];
            if (!this.attributes.traffic_sources_used.includes(utmSource)) {
                this.attributes.traffic_sources_used.push(utmSource);
            }
        }
        
        // íŠ¸ë˜í”½ ì†ŒìŠ¤ ì¶”ë¡ 
        inferTrafficSource() {
            const referrer = document.referrer;
            if (!referrer) return 'direct';
            
            const referrerHost = new URL(referrer).hostname.toLowerCase();
            
            if (referrerHost.includes('google')) return 'google';
            if (referrerHost.includes('naver')) return 'naver';
            if (referrerHost.includes('facebook')) return 'facebook';
            if (referrerHost.includes('instagram')) return 'instagram';
            if (referrerHost.includes('linkedin')) return 'linkedin';
            if (referrerHost.includes('twitter') || referrerHost.includes('t.co')) return 'twitter';
            if (referrerHost.includes('youtube')) return 'youtube';
            
            return 'referral';
        }
        
        // í˜ì´ì§€ ê´€ì‹¬ì‚¬ ì—…ë°ì´íŠ¸
        updatePageInterests() {
            const currentPath = window.location.pathname;
            const pageCategory = this.categorizePageContent(currentPath);
            const sectionName = this.getMostVisitedSection(currentPath);
            
            console.log('ğŸ“Š Page interests update:', { currentPath, pageCategory, sectionName });
            
            // ê´€ì‹¬ ì£¼ì œ ì¶”ê°€ (ThinkingData ë¸”ë¡œê·¸ ì¹´í…Œê³ ë¦¬ ê¸°ë°˜)
            if (pageCategory) {
                te.userUniqAppend({ 
                    interested_topics: [pageCategory] 
                });
                
                this.attributes.interested_topics = this.attributes.interested_topics || [];
                if (!this.attributes.interested_topics.includes(pageCategory)) {
                    this.attributes.interested_topics.push(pageCategory);
                }
            }
            
            // ìµœê·¼ ë°©ë¬¸ í˜ì´ì§€ ì¶”ê°€ (ìµœëŒ€ 20ê°œ ìœ ì§€)
            this.attributes.viewed_pages = this.attributes.viewed_pages || [];
            this.attributes.viewed_pages.unshift(currentPath);
            if (this.attributes.viewed_pages.length > 20) {
                this.attributes.viewed_pages = this.attributes.viewed_pages.slice(0, 20);
            }
            
            te.userSet({ 
                viewed_pages: this.attributes.viewed_pages.slice(0, 10) // ThinkingDataì—ëŠ” ìµœê·¼ 10ê°œë§Œ ì „ì†¡
            });
            
            // ê°€ì¥ ë§ì´ ë°©ë¬¸í•œ ì„¹ì…˜ ì—…ë°ì´íŠ¸
            if (sectionName) {
                this.updateMostVisitedSection(sectionName);
            }
            
            this.saveAttributes();
        }
        
            // í˜ì´ì§€ ì½˜í…ì¸  ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜ (ì‹¤ì œ ThinkingData ì›¹ì‚¬ì´íŠ¸ ê¸°ì¤€)
    categorizePageContent(path) {
        // ë¸”ë¡œê·¸ëŠ” ì‹¤ì œ ì¹´í…Œê³ ë¦¬ê°€ 4ê°œë§Œ ì¡´ì¬: ë¶„ì„, ê¸°ëŠ¥, ì‚°ì—…ì‹œë¦¬ì¦ˆ, í”Œë ˆì´ë¶
        if (path.includes('/blog/')) {
            // ì‹¤ì œ ë¸”ë¡œê·¸ ì¹´í…Œê³ ë¦¬ì— ë§ì¶° ë‹¨ìˆœí™”
            if (path.includes('feature') || path.includes('ê¸°ëŠ¥')) return 'feature';
            if (path.includes('industry') || path.includes('ì‚°ì—…ì‹œë¦¬ì¦ˆ')) return 'industry';
            if (path.includes('playbook') || path.includes('í”Œë ˆì´ë¶')) return 'playbook';
            
            // ë¶„ì„ì´ ê°€ì¥ ë§ìœ¼ë¯€ë¡œ ê¸°ë³¸ê°’
            return 'analytics';
        }
        
        // ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ì„¹ì…˜ë“¤ë§Œ
        if (path.includes('/user-case')) return 'user_case';
        if (path.includes('/company')) return 'company';
        if (path.includes('/culture')) return 'culture';
        if (path.includes('/news')) return 'news';
        
        return null;
    }
        
        // ì„¹ì…˜ ë¶„ë¥˜
        getMostVisitedSection(path) {
            for (const [section, name] of Object.entries(this.sectionMapping)) {
                if (path.startsWith(section)) {
                    return name;
                }
            }
            return 'other';
        }
        
        // ê°€ì¥ ë§ì´ ë°©ë¬¸í•œ ì„¹ì…˜ ì—…ë°ì´íŠ¸
        updateMostVisitedSection(sectionName) {
            this.attributes.section_visits = this.attributes.section_visits || {};
            this.attributes.section_visits[sectionName] = (this.attributes.section_visits[sectionName] || 0) + 1;
            
            // ê°€ì¥ ë§ì´ ë°©ë¬¸í•œ ì„¹ì…˜ ì°¾ê¸°
            const mostVisited = Object.entries(this.attributes.section_visits)
                .sort(([,a], [,b]) => b - a)[0];
            
            if (mostVisited) {
                te.userSet({ most_visited_section: mostVisited[0] });
                this.attributes.most_visited_section = mostVisited[0];
            }
        }
        
        // í¼ ì œì¶œ ì¶”ì 
        trackFormSubmission() {
            te.userAdd({ total_form_submissions: 1 });
            this.attributes.total_form_submissions = (this.attributes.total_form_submissions || 0) + 1;
            this.updateEngagementLevel();
            this.saveAttributes();
        }
        
        // ë‹¤ìš´ë¡œë“œ ì¶”ì 
        trackDownload() {
            te.userAdd({ total_downloads: 1 });
            this.attributes.total_downloads = (this.attributes.total_downloads || 0) + 1;
            this.updateEngagementLevel();
            this.saveAttributes();
        }
        
        // ë¹„ë””ì˜¤ ìƒí˜¸ì‘ìš© ì¶”ì 
        trackVideoInteraction() {
            te.userAdd({ total_video_interactions: 1 });
            this.attributes.total_video_interactions = (this.attributes.total_video_interactions || 0) + 1;
            this.updateEngagementLevel();
            this.saveAttributes();
        }
        
        // 100% ìŠ¤í¬ë¡¤ ì¶”ì 
        trackFullScroll() {
            te.userAdd({ total_scroll_depth_100: 1 });
            this.attributes.total_scroll_depth_100 = (this.attributes.total_scroll_depth_100 || 0) + 1;
            this.updateContentPreference('deep');
            this.updateEngagementLevel();
            this.saveAttributes();
        }
        
        // íŒì—… ìƒí˜¸ì‘ìš© ì¶”ì 
        trackPopupInteraction() {
            te.userAdd({ popup_interactions: 1 });
            this.attributes.popup_interactions = (this.attributes.popup_interactions || 0) + 1;
            this.saveAttributes();
        }
        
        // ì™¸ë¶€ ë§í¬ í´ë¦­ ì¶”ì 
        trackExternalLinkClick() {
            te.userAdd({ external_link_clicks: 1 });
            this.attributes.external_link_clicks = (this.attributes.external_link_clicks || 0) + 1;
            this.saveAttributes();
        }
        
        // ì‹œê°„ ê´€ë ¨ ì†ì„± ì—…ë°ì´íŠ¸
        updateTimeAttributes() {
            const now = new Date();
            const hour = now.getHours();
            const dayOfWeek = now.toLocaleDateString('en', {weekday: 'lowercase'});
            
            // ì„ í˜¸ ë°©ë¬¸ ì‹œê°„ëŒ€
            const timeOfDay = this.getTimeOfDay(hour);
            te.userSet({ 
                preferred_visit_time: timeOfDay,
                last_visit_day_of_week: dayOfWeek 
            });
            
            this.attributes.preferred_visit_time = timeOfDay;
            this.attributes.last_visit_day_of_week = dayOfWeek;
        }
        
        // ì‹œê°„ëŒ€ ë¶„ë¥˜
        getTimeOfDay(hour) {
            if (hour >= 6 && hour < 12) return 'morning';
            if (hour >= 12 && hour < 18) return 'afternoon';
            if (hour >= 18 && hour < 22) return 'evening';
            return 'night';
        }
        
        // ì„¸ì…˜ ì¢…ë£Œ ì‹œ ì‹œê°„ ì§€í‘œ ì—…ë°ì´íŠ¸
        updateSessionTimeMetrics(sessionDuration) {
            // ì´ ì²´ë¥˜ì‹œê°„ ëˆ„ì 
            te.userAdd({ total_time_spent: sessionDuration });
            this.attributes.total_time_spent = (this.attributes.total_time_spent || 0) + sessionDuration;
            
            // ìµœì¥ ì„¸ì…˜ ê¸°ë¡ ê°±ì‹ 
            const currentLongest = this.attributes.longest_session_duration || 0;
            if (sessionDuration > currentLongest) {
                te.userSet({ longest_session_duration: sessionDuration });
                this.attributes.longest_session_duration = sessionDuration;
            }
            
            // í‰ê·  ì„¸ì…˜ ì§€ì†ì‹œê°„ ê³„ì‚°
            const totalSessions = this.attributes.total_sessions || 1;
            const averageDuration = Math.round(this.attributes.total_time_spent / totalSessions);
            te.userSet({ average_session_duration: averageDuration });
            this.attributes.average_session_duration = averageDuration;
            
            this.saveAttributes();
        }
        
        // ì°¸ì—¬ë„ ìˆ˜ì¤€ ì—…ë°ì´íŠ¸
        updateEngagementLevel() {
            let score = 0;
            
            // í–‰ë™ë³„ ì ìˆ˜ ê³„ì‚°
            score += (this.attributes.total_form_submissions || 0) * 50;
            score += (this.attributes.total_downloads || 0) * 30;
            score += (this.attributes.total_video_interactions || 0) * 20;
            score += (this.attributes.total_scroll_depth_100 || 0) * 15;
            score += (this.attributes.popup_interactions || 0) * 10;
            score += (this.attributes.external_link_clicks || 0) * 5;
            
            // ì„¸ì…˜ ìˆ˜ì™€ ì²´ë¥˜ì‹œê°„ ê³ ë ¤
            score += Math.min((this.attributes.total_sessions || 0) * 10, 100);
            score += Math.min((this.attributes.total_time_spent || 0) / 60, 200); // ë¶„ë‹¹ 1ì , ìµœëŒ€ 200ì 
            
            // ì°¸ì—¬ë„ ìˆ˜ì¤€ ë¶„ë¥˜
            let level = 'low';
            if (score >= 200) level = 'high';
            else if (score >= 50) level = 'medium';
            
            te.userSet({ 
                engagement_level: level,
                engagement_score: score 
            });
            
            this.attributes.engagement_level = level;
            this.attributes.engagement_score = score;
            
            // ìƒëª…ì£¼ê¸° ë‹¨ê³„ ì—…ë°ì´íŠ¸
            this.updateLifecycleStage();
        }
        
        // ì½˜í…ì¸  ì„ í˜¸ë„ ì—…ë°ì´íŠ¸
        updateContentPreference(depth) {
            this.attributes.content_engagement = this.attributes.content_engagement || {};
            
            // ê¹Šì´ë³„ ì„ í˜¸ë„ ëˆ„ì 
            this.attributes.content_engagement[depth] = (this.attributes.content_engagement[depth] || 0) + 1;
            
            // ê°€ì¥ ì„ í˜¸í•˜ëŠ” ê¹Šì´ ì°¾ê¸°
            const preferences = Object.entries(this.attributes.content_engagement)
                .sort(([,a], [,b]) => b - a);
            
            if (preferences.length > 0) {
                te.userSet({ content_depth_preference: preferences[0][0] });
                this.attributes.content_depth_preference = preferences[0][0];
            }
        }
        
            // ë°©ë¬¸ì ìƒëª…ì£¼ê¸° ë‹¨ê³„ ì—…ë°ì´íŠ¸ (ì‹¤ì œ ì›¹ì‚¬ì´íŠ¸ êµ¬ì¡° ê¸°ì¤€)
    updateLifecycleStage() {
        const sessions = this.attributes.total_sessions || 0;
        const formSubmissions = this.attributes.total_form_submissions || 0;
        const downloads = this.attributes.total_downloads || 0;
        const companyViews = (this.attributes.section_visits && this.attributes.section_visits.company) || 0;
        const userCaseViews = (this.attributes.section_visits && this.attributes.section_visits.user_case) || 0;
        
        let stage = 'awareness';
        
        // Decision: í¼ ì œì¶œì´ë‚˜ íšŒì‚¬ ì†Œê°œ/ê³ ê°ì‚¬ë¡€ í˜ì´ì§€ ì—¬ëŸ¬ ë²ˆ ë°©ë¬¸ (êµ¬ë§¤ ê²€í†  ë‹¨ê³„)
        if (formSubmissions > 0 || companyViews >= 2 || userCaseViews >= 2) {
            stage = 'decision';
        }
        // Consideration: ì„¸ì…˜ 3íšŒ ì´ìƒ ë˜ëŠ” ë‹¤ìš´ë¡œë“œ ê²½í—˜ ë˜ëŠ” íšŒì‚¬/ê³ ê°ì‚¬ë¡€ ë°©ë¬¸
        else if (sessions >= 3 || downloads > 0 || companyViews > 0 || userCaseViews > 0) {
            stage = 'consideration';
        }
        
        te.userSet({ visitor_lifecycle_stage: stage });
        this.attributes.visitor_lifecycle_stage = stage;
    }
        
        // ìƒí˜¸ì‘ìš© ë¹ˆë„ ê³„ì‚°
        updateInteractionFrequency() {
            const totalInteractions = (this.attributes.total_form_submissions || 0) +
                                    (this.attributes.total_downloads || 0) +
                                    (this.attributes.total_video_interactions || 0) +
                                    (this.attributes.popup_interactions || 0) +
                                    (this.attributes.external_link_clicks || 0);
            
            const sessions = this.attributes.total_sessions || 1;
            const interactionRate = totalInteractions / sessions;
            
            let frequency = 'low';
            if (interactionRate >= 3) frequency = 'high';
            else if (interactionRate >= 1) frequency = 'medium';
            
            te.userSet({ interaction_frequency: frequency });
            this.attributes.interaction_frequency = frequency;
        }
        
        // í˜ì´ì§€ ì²´ë¥˜ ì‹œê°„ ì¶”ì  ì‹œì‘
        startPageEngagement() {
            this.pageStartTime = Date.now();
            
            // 10ì´ˆ í›„ ì½˜í…ì¸  ì„ í˜¸ë„ 'medium' ê¸°ë¡
            this.contentEngagementTimer = setTimeout(() => {
                this.updateContentPreference('medium');
            }, 10000);
        }
        
        // í˜ì´ì§€ ì²´ë¥˜ ì¢…ë£Œ
        endPageEngagement() {
            const engagementTime = Date.now() - this.pageStartTime;
            
            // íƒ€ì´ë¨¸ ì •ë¦¬
            if (this.contentEngagementTimer) {
                clearTimeout(this.contentEngagementTimer);
            }
            
            // 30ì´ˆ ì´ìƒ ì²´ë¥˜ì‹œ 'surface' ì„ í˜¸ë„ ê¸°ë¡
            if (engagementTime >= 30000) {
                this.updateContentPreference('surface');
            }
            
            return Math.round(engagementTime / 1000);
        }
    }

    // ìœ ì € ì†ì„± ì¶”ì ê¸° ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
    const userTracker = new UserAttributeTracker();

    // ê¸°ì¡´ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ì— ìœ ì € ì†ì„± ì¶”ì  ì¶”ê°€
    document.addEventListener('DOMContentLoaded', function() {
        // í˜ì´ì§€ ê´€ì‹¬ì‚¬ ì—…ë°ì´íŠ¸
        userTracker.updatePageInterests();
        userTracker.startPageEngagement();
    });

    // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì„¸ì…˜ ì‹œê°„ ì—…ë°ì´íŠ¸
    window.addEventListener('beforeunload', function() {
        const sessionDuration = Math.round((Date.now() - userTracker.sessionStartTime) / 1000);
        userTracker.updateSessionTimeMetrics(sessionDuration);
        
        const pageEngagement = userTracker.endPageEngagement();
        console.log('ğŸ“Š Page engagement time:', pageEngagement, 'seconds');
    });

    // ê¸°ì¡´ ì´ë²¤íŠ¸ í•¨ìˆ˜ë“¤ì— ìœ ì € ì†ì„± ì¶”ì  ì—°ë™
    const originalTrackFormSubmission = window.trackFormSubmission || function() {};
    window.trackFormSubmission = function() {
        originalTrackFormSubmission();
        userTracker.trackFormSubmission();
    };

    const originalTrackDownload = window.trackDownload || function() {};
    window.trackDownload = function() {
        originalTrackDownload();
        userTracker.trackDownload();
    };

    const originalTrackFullScroll = window.trackFullScroll || function() {};
    window.trackFullScroll = function() {
        originalTrackFullScroll();
        userTracker.trackFullScroll();
    };

    // ë¹„ë””ì˜¤ ì´ë²¤íŠ¸ì— ìœ ì € ì†ì„± ì¶”ì  ì—°ë™
    const originalVideoEventHandlers = {
        onPlay: function() { userTracker.trackVideoInteraction(); },
        onComplete: function() { userTracker.trackVideoInteraction(); }
    };

    // ìŠ¤í¬ë¡¤ ê¹Šì´ 100% ë„ë‹¬ ì‹œ ìœ ì € ì†ì„± ì—…ë°ì´íŠ¸
    let originalScrollHandler = null;
    if (typeof handleScroll === 'function') {
        originalScrollHandler = handleScroll;
        window.handleScroll = function() {
            originalScrollHandler();
            
            // 100% ìŠ¤í¬ë¡¤ ì²´í¬
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const windowHeight = window.innerHeight;
            const documentHeight = Math.max(
                document.body.scrollHeight,
                document.documentElement.scrollHeight
            );
            
            const scrollPercentage = Math.round(((scrollTop + windowHeight) / documentHeight) * 100);
            
            if (scrollPercentage >= 100 && !window.fullScrollTracked) {
                userTracker.trackFullScroll();
                window.fullScrollTracked = true;
            }
        };
    }

    // íŒì—… ìƒí˜¸ì‘ìš© ì¶”ì 
    document.addEventListener('click', function(event) {
        const target = event.target;
        
        // ì™¸ë¶€ ë§í¬ í´ë¦­ ê°ì§€
        if (target.closest('a')) {
            const link = target.closest('a');
            if (link.href && isExternalLink(link.href)) {
                userTracker.trackExternalLinkClick();
            }
        }
        
        // íŒì—… ê´€ë ¨ í´ë¦­ ê°ì§€
        if (target.classList.contains('close') || 
            target.classList.contains('modal-close') ||
            target.textContent.includes('í˜œíƒ í™•ì¸í•˜ê¸°')) {
            userTracker.trackPopupInteraction();
        }
    });

    // í˜ì´ì§€ ë³€ê²½ ê°ì§€ (SPA ëŒ€ì‘)
    let currentPath = window.location.pathname;
    setInterval(function() {
        if (window.location.pathname !== currentPath) {
            currentPath = window.location.pathname;
            userTracker.updatePageInterests();
            userTracker.startPageEngagement();
        }
    }, 1000);

         console.log('âœ… User Attribute Tracking System initialized');

</script>
<!-- End Thinking Data -->