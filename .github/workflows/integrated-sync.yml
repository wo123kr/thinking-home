name: Google Search Console â†’ ThinkingData í†µí•© ë™ê¸°í™”

on:
  schedule:
    # ë§¤ì¼ ìƒˆë²½ 3ì‹œ (KST, UTC+9 â†’ UTC 18ì‹œ)
    - cron: '0 18 * * *'
  workflow_dispatch:
    # ê³ ê¸‰ ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜
    inputs:
      sync_type:
        description: 'ë™ê¸°í™” íƒ€ì… ì„ íƒ'
        required: true
        default: 'yesterday'
        type: choice
        options:
          - yesterday
          - last-week
          - last-month
      force_run:
        description: 'ê°•ì œ ì‹¤í–‰ (ì—ëŸ¬ ë¬´ì‹œ)'
        required: false
        default: false
        type: boolean

jobs:
  sync-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ”§ Install dependencies
      run: npm ci
      
    - name: ğŸ” Setup Google Service Account
      run: |
        mkdir -p credentials
        echo '${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}' > credentials/service-account-key.json
        echo "GOOGLE_APPLICATION_CREDENTIALS=$PWD/credentials/service-account-key.json" >> $GITHUB_ENV
        echo "âœ… Google Service Account ì„¤ì • ì™„ë£Œ"
        
    - name: ğŸ”‘ Setup ThinkingData credentials
      run: |
        echo "TE_APP_ID=${{ secrets.TE_APP_ID }}" >> $GITHUB_ENV
        echo "TE_SERVER_URL=${{ secrets.TE_SERVER_URL }}" >> $GITHUB_ENV
        echo "SLACK_CHANNEL_ID=${{ secrets.SLACK_CHANNEL_ID }}" >> $GITHUB_ENV
        echo "âœ… ThinkingData ì¸ì¦ ì •ë³´ ì„¤ì • ì™„ë£Œ"
        echo "ğŸ” Slack Channel ID í™•ì¸: ${{ secrets.SLACK_CHANNEL_ID }}"
        
    - name: ğŸ“Š Run data sync
      id: sync
      run: |
        SYNC_TYPE="${{ github.event.inputs.sync_type || 'yesterday' }}"
        FORCE_RUN="${{ github.event.inputs.force_run || 'false' }}"
        
        echo "ğŸ”„ ë™ê¸°í™” íƒ€ì…: $SYNC_TYPE"
        echo "ğŸ”§ ê°•ì œ ì‹¤í–‰: $FORCE_RUN"
        echo "ğŸ“… ì‹¤í–‰ ì‹œê°„: $(date)"
        echo "ğŸŒ ì‹œê°„ëŒ€: $(date +%Z)"
        echo "ğŸ¢ Repository: ${{ github.repository }}"
        
        # ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ ê²°ì •
        if [ -f "tracking/search-performance.js" ]; then
          SCRIPT="tracking/search-performance.js"
        elif [ -f "google-search-console.js" ]; then
          SCRIPT="google-search-console.js"
        else
          echo "âŒ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          exit 1
        fi
        
        echo "ğŸ“œ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸: $SCRIPT"
        
        # ë™ê¸°í™” ì‹¤í–‰
        case $SYNC_TYPE in
          "yesterday")
            echo "ğŸ“… ì–´ì œ ë°ì´í„° ì „ì†¡ ì‹œì‘"
            node $SCRIPT yesterday
            ;;
          "last-week")
            echo "ğŸ“Š ì§€ë‚œ ì£¼ ë°ì´í„° ì „ì†¡ ì‹œì‘"
            node $SCRIPT last-week
            ;;
          "last-month")
            echo "ğŸ“ˆ ì§€ë‚œ ë‹¬ ë°ì´í„° ì „ì†¡ ì‹œì‘"
            node $SCRIPT last-month
            ;;
          *)
            echo "âŒ ì•Œ ìˆ˜ ì—†ëŠ” ë™ê¸°í™” íƒ€ì…: $SYNC_TYPE"
            exit 1
            ;;
        esac
        
        echo "âœ… ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ"
        echo "sync_status=success" >> $GITHUB_OUTPUT
        
    - name: ğŸ“ Upload logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: sync-logs-${{ github.run_id }}-${{ github.sha }}
        path: |
          logs/
          exports/
        retention-days: 30
        
    - name: ğŸ”” Notify on success
      if: success() && steps.sync.outputs.sync_status == 'success'
      uses: slackapi/slack-github-action@v1.24.0
      with:
        channel-id: ${{ secrets.SLACK_CHANNEL_ID }}
        payload: |
          {
            "text": "âœ… Google Search Console â†’ ThinkingData ë™ê¸°í™” ì„±ê³µ",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ë™ê¸°í™” ì„±ê³µ ì•Œë¦¼* ğŸ‰"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*ì‹¤í–‰ ID:*\n${{ github.run_id }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ë™ê¸°í™” íƒ€ì…:*\n${{ github.event.inputs.sync_type || 'yesterday' }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ì‹¤í–‰ ì‹œê°„:*\n$(date '+%Y-%m-%d %H:%M:%S KST')"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Repository:*\n${{ github.repository }}"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|ë¡œê·¸ í™•ì¸í•˜ê¸°>"
                }
              }
            ]
          }
      env:
        SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        
    - name: ğŸš¨ Notify on failure
      if: failure()
      uses: slackapi/slack-github-action@v1.24.0
      with:
        channel-id: ${{ secrets.SLACK_CHANNEL_ID }}
        payload: |
          {
            "text": "âŒ Google Search Console â†’ ThinkingData ë™ê¸°í™” ì‹¤íŒ¨",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ë™ê¸°í™” ì‹¤íŒ¨ ì•Œë¦¼* ğŸš¨"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*ì‹¤í–‰ ID:*\n${{ github.run_id }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ë™ê¸°í™” íƒ€ì…:*\n${{ github.event.inputs.sync_type || 'yesterday' }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ì‹¤íŒ¨ ì‹œê°„:*\n$(date '+%Y-%m-%d %H:%M:%S KST')"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Repository:*\n${{ github.repository }}"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|ë¡œê·¸ í™•ì¸í•˜ê¸°>"
                }
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "ğŸ’¡ *ë¬¸ì œ í•´ê²° íŒ:* GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ êµ¬ì²´ì ì¸ ì˜¤ë¥˜ ì›ì¸ì„ íŒŒì•…í•˜ì„¸ìš”."
                  }
                ]
              }
            ]
          }
      env:
        SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }} 